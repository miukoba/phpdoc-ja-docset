<html><!-- Mirrored from php.net/manual/en/function.imap-fetchstructure.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 16:01:33 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

  <title>imap_fetchstructure</title>

 <link rel="shortcut icon" href="../../favicon.ico">
 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="function.imap-fetchstructure.html">
 <link rel="shorturl" href="http://php.net/imap-fetchstructure">
 <link rel="alternate" href="http://php.net/imap-fetchstructure" hreflang="x-default">

 <link rel="contents" href="index-2.html">
 <link rel="index" href="ref.imap.html">
 <link rel="prev" href="function.imap-fetchmime.html">
 <link rel="next" href="function.imap-fetchtext.html">

 <link rel="alternate" href="function.imap-fetchstructure.html" hreflang="en">
 <link rel="alternate" href="http://php.net/manual/pt_BR/function.imap-fetchstructure.php" hreflang="pt_BR">
 <link rel="alternate" href="http://php.net/manual/zh/function.imap-fetchstructure.php" hreflang="zh">
 <link rel="alternate" href="http://php.net/manual/fr/function.imap-fetchstructure.php" hreflang="fr">
 <link rel="alternate" href="http://php.net/manual/de/function.imap-fetchstructure.php" hreflang="de">
 <link rel="alternate" href="http://php.net/manual/it/function.imap-fetchstructure.php" hreflang="it">
 <link rel="alternate" href="http://php.net/manual/ja/function.imap-fetchstructure.php" hreflang="ja">
 <link rel="alternate" href="http://php.net/manual/ro/function.imap-fetchstructure.php" hreflang="ro">
 <link rel="alternate" href="http://php.net/manual/ru/function.imap-fetchstructure.php" hreflang="ru">
 <link rel="alternate" href="http://php.net/manual/es/function.imap-fetchstructure.php" hreflang="es">
 <link rel="alternate" href="http://php.net/manual/tr/function.imap-fetchstructure.php" hreflang="tr">

<link rel="stylesheet" type="text/css" href="../../cached8fe1.css?t=1401250819&amp;f=/fonts/Fira/fira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached4b8d.css?t=1404368420&amp;f=/fonts/Font-Awesome/css/fontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached5065.css?t=1403329232&amp;f=/styles/theme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cachedc78d.css?t=1401249623&amp;f=/styles/theme-medium.css" media="screen">

 <!--[if lte IE 7]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie7.css" media="screen">
 <![endif]-->

 <!--[if lte IE 8]>
 <script type="text/javascript">
  window.brokenIE = true;
 </script>
 <![endif]-->

 <!--[if lte IE 9]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie9.css" media="screen">
 <![endif]-->

 <!--[if IE]>
 <script type="text/javascript" src="http://php.net/js/ext/html5.js"></script>
 <![endif]-->

 <base>

</head>
<body class="docs " style="">


<div class="headsup"><a href="http://php.net/index.php#id2014-08-28-1">PHP 5.6.0 released</a></div>
<nav id="trick"><div><dl>
<dt><a href="getting-started.html">Getting Started</a></dt>
	<dd><a href="introduction.html">Introduction</a></dd>
	<dd><a href="tutorial.html">A simple tutorial</a></dd>
<dt><a href="langref.html">Language Reference</a></dt>
	<dd><a href="language.basic-syntax.html">Basic syntax</a></dd>
	<dd><a href="language.types.html">Types</a></dd>
	<dd><a href="language.variables.html">Variables</a></dd>
	<dd><a href="language.constants.html">Constants</a></dd>
	<dd><a href="language.expressions.html">Expressions</a></dd>
	<dd><a href="language.operators.html">Operators</a></dd>
	<dd><a href="language.control-structures.html">Control Structures</a></dd>
	<dd><a href="language.functions.html">Functions</a></dd>
	<dd><a href="language.oop5.html">Classes and Objects</a></dd>
	<dd><a href="language.namespaces.html">Namespaces</a></dd>
	<dd><a href="language.exceptions.html">Exceptions</a></dd>
	<dd><a href="language.generators.html">Generators</a></dd>
	<dd><a href="language.references.html">References Explained</a></dd>
	<dd><a href="reserved.variables.html">Predefined Variables</a></dd>
	<dd><a href="reserved.exceptions.html">Predefined Exceptions</a></dd>
	<dd><a href="reserved.interfaces.html">Predefined Interfaces and Classes</a></dd>
	<dd><a href="context.html">Context options and parameters</a></dd>
	<dd><a href="wrappers.html">Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href="security.html">Security</a></dt>
	<dd><a href="security.intro.html">Introduction</a></dd>
	<dd><a href="security.general.html">General considerations</a></dd>
	<dd><a href="security.cgi-bin.html">Installed as CGI binary</a></dd>
	<dd><a href="security.apache.html">Installed as an Apache module</a></dd>
	<dd><a href="security.filesystem.html">Filesystem Security</a></dd>
	<dd><a href="security.database.html">Database Security</a></dd>
	<dd><a href="security.errors.html">Error Reporting</a></dd>
	<dd><a href="security.globals.html">Using Register Globals</a></dd>
	<dd><a href="security.variables.html">User Submitted Data</a></dd>
	<dd><a href="security.magicquotes.html">Magic Quotes</a></dd>
	<dd><a href="security.hiding.html">Hiding PHP</a></dd>
	<dd><a href="security.current.html">Keeping Current</a></dd>
<dt><a href="features.html">Features</a></dt>
	<dd><a href="features.http-auth.html">HTTP authentication with PHP</a></dd>
	<dd><a href="features.cookies.html">Cookies</a></dd>
	<dd><a href="features.sessions.html">Sessions</a></dd>
	<dd><a href="features.xforms.html">Dealing with XForms</a></dd>
	<dd><a href="features.file-upload.html">Handling file uploads</a></dd>
	<dd><a href="features.remote-files.html">Using remote files</a></dd>
	<dd><a href="features.connection-handling.html">Connection handling</a></dd>
	<dd><a href="features.persistent-connections.html">Persistent Database Connections</a></dd>
	<dd><a href="features.safe-mode.html">Safe Mode</a></dd>
	<dd><a href="features.commandline.html">Command line usage</a></dd>
	<dd><a href="features.gc.html">Garbage Collection</a></dd>
	<dd><a href="features.dtrace.html">DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href="funcref.html">Function Reference</a></dt>
	<dd><a href="refs.basic.php.html">Affecting PHP's Behaviour</a></dd>
	<dd><a href="refs.utilspec.audio.html">Audio Formats Manipulation</a></dd>
	<dd><a href="refs.remote.auth.html">Authentication Services</a></dd>
	<dd><a href="refs.utilspec.cmdline.html">Command Line Specific Extensions</a></dd>
	<dd><a href="refs.compression.html">Compression and Archive Extensions</a></dd>
	<dd><a href="refs.creditcard.html">Credit Card Processing</a></dd>
	<dd><a href="refs.crypto.html">Cryptography Extensions</a></dd>
	<dd><a href="refs.database.html">Database Extensions</a></dd>
	<dd><a href="refs.calendar.html">Date and Time Related Extensions</a></dd>
	<dd><a href="refs.fileprocess.file.html">File System Related Extensions</a></dd>
	<dd><a href="refs.international.html">Human Language and Character Encoding Support</a></dd>
	<dd><a href="refs.utilspec.image.html">Image Processing and Generation</a></dd>
	<dd><a href="refs.remote.mail.html">Mail Related Extensions</a></dd>
	<dd><a href="refs.math.html">Mathematical Extensions</a></dd>
	<dd><a href="refs.utilspec.nontext.html">Non-Text MIME Output</a></dd>
	<dd><a href="refs.fileprocess.process.html">Process Control Extensions</a></dd>
	<dd><a href="refs.basic.other.html">Other Basic Extensions</a></dd>
	<dd><a href="refs.remote.other.html">Other Services</a></dd>
	<dd><a href="refs.search.html">Search Engine Extensions</a></dd>
	<dd><a href="refs.utilspec.server.html">Server Specific Extensions</a></dd>
	<dd><a href="refs.basic.session.html">Session Extensions</a></dd>
	<dd><a href="refs.basic.text.html">Text Processing</a></dd>
	<dd><a href="refs.basic.vartype.html">Variable and Type Related Extensions</a></dd>
	<dd><a href="refs.webservice.html">Web Services</a></dd>
	<dd><a href="refs.utilspec.windows.html">Windows Only Extensions</a></dd>
	<dd><a href="refs.xml.html">XML Manipulation</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="row-fluid">
          
              
        <ul class="breadcrumbs-container">
            <li><a href="index-2.html">PHP Manual</a></li>      <li><a href="funcref.html">Function Reference</a></li>      <li><a href="refs.remote.mail.html">Mail Related Extensions</a></li>      <li><a href="book.imap.html">IMAP</a></li>      <li><a href="ref.imap.html">IMAP Functions</a></li>    </ul>
  </div>




<div id="layout">
  <section id="layout-content">
  <div id="function.imap-fetchstructure" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">imap_fetchstructure</h1>
  <p class="verinfo">(PHP 4, PHP 5)</p><p class="refpurpose"><span class="refname">imap_fetchstructure</span> â€” <span class="dc-title">Read the structure of a particular message</span></p>

 </div>
 <div class="refsect1 description" id="refsect1-function.imap-fetchstructure-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">object</span> <span class="methodname"><strong>imap_fetchstructure</strong></span>
    ( <span class="methodparam"><span class="type">resource</span> <code class="parameter">$imap_stream</code></span>
   , <span class="methodparam"><span class="type">int</span> <code class="parameter">$msg_number</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$options</code><span class="initializer"> = 0</span></span>
  ] )</div>

  <p class="para rdfs-comment">
   Fetches all the structured information for a given message. 
  </p>
 </div>

 <div class="refsect1 parameters" id="refsect1-function.imap-fetchstructure-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   </p><dl>

    <dt>
<code class="parameter">
imap_stream</code></dt>
<dd>
<p class="para">An IMAP stream returned by
<span class="function"><a href="function.imap-open.html" class="function">imap_open()</a></span>.</p></dd>

    
     <dt>
<code class="parameter">msg_number</code></dt>

     <dd>

      <p class="para">
       The message number
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">options</code></dt>

     <dd>

      <p class="para">
       This optional parameter only has a single option, 
       <strong><code>FT_UID</code></strong>, which tells the function to treat the
       <code class="parameter">msg_number</code> argument as a 
       <em>UID</em>.
      </p>
     </dd>

    
   </dl>

  <p></p>
 </div>

 <div class="refsect1 returnvalues" id="refsect1-function.imap-fetchstructure-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Returns an object includes the envelope, internal date, size, flags and
   body structure along with a similar object for each mime attachment. The
   structure of the returned objects is as follows:
  </p>
  <p class="para">
   </p><table class="doctable table">
    <caption><strong>
     Returned Objects for <span class="function"><strong>imap_fetchstructure()</strong></span>
    </strong></caption>
    
     <tbody class="tbody">
      <tr>
       <td>type</td>
       <td>Primary body type</td>
      </tr>

      <tr>
       <td>encoding</td>
       <td>Body transfer encoding</td>
      </tr>

      <tr>
       <td>ifsubtype</td>
       <td><strong><code>TRUE</code></strong> if there is a subtype string</td>
      </tr>

      <tr>
       <td>subtype</td>
       <td><acronym title="Multipurpose Internet Mail Extensions">MIME</acronym> subtype</td>
      </tr>

      <tr>
       <td>ifdescription</td>
       <td><strong><code>TRUE</code></strong> if there is a description string</td>
      </tr>

      <tr>
       <td>description</td>
       <td>Content description string</td>
      </tr>

      <tr>
       <td>ifid</td>
       <td><strong><code>TRUE</code></strong> if there is an identification string</td>
      </tr>

      <tr>
       <td>id</td>
       <td>Identification string</td>
      </tr>

      <tr>
       <td>lines</td>
       <td>Number of lines</td>
      </tr>

      <tr>
       <td>bytes</td>
       <td>Number of bytes</td>
      </tr>

      <tr>
       <td>ifdisposition</td>
       <td><strong><code>TRUE</code></strong> if there is a disposition string</td>
      </tr>

      <tr>
       <td>disposition</td>
       <td>Disposition string</td>
      </tr>

      <tr>
       <td>ifdparameters</td>
       <td><strong><code>TRUE</code></strong> if the <var class="varname"><var class="varname">dparameters</var></var> array exists</td>
      </tr>

      <tr>
       <td>dparameters</td>
       <td>An array of objects where each object has an
        <em>"attribute"</em> and a <em>"value"</em>
        property corresponding to the parameters on the
        <em>Content-disposition</em> <acronym title="Multipurpose Internet Mail Extensions">MIME</acronym>
        header.</td>
      </tr>

      <tr>
       <td>ifparameters</td>
       <td><strong><code>TRUE</code></strong> if the parameters array exists</td>
      </tr>

      <tr>
       <td>parameters</td>
       <td>An array of objects where each object has an
        <em>"attribute"</em> and a <em>"value"</em>
        property.</td>
      </tr>

      <tr>
       <td>parts</td>
       <td>An array of objects identical in structure to the top-level
       object, each of which corresponds to a <acronym title="Multipurpose Internet Mail Extensions">MIME</acronym> body
       part.</td>
      </tr>

     </tbody>
    
   </table>

  <p></p>
  <p class="para">
   </p><table class="doctable table">
     <caption><strong>Primary body type (may vary with used library)</strong></caption>
     
      <tbody class="tbody">
      <tr><td>0</td><td>text</td></tr>

      <tr><td>1</td><td>multipart</td></tr>

      <tr><td>2</td><td>message</td></tr>

      <tr><td>3</td><td>application</td></tr>

      <tr><td>4</td><td>audio</td></tr>

      <tr><td>5</td><td>image</td></tr>

      <tr><td>6</td><td>video</td></tr>

      <tr><td>7</td><td>other</td></tr>

      </tbody>
     
   </table>

  <p></p>
  <p class="para">
   </p><table class="doctable table">
     <caption><strong>Transfer encodings (may vary with used library)</strong></caption>
     
      <tbody class="tbody">
      <tr><td>0</td><td>7BIT</td></tr>

      <tr><td>1</td><td>8BIT</td></tr>

      <tr><td>2</td><td>BINARY</td></tr>

      <tr><td>3</td><td>BASE64</td></tr>

      <tr><td>4</td><td>QUOTED-PRINTABLE</td></tr>

      <tr><td>5</td><td>OTHER</td></tr>

     </tbody>
    
   </table>

  <p></p>
 </div>

 <div class="refsect1 seealso" id="refsect1-function.imap-fetchstructure-seealso">
  <h3 class="title">See Also</h3>
  <p class="para">
   </p><ul class="simplelist">
    <li class="member"><span class="function"><a href="function.imap-fetchbody.html" class="function" rel="rdfs-seeAlso">imap_fetchbody()</a> - Fetch a particular section of the body of the message</span></li>
    <li class="member"><span class="function"><a href="function.imap-bodystruct.html" class="function" rel="rdfs-seeAlso">imap_bodystruct()</a> - Read the structure of a specified body section of a specific message</span></li>
   </ul>
  <p></p>
 </div>

</div>
<section id="usernotes">
 <div class="head"><h3 class="title">User Contributed Notes</h3></div><div id="allnotes">
  <div class="note" id="85486">  
  <a class="name">
  <strong class="user"><em>david at hundsness dot com</em></strong></a><div class="date" title="2008-09-02 02:31"><strong>5 years ago</strong></div>
  <div class="text" id="Hcom85486">
<div class="phpcode"><code><span class="html">
Here is code to parse and decode all types of messages, including attachments. I've been using something like this for awhile now, so it's pretty robust.<br><br>&lt;?<br>function getmsg($mbox,$mid) {<br>&nbsp; &nbsp; // input $mbox = IMAP stream, $mid = message id<br>&nbsp; &nbsp; // output all the following:<br>&nbsp; &nbsp; global $charset,$htmlmsg,$plainmsg,$attachments;<br>&nbsp; &nbsp; $htmlmsg = $plainmsg = $charset = '';<br>&nbsp; &nbsp; $attachments = array();<br><br>&nbsp; &nbsp; // HEADER<br>&nbsp; &nbsp; $h = imap_header($mbox,$mid);<br>&nbsp; &nbsp; // add code here to get date, from, to, cc, subject...<br><br>&nbsp; &nbsp; // BODY<br>&nbsp; &nbsp; $s = imap_fetchstructure($mbox,$mid);<br>&nbsp; &nbsp; if (!$s-&gt;parts)&nbsp; // simple<br>&nbsp; &nbsp; &nbsp; &nbsp; getpart($mbox,$mid,$s,0);&nbsp; // pass 0 as part-number<br>&nbsp; &nbsp; else {&nbsp; // multipart: cycle through each part<br>&nbsp; &nbsp; &nbsp; &nbsp; foreach ($s-&gt;parts as $partno0=&gt;$p)<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; getpart($mbox,$mid,$p,$partno0+1);<br>&nbsp; &nbsp; }<br>}<br><br>function getpart($mbox,$mid,$p,$partno) {<br>&nbsp; &nbsp; // $partno = '1', '2', '2.1', '2.1.3', etc for multipart, 0 if simple<br>&nbsp; &nbsp; global $htmlmsg,$plainmsg,$charset,$attachments;<br><br>&nbsp; &nbsp; // DECODE DATA<br>&nbsp; &nbsp; $data = ($partno)?<br>&nbsp; &nbsp; &nbsp; &nbsp; imap_fetchbody($mbox,$mid,$partno):&nbsp; // multipart<br>&nbsp; &nbsp; &nbsp; &nbsp; imap_body($mbox,$mid);&nbsp; // simple<br>&nbsp; &nbsp; // Any part may be encoded, even plain text messages, so check everything.<br>&nbsp; &nbsp; if ($p-&gt;encoding==4)<br>&nbsp; &nbsp; &nbsp; &nbsp; $data = quoted_printable_decode($data);<br>&nbsp; &nbsp; elseif ($p-&gt;encoding==3)<br>&nbsp; &nbsp; &nbsp; &nbsp; $data = base64_decode($data);<br><br>&nbsp; &nbsp; // PARAMETERS<br>&nbsp; &nbsp; // get all parameters, like charset, filenames of attachments, etc.<br>&nbsp; &nbsp; $params = array();<br>&nbsp; &nbsp; if ($p-&gt;parameters)<br>&nbsp; &nbsp; &nbsp; &nbsp; foreach ($p-&gt;parameters as $x)<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $params[strtolower($x-&gt;attribute)] = $x-&gt;value;<br>&nbsp; &nbsp; if ($p-&gt;dparameters)<br>&nbsp; &nbsp; &nbsp; &nbsp; foreach ($p-&gt;dparameters as $x)<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $params[strtolower($x-&gt;attribute)] = $x-&gt;value;<br><br>&nbsp; &nbsp; // ATTACHMENT<br>&nbsp; &nbsp; // Any part with a filename is an attachment,<br>&nbsp; &nbsp; // so an attached text file (type 0) is not mistaken as the message.<br>&nbsp; &nbsp; if ($params['filename'] || $params['name']) {<br>&nbsp; &nbsp; &nbsp; &nbsp; // filename may be given as 'Filename' or 'Name' or both<br>&nbsp; &nbsp; &nbsp; &nbsp; $filename = ($params['filename'])? $params['filename'] : $params['name'];<br>&nbsp; &nbsp; &nbsp; &nbsp; // filename may be encoded, so see imap_mime_header_decode()<br>&nbsp; &nbsp; &nbsp; &nbsp; $attachments[$filename] = $data;&nbsp; // this is a problem if two files have same name<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; // TEXT<br>&nbsp; &nbsp; if ($p-&gt;type==0 &amp;&amp; $data) {<br>&nbsp; &nbsp; &nbsp; &nbsp; // Messages may be split in different parts because of inline attachments,<br>&nbsp; &nbsp; &nbsp; &nbsp; // so append parts together with blank row.<br>&nbsp; &nbsp; &nbsp; &nbsp; if (strtolower($p-&gt;subtype)=='plain')<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $plainmsg. = trim($data) ."\n\n";<br>&nbsp; &nbsp; &nbsp; &nbsp; else<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $htmlmsg. = $data ."&lt;br&gt;&lt;br&gt;";<br>&nbsp; &nbsp; &nbsp; &nbsp; $charset = $params['charset'];&nbsp; // assume all parts are same charset<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; // EMBEDDED MESSAGE<br>&nbsp; &nbsp; // Many bounce notifications embed the original message as type 2,<br>&nbsp; &nbsp; // but AOL uses type 1 (multipart), which is not handled here.<br>&nbsp; &nbsp; // There are no PHP functions to parse embedded messages,<br>&nbsp; &nbsp; // so this just appends the raw source to the main message.<br>&nbsp; &nbsp; elseif ($p-&gt;type==2 &amp;&amp; $data) {<br>&nbsp; &nbsp; &nbsp; &nbsp; $plainmsg. = $data."\n\n";<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; // SUBPART RECURSION<br>&nbsp; &nbsp; if ($p-&gt;parts) {<br>&nbsp; &nbsp; &nbsp; &nbsp; foreach ($p-&gt;parts as $partno0=&gt;$p2)<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; getpart($mbox,$mid,$p2,$partno.'.'.($partno0+1));&nbsp; // 1.2, 1.2.1, etc.<br>&nbsp; &nbsp; }<br>}<br>?&gt;</span>
</code></div>
  </div>
 </div>
  <div class="note" id="100038">  
  <a class="name">
  <strong class="user"><em>raulggonzalez at gmail dot com</em></strong></a><div class="date" title="2010-09-21 05:54"><strong>3 years ago</strong></div>
  <div class="text" id="Hcom100038">
<div class="phpcode"><code><span class="html">
Hello eveybody,
<br>
<br>After reading plenty of posts (some good, some others not so good) I want to post a function to find out whether an email is coming with attachments
<br>
<br>The function can be called passing the object returned by imap_fetchstructure() or any of its parts (recursively)
<br>
<br><span class="default">&lt;?php
<br>$inbox </span><span class="keyword">= </span><span class="default">imap_open</span><span class="keyword">(</span><span class="default">$hostname</span><span class="keyword">,</span><span class="default">$username</span><span class="keyword">,</span><span class="default">$password</span><span class="keyword">) or die(</span><span class="string">'Cannot connect to mail: ' </span><span class="keyword">. </span><span class="default">imap_last_error</span><span class="keyword">());
<br></span><span class="default">$struct </span><span class="keyword">= </span><span class="default">imap_fetchstructure</span><span class="keyword">(</span><span class="default">$inbox</span><span class="keyword">,</span><span class="default">$uid</span><span class="keyword">,</span><span class="default">FT_UID</span><span class="keyword">);
<br></span><span class="default">$existAttachments </span><span class="keyword">= </span><span class="default">existAttachment</span><span class="keyword">(</span><span class="default">$struct</span><span class="keyword">);
<br>
<br>function </span><span class="default">existAttachment</span><span class="keyword">(</span><span class="default">$part</span><span class="keyword">){
<br>&nbsp; &nbsp; if (isset(</span><span class="default">$part</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; foreach (</span><span class="default">$part</span><span class="keyword">-&gt;</span><span class="default">parts </span><span class="keyword">as </span><span class="default">$partOfPart</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">existAttachment</span><span class="keyword">(</span><span class="default">$partOfPart</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; }
<br>&nbsp; &nbsp; else{
<br>&nbsp; &nbsp; &nbsp; &nbsp; if (isset(</span><span class="default">$part</span><span class="keyword">-&gt;</span><span class="default">disposition</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">$part</span><span class="keyword">-&gt;</span><span class="default">disposition </span><span class="keyword">== </span><span class="string">'attachment'</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">'&lt;p&gt;' </span><span class="keyword">. </span><span class="default">$part</span><span class="keyword">-&gt;</span><span class="default">dparameters</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]-&gt;</span><span class="default">value </span><span class="keyword">. </span><span class="string">'&lt;/p&gt;'</span><span class="keyword">;
<br></span><span class="comment">// here you can create a link to the file whose name is&nbsp; $part-&gt;dparameters[0]-&gt;value to download it
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">return </span><span class="default">true</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; }
<br>}
<br></span><span class="default">?&gt;
<br></span>
<br>Hopefully somebody can use it as well</span>
</code></div>
  </div>
 </div>
  <div class="note" id="52007">  
  <a class="name">
  <strong class="user"><em>masterbassist</em></strong></a><div class="date" title="2005-04-18 09:52"><strong>9 years ago</strong></div>
  <div class="text" id="Hcom52007">
<div class="phpcode"><code><span class="html">
I think the following line (when building attachment information)<br><br>&gt;&gt;&gt; "filename" =&gt; $parts[$i]-&gt;parameters[0]-&gt;value<br><br>needs to be<br><br>&gt;&gt;&gt; "filename" =&gt; $parts[$i]-&gt;dparameters[0]-&gt;value<br><br>The first version generated a PHP warning under PHP 5.0.3.&nbsp; The second version actually gets the filename.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="43279">  
  <a class="name">
  <strong class="user"><em>aperez at informatica dot 24ruedas dot com</em></strong></a><div class="date" title="2004-06-16 12:10"><strong>10 years ago</strong></div>
  <div class="text" id="Hcom43279">
<div class="phpcode"><code><span class="html">
About above comment and source code I wrote: certainly, plain/html text files are attachments, but I've written my code thinking about web IMAP clients, where text parts are not for downloading, simply they are shown. That's the reason.<br><br>Thanks anyway. :)</span>
</code></div>
  </div>
 </div>
  <div class="note" id="36816">  
  <a class="name">
  <strong class="user"><em>chrislhill at "O_o" hotmail dot com</em></strong></a><div class="date" title="2003-10-23 11:36"><strong>10 years ago</strong></div>
  <div class="text" id="Hcom36816">
<div class="phpcode"><code><span class="html">
For people just beging this may help alot as I spent a couple hours just trying to relize how exact the array was stored. (at the time I did not know the print_r function :P)<br><br>$struct = imap_fetchstructure($mbox, $msgnumber);<br>print_r($struct);<br><br>Will give you a better example for your messages but they are called as $struct using the varible method above.<br><br>$struct-&gt;type; //would return the type<br>$struct-&gt;encoding //would return the encoding <br><br>and etc..<br><br>This can be done many different ways but that is the basics on pulling the info out of the structure of fetchstructure itself, I hope it helps someone starting because it wouldve helped me :/.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="42656">  
  <a class="name">
  <strong class="user"><em>aperez at informatica dot 24ruedas dot com</em></strong></a><div class="date" title="2004-05-25 12:12"><strong>10 years ago</strong></div>
  <div class="text" id="Hcom42656">
<div class="phpcode"><code><span class="html">
This is my function to check attachments:<br><br><span class="default">&lt;?php<br>&nbsp; $est</span><span class="keyword">=</span><span class="default">imap_fetchstructure</span><span class="keyword">(</span><span class="default">$con</span><span class="keyword">,</span><span class="default">$msg</span><span class="keyword">);<br><br>&nbsp; if(</span><span class="default">checkAttachments</span><span class="keyword">(</span><span class="default">$est</span><span class="keyword">))<br>&nbsp; {<br>&nbsp; &nbsp; echo(</span><span class="string">"You have attachment(s)"</span><span class="keyword">);<br>&nbsp; }<br>&nbsp; else<br>&nbsp; {<br>&nbsp; &nbsp; echo(</span><span class="string">"You don't have attachment(s)"</span><span class="keyword">);<br>&nbsp; }<br>&nbsp; <br>&nbsp; function </span><span class="default">checkAttachments</span><span class="keyword">(</span><span class="default">$estMsg</span><span class="keyword">)<br>&nbsp; {<br>&nbsp; &nbsp; if((</span><span class="default">$estMsg</span><span class="keyword">-&gt;</span><span class="default">type</span><span class="keyword">!=</span><span class="default">0</span><span class="keyword">) &amp;&amp; (</span><span class="default">$estMsg</span><span class="keyword">-&gt;</span><span class="default">type</span><span class="keyword">!=</span><span class="default">1</span><span class="keyword">))<br>&nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; </span><span class="comment">// Text and multipart parts will not be shown as attachments<br>&nbsp; &nbsp; &nbsp; </span><span class="keyword">return(</span><span class="default">true</span><span class="keyword">);<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; else<br>&nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; </span><span class="comment">// If there's no attachments, parts inside will be checked<br>&nbsp; &nbsp; &nbsp; </span><span class="keyword">if(</span><span class="default">$estMsg</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">)<br>&nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$partMsg</span><span class="keyword">=</span><span class="default">$estMsg</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Parts will be checked while no attachments found or not all of them checked<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">while(!(</span><span class="default">checkAttachments</span><span class="keyword">(</span><span class="default">$partMsg</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">])) &amp;&amp; (</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">sizeof</span><span class="keyword">(</span><span class="default">$estMsg</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">)))<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i</span><span class="keyword">++;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// If any 'checkAttachment' calls returned 'true', 'i' should be<br>&nbsp; &nbsp; &nbsp; &nbsp; // equal to number of parts(after increased in while). So, no<br>&nbsp; &nbsp; &nbsp; &nbsp; // attachments found<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if(</span><span class="default">$i</span><span class="keyword">==</span><span class="default">sizeof</span><span class="keyword">(</span><span class="default">$estMsg</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">))<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return(</span><span class="default">false</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; else<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return(</span><span class="default">true</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; else<br>&nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// If no parts and text or multipart type, no attachments<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">return(</span><span class="default">false</span><span class="keyword">);&nbsp; <br>&nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; }<br>&nbsp; }<br>&nbsp; </span><span class="default">imap_close</span><span class="keyword">(</span><span class="default">$con</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>I hope this helps somebody else(if bugs, thanks for your fixes).</span>
</code></div>
  </div>
 </div>
  <div class="note" id="112486">  
  <a class="name">
  <strong class="user"><em>Anonymous</em></strong></a><div class="date" title="2013-06-20 10:52"><strong>1 year ago</strong></div>
  <div class="text" id="Hcom112486">
<div class="phpcode"><code><span class="html">
I improved the code from this post (<br><a rel="nofollow" target="_blank">http://www.php.net/manual/en/function.imap-fetchstructure.php#51497</a>) a bit, now it handles multi embedded email correctly, and gives you a content with not marking character, like the '=' (soft line break).<br><br><span class="default">&lt;?php<br></span><span class="comment">//return is structured as<br>// $mail = array ( 'body' =&gt; ...<br>//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 'attachment' =&gt; array() );<br></span><span class="keyword">function </span><span class="default">_get_body_attach</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mid</span><span class="keyword">) {<br>&nbsp; &nbsp; </span><span class="default">$struct </span><span class="keyword">= </span><span class="default">imap_fetchstructure</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mid</span><span class="keyword">);<br><br>&nbsp; &nbsp; </span><span class="default">$parts </span><span class="keyword">= </span><span class="default">$struct</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">;<br>&nbsp; &nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br>&nbsp; &nbsp; if (!</span><span class="default">$parts</span><span class="keyword">) { </span><span class="comment">/* Simple message, only 1 piece */<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$attachment </span><span class="keyword">= array(); </span><span class="comment">/* No attachments */<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$content </span><span class="keyword">= </span><span class="default">imap_body</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mid</span><span class="keyword">);<br>&nbsp; &nbsp; } else { </span><span class="comment">/* Complicated message, multiple parts */<br><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$endwhile </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$stack </span><span class="keyword">= array(); </span><span class="comment">/* Stack while parsing message */<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$content </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">/* Content of message */<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$attachment </span><span class="keyword">= array(); </span><span class="comment">/* Attachments */<br><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">while (!</span><span class="default">$endwhile</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$stack</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$parts </span><span class="keyword">= </span><span class="default">$stack</span><span class="keyword">[</span><span class="default">count</span><span class="keyword">(</span><span class="default">$stack</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">][</span><span class="string">"p"</span><span class="keyword">];<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i&nbsp; &nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">$stack</span><span class="keyword">[</span><span class="default">count</span><span class="keyword">(</span><span class="default">$stack</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">][</span><span class="string">"i"</span><span class="keyword">] + </span><span class="default">1</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">array_pop</span><span class="keyword">(</span><span class="default">$stack</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$endwhile </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!</span><span class="default">$endwhile</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">/* Create message part first (example '1.2.3') */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$partstring </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; foreach (</span><span class="default">$stack </span><span class="keyword">as </span><span class="default">$s</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$partstring </span><span class="keyword">.= (</span><span class="default">$s</span><span class="keyword">[</span><span class="string">"i"</span><span class="keyword">]+</span><span class="default">1</span><span class="keyword">) . </span><span class="string">"."</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$partstring </span><span class="keyword">.= (</span><span class="default">$i</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">);<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">disposition</span><span class="keyword">) == </span><span class="string">"ATTACHMENT" </span><span class="keyword">|| </span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">disposition</span><span class="keyword">) == </span><span class="string">"INLINE"</span><span class="keyword">) { </span><span class="comment">/* Attachment or inline images */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$filedata </span><span class="keyword">= </span><span class="default">imap_fetchbody</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mid</span><span class="keyword">, </span><span class="default">$partstring</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ( </span><span class="default">$filedata </span><span class="keyword">!= </span><span class="string">'' </span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// handles base64 encoding or plain text<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$decoded_data </span><span class="keyword">= </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$filedata</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ( </span><span class="default">$decoded_data </span><span class="keyword">== </span><span class="default">false </span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$attachment</span><span class="keyword">[] = array(</span><span class="string">"filename" </span><span class="keyword">=&gt; </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">parameters</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]-&gt;</span><span class="default">value</span><span class="keyword">,<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">"filedata" </span><span class="keyword">=&gt; </span><span class="default">$filedata</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$attachment</span><span class="keyword">[] = array(</span><span class="string">"filename" </span><span class="keyword">=&gt; </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">parameters</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]-&gt;</span><span class="default">value</span><span class="keyword">,<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">"filedata" </span><span class="keyword">=&gt; </span><span class="default">$decoded_data</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } elseif (</span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">subtype</span><span class="keyword">) == </span><span class="string">"PLAIN" </span><span class="keyword">&amp;&amp; </span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">]-&gt;</span><span class="default">subtype</span><span class="keyword">) != </span><span class="string">"HTML"</span><span class="keyword">) { </span><span class="comment">/* plain text message */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$content </span><span class="keyword">.= </span><span class="default">imap_fetchbody</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mid</span><span class="keyword">, </span><span class="default">$partstring</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } elseif ( </span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">subtype</span><span class="keyword">) == </span><span class="string">"HTML" </span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">/* HTML message takes priority */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$content </span><span class="keyword">.= </span><span class="default">imap_fetchbody</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mid</span><span class="keyword">, </span><span class="default">$partstring</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">parts</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ( </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">subtype </span><span class="keyword">!= </span><span class="string">'RELATED' </span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// a glitch: embedded email message have one additional stack in the structure with subtype 'RELATED', but this stack is not present when using imap_fetchbody() to fetch parts.<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$stack</span><span class="keyword">[] = array(</span><span class="string">"p" </span><span class="keyword">=&gt; </span><span class="default">$parts</span><span class="keyword">, </span><span class="string">"i" </span><span class="keyword">=&gt; </span><span class="default">$i</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$parts </span><span class="keyword">= </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">parts</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i</span><span class="keyword">++;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; } </span><span class="comment">/* while */<br>&nbsp; &nbsp; </span><span class="keyword">} </span><span class="comment">/* complicated message */<br><br>&nbsp; &nbsp; </span><span class="default">$ret </span><span class="keyword">= array();<br>&nbsp; &nbsp; </span><span class="default">$ret</span><span class="keyword">[</span><span class="string">'body'</span><span class="keyword">] = </span><span class="default">quoted_printable_decode</span><span class="keyword">(</span><span class="default">$content</span><span class="keyword">);<br>&nbsp; &nbsp; </span><span class="default">$ret</span><span class="keyword">[</span><span class="string">'attachment'</span><span class="keyword">] = </span><span class="default">$attachment</span><span class="keyword">;<br>&nbsp; &nbsp; return </span><span class="default">$ret</span><span class="keyword">;<br>}<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="34952">  
  <a class="name">
  <strong class="user"><em>es96 at hotmail dot com</em></strong></a><div class="date" title="2003-08-13 02:38"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom34952">
<div class="phpcode"><code><span class="html">
If you are getting CHARSET as US-ASCII even if the header has a Content-Type: field, make sure the header also has a MIME-Version: field.<br><br>For example, the following header will correcty report charset as KOI8-R<br><br>MIME-Version: 1.0<br>Content-Type: text/plain; charset="koi8-r"<br><br>Without the MIME-Version it will be reported as US-ASII</span>
</code></div>
  </div>
 </div>
  <div class="note" id="28043">  
  <a class="name">
  <strong class="user"><em>as1 at powersite dot com dot ar</em></strong></a><div class="date" title="2002-12-30 01:57"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom28043">
<div class="phpcode"><code><span class="html">
Sorry, my before code is not complet:<br><br>$struct = imap_fetchstructure( $conn, $curMsg );<br><br>$i = 1;<br>while( imap_fetchbody( $conn, $curMsg, $i ) ){<br>&nbsp; $struct-&gt;parts[$i-1] = imap_bodystruct( $conn, $curMsg, $i );<br>&nbsp; $j = 1;<br>&nbsp; while( imap_fetchbody( $conn, $curMsg, "$i.$j" ) ){<br>&nbsp; &nbsp; $struct-&gt;parts[$i-1]-&gt;parts[$j-1] = imap_bodystruct( $conn, $curMsg, "$i.$j" );<br>&nbsp; &nbsp; $j++;<br>&nbsp; &nbsp; }<br>&nbsp; $i++;<br>}</span>
</code></div>
  </div>
 </div>
  <div class="note" id="28040">  
  <a class="name">
  <strong class="user"><em>as1 at powersite dot com dot ar</em></strong></a><div class="date" title="2002-12-30 01:01"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom28040">
<div class="phpcode"><code><span class="html">
If your imap_fetchstructure not retrive all parts, write it:<br><br>$struct = imap_fetchstructure( $conn, $curMsg );<br><br>$i = 1;<br>while( imap_fetchbody( $conn, $curMsg, $i ) ){<br>&nbsp;&nbsp; $struct-&gt;parts[$i-1] = imap_bodystruct( $conn, $curMsg, $i );<br>&nbsp;&nbsp; $i++;<br>}</span>
</code></div>
  </div>
 </div>
  <div class="note" id="27396">  
  <a class="name">
  <strong class="user"><em>paradise at ml75 dot com</em></strong></a><div class="date" title="2002-12-04 07:40"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom27396">
<div class="phpcode"><code><span class="html">
I'm using freeBSD and had lots of problems with all functions/mail applications i could find on the net...<br><br>So i'm writing my own now..<br><br>Most of the stuff works fine now.. but i'm still working on the chooser to select the best part to show. (plain or HTML).<br><br>The #1 problem is that most functions give the wrong ID numbers beck to fetch the body.<br><br>Here's a sollution to that problem.. :P<br><br>// Debug function.. always handy until it's 100% completed..<br>&nbsp;&nbsp; $attachments = array(); $dispos=0;<br>&nbsp;&nbsp; $debug=true;<br>&nbsp;&nbsp; function doDebug($msg){<br>&nbsp; &nbsp; &nbsp; global $debug, $debug_depth, $dispos;<br>&nbsp; &nbsp; &nbsp; if($debug){<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; for($y = 0; $y &lt; $debug_depth; $y++) echo("&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;");<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if($dispos == 0) echo($msg."&lt;br/&gt;"); else echo("&lt;i&gt;".$msg."&lt;/i&gt;&lt;br/&gt;");<br>&nbsp; &nbsp; &nbsp; }<br>&nbsp;&nbsp; }<br><br>&nbsp;&nbsp; function Check_Part($part,$id){<br>&nbsp; &nbsp; &nbsp; global $attachments, $debug, $debug_depth, $dispos; $ans=sizeof($attachments);<br>&nbsp; &nbsp; &nbsp; doDebug("+Checking part $id");<br>&nbsp; &nbsp; &nbsp; $debug_depth++;<br>&nbsp; &nbsp; &nbsp; doDebug("Parttype=".$part-&gt;type ."/". mimetype($part-&gt;type) ."/". $part-&gt;subtype);<br><br>&nbsp; &nbsp; &nbsp; if($part-&gt;ifdisposition){ $dispos++; doDebug("&lt;b&gt;Disposition&lt;/b&gt;"); }<br>&nbsp; &nbsp; &nbsp; if($part-&gt;ifdescription){ doDebug("&lt;b&gt;Description=".$part-&gt;description."&lt;/b&gt;"); }<br><br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; switch($part-&gt;type){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case 1: if((strtolower($part-&gt;subtype) == "mixed") <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; or (strtolower($part-&gt;subtype)&nbsp; == "alternative")<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; or (strtolower($part-&gt;subtype) == "related")) break;<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; default: $an = sizeof($attachments);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if($part-&gt;ifdparameters){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $dpara = $part-&gt;dparameters;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; for ($v=0;$v&lt;sizeof($dpara);$v++){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (eregi("filename", $dpara[$v]-&gt;attribute)) <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $fname = $dpara[$v]-&gt;value;}<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if($part-&gt;ifparameters){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(empty($fname)){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $para = $part-&gt;parameters;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; for ($v=0;$v&lt;sizeof($para);$v++){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (eregi("name", $para[$v]-&gt;attribute)) $fname = $para[$v]-&gt;value;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(empty($fname))$fname = "Onbekend";<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $attachments[$an]-&gt;id = ($an+1);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $attachments[$an]-&gt;part = $id;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $attachments[$an]-&gt;filename = $fname;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $attachments[$an]-&gt;type=$part-&gt;type;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $attachments[$an]-&gt;subtype=$part-&gt;subtype;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $attachments[$an]-&gt;dispos=$dispos;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $attachments[$an]-&gt;size=$part-&gt;bytes;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; doDebug("Filename=".$attachments[$an]-&gt;filename); break;<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br><br>&nbsp; &nbsp; &nbsp; for($x = 0; $x &lt; count($part-&gt;parts); $x++){<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Check_Part($part-&gt;parts[$x], $id.".".($x+1));<br>&nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; doDebug("Dit deel had iets nuttigs.");<br>&nbsp; &nbsp; &nbsp; if($part-&gt;ifdisposition) $dispos--;<br>&nbsp; &nbsp; &nbsp; $debug_depth--;<br>&nbsp; &nbsp; &nbsp; doDebug("-End of part $id");<br>&nbsp;&nbsp; }<br><br>&nbsp;&nbsp; function decode_mail($mbox, $msg){<br>&nbsp; &nbsp; &nbsp; global $attachments, $debug, $debug_depth;<br>&nbsp; &nbsp; &nbsp; doDebug("+Decoding message $msg"); $debug_depth++;<br>&nbsp; &nbsp; &nbsp; $obj = imap_fetchstructure($mbox, $msg, FT_UID); $moet_werken=true; $id=1;<br>&nbsp; &nbsp; &nbsp; while($moet_werken){<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Check_Part($obj, $id);<br><br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $moet_werken=false;<br>&nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; $debug_depth--; doDebug("-End of message $msg");<br>&nbsp;&nbsp; }<br><br>Now to get this to work..<br>Decode_Mail([Mailbox connection], [Message Number]);<br><br>this is the outpu attachment array..<br>1--1.1.1--Onbekend--0--PLAIN--0--31 <br>2--1.1.2--Onbekend--0--HTML--0--29 <br>3--1.2--Beschrijving Nieuw E.doc--3--MSWORD--1--613718 <br>--------------------------------------<br><br>PS.. "Onbekend" is dutch for "Unknown".<br><br>Good luck.<br>Paradise (www.ml75.nl)</span>
</code></div>
  </div>
 </div>
  <div class="note" id="26295">  
  <a class="name">
  <strong class="user"><em>theUNDERSCOREVoodooChileADGMXdotNET</em></strong></a><div class="date" title="2002-10-25 05:21"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom26295">
<div class="phpcode"><code><span class="html">
you can easily see through everything with these functions:<br><br>function printarray($array){<br>&nbsp; while(list($key,$value) = each($array)){<br>&nbsp; &nbsp; if(is_array($value)){<br>&nbsp; &nbsp; &nbsp; echo $key."(array):&lt;blockquote&gt;";<br>&nbsp; &nbsp; &nbsp; printarray($value);//recursief!! <br>&nbsp; &nbsp; &nbsp; echo "&lt;/blockquote&gt;";<br>&nbsp; &nbsp; }elseif(is_object($value)){<br>&nbsp; &nbsp; &nbsp; echo $key."(object):&lt;blockquote&gt;";<br>&nbsp; &nbsp; &nbsp; printobject($value);<br>&nbsp; &nbsp; &nbsp; echo "&lt;/blockquote&gt;";<br>&nbsp; &nbsp; }else{<br>&nbsp; &nbsp; &nbsp; echo $key."==&gt;".$value."&lt;br /&gt;";<br>&nbsp; &nbsp; }<br>&nbsp; }<br>}<br><br>function printobject($obj){<br>&nbsp; $array = get_object_vars($obj);<br>&nbsp; printarray($array);<br>}<br><br>end then do this:<br><br>&nbsp; $struct = imap_fetchstructure($box,$mailnr);<br>&nbsp; //$struct is een object!!<br>&nbsp; drukobjectaf($struct);<br><br>you get an extended tree-view into the hierarchie of objects and arrays<br>Comparing different mails(changing thenumber) may bring more clarity into this matter<br><br>(these functions may not work properly as they are translated from my dutch original, but they ought to be OK)</span>
</code></div>
  </div>
 </div>
  <div class="note" id="25368">  
  <a class="name">
  <strong class="user"><em>jcastro at elnuevodia dot com</em></strong></a><div class="date" title="2002-09-20 01:16"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom25368">
<div class="phpcode"><code><span class="html">
I think the above note about attachments is wrong. I tested sending files with and without attachments and I get the following&lt;br&gt;<br>with attachment: type=3 bytes=343648<br>no attachment: type=0 bytes=2<br>so checking for $struct-&gt;bytes == " " means nothing. At least in my test<br>running windows 2000, php4.2.1 using outlook and exchange. It seems that cheking the type will be more reliable</span>
</code></div>
  </div>
 </div>
  <div class="note" id="25328">  
  <a class="name"><strong class="user"><em>Anonymous</em></strong></a><div class="date" title="2002-09-19 03:20"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom25328">
<div class="phpcode"><code><span class="html">
This function sets MIME charset <br>parameter value to US-ASCII when<br>either Content-Type header is missing <br>or Content-Type header doesn't have<br>charset parameter. This may be compliant<br>to RFC 822, but this poses<br>a problem for&nbsp; a calling function that<br>has to deal with untagged messages <br>in MIME charset other than US-ASCII.<br>To work around this,&nbsp; US-ASCII<br>has to be treated as the absence of MIME charset.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="22616">  
  <a class="name">
  <strong class="user"><em>kmakaveev(at)yahoo(dot)com</em></strong></a><div class="date" title="2002-06-25 07:29"><strong>12 years ago</strong></div>
  <div class="text" id="Hcom22616">
<div class="phpcode"><code><span class="html">
There's a little mistake in the code above!<br>The second echo must return "The message has no attachment!".<br>And that code must have some some additional&nbsp; thing to work properly! Maybe I must use -&gt;parts to determine how many parts has a particular message!</span>
</code></div>
  </div>
 </div>
  <div class="note" id="19296">  
  <a class="name">
  <strong class="user"><em>trionon at mail dot ru</em></strong></a><div class="date" title="2002-02-22 08:42"><strong>12 years ago</strong></div>
  <div class="text" id="Hcom19296">
<div class="phpcode"><code><span class="html">
It's better to use special constants instead of digits for primary content-type:<br><br>&nbsp; &nbsp; &nbsp; &nbsp; TYPETEXT&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unformatted text<br>&nbsp; &nbsp; &nbsp; &nbsp; TYPEMULTIPART&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; multiple part<br>&nbsp; &nbsp; &nbsp; &nbsp; TYPEMESSAGE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; encapsulated message<br>&nbsp; &nbsp; &nbsp; &nbsp; TYPEAPPLICATION&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; application data<br>&nbsp; &nbsp; &nbsp; &nbsp; TYPEAUDIO&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; audio<br>&nbsp; &nbsp; &nbsp; &nbsp; TYPEIMAGE&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; static image (GIF, JPEG, etc.)<br>&nbsp; &nbsp; &nbsp; &nbsp; TYPEVIDEO&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; video<br>&nbsp; &nbsp; &nbsp; &nbsp; TYPEOTHER&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unknown<br><br>These constants are documented in the source code of IMAP extension but they are still undocumented here :(</span>
</code></div>
  </div>
 </div>
  <div class="note" id="19172">  
  <a class="name">
  <strong class="user"><em>php AT firstnetimpressions.com</em></strong></a><div class="date" title="2002-02-18 01:15"><strong>12 years ago</strong></div>
  <div class="text" id="Hcom19172">
<div class="phpcode"><code><span class="html">
Point of clarification:<br><br>The seventh primary body type is not "Other" as documented, but actually "Model".&nbsp; This encompasses IGES, VRML, MESH, DWF, etc.<br><br><a rel="nofollow" target="_blank">http://www.isi.edu/in-notes/iana/assignments/media-types/media-types</a><br><br>"Other" is the eigth primary body type.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="12632">  
  <a class="name">
  <strong class="user"><em>mkknapp at quadrapod dot com</em></strong></a><div class="date" title="2001-04-25 06:48"><strong>13 years ago</strong></div>
  <div class="text" id="Hcom12632">
<div class="phpcode"><code><span class="html">
Assuming $struct = imap_fetchstructure($x,$y);
<br>
<br>It is important to note that if a message has NO attachements, $struct-&gt;parts is an empty array, and $struct-&gt;bytes has a value.&nbsp; If a message as ANY attachements, $struct-&gt;bytes ALWAYS = 0. To get the size of the primary body, you have to call structure-&gt;part[0]-&gt;bytes.&nbsp; To get the size of the whole message, either strlen(imap_body) or add up the -&gt;bytes of all the parts.
<br>
<br>Another interesting note: 
<br>When there is body text and no attachements:
<br>count($struct-&gt;parts) = 0
<br>When there is body text and 1 attachement:
<br>count($struct-&gt;parts) = 2
<br>
<br>These imap functions could really use better documentation. Like giving the meathods for the dparameter and parameter classes...</span>
</code></div>
  </div>
 </div>
  <div class="note" id="12485">  
  <a class="name">
  <strong class="user"><em>jbrandt at europa dot com</em></strong></a><div class="date" title="2001-04-16 03:45"><strong>13 years ago</strong></div>
  <div class="text" id="Hcom12485">
<div class="phpcode"><code><span class="html">
Parsing the recursive object returned from imap_fetchstructure is easy. However trying to figure out the name of the section to pass to imap_fetchbody() isn't quite so straight forward because the naming conventions for the MIME sections are odd. If you copy and paste the following function you can pass an UID of an IMAP message and it will print out a hierarchy of the message and label each section.
<br>
<br>The only required parameters are $mbox and $em_uid. The other parameters are used when the function needs to call itself.
<br>
<br>Two functions mime_encoding() and mime_type() are not included. All they do is return string for the integer represention of a mime type/encoding.
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">function </span><span class="default">imap_dbody</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$em_uid</span><span class="keyword">, </span><span class="default">$mimeobj</span><span class="keyword">, </span><span class="default">$depth </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">, </span><span class="default">$section </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">)
<br>{
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// If this is the first run of the function then grab a object of the MIME structure of the message
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if(</span><span class="default">$section </span><span class="keyword">== </span><span class="default">0</span><span class="keyword">) </span><span class="default">$mimeobj </span><span class="keyword">= </span><span class="default">imap_fetchstructure</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$em_uid</span><span class="keyword">, </span><span class="default">FT_UID</span><span class="keyword">);
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; for(</span><span class="default">$y </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$y </span><span class="keyword">&lt; </span><span class="default">$depth</span><span class="keyword">; </span><span class="default">$y</span><span class="keyword">++) echo(</span><span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"</span><span class="keyword">);
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; echo(</span><span class="default">mime_type</span><span class="keyword">(</span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">type</span><span class="keyword">) . </span><span class="string">"/</span><span class="keyword">{</span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">subtype</span><span class="keyword">}</span><span class="string">, "</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; echo(</span><span class="default">mime_encoding</span><span class="keyword">(</span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">encoding</span><span class="keyword">) . </span><span class="string">" (&lt;B&gt;</span><span class="default">$section</span><span class="string">&lt;/B&gt;)&lt;BR&gt;"</span><span class="keyword">);
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; for(</span><span class="default">$x </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$x </span><span class="keyword">&lt; </span><span class="default">count</span><span class="keyword">(</span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">); </span><span class="default">$x</span><span class="keyword">++)
<br>&nbsp; &nbsp; &nbsp; &nbsp; {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// If we are in the root of the object increment by whole integers
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if(</span><span class="default">$section </span><span class="keyword">== </span><span class="default">0</span><span class="keyword">) </span><span class="default">$nsection </span><span class="keyword">= </span><span class="default">$x </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">;
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// If we are in the object and the first sub-object of our object isn't multipart
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // then increment the postfix by ".1" otherwise we are multipart or a message
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // and leave the section id alone to be handled by the next code block
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">else if((</span><span class="default">$pos </span><span class="keyword">= </span><span class="default">strrpos</span><span class="keyword">(</span><span class="default">$section</span><span class="keyword">, </span><span class="string">"."</span><span class="keyword">)) &amp;&amp; </span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]-&gt;</span><span class="default">type </span><span class="keyword">!= </span><span class="default">TYPEMULTIPART</span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$nsection </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$section</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$pos</span><span class="keyword">) . </span><span class="string">"." </span><span class="keyword">. (</span><span class="default">$x </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$nsection </span><span class="keyword">= </span><span class="default">$section</span><span class="keyword">;
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// If there are more parts to the part about to be processed reference it as a header with ".0"
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // but only if the child of this child isn't MULTIPART
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">[</span><span class="default">$x</span><span class="keyword">]-&gt;</span><span class="default">parts</span><span class="keyword">))
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Funny really, if a mime section is a inline message that has a multipart body you reference the message
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // mime section with "2" the inline message header with "2.0" and the subsections with "2.x"
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // However if the mime section is a inline message with only 1 part then you reference the
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // mime section in the message with 2.0 and the inline message body with 2.1
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if(!(</span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">[</span><span class="default">$x</span><span class="keyword">]-&gt;</span><span class="default">type </span><span class="keyword">== </span><span class="default">TYPEMESSAGE </span><span class="keyword">&amp;&amp; </span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">[</span><span class="default">$x</span><span class="keyword">]-&gt;</span><span class="default">parts</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]-&gt;</span><span class="default">type </span><span class="keyword">== </span><span class="default">TYPEMULTIPART</span><span class="keyword">))
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$nsection </span><span class="keyword">.= </span><span class="string">".0"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$nsection </span><span class="keyword">.= </span><span class="string">""</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">imap_dbody</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$em_uid</span><span class="keyword">, </span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">[</span><span class="default">$x</span><span class="keyword">], </span><span class="default">$depth </span><span class="keyword">+ </span><span class="default">1</span><span class="keyword">, </span><span class="default">$nsection</span><span class="keyword">);
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// If after processing the entire MIME object the $x variable is still zero then we didn't
<br>&nbsp; &nbsp; &nbsp; &nbsp; // process a multipart mime message, it's just normal email so say so here.
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if(</span><span class="default">$x </span><span class="keyword">== </span><span class="default">0 </span><span class="keyword">&amp;&amp; </span><span class="default">$section </span><span class="keyword">== </span><span class="default">0</span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo(</span><span class="default">mime_type</span><span class="keyword">(</span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">type</span><span class="keyword">) . </span><span class="string">"/</span><span class="keyword">{</span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">subtype</span><span class="keyword">}</span><span class="string">, "</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo(</span><span class="default">mime_encoding</span><span class="keyword">(</span><span class="default">$mimeobj</span><span class="keyword">-&gt;</span><span class="default">encoding</span><span class="keyword">) . </span><span class="string">" (&lt;B&gt;1&lt;/B&gt;) (&lt;B&gt;NOT MIME MULTIPART&lt;/B&gt;)&lt;BR&gt;"</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>}
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="99208">  
  <a class="name">
  <strong class="user"><em>burninleo at gmx dot net</em></strong></a><div class="date" title="2010-08-03 09:42"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom99208">
<div class="phpcode"><code><span class="html">
Use imap_errors() to get rid of sticky error messages about incorrect MIME headers.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="2758">  
  <a class="name">
  <strong class="user"><em>hholzgra at media-engineering dot de</em></strong></a><div class="date" title="1999-12-15 01:59"><strong>14 years ago</strong></div>
  <div class="text" id="Hcom2758">
<div class="phpcode"><code><span class="html">
the parts objects are identical in
<br>structure to those returned by imap_fetchstructure, describing one subfolder each
<br>
<br>parameters and dparameters are MIME-specific, theese contain the
<br>extra parameters provided in the Content-Type and Content-Disposion Header lines such as Charset or Filename</span>
</code></div>
  </div>
 </div>
  <div class="note" id="78076">  
  <a class="name">
  <strong class="user"><em>phpnet,a,emailaddress,cjb,net</em></strong></a><div class="date" title="2007-09-26 07:13"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom78076">
<div class="phpcode"><code><span class="html">
Another comment to inform people about something that should really be in the function description:<br><br>imap_fetchstructure() downloads the entire email, attachments and all, rather than just the structure.<br>I guess it's an undocumented feature, not a bug.<br><br>I had assumed that the script would have only downloaded the amount of data that was returned, but my script downloaded a cumulative 2.5gig before i noticed.&nbsp; Hopefully no-one else will have this happen.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="61280">  
  <a class="name">
  <strong class="user"><em>oersoep at gmail dot com</em></strong></a><div class="date" title="2006-01-29 11:58"><strong>8 years ago</strong></div>
  <div class="text" id="Hcom61280">
<div class="phpcode"><code><span class="html">
Please keep in mind that the "parameters" array is a stdClass object when there are no parameters, and NOT a zero-size array.<br>In PHP5 you'll get this error when iterating structure-&gt;parts[x]-&gt;parameters if there aren't any parameters for this part:<br><br>PHP Fatal error:&nbsp; Cannot use object of type stdClass as array in file.php on line 100</span>
</code></div>
  </div>
 </div>
  <div class="note" id="60361">  
  <a class="name">
  <strong class="user"><em>sirber at detritus dot qc dot ca</em></strong></a><div class="date" title="2006-01-04 11:48"><strong>8 years ago</strong></div>
  <div class="text" id="Hcom60361">
<div class="phpcode"><code><span class="html">
"Primary body type" of "unknown/unknown" will be int(9).</span>
</code></div>
  </div>
 </div>
  <div class="note" id="57058">  
  <a class="name">
  <strong class="user"><em>hans at lintoo dot dk</em></strong></a><div class="date" title="2005-09-22 07:07"><strong>8 years ago</strong></div>
  <div class="text" id="Hcom57058">
<div class="phpcode"><code><span class="html">
To fetch a single part (for example to investigate a charset or something like that)<br><br><span class="default">&lt;?php<br></span><span class="keyword">class </span><span class="default">StructureEngine </span><span class="keyword">{<br>&nbsp; &nbsp; private </span><span class="default">$structureObject</span><span class="keyword">;<br>&nbsp; &nbsp; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$structureInfo</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">structureObject </span><span class="keyword">= </span><span class="default">$structureInfo</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; </span><span class="comment">// snip....<br><br>&nbsp; &nbsp; </span><span class="keyword">public function </span><span class="default">getPart</span><span class="keyword">(</span><span class="default">$partNum</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$path </span><span class="keyword">= </span><span class="default">split</span><span class="keyword">(</span><span class="string">"[.]"</span><span class="keyword">,</span><span class="default">$partNum</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$currentPart </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">structureObject</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; foreach (</span><span class="default">$path </span><span class="keyword">as </span><span class="default">$key </span><span class="keyword">=&gt; </span><span class="default">$num</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$currentPart </span><span class="keyword">= </span><span class="default">$currentPart</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">[</span><span class="default">$num</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">];<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">$currentPart</span><span class="keyword">;<br>&nbsp; &nbsp; }<br>}<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="57054">  
  <a class="name">
  <strong class="user"><em>hans at lintoo dot dk</em></strong></a><div class="date" title="2005-09-22 06:14"><strong>8 years ago</strong></div>
  <div class="text" id="Hcom57054">
<div class="phpcode"><code><span class="html">
A class for searching through a stucture object. <br>You can search matching 1-3 parameters or use the methods included. <br>Feel free to use it, correct it or extend it if you please. Enjoy!<br><br><a rel="nofollow" target="_blank">http://lintoo.dk/public/structureengine.class.phps</a><br><br>The code was too wide for this manual, so I hope the link above will do. Here a quick overview instead:<br><br><span class="default">&lt;?php<br></span><span class="keyword">class </span><span class="default">StructureEngine </span><span class="keyword">{<br>&nbsp; &nbsp; private </span><span class="default">$structureObject</span><span class="keyword">;<br>&nbsp; &nbsp; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$structureInfo</span><span class="keyword">) {}<br>&nbsp; &nbsp; public function </span><span class="default">locatePlain</span><span class="keyword">() {}<br>&nbsp; &nbsp; public function </span><span class="default">locateHTML</span><span class="keyword">() {}<br>&nbsp; &nbsp; public function </span><span class="default">locateAttachments</span><span class="keyword">() {}<br>&nbsp; &nbsp; private function </span><span class="default">checkParam</span><span class="keyword">(</span><span class="default">$part</span><span class="keyword">, </span><span class="default">$type</span><span class="keyword">, </span><span class="default">$value</span><span class="keyword">) {}<br>&nbsp; &nbsp; private function </span><span class="default">findParts</span><span class="keyword">(</span><span class="default">$partsArray</span><span class="keyword">, </span><span class="default">$prefix</span><span class="keyword">, </span><span class="default">$param1Type </span><span class="keyword">= </span><span class="string">'type'</span><span class="keyword">, </span><span class="default">$param1Value </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">, </span><span class="default">$param2Type </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">, ...) {}<br>}<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="54438">  
  <a class="name">
  <strong class="user"><em>john at vetsurgeon dot org dot uk</em></strong></a><div class="date" title="2005-07-04 09:07"><strong>9 years ago</strong></div>
  <div class="text" id="Hcom54438">
<div class="phpcode"><code><span class="html">
A little script I threw together to break a message down and process it into a usable array<br><br>&lt;?<br>//script will fetch an email identified by $msgid, and parse the its parts into an<br>//array $partsarray<br>//structure of array:<br>//$partsarray[&lt;name of part&gt;][&lt;attachment/text&gt;]<br>//if attachment- subarray is [filename][binary data]<br>//if text- subarray is [type of text(HTML/PLAIN)][text string]<br><br>//i.e.<br>//$partsarray[3.1][attachment][filename]=filename of attachment in part 3.1<br>//$partsarray[3.1][attachment][binary]=binary data of attachment in part 3.1<br>//$partsarray[2][text][type]=type of text in part 2<br>//$partsarray[2][text][string]=decoded text string in part 2<br>//$partsarray[not multipart][text][string]=decoded text string in message that isn't multipart<br><br>function parsepart($p,$i){<br>&nbsp; &nbsp; global $link,$msgid,$partsarray;<br>&nbsp; &nbsp; //where to write file attachments to:<br>&nbsp; &nbsp; $filestore = '[full/path/to/attachment/store/(chmod777)]';<br><br>&nbsp; &nbsp; //fetch part<br>&nbsp; &nbsp; $part=imap_fetchbody($link,$msgid,$i);<br>&nbsp; &nbsp; //if type is not text<br>&nbsp; &nbsp; if ($p-&gt;type!=0){<br>&nbsp; &nbsp; &nbsp; &nbsp; //DECODE PART&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; //decode if base64<br>&nbsp; &nbsp; &nbsp; &nbsp; if ($p-&gt;encoding==3)$part=base64_decode($part);<br>&nbsp; &nbsp; &nbsp; &nbsp; //decode if quoted printable<br>&nbsp; &nbsp; &nbsp; &nbsp; if ($p-&gt;encoding==4)$part=quoted_printable_decode($part);<br>&nbsp; &nbsp; &nbsp; &nbsp; //no need to decode binary or 8bit!<br>&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; //get filename of attachment if present<br>&nbsp; &nbsp; &nbsp; &nbsp; $filename='';<br>&nbsp; &nbsp; &nbsp; &nbsp; // if there are any dparameters present in this part<br>&nbsp; &nbsp; &nbsp; &nbsp; if (count($p-&gt;dparameters)&gt;0){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; foreach ($p-&gt;dparameters as $dparam){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ((strtoupper($dparam-&gt;attribute)=='NAME') ||(strtoupper($dparam-&gt;attribute)=='FILENAME')) $filename=$dparam-&gt;value;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; //if no filename found<br>&nbsp; &nbsp; &nbsp; &nbsp; if ($filename==''){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // if there are any parameters present in this part<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (count($p-&gt;parameters)&gt;0){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; foreach ($p-&gt;parameters as $param){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ((strtoupper($param-&gt;attribute)=='NAME') ||(strtoupper($param-&gt;attribute)=='FILENAME')) $filename=$param-&gt;value;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; //write to disk and set partsarray variable<br>&nbsp; &nbsp; &nbsp; &nbsp; if ($filename!=''){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $partsarray[$i][attachment] = array('filename'=&gt;$filename,'binary'=&gt;$part);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $fp=fopen($filestore.$filename,"w+");<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fwrite($fp,$part);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; fclose($fp);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; //end if type!=0&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; //if part is text<br>&nbsp; &nbsp; else if($p-&gt;type==0){<br>&nbsp; &nbsp; &nbsp; &nbsp; //decode text<br>&nbsp; &nbsp; &nbsp; &nbsp; //if QUOTED-PRINTABLE<br>&nbsp; &nbsp; &nbsp; &nbsp; if ($p-&gt;encoding==4) $part=quoted_printable_decode($part);<br>&nbsp; &nbsp; &nbsp; &nbsp; //if base 64<br>&nbsp; &nbsp; &nbsp; &nbsp; if ($p-&gt;encoding==3) $part=base64_decode($part);<br>&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; //OPTIONAL PROCESSING e.g. nl2br for plain text<br>&nbsp; &nbsp; &nbsp; &nbsp; //if plain text<br><br>&nbsp; &nbsp; &nbsp; &nbsp; if (strtoupper($p-&gt;subtype)=='PLAIN')1;<br>&nbsp; &nbsp; &nbsp; &nbsp; //if HTML<br>&nbsp; &nbsp; &nbsp; &nbsp; else if (strtoupper($p-&gt;subtype)=='HTML')1;<br>&nbsp; &nbsp; &nbsp; &nbsp; $partsarray[$i][text] = array('type'=&gt;$p-&gt;subtype,'string'=&gt;$part);<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; //if subparts... recurse into function and parse them too!<br>&nbsp; &nbsp; if (count($p-&gt;parts)&gt;0){<br>&nbsp; &nbsp; &nbsp; &nbsp; foreach ($p-&gt;parts as $pno=&gt;$parr){<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; parsepart($parr,($i.'.'.($pno+1)));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>return;<br>}<br><br>//open resource<br>$link=imap_open("{localhost:110/pop3}INBOX",'[YOUR USERNAME]','[YOUR PASSWORD]');<br><br>//fetch structure of message<br>$s=imap_fetchstructure($link,$msgid);<br><br>//see if there are any parts<br>if (count($s-&gt;parts)&gt;0){<br>foreach ($s-&gt;parts as $partno=&gt;$partarr){<br>&nbsp; &nbsp; //parse parts of email<br>&nbsp; &nbsp; parsepart($partarr,$partno+1);<br>&nbsp; &nbsp; }<br>}<br><br>//for not multipart messages<br>else{<br>&nbsp; &nbsp; //get body of message<br>&nbsp; &nbsp; $text=imap_body($link,$msgid);<br>&nbsp; &nbsp; //decode if quoted-printable<br>&nbsp; &nbsp; if ($s-&gt;encoding==4) $text=quoted_printable_decode($text);<br>&nbsp; &nbsp; //OPTIONAL PROCESSING<br>&nbsp; &nbsp; if (strtoupper($s-&gt;subtype)=='PLAIN') $text=$text;<br>&nbsp; &nbsp; if (strtoupper($s-&gt;subtype)=='HTML') $text=$text;<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; $partsarray['not multipart'][text]=array('type'=&gt;$s-&gt;subtype,'string'=&gt;$text);<br>}<br><br>print_r($partsarray);<br>?&gt;</span>
</code></div>
  </div>
 </div>
  <div class="note" id="51497">  
  <a class="name">
  <strong class="user"><em>spam at emielmols dot info</em></strong></a><div class="date" title="2005-04-01 03:47"><strong>9 years ago</strong></div>
  <div class="text" id="Hcom51497">
<div class="phpcode"><code><span class="html">
I've created a function which simply extracts basic message content as a string ($content) and attachments as an array ($attachments). I've tested it with messages from Outlook, Outlook Express and Hotmail. Perhaps it's useful to anyone.<br><br><span class="default">&lt;?php<br>&nbsp; &nbsp; &nbsp; &nbsp; $struct </span><span class="keyword">= </span><span class="default">imap_fetchstructure</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mid</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$parts </span><span class="keyword">= </span><span class="default">$struct</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br><br>&nbsp; &nbsp; &nbsp; &nbsp; if (!</span><span class="default">$parts</span><span class="keyword">) { </span><span class="comment">/* Simple message, only 1 piece */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$attachment </span><span class="keyword">= array(); </span><span class="comment">/* No attachments */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$content </span><span class="keyword">= </span><span class="default">imap_body</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mid</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; } else { </span><span class="comment">/* Complicated message, multiple parts */<br>&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$endwhile </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$stack </span><span class="keyword">= array(); </span><span class="comment">/* Stack while parsing message */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$content </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">/* Content of message */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$attachment </span><span class="keyword">= array(); </span><span class="comment">/* Attachments */<br>&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">while (!</span><span class="default">$endwhile</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$stack</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$parts </span><span class="keyword">= </span><span class="default">$stack</span><span class="keyword">[</span><span class="default">count</span><span class="keyword">(</span><span class="default">$stack</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">][</span><span class="string">"p"</span><span class="keyword">];<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i&nbsp; &nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">$stack</span><span class="keyword">[</span><span class="default">count</span><span class="keyword">(</span><span class="default">$stack</span><span class="keyword">)-</span><span class="default">1</span><span class="keyword">][</span><span class="string">"i"</span><span class="keyword">] + </span><span class="default">1</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">array_pop</span><span class="keyword">(</span><span class="default">$stack</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$endwhile </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!</span><span class="default">$endwhile</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">/* Create message part first (example '1.2.3') */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$partstring </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; foreach (</span><span class="default">$stack </span><span class="keyword">as </span><span class="default">$s</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$partstring </span><span class="keyword">.= (</span><span class="default">$s</span><span class="keyword">[</span><span class="string">"i"</span><span class="keyword">]+</span><span class="default">1</span><span class="keyword">) . </span><span class="string">"."</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$partstring </span><span class="keyword">.= (</span><span class="default">$i</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">disposition</span><span class="keyword">) == </span><span class="string">"ATTACHMENT"</span><span class="keyword">) { </span><span class="comment">/* Attachment */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$attachment</span><span class="keyword">[] = array(</span><span class="string">"filename" </span><span class="keyword">=&gt; </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">parameters</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]-&gt;</span><span class="default">value</span><span class="keyword">,<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="string">"filedata" </span><span class="keyword">=&gt; </span><span class="default">imap_fetchbody</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mid</span><span class="keyword">, </span><span class="default">$partstring</span><span class="keyword">));<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } elseif (</span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">subtype</span><span class="keyword">) == </span><span class="string">"PLAIN"</span><span class="keyword">) { </span><span class="comment">/* Message */<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$content </span><span class="keyword">.= </span><span class="default">imap_fetchbody</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mid</span><span class="keyword">, </span><span class="default">$partstring</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">parts</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$stack</span><span class="keyword">[] = array(</span><span class="string">"p" </span><span class="keyword">=&gt; </span><span class="default">$parts</span><span class="keyword">, </span><span class="string">"i" </span><span class="keyword">=&gt; </span><span class="default">$i</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$parts </span><span class="keyword">= </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]-&gt;</span><span class="default">parts</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i</span><span class="keyword">++;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } </span><span class="comment">/* while */<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">} </span><span class="comment">/* complicated message */<br><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">echo </span><span class="string">"Analyzed message </span><span class="default">$mid</span><span class="string">, result: &lt;br /&gt;"</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">"Content: </span><span class="default">$content</span><span class="string">&lt;br /&gt;&lt;br /&gt;"</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">"Attachments:"</span><span class="keyword">; </span><span class="default">print_r </span><span class="keyword">(</span><span class="default">$attachment</span><span class="keyword">);<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="48352">  
  <a class="name">
  <strong class="user"><em>y dot daradkeh at gmail dot com</em></strong></a><div class="date" title="2004-12-20 07:40"><strong>9 years ago</strong></div>
  <div class="text" id="Hcom48352">
<div class="phpcode"><code><span class="html">
Hey people, get the message attachments with this code:<br><br><span class="default">&lt;?php<br><br>$mbox </span><span class="keyword">= </span><span class="default">imap_open</span><span class="keyword">(</span><span class="string">"</span><span class="default">$imap_server</span><span class="string">"</span><span class="keyword">.</span><span class="default">$f</span><span class="keyword">,</span><span class="default">$name</span><span class="keyword">,</span><span class="default">$pass</span><span class="keyword">);<br><br></span><span class="comment">// delibertely choose a message with an attachment<br><br></span><span class="default">$info </span><span class="keyword">= </span><span class="default">imap_fetchstructure</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">, </span><span class="default">$mno</span><span class="keyword">);<br><br></span><span class="comment">// find out how may parts the object has<br></span><span class="default">$numparts </span><span class="keyword">= </span><span class="default">count</span><span class="keyword">(</span><span class="default">$info</span><span class="keyword">-&gt;</span><span class="default">parts</span><span class="keyword">);<br><br></span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br></span><span class="comment">// find if multipart message<br></span><span class="keyword">if (</span><span class="default">$numparts </span><span class="keyword">&gt;</span><span class="default">1</span><span class="keyword">)<br>{<br>&nbsp;&nbsp; echo </span><span class="string">"&lt;b&gt;More than one part&lt;/b&gt;&lt;br&gt;&lt;br&gt;"</span><span class="keyword">;<br><br>&nbsp;&nbsp; foreach (</span><span class="default">$info</span><span class="keyword">-&gt;</span><span class="default">parts </span><span class="keyword">as </span><span class="default">$part</span><span class="keyword">)<br>&nbsp;&nbsp; {<br>&nbsp; &nbsp; &nbsp; if (</span><span class="default">$part</span><span class="keyword">-&gt;</span><span class="default">disposition </span><span class="keyword">== </span><span class="string">"INLINE"</span><span class="keyword">)<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">printf</span><span class="keyword">(</span><span class="string">"Inline message has %s lines&lt;BR&gt;"</span><span class="keyword">, </span><span class="default">$part</span><span class="keyword">-&gt;</span><span class="default">lines</span><span class="keyword">);<br>&nbsp; &nbsp;&nbsp; elseif (</span><span class="default">$part</span><span class="keyword">-&gt;</span><span class="default">disposition </span><span class="keyword">== </span><span class="string">"attachment"</span><span class="keyword">)<br>&nbsp; &nbsp;&nbsp; {<br>&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">++;<br>&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">$i</span><span class="keyword">.</span><span class="string">" Attachment/s found!&lt;br&gt;"</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Filename: "</span><span class="keyword">.</span><span class="default">$part</span><span class="keyword">-&gt;</span><span class="default">dparameters</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]-&gt;</span><span class="default">value</span><span class="keyword">.</span><span class="string">"&lt;br&gt;&lt;br&gt;"</span><span class="keyword">;<br>&nbsp; &nbsp;&nbsp; }<br>&nbsp;&nbsp; }<br>}<br>else<br>&nbsp;&nbsp; echo </span><span class="string">"Only one part"</span><span class="keyword">;<br><br></span><span class="default">imap_close</span><span class="keyword">(</span><span class="default">$mbox</span><span class="keyword">);<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="39420">  
  <a class="name">
  <strong class="user"><em>richy at smilingsouls dot net</em></strong></a><div class="date" title="2004-01-28 03:08"><strong>10 years ago</strong></div>
  <div class="text" id="Hcom39420">
<div class="phpcode"><code><span class="html">
After many long hours of pouring over the object returned by imap_fetchstructure() I came up with the solution posted at the following url:<br><br><a rel="nofollow" target="_blank">http://p2p.wrox.com/topic.asp?TOPIC_ID=9063</a><br><br>The url above provides an example of how to access variables in the object returned by imap_fetchstructure().&nbsp; This class creates an object with member variables containing the correct part numbers which are compatible with the imap_fetchbody() function.<br><br>The structure returned looks something like this:<br><br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 0 Raw Headers<br>$this-&gt;pid[$mid][0]&nbsp; =&nbsp; 1 text/plain&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; top level message<br>$this-&gt;pid[$mid][1]&nbsp; =&nbsp; 2 message/rfc822&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entire unparsed message<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; multipart/mixed - part is skipped!<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 2.0 Raw Headers<br>$this-&gt;pid[$mid][2]&nbsp; =&nbsp; &nbsp; &nbsp; 2.1 multipart/alternative&nbsp; &nbsp; &nbsp;&nbsp; contains unparsed contents of next subpart (text/plain &amp;&amp; text/html)<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.1.0 Raw Headers<br>$this-&gt;pid[$mid][3]&nbsp; =&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.1.1 text/plain&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2nd level inline embedded message<br>$this-&gt;pid[$mid][4]&nbsp; =&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.1.2 text/html<br><br>$this-&gt;pid[$mid][5]&nbsp; =&nbsp; &nbsp; &nbsp; 2.2 message/rfc822&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; entire unparsed message<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; multipart/mixed - part is skipped!<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.2.0 Raw Headers<br>$this-&gt;pid[$mid][6]&nbsp; =&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.2.1 multipart/alternative <br>$this-&gt;pid[$mid][7]&nbsp; =&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.2.1.1 text/plain&nbsp; &nbsp; &nbsp; 3rd level inline embedded message<br>$this-&gt;pid[$mid][8]&nbsp; =&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.2.1.2 text/html<br>$this-&gt;pid[$mid][9]&nbsp; =&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.2.2 image/jpeg<br>$this-&gt;pid[$mid][10] =&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 2.2.3 image/jpeg<br>$this-&gt;pid[$mid][11] =&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.2.4 image/jpeg<br>$this-&gt;pid[$mid][12] =&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2.2.5 image/gif<br><br>Its important to note why multipart/related, multipart/mixed and certain multipart/alternative (if parent part is message/rfc822 &amp;&amp; not multipart/mixed) parts are skipped, imap_fetchbody **does not** retreive a message part for these parts.&nbsp; Which isn't a bug, as I have read in other places, these parts exist for the purpose of designing the viewer portion of a mail application.&nbsp; Also, headers aren't assigned part numbers here because they are easy to pick out.<br><br>: )<br>Rich</span>
</code></div>
  </div>
 </div>
  <div class="note" id="3560">  
  <a class="name">
  <strong class="user"><em>vksgeneric at hotmail dot com</em></strong></a><div class="date" title="2000-02-02 05:22"><strong>14 years ago</strong></div>
  <div class="text" id="Hcom3560">
<div class="phpcode"><code><span class="html">
It looks like some clients (e.g. outlook) can attach a file that has two mime-types associated with it, like:
<br>
<br>Content-Type: model/vrml,x-world/x-vrml
<br>
<br>This bombs the parsing procedure somewhere in c-client, I guess, and as a result ifparameters is set to false for the respective part, and you can not retrieve filename, mimetype, or any other parameters.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="86753">  
  <a class="name">
  <strong class="user"><em>Rui Torre rui_sharkye at hotmail dot com</em></strong></a><div class="date" title="2008-11-02 02:34"><strong>5 years ago</strong></div>
  <div class="text" id="Hcom86753">
<div class="phpcode"><code><span class="html">
I've made this two functions to decode mime headers and so far they are working just fine decoding all headers. Please let me know if you find any error. Hope they are useful for you too.
<br>
<br><span class="default">&lt;?php
<br>
<br></span><span class="keyword">function </span><span class="default">decode_headers</span><span class="keyword">(</span><span class="default">$cabecalho</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; while (</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">'/^(.*)=\?([^?]*)\?(Q|B)\?(.*)$/Ui'</span><span class="keyword">, </span><span class="default">$cabecalho</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$cabecalho </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/(\t|\r|\n)/"</span><span class="keyword">, </span><span class="string">""</span><span class="keyword">, </span><span class="default">$cabecalho</span><span class="keyword">); 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$cabecalho </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/\?(Q|B)\?=/Ui"</span><span class="keyword">, </span><span class="string">"?\\1? ="</span><span class="keyword">, </span><span class="default">$cabecalho</span><span class="keyword">); 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$partes_cabecalho </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">"?="</span><span class="keyword">, </span><span class="default">$cabecalho</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$resultado </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; foreach (</span><span class="default">$partes_cabecalho </span><span class="keyword">as </span><span class="default">$texto</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$texto </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/\?(Q|B)\?\s=/Ui"</span><span class="keyword">, </span><span class="string">"?\\1?="</span><span class="keyword">, </span><span class="default">$texto</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$texto </span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">"/\?(Q|B)\?/Ui"</span><span class="keyword">, </span><span class="string">"=?\\1=?"</span><span class="keyword">, </span><span class="default">$texto</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">'/^(.*)=\?([^?]*)=\?(Q|B)=\?(.*)$/Ui'</span><span class="keyword">, </span><span class="default">$texto</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$partes_texto </span><span class="keyword">= </span><span class="default">explode </span><span class="keyword">(</span><span class="string">"=?"</span><span class="keyword">, </span><span class="default">$texto</span><span class="keyword">);&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$parte </span><span class="keyword">= </span><span class="default">descodificar_parte</span><span class="keyword">(</span><span class="default">$partes_texto</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">$partes_texto</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$parte </span><span class="keyword">.= </span><span class="default">descodificar_parte</span><span class="keyword">(</span><span class="default">$partes_texto</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">], </span><span class="default">$partes_texto</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else { 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$parte </span><span class="keyword">= </span><span class="default">$texto</span><span class="keyword">;&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">$partes_texto</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]) == </span><span class="string">"UTF-8"</span><span class="keyword">){ </span><span class="default">$parte </span><span class="keyword">= </span><span class="default">utf8_decode</span><span class="keyword">(</span><span class="default">$parte</span><span class="keyword">);}&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$resultado </span><span class="keyword">.= </span><span class="default">$parte</span><span class="keyword">;&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$cabecalho </span><span class="keyword">= </span><span class="default">$resultado</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; } 
<br>&nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$cabecalho</span><span class="keyword">);&nbsp; &nbsp; &nbsp;&nbsp; 
<br>&nbsp; &nbsp; }
<br>&nbsp; &nbsp; 
<br>&nbsp; &nbsp; function </span><span class="default">descodificar_parte</span><span class="keyword">(</span><span class="default">$texto</span><span class="keyword">, </span><span class="default">$codificacao</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">trim</span><span class="keyword">(</span><span class="default">$texto</span><span class="keyword">) == </span><span class="string">""</span><span class="keyword">){ return </span><span class="string">""</span><span class="keyword">;}
<br>&nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">ucfirst</span><span class="keyword">(</span><span class="default">$codificacao</span><span class="keyword">) == </span><span class="string">"B"</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$texto </span><span class="keyword">= </span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$texto</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$texto </span><span class="keyword">= </span><span class="default">htmlspecialchars</span><span class="keyword">(</span><span class="default">$texto</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; } else if (</span><span class="default">ucfirst</span><span class="keyword">(</span><span class="default">$codificacao</span><span class="keyword">) == </span><span class="string">"Q"</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$texto </span><span class="keyword">= </span><span class="default">str_replace</span><span class="keyword">(</span><span class="string">"_"</span><span class="keyword">, </span><span class="string">" "</span><span class="keyword">, </span><span class="default">$texto</span><span class="keyword">); 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$texto </span><span class="keyword">= </span><span class="default">quoted_printable_decode</span><span class="keyword">(</span><span class="default">$texto</span><span class="keyword">);&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; } 
<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">$texto</span><span class="keyword">;
<br>&nbsp; &nbsp; }
<br>
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="43244">  
  <a class="name">
  <strong class="user"><em>passeniermaxime at hotmail dot com</em></strong></a><div class="date" title="2004-06-15 08:15"><strong>10 years ago</strong></div>
  <div class="text" id="Hcom43244">
<div class="phpcode"><code><span class="html">
I have written a code that check's for attachments.<br>There is a slight problem with the above code; <br>when you send a mail with a .txt document as attachment<br>the type will be 0 and so there won't be a attachment found.<br><br>I check for the disposition of the body part witch can be inline or attachment. <br>If this is an attachment he will display it.<br>You an also mix up both codes by checking on the type and the disposition.<br><br>//////////////////////////////////<br>///&nbsp;&nbsp; $mbox = connection <br>///&nbsp;&nbsp; $a_mails_sort[$i] = message id<br><br>$structuur = imap_fetchstructure($mbox,$a_mails_sort[$i]);<br>$bericht_delen=$structuur-&gt;parts;<br>for($i_delen = 0; $i_delen&lt;=count($bericht_delen);$i_delen++)<br>&nbsp; {<br>&nbsp; if($bericht_delen[$i_delen]-&gt;disposition == "attachment")<br>&nbsp; &nbsp; {<br>&nbsp; &nbsp; $attachment = "OK";<br>&nbsp; &nbsp; }// end if<br>&nbsp; }//end for</span>
</code></div>
  </div>
 </div></div>

 
</section>    </section><!-- layout-content -->
        


  </div><!-- layout -->
         
  

    
 <!-- External and third party libraries. -->
 







<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top%402x.png"></a>



<!-- Mirrored from php.net/manual/en/function.imap-fetchstructure.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 16:01:33 GMT -->


</body></html>