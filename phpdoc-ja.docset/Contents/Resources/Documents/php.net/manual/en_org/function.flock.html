<html><!-- Mirrored from php.net/manual/en/function.flock.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 16:04:26 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

  <title>flock</title>

 <link rel="shortcut icon" href="../../favicon.ico">
 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="function.flock.html">
 <link rel="shorturl" href="http://php.net/flock">
 <link rel="alternate" href="http://php.net/flock" hreflang="x-default">

 <link rel="contents" href="index-2.html">
 <link rel="index" href="ref.filesystem.html">
 <link rel="prev" href="function.filetype.html">
 <link rel="next" href="function.fnmatch.html">

 <link rel="alternate" href="function.flock.html" hreflang="en">
 <link rel="alternate" href="http://php.net/manual/pt_BR/function.flock.php" hreflang="pt_BR">
 <link rel="alternate" href="http://php.net/manual/zh/function.flock.php" hreflang="zh">
 <link rel="alternate" href="http://php.net/manual/fr/function.flock.php" hreflang="fr">
 <link rel="alternate" href="http://php.net/manual/de/function.flock.php" hreflang="de">
 <link rel="alternate" href="http://php.net/manual/it/function.flock.php" hreflang="it">
 <link rel="alternate" href="http://php.net/manual/ja/function.flock.php" hreflang="ja">
 <link rel="alternate" href="http://php.net/manual/ro/function.flock.php" hreflang="ro">
 <link rel="alternate" href="http://php.net/manual/ru/function.flock.php" hreflang="ru">
 <link rel="alternate" href="http://php.net/manual/es/function.flock.php" hreflang="es">
 <link rel="alternate" href="http://php.net/manual/tr/function.flock.php" hreflang="tr">

<link rel="stylesheet" type="text/css" href="../../cached8fe1.css?t=1401250819&amp;f=/fonts/Fira/fira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached4b8d.css?t=1404368420&amp;f=/fonts/Font-Awesome/css/fontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached5065.css?t=1403329232&amp;f=/styles/theme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cachedc78d.css?t=1401249623&amp;f=/styles/theme-medium.css" media="screen">

 <!--[if lte IE 7]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie7.css" media="screen">
 <![endif]-->

 <!--[if lte IE 8]>
 <script type="text/javascript">
  window.brokenIE = true;
 </script>
 <![endif]-->

 <!--[if lte IE 9]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie9.css" media="screen">
 <![endif]-->

 <!--[if IE]>
 <script type="text/javascript" src="http://php.net/js/ext/html5.js"></script>
 <![endif]-->

 <base>

</head>
<body class="docs " style="">


<div class="headsup"><a href="http://php.net/index.php#id2014-08-28-1">PHP 5.6.0 released</a></div>
<nav id="trick"><div><dl>
<dt><a href="getting-started.html">Getting Started</a></dt>
	<dd><a href="introduction.html">Introduction</a></dd>
	<dd><a href="tutorial.html">A simple tutorial</a></dd>
<dt><a href="langref.html">Language Reference</a></dt>
	<dd><a href="language.basic-syntax.html">Basic syntax</a></dd>
	<dd><a href="language.types.html">Types</a></dd>
	<dd><a href="language.variables.html">Variables</a></dd>
	<dd><a href="language.constants.html">Constants</a></dd>
	<dd><a href="language.expressions.html">Expressions</a></dd>
	<dd><a href="language.operators.html">Operators</a></dd>
	<dd><a href="language.control-structures.html">Control Structures</a></dd>
	<dd><a href="language.functions.html">Functions</a></dd>
	<dd><a href="language.oop5.html">Classes and Objects</a></dd>
	<dd><a href="language.namespaces.html">Namespaces</a></dd>
	<dd><a href="language.exceptions.html">Exceptions</a></dd>
	<dd><a href="language.generators.html">Generators</a></dd>
	<dd><a href="language.references.html">References Explained</a></dd>
	<dd><a href="reserved.variables.html">Predefined Variables</a></dd>
	<dd><a href="reserved.exceptions.html">Predefined Exceptions</a></dd>
	<dd><a href="reserved.interfaces.html">Predefined Interfaces and Classes</a></dd>
	<dd><a href="context.html">Context options and parameters</a></dd>
	<dd><a href="wrappers.html">Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href="security.html">Security</a></dt>
	<dd><a href="security.intro.html">Introduction</a></dd>
	<dd><a href="security.general.html">General considerations</a></dd>
	<dd><a href="security.cgi-bin.html">Installed as CGI binary</a></dd>
	<dd><a href="security.apache.html">Installed as an Apache module</a></dd>
	<dd><a href="security.filesystem.html">Filesystem Security</a></dd>
	<dd><a href="security.database.html">Database Security</a></dd>
	<dd><a href="security.errors.html">Error Reporting</a></dd>
	<dd><a href="security.globals.html">Using Register Globals</a></dd>
	<dd><a href="security.variables.html">User Submitted Data</a></dd>
	<dd><a href="security.magicquotes.html">Magic Quotes</a></dd>
	<dd><a href="security.hiding.html">Hiding PHP</a></dd>
	<dd><a href="security.current.html">Keeping Current</a></dd>
<dt><a href="features.html">Features</a></dt>
	<dd><a href="features.http-auth.html">HTTP authentication with PHP</a></dd>
	<dd><a href="features.cookies.html">Cookies</a></dd>
	<dd><a href="features.sessions.html">Sessions</a></dd>
	<dd><a href="features.xforms.html">Dealing with XForms</a></dd>
	<dd><a href="features.file-upload.html">Handling file uploads</a></dd>
	<dd><a href="features.remote-files.html">Using remote files</a></dd>
	<dd><a href="features.connection-handling.html">Connection handling</a></dd>
	<dd><a href="features.persistent-connections.html">Persistent Database Connections</a></dd>
	<dd><a href="features.safe-mode.html">Safe Mode</a></dd>
	<dd><a href="features.commandline.html">Command line usage</a></dd>
	<dd><a href="features.gc.html">Garbage Collection</a></dd>
	<dd><a href="features.dtrace.html">DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href="funcref.html">Function Reference</a></dt>
	<dd><a href="refs.basic.php.html">Affecting PHP's Behaviour</a></dd>
	<dd><a href="refs.utilspec.audio.html">Audio Formats Manipulation</a></dd>
	<dd><a href="refs.remote.auth.html">Authentication Services</a></dd>
	<dd><a href="refs.utilspec.cmdline.html">Command Line Specific Extensions</a></dd>
	<dd><a href="refs.compression.html">Compression and Archive Extensions</a></dd>
	<dd><a href="refs.creditcard.html">Credit Card Processing</a></dd>
	<dd><a href="refs.crypto.html">Cryptography Extensions</a></dd>
	<dd><a href="refs.database.html">Database Extensions</a></dd>
	<dd><a href="refs.calendar.html">Date and Time Related Extensions</a></dd>
	<dd><a href="refs.fileprocess.file.html">File System Related Extensions</a></dd>
	<dd><a href="refs.international.html">Human Language and Character Encoding Support</a></dd>
	<dd><a href="refs.utilspec.image.html">Image Processing and Generation</a></dd>
	<dd><a href="refs.remote.mail.html">Mail Related Extensions</a></dd>
	<dd><a href="refs.math.html">Mathematical Extensions</a></dd>
	<dd><a href="refs.utilspec.nontext.html">Non-Text MIME Output</a></dd>
	<dd><a href="refs.fileprocess.process.html">Process Control Extensions</a></dd>
	<dd><a href="refs.basic.other.html">Other Basic Extensions</a></dd>
	<dd><a href="refs.remote.other.html">Other Services</a></dd>
	<dd><a href="refs.search.html">Search Engine Extensions</a></dd>
	<dd><a href="refs.utilspec.server.html">Server Specific Extensions</a></dd>
	<dd><a href="refs.basic.session.html">Session Extensions</a></dd>
	<dd><a href="refs.basic.text.html">Text Processing</a></dd>
	<dd><a href="refs.basic.vartype.html">Variable and Type Related Extensions</a></dd>
	<dd><a href="refs.webservice.html">Web Services</a></dd>
	<dd><a href="refs.utilspec.windows.html">Windows Only Extensions</a></dd>
	<dd><a href="refs.xml.html">XML Manipulation</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="row-fluid">
          
              
        <ul class="breadcrumbs-container">
            <li><a href="index-2.html">PHP Manual</a></li>      <li><a href="funcref.html">Function Reference</a></li>      <li><a href="refs.fileprocess.file.html">File System Related Extensions</a></li>      <li><a href="book.filesystem.html">Filesystem</a></li>      <li><a href="ref.filesystem.html">Filesystem Functions</a></li>    </ul>
  </div>




<div id="layout">
  <section id="layout-content">
  <div id="function.flock" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">flock</h1>
  <p class="verinfo">(PHP 4, PHP 5)</p><p class="refpurpose"><span class="refname">flock</span> â€” <span class="dc-title">Portable advisory file locking</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.flock-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>flock</strong></span>
    ( <span class="methodparam"><span class="type">resource</span> <code class="parameter">$handle</code></span>
   , <span class="methodparam"><span class="type">int</span> <code class="parameter">$operation</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter reference">&amp;$wouldblock</code></span>
  ] )</div>

  <p class="para rdfs-comment">
   <span class="function"><strong>flock()</strong></span> allows you to perform a simple reader/writer
   model which can be used on virtually every platform (including most Unix
   derivatives and even Windows).
  </p>
  <p class="para">
   On versions of PHP before 5.3.2, the lock is released also by
   <span class="function"><a href="function.fclose.html" class="function">fclose()</a></span> (which is also called automatically when script
   finished).
  </p>
  <p class="para">
   PHP supports a portable way of locking complete files in an advisory way
   (which means all accessing programs have to use the same way of locking
   or it will not work). By default, this function will block until the
   requested lock is acquired; this may be controlled (on non-Windows
   platforms) with the <strong><code>LOCK_NB</code></strong> option documented below.
  </p>
 </div>

 
 <div class="refsect1 parameters" id="refsect1-function.flock-parameters">
  <h3 class="title">Parameters</h3>
  <p class="para">
   </p><dl>

    
     <dt>
<code class="parameter">handle</code></dt>

     <dd>

      <p class="para">A file system pointer <span class="type"><a href="language.types.resource.html" class="type resource">resource</a></span>
that is typically created using <span class="function"><a href="function.fopen.html" class="function">fopen()</a></span>.</p>
     </dd>

    
    
     <dt>
<code class="parameter">operation</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">operation</code> is one of the following:
       </p><ul class="itemizedlist">
        <li class="listitem">
         <span class="simpara">
          <strong><code>LOCK_SH</code></strong> to acquire a shared lock (reader).
         </span>
        </li>
        <li class="listitem">
         <span class="simpara">
          <strong><code>LOCK_EX</code></strong> to acquire an exclusive lock (writer).
         </span>
        </li>
        <li class="listitem">
         <span class="simpara">
          <strong><code>LOCK_UN</code></strong> to release a lock (shared or exclusive).
         </span>
        </li>
       </ul>
      <p></p>
      <p class="para">
       It is also possible to add <strong><code>LOCK_NB</code></strong> as a bitmask to one 
       of the above operations if you don't want <span class="function"><strong>flock()</strong></span> to 
       block while locking. (not supported on Windows)
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">wouldblock</code></dt>

     <dd>

      <p class="para">
       The optional third argument is set to 1 if the lock would block
       (EWOULDBLOCK errno condition). (not supported on Windows)
      </p>
     </dd>

    
   </dl>

  <p></p>
 </div>

 
 <div class="refsect1 returnvalues" id="refsect1-function.flock-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   Returns <strong><code>TRUE</code></strong> on success or <strong><code>FALSE</code></strong> on failure.
  </p>
 </div>

 
 <div class="refsect1 changelog" id="refsect1-function.flock-changelog">
  <h3 class="title">Changelog</h3>
  <p class="para">
   </p><table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>Version</th>
       <th>Description</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>5.3.2</td>
       <td>
        The automatic unlocking when the file's resource handle is closed was
        removed. Unlocking now always has to be done manually.
       </td>
      </tr>

     </tbody>
    
   </table>

  <p></p>
 </div>

 
 <div class="refsect1 examples" id="refsect1-function.flock-examples">
  <h3 class="title">Examples</h3>
  <p class="para">
   </p><div class="example" id="example-2476">
    <p><strong>Example #1 <span class="function"><strong>flock()</strong></span> example</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br><br>$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"/tmp/lock.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"r+"</span><span style="color: #007700">);<br><br>if&nbsp;(</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">LOCK_EX</span><span style="color: #007700">))&nbsp;{&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;acquire&nbsp;an&nbsp;exclusive&nbsp;lock<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">ftruncate</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;truncate&nbsp;file<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"Write&nbsp;something&nbsp;here\n"</span><span style="color: #007700">);<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fflush</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;flush&nbsp;output&nbsp;before&nbsp;releasing&nbsp;the&nbsp;lock<br>&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">LOCK_UN</span><span style="color: #007700">);&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;release&nbsp;the&nbsp;lock<br></span><span style="color: #007700">}&nbsp;else&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Couldn't&nbsp;get&nbsp;the&nbsp;lock!"</span><span style="color: #007700">;<br>}<br><br></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br><br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  <p></p>
  <p class="para">
   </p><div class="example" id="example-2477">
    <p><strong>Example #2 <span class="function"><strong>flock()</strong></span> using the <strong><code>LOCK_NB</code></strong> option</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br>$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">'/tmp/lock.txt'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'r+'</span><span style="color: #007700">);<br><br></span><span style="color: #FF8000">/*&nbsp;Activate&nbsp;the&nbsp;LOCK_NB&nbsp;option&nbsp;on&nbsp;an&nbsp;LOCK_EX&nbsp;operation&nbsp;*/<br></span><span style="color: #007700">if(!</span><span style="color: #0000BB">flock</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">LOCK_EX&nbsp;</span><span style="color: #007700">|&nbsp;</span><span style="color: #0000BB">LOCK_NB</span><span style="color: #007700">))&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">'Unable&nbsp;to&nbsp;obtain&nbsp;lock'</span><span style="color: #007700">;<br>&nbsp;&nbsp;&nbsp;&nbsp;exit(-</span><span style="color: #0000BB">1</span><span style="color: #007700">);<br>}<br><br></span><span style="color: #FF8000">/*&nbsp;...&nbsp;*/<br><br></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  <p></p>
 </div>

 
 <div class="refsect1 notes" id="refsect1-function.flock-notes">
  <h3 class="title">Notes</h3>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   </p><p class="para">
    <span class="function"><strong>flock()</strong></span> uses mandatory locking instead of advisory
    locking on Windows. Mandatory locking is also supported on Linux and
    System V based operating systems via the usual mechanism supported by the
    fcntl() system call: that is, if the file in question has the setgid
    permission bit set and the group execution bit cleared. On Linux, the file
    system will also need to be mounted with the mand option for this to work.
   </p>
  <p></p></blockquote>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   </p><p class="para">
    Because <span class="function"><strong>flock()</strong></span> requires a file pointer, you may have
    to use a special lock file to protect access to a file that you intend
    to truncate by opening it in write mode (with a "w" or "w+" argument to
    <span class="function"><a href="function.fopen.html" class="function">fopen()</a></span>).
   </p>
  <p></p></blockquote>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   </p><p class="para">
    May only be used on file pointers returned by <span class="function"><a href="function.fopen.html" class="function">fopen()</a></span>
    for local files, or file pointers pointing to userspace streams that
    implement the <span class="function"><a href="streamwrapper.stream-lock.html" class="function">streamWrapper::stream_lock()</a></span> method.
   </p>
  <p></p></blockquote>
  <div class="warning"><strong class="warning">Warning</strong>
   <p class="para">
    Assigning another value to <code class="parameter">handle</code> argument in
    subsequent code will release the lock.
   </p>
  </div>
  <div class="warning"><strong class="warning">Warning</strong>
   <p class="para">
    On some operating systems <span class="function"><strong>flock()</strong></span> is implemented at
    the process level. When using a multithreaded server API like ISAPI you
    may not be able to rely on <span class="function"><strong>flock()</strong></span> to protect files
    against other PHP scripts running in parallel threads of the same server
    instance!
   </p>
   <p class="para">
    <span class="function"><strong>flock()</strong></span> is not supported on antiquated filesystems like
    <em>FAT</em> and its derivates and will therefore always
    return <strong><code>FALSE</code></strong> under this environments (this is especially true for
    Windows 98 users).
   </p>
  </div>
 </div>

 
</div>
<section id="usernotes">
 <div class="head"><h3 class="title">User Contributed Notes</h3></div><div id="allnotes">
  <div class="note" id="78318">  
  <a class="name">
  <strong class="user"><em>Antti Haapala</em></strong></a><div class="date" title="2007-10-06 03:41"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom78318">
<div class="phpcode"><code><span class="html">
The supplied documentation is vague, ambiguous and lacking, and the user comments contain erroneous information! The flock function follows the semantics of the Unix system call bearing the same name. Flock utilizes ADVISORY locking only; that is, other processes may ignore the lock completely; it only affects those that call the flock call.<br><br>LOCK_SH means SHARED LOCK. Any number of processes MAY HAVE A SHARED LOCK simultaneously. It is commonly called a reader lock.<br><br>LOCK_EX means EXCLUSIVE LOCK. Only a single process may possess an exclusive lock to a given file at a time.<br><br>If the file has been LOCKED with LOCK_SH in another process, flock with LOCK_SH will SUCCEED. flock with LOCK_EX will BLOCK UNTIL ALL READER LOCKS HAVE BEEN RELEASED.<br><br>If the file has been locked with LOCK_EX in another process, the CALL WILL BLOCK UNTIL ALL OTHER LOCKS have been released.<br><br>If however, you call flock on a file on which you possess the lock, it will try to change it. So: flock(LOCK_EX) followed by flock(LOCK_SH) will get you a SHARED lock, not "read-write" lock.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="100864">  
  <a class="name">
  <strong class="user"><em>webmaster at bitpush dot com</em></strong></a><div class="date" title="2010-11-11 08:31"><strong>3 years ago</strong></div>
  <div class="text" id="Hcom100864">
<div class="phpcode"><code><span class="html">
Regarding the change in PHP 5.3.2 with locked files:<br><br>Without having studied the PHP source code in detail, the situation appears to be as follows when the PHP function fclose() is called:<br><br>Before 5.3.2 PHP would check if the file was locked, then release the lock, and then close the file.<br><br>From 5.3.2 PHP just closes the file.<br><br>But note, that the operating system releases the lock automatically when the file is closed. Therefore a call to fclose() STILL releases the lock (this is tested with PHP 5.3.2, Linux, x64).</span>
</code></div>
  </div>
 </div>
  <div class="note" id="111984">  
  <a class="name">
  <strong class="user"><em>metamarkers at gmail dot com</em></strong></a><div class="date" title="2013-04-19 12:13"><strong>1 year ago</strong></div>
  <div class="text" id="Hcom111984">
<div class="phpcode"><code><span class="html">
you can wrap a lock as an object to make it a scope-based lock. when the lock object is no longer referenced, like when it's unset or the owner returns, the destructor will call unlock.<br><br>this way you can just create a lock object and forget about it.<br><br><span class="default">&lt;?php<br></span><span class="keyword">class </span><span class="default">lock </span><span class="keyword">{<br><br>&nbsp; &nbsp; private </span><span class="default">$handle</span><span class="keyword">;<br><br>&nbsp; &nbsp; public static function </span><span class="default">read </span><span class="keyword">( </span><span class="default">$handle </span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$lock </span><span class="keyword">= new static();<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$lock</span><span class="keyword">-&gt;</span><span class="default">handle </span><span class="keyword">= </span><span class="default">$handle</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_SH</span><span class="keyword">) ? </span><span class="default">$lock </span><span class="keyword">: </span><span class="default">false</span><span class="keyword">;<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; public static function </span><span class="default">write </span><span class="keyword">( </span><span class="default">$handle </span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$lock </span><span class="keyword">= new static();<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$lock</span><span class="keyword">-&gt;</span><span class="default">handle </span><span class="keyword">= </span><span class="default">$handle</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">) ? </span><span class="default">$lock </span><span class="keyword">: </span><span class="default">false</span><span class="keyword">;<br>&nbsp; &nbsp; }<br><br>&nbsp; &nbsp; public function </span><span class="default">__destruct </span><span class="keyword">( ) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">handle</span><span class="keyword">,</span><span class="default">LOCK_UN</span><span class="keyword">);<br>&nbsp; &nbsp; }<br><br>}<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="82521">  
  <a class="name">
  <strong class="user"><em>John dot wellesz at teaser dot fr</em></strong></a><div class="date" title="2008-04-14 05:59"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom82521">
<div class="phpcode"><code><span class="html">
I just want to add a note about making atomic lock on NFS, there is only two<br>ways:<br><br>- 1 (the most robust but the most complicate) - It's to use link() to create a<br>&nbsp; hard link to a file you want to lock (on the same FS of course).<br>&nbsp; (On most NFS implementations, Link() is atomic)<br><br>Once you created a hard link (not a symbolic link), with a unique randomly<br>generated name, call stat() on it and count the number of link (nlink), if there<br>is only 2 then the file is locked.<br><br>If there is more than two you have to unlink() the link you just created and<br>create a new one with a new unique name (else NFS will use its cache and stat<br>will return wrong data) then call stat() on the new link and test the number of<br>links again, repeat this operation until you get the lock.<br><br>You have to use usleep() between the link() attempts with a fixed + random<br>sleep value to avoid dead lock situations (link() and unlink() may be atomic<br>but not instantaneous)<br><br>Also note than when you unlink a file through NFS, if NFS think that the file<br>is still in use, it will create a .nfs link to this file until it realizes the<br>file is no longer in use... A wrong timing could generate thousands of those<br>files and a deadlock situation.&nbsp; Because of this when a deadlock situation<br>occurs or if your stat() command returns a very high number of links, you have<br>to look for .nfs file in the same directory you created your links and unlink<br>all the .nfs file you find (sometimes NFS take its time to remove them)<br><br>- 2 (the simplest) - the second method is to use a lock server and lock daemons<br>&nbsp; on each client that will forward lock request to the server... (this is more<br>dangerous than the first method because the daemons may be killed...)<br><br>Here is for reference the function I created to make atomic locks through NFS<br>(this function is in production since at least 4 years now), it's just for<br>reference because it uses many external functions to do its job but you can see<br>the principle:<br><br><a rel="nofollow" target="_blank">http://pastey.net/85793</a></span>
</code></div>
  </div>
 </div>
  <div class="note" id="109237">  
  <a class="name">
  <strong class="user"><em>mdessaintes at gmail dot com</em></strong></a><div class="date" title="2012-06-28 04:30"><strong>2 years ago</strong></div>
  <div class="text" id="Hcom109237">
<div class="phpcode"><code><span class="html">
I just spent some time (again) to understand why a reading with file_get_contents() and file was returning me an empty string "" or array() whereas the file was existing and the contents not empty.
<br>
<br>In fact, i was locking file when writing it (file_put_contents third arg) but not testing if file was locked when reading it (and the file was accessed a lot).
<br>
<br>So, please pay attention that file_get_contents(), file() and maybe others php files functions are going to return empty data like if the contents of the file was an empty string.
<br>
<br>To avoid this problem, you have to set a LOCK_SH on your file before reading it (and then waiting if locked).
<br>
<br>Something like this :
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">public static function </span><span class="default">getContents</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$waitIfLocked </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">) {
<br>&nbsp; &nbsp; if(!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">)) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'File "'</span><span class="keyword">.</span><span class="default">$path</span><span class="keyword">.</span><span class="string">'" does not exists'</span><span class="keyword">);
<br>&nbsp; &nbsp; }
<br>&nbsp; &nbsp; else {
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$fo </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$locked </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_SH</span><span class="keyword">, </span><span class="default">$waitIfLocked</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; if(!</span><span class="default">$locked</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">false</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; else {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$cts </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">$cts</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; }
<br>}
<br></span><span class="default">?&gt;
<br></span>
<br>Code to test by yourself :
<br>
<br>abc.txt :
<br>someText
<br>
<br>file.php :
<br><span class="default">&lt;?php
<br>$fo </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'abc.txt'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);
<br>
<br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);
<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">);
<br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);
<br></span><span class="default">?&gt;
<br></span>
<br>file2.php : 
<br><span class="default">&lt;?php
<br>var_dump</span><span class="keyword">(</span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">'abc.txt'</span><span class="keyword">));
<br></span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">file</span><span class="keyword">(</span><span class="string">'abc.txt'</span><span class="keyword">));
<br></span><span class="default">?&gt;
<br></span>
<br>Then launch file.php and switch to file2.php during the 10 seconds and see the difference before/after</span>
</code></div>
  </div>
 </div>
  <div class="note" id="101701">  
  <a class="name">
  <strong class="user"><em>Evan Battaglia</em></strong></a><div class="date" title="2011-01-05 05:13"><strong>3 years ago</strong></div>
  <div class="text" id="Hcom101701">
<div class="phpcode"><code><span class="html">
LOCK_NB seems to be checked and works fine in Windows, too, in PHP 5.3.3.
<br>
<br>For instance, try concurrently running two instances of the following script (via the CLI). The second prints "Didn't quite get the lock..." as expected, whereas w/o the LOCK_NB flag, it just hangs.
<br>
<br><span class="default">&lt;?php
<br>$x </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"flocktest.txt"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);
<br>if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">)) {
<br>&nbsp; &nbsp; print </span><span class="string">"No problems, I got the lock, now I'm going to sit on it."</span><span class="keyword">;
<br>&nbsp; &nbsp; while (</span><span class="default">true</span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">5</span><span class="keyword">);
<br>} else {
<br>&nbsp; &nbsp; print </span><span class="string">"Didn't quite get the lock. Quitting now. Good night."</span><span class="keyword">;
<br>}
<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">);
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="84824">  
  <a class="name">
  <strong class="user"><em>tinymountain at nospam dot gmail dot com</em></strong></a><div class="date" title="2008-07-31 01:36"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom84824">
<div class="phpcode"><code><span class="html">
Here's a handy class to allow retrying a write with flock a set number of times. If it can't flock, it will sleep for a brief random interval and try again. If you have a lot of concurrent writes going on, you can use it to avoid data corruption.
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">class </span><span class="default">SafeWriter
<br></span><span class="keyword">{
<br>&nbsp; &nbsp; </span><span class="comment">// suggested mode 'a' for writing to the end of the file
<br>&nbsp; &nbsp; </span><span class="keyword">public static function </span><span class="default">writeData</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">)
<br>&nbsp; &nbsp; {
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">, </span><span class="default">$mode</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$retries </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$max_retries </span><span class="keyword">= </span><span class="default">100</span><span class="keyword">;
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; if (!</span><span class="default">$fp</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// failure
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">return </span><span class="default">false</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// keep trying to get a lock as long as possible
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">do {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">$retries </span><span class="keyword">&gt; </span><span class="default">0</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">, </span><span class="default">10000</span><span class="keyword">));
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$retries </span><span class="keyword">+= </span><span class="default">1</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; } while (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">) and </span><span class="default">$retries </span><span class="keyword">&lt;= </span><span class="default">$max_retries</span><span class="keyword">);
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// couldn't get the lock, give up
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if (</span><span class="default">$retries </span><span class="keyword">== </span><span class="default">$max_retries</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// failure
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">return </span><span class="default">false</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// got the lock, write the data
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"</span><span class="default">$data</span><span class="string">\n"</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// release the lock
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// success
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">return </span><span class="default">true</span><span class="keyword">;
<br>&nbsp; &nbsp; }
<br>}
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="32443">  
  <a class="name">
  <strong class="user"><em>joel[at_sign]purerave.com</em></strong></a><div class="date" title="2003-05-27 06:12"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom32443">
<div class="phpcode"><code><span class="html">
I have found that if you open a currently locked file with 'w' or 'w+' ("file pointer at the beginning of the file and truncate the file to zero length")&nbsp; then it will not truncate the file when the lock is released and the file available.
<br>
<br>Example I used to test it:
<br><span class="default">&lt;?php
<br></span><span class="comment">// a.php
<br></span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"w+" </span><span class="keyword">);
<br></span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">); </span><span class="comment">// exclusive lock
<br>
<br></span><span class="default">$steps </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;
<br></span><span class="comment">// write to the file
<br></span><span class="keyword">for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt; </span><span class="default">$steps</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {
<br>&nbsp; &nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'a '</span><span class="keyword">.</span><span class="default">time</span><span class="keyword">().</span><span class="string">' test '</span><span class="keyword">. </span><span class="default">$i</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);
<br>&nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);
<br>}
<br></span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN </span><span class="keyword">); </span><span class="comment">// release the lock
<br></span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);
<br></span><span class="default">?&gt;
<br></span>
<br>----------
<br><span class="default">&lt;?php
<br></span><span class="comment">// b.php
<br>
<br></span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"w+" </span><span class="keyword">);
<br></span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">); </span><span class="comment">// exclusive lock
<br>
<br>// ftruncate($fp, 0) is needed here! &lt;----
<br>
<br></span><span class="default">$steps </span><span class="keyword">= </span><span class="default">5</span><span class="keyword">;
<br></span><span class="comment">// write to the file
<br></span><span class="keyword">for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt; </span><span class="default">$steps</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {
<br>&nbsp; &nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'b '</span><span class="keyword">.</span><span class="default">time</span><span class="keyword">().</span><span class="string">' test '</span><span class="keyword">. </span><span class="default">$i</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);
<br>&nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);
<br>}
<br></span><span class="default">flock</span><span class="keyword">( </span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN </span><span class="keyword">); </span><span class="comment">// release the lock
<br></span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);
<br></span><span class="default">?&gt;
<br></span>
<br>Loading a.php then loading b.php right after will result in:
<br>b 1054075769 test 0
<br>b 1054075770 test 1
<br>b 1054075771 test 2
<br>b 1054075772 test 3
<br>b 1054075773 test 4
<br>a 1054075764 test 5
<br>a 1054075765 test 6
<br>a 1054075766 test 7
<br>a 1054075767 test 8
<br>a 1054075768 test 9
<br>
<br>As you can see, b.php does not truncate the file as the w+ would suggest if the file were instantly available. But only moves the pointer to the begining of the file. If b.php was loaded after a.php finished then there would be no "a ..." lines in the file, since it would be truncated.
<br>
<br>To fix this you have to add ftruncate($fp, 0) right after the flock.
<br>
<br>'r+' and 'a' seem to work fine, though.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="115558">  
  <a class="name">
  <strong class="user"><em>sinus-php at sinpi dot net</em></strong></a><div class="date" title="2014-08-15 02:01"><strong>13 days ago</strong></div>
  <div class="text" id="Hcom115558">
<div class="phpcode"><code><span class="html">
"Assigning another value to handle argument in subsequent code will release the lock."<br>Note: this is also true for losing the handle's context completely (like returning from a function, in which the handle was a local variable).<br><br><span class="default">&lt;?php<br>touch</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">);<br><br>function </span><span class="default">mylock</span><span class="keyword">() {<br>&nbsp; </span><span class="default">$F1 </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br>&nbsp; if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$F1</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">)) echo </span><span class="string">"First lock OK\n"</span><span class="keyword">; else echo </span><span class="string">"First lock FAIL\n"</span><span class="keyword">;<br>&nbsp; </span><span class="default">$F2 </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br>&nbsp; if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$F2</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">)) echo </span><span class="string">"Second lock OK\n"</span><span class="keyword">; else echo </span><span class="string">"Second lock FAIL\n"</span><span class="keyword">;<br>}<br><br></span><span class="default">mylock</span><span class="keyword">();<br>echo </span><span class="string">"Function returned.\n"</span><span class="keyword">;<br></span><span class="default">mylock</span><span class="keyword">();<br><br></span><span class="default">unlink</span><span class="keyword">(</span><span class="string">"testfile"</span><span class="keyword">);<br></span><span class="default">?&gt;<br></span><br>Prints out:<br><br>First lock OK<br>Second lock FAIL<br>Function returned.<br>First lock OK<br>Second lock FAIL<br><br>This will lock the testfile, then attempt to lock it again with a new file handle (obviously failing). Trying this again, though, results in proper locking again (and then failing again), because when exiting the function both handles are lost and automatically unlocked.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="114036">  
  <a class="name">
  <strong class="user"><em>enyby at yandex dot ru</em></strong></a><div class="date" title="2014-01-04 08:36"><strong>7 months ago</strong></div>
  <div class="text" id="Hcom114036">
<div class="phpcode"><code><span class="html">
Use rename or unlink on handled file breaked LOCK_EX flock on handle (Linux only).<br><br>Example:<br><br>$handle = fopen($lockFile, 'c');<br>var_dump(flock($handle, LOCK_EX | LOCK_NB)); // false because flock use other php process<br>rename($lockFile, $lockFile.'.old'); // or unlink<br>var_dump(flock($handle, LOCK_EX | LOCK_NB)); // always true (!!!)</span>
</code></div>
  </div>
 </div>
  <div class="note" id="111443">  
  <a class="name">
  <strong class="user"><em>steven at aubergine-it dot nl</em></strong></a><div class="date" title="2013-02-20 03:14"><strong>1 year ago</strong></div>
  <div class="text" id="Hcom111443">
<div class="phpcode"><code><span class="html">
You cannot combine gzopen with flock; so:<br><br><span class="default">&lt;?php<br>$f </span><span class="keyword">= </span><span class="default">gzopen</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">,</span><span class="string">'w'</span><span class="keyword">);<br></span><span class="default">$o </span><span class="keyword">= </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$f</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">);<br></span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$o</span><span class="keyword">);<br></span><span class="default">flush</span><span class="keyword">();<br></span><span class="default">?&gt;<br></span><br>Gives:<br><br>boolean false</span>
</code></div>
  </div>
 </div>
  <div class="note" id="107939">  
  <a class="name">
  <strong class="user"><em>ondrej dot nemecek at gmail dot com</em></strong></a><div class="date" title="2012-03-15 03:15"><strong>2 years ago</strong></div>
  <div class="text" id="Hcom107939">
<div class="phpcode"><code><span class="html">
Notice: On NFS with NFS locking daemon you cannot open file for reading and than lock exklusively:<br><br>$rFopened&nbsp; = fopen($sFile,'r');<br>$bResult&nbsp;&nbsp; = flock($rFopened, LOCK_EX);<br><br>var_dump($bResult); // returns FALSE<br><br>Mixed fopen modes (a+, w+ ...) works with LOCK_EX fine.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="105879">  
  <a class="name">
  <strong class="user"><em>mdessaintes at gmail dot com</em></strong></a><div class="date" title="2011-09-22 08:44"><strong>2 years ago</strong></div>
  <div class="text" id="Hcom105879">
<div class="phpcode"><code><span class="html">
I just spend a long time to understand why write function returns me "0", on a basic file opening and then writing.
<br>
<br>I discovered that if you use LOCK_SH and then you write something, that will not work :
<br>
<br><span class="default">&lt;?php
<br>$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.txt'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">);
<br>
<br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">LOCK_SH</span><span class="keyword">);
<br>
<br></span><span class="default">$written </span><span class="keyword">= </span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'data'</span><span class="keyword">);
<br>
<br></span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$written</span><span class="keyword">); </span><span class="comment">// 0 and file is not changed
<br>
<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="101226">  
  <a class="name">
  <strong class="user"><em>holdoffhunger at gmail dot com</em></strong></a><div class="date" title="2010-12-03 07:53"><strong>3 years ago</strong></div>
  <div class="text" id="Hcom101226">
<div class="phpcode"><code><span class="html">
I've been having trouble getting Flock to work when I read a file, delete it, and then output slightly changed information back to the same location.&nbsp; When deleting with Unlink, there's a very brief period of time where no file exists.&nbsp; But, if you do an fopen using the "w" mode, it keeps the file in existence, but deletes all of its data when you go to write to it.&nbsp; That way, the file never actually disappears, and another script accessing the same file with flock won't get a "file doesn't exist" error.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="95257">  
  <a class="name">
  <strong class="user"><em>dejangex at yahoo dot com</em></strong></a><div class="date" title="2009-12-21 01:47"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom95257">
<div class="phpcode"><code><span class="html">
Actually, there is no use of the while loop with the usleep. My testing has revealed the following:<br><br><span class="default">&lt;?php<br></span><span class="comment">//some code here<br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">) </span><span class="comment">// &lt;- Your code will pause here untill you get the lock for indefinite amount of time or till your script times out<br>//some code here<br></span><span class="default">?&gt;<br></span><br>This will actually check for the lock without pausing and then it will sleep:<br><br><span class="default">&lt;?php<br></span><span class="comment">//code here<br></span><span class="keyword">while (!</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX </span><span class="keyword">| </span><span class="default">LOCK_NB</span><span class="keyword">)) {<br> </span><span class="comment">//Lock not acquired, try again in:<br> </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">100</span><span class="keyword">)*</span><span class="default">1000</span><span class="keyword">)) </span><span class="comment">//0-100 miliseconds<br></span><span class="keyword">}<br></span><span class="comment">//lock acquired<br>//rest of the code<br></span><span class="default">?&gt;<br></span><br>The problem is, if you have a busy site and a lots of locking, the while loop may not acquire the lock for some time. Locking without LOCK_NB is much more persistent and it will wait for the lock for as long as it takes. It is almose guaranteed that the file will be locked, unless the script times out or something.<br><br>Consider these two scripts: 1st one is ran, and the second one is ran 5 seconds after the first.<br><br><span class="default">&lt;?php<br></span><span class="comment">//1st script<br></span><span class="default">$file_handle </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.test'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);<br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">); </span><span class="comment">//lock the file<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">); </span><span class="comment">//sleep 10 seconds<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">); </span><span class="comment">//close and unlock the file<br></span><span class="default">?&gt;<br></span><br><span class="default">&lt;?php<br></span><span class="comment">//2nd script<br></span><span class="default">$file_handle </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file.test'</span><span class="keyword">, </span><span class="string">'r+'</span><span class="keyword">);<br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">); </span><span class="comment">//lock the file<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$file_handle</span><span class="keyword">); </span><span class="comment">//close and unlock the file<br></span><span class="default">?&gt;<br></span><br>If you run 1st and then the 2nd script,the 2nd script will wait untill the 1st has finished. As soon as the first script finishes, the second one will acquire the lock and finish the execution. If you use flock($file_handle, LOCK_EX | LOCK_NB) in the 2nd script while the 1st script is running, it would finish execution immediately and you would not get the lock.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="93400">  
  <a class="name">
  <strong class="user"><em>daniel AT brightbyte DOT de</em></strong></a><div class="date" title="2009-09-08 12:49"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom93400">
<div class="phpcode"><code><span class="html">
flock on Solaris is slightly strange: it will fail if you try to get an exclusive lock on a file not opened for writing. That is, for reading files, you MUST use a shared lock. From the Solaris man page for flock:<br><br>"Read permission is required on a file to obtain a shared lock, and write&nbsp; permission is required to obtain an exclusive lock."<br><br>In contrast, this is from the Linux man page for flock:<br><br>"The mode used to open the file doesnâ€™t matter to flock."<br><br>So, beware...</span>
</code></div>
  </div>
 </div>
  <div class="note" id="92731">  
  <a class="name">
  <strong class="user"><em>Kuzma dot Deretuke at gmail dot com</em></strong></a><div class="date" title="2009-08-06 04:31"><strong>5 years ago</strong></div>
  <div class="text" id="Hcom92731">
<div class="phpcode"><code><span class="html">
I use exclusive writing to replace standard flock():<br><br><span class="default">&lt;?php<br></span><span class="comment">// get/set lock file name<br></span><span class="keyword">function </span><span class="default">m_lock_file</span><span class="keyword">( </span><span class="default">$format </span><span class="keyword">= </span><span class="default">null </span><span class="keyword">) {<br>&nbsp; &nbsp; static </span><span class="default">$file_format </span><span class="keyword">= </span><span class="string">'./%s.lock'</span><span class="keyword">;<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; if (</span><span class="default">$format </span><span class="keyword">!== </span><span class="default">null</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$file_format </span><span class="keyword">= </span><span class="default">$format</span><span class="keyword">;<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; return </span><span class="default">$file_format</span><span class="keyword">;<br>}<br><br></span><span class="comment">// acquire/check/release lock<br></span><span class="keyword">function </span><span class="default">m_lock</span><span class="keyword">( </span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">$acquire </span><span class="keyword">= </span><span class="default">null </span><span class="keyword">) {<br>&nbsp; &nbsp; static </span><span class="default">$handlers </span><span class="keyword">= array();<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; if (</span><span class="default">is_bool</span><span class="keyword">(</span><span class="default">$acquire</span><span class="keyword">)) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$file </span><span class="keyword">= </span><span class="default">sprintf</span><span class="keyword">(</span><span class="default">m_lock_file</span><span class="keyword">(), </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">), </span><span class="default">$lockId</span><span class="keyword">);<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; if (</span><span class="default">$acquire </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; if (isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">])) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br>&nbsp; &nbsp; &nbsp; &nbsp; } else {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"Lock '</span><span class="default">$lockId</span><span class="string">' is already unlocked"</span><span class="keyword">, </span><span class="default">E_USER_WARNING</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; if (</span><span class="default">$acquire </span><span class="keyword">=== </span><span class="default">true</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; if (!isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">])) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$handler </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$count </span><span class="keyword">= </span><span class="default">100</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; do {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">) || @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">)) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$handler </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">, </span><span class="string">"x"</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$handler</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">10000</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">] = </span><span class="default">$handler</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } while (</span><span class="default">false </span><span class="keyword">=== </span><span class="default">$handler </span><span class="keyword">&amp;&amp; </span><span class="default">$count</span><span class="keyword">-- &gt; </span><span class="default">0</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; } else {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"Lock '</span><span class="default">$lockId</span><span class="string">' is already locked"</span><span class="keyword">, </span><span class="default">E_USER_WARNING</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; return isset(</span><span class="default">$handlers</span><span class="keyword">[</span><span class="default">$lockId</span><span class="keyword">]);<br>}<br></span><span class="default">?&gt;<br></span><br>Usage sample:<br><br><span class="default">&lt;?php<br>$lockId </span><span class="keyword">= </span><span class="string">"qq"</span><span class="keyword">;<br><br></span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br>if (</span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">)) {<br>&nbsp; &nbsp; echo </span><span class="string">"locked"</span><span class="keyword">;<br><br>&nbsp; &nbsp; </span><span class="comment">// here you can perform any thread-safe operations<br>&nbsp; &nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">300 </span><span class="keyword">* </span><span class="default">1000</span><span class="keyword">);<br><br>&nbsp; &nbsp; </span><span class="default">m_lock</span><span class="keyword">(</span><span class="default">$lockId</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br>} else {<br>&nbsp; &nbsp; echo </span><span class="string">"not locked"</span><span class="keyword">;<br>}<br><br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="88907">  
  <a class="name">
  <strong class="user"><em>Fernando Gabrieli fgabrieli at gmail</em></strong></a><div class="date" title="2009-02-12 11:06"><strong>5 years ago</strong></div>
  <div class="text" id="Hcom88907">
<div class="phpcode"><code><span class="html">
When writing to a file, you should avoid using w+ because it would erase the contents of the file before locking
<br>
<br>If you need to write the complete file again you could use the following instead:
<br>
<br><span class="default">&lt;?php
<br>$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'yourfile.txt'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">) ;
<br>
<br>if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {
<br>&nbsp; &nbsp; </span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">) ; </span><span class="comment">// &lt;-- this will erase the contents such as 'w+'
<br>&nbsp; &nbsp; 
<br>&nbsp; &nbsp; </span><span class="default">fputs</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'test string'</span><span class="keyword">) ;
<br>&nbsp; &nbsp; 
<br>&nbsp; &nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">) ;
<br>}
<br>
<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) ;
<br></span><span class="default">?&gt;
<br></span>
<br>Best,
<br>Fernando Gabrieli</span>
</code></div>
  </div>
 </div>
  <div class="note" id="80006">  
  <a class="name">
  <strong class="user"><em>admin ifyouwantblood de</em></strong></a><div class="date" title="2007-12-23 07:05"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom80006">
<div class="phpcode"><code><span class="html">
besides from what the manual says about locking a file opendend in w or w+ and using a special lock file for these cases, you should simply truncate the file yourself with ftruncate() after writing:<br><br><span class="default">&lt;?php<br><br>$data</span><span class="keyword">=</span><span class="string">'some data'</span><span class="keyword">;<br></span><span class="default">$handle</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'file'</span><span class="keyword">,</span><span class="string">'r+'</span><span class="keyword">);<br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">);<br></span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">$data</span><span class="keyword">);<br></span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">ftell</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">));<br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">,</span><span class="default">LOCK_UN</span><span class="keyword">);<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">);<br><br></span><span class="default">?&gt;<br></span><br>now the file will have the size of $data without opening the file in w mode but with a lock on the file.<br><br>to the previous writers jpriebe and mallory:<br>of course the lock is lost in this case, but thats simply because the file is closed by PHP. and closing the file means unlocking it (same as when you use fclose() yourself).</span>
</code></div>
  </div>
 </div>
  <div class="note" id="79913">  
  <a class="name">
  <strong class="user"><em>mallory dot dessaintes at gmail dot com</em></strong></a><div class="date" title="2007-12-19 07:56"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom79913">
<div class="phpcode"><code><span class="html">
I have noticed that if you change the value of your fopen ressource, the lock is working no longer..<br><br><span class="default">&lt;?php<br><br>$fo </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'lockfile.txt'</span><span class="keyword">,</span><span class="string">'a'</span><span class="keyword">);<br><br></span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fo</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">);<br><br></span><span class="default">$fo </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br><br></span><span class="comment">// Lock is disable<br><br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="79668">  
  <a class="name">
  <strong class="user"><em>candide at idees-et-solutions dot fr</em></strong></a><div class="date" title="2007-12-07 03:48"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom79668">
<div class="phpcode"><code><span class="html">
Just a comment about the last method to lock files using filemtime().<br>What if&nbsp;&nbsp; filemtime($fp[1]) == $fp[3]&nbsp;&nbsp; because somebody modified the file less than 1s after the value of $fp[3] was picked up?<br>Then this modification will be lost...? <br><br>This system to lock files is made to prevent problems when two modifications are so close that they can interfere, so the case "less than 1s" will often happen?<br><br>However, lose some modifications is better than spoil all the file...</span>
</code></div>
  </div>
 </div>
  <div class="note" id="78320">  
  <a class="name">
  <strong class="user"><em>Antti Haapala</em></strong></a><div class="date" title="2007-10-06 04:30"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom78320">
<div class="phpcode"><code><span class="html">
Further information on flock: The system is not restarted if a signal is delivered to the process, so flock will happily return false in case of SIGALRM, SIGFPE or something else.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="74155">  
  <a class="name">
  <strong class="user"><em>Will Reiher</em></strong></a><div class="date" title="2007-03-27 04:52"><strong>7 years ago</strong></div>
  <div class="text" id="Hcom74155">
<div class="phpcode"><code><span class="html">
I've been testing a few custom file access functions but I always liked the simplicity of file_get_contents(). Of course it doesn't seem to respect any file locks created with flock(). I created the function below to wrap around file_get_contents() so it can support locked files. It's an odd way of doing it but it works for me.
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">function </span><span class="default">flock_get_contents</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">){
<br>
<br>&nbsp; &nbsp; </span><span class="default">$return </span><span class="keyword">= </span><span class="default">FALSE</span><span class="keyword">;
<br>
<br>&nbsp; &nbsp; if(</span><span class="default">is_string</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">) &amp;&amp; !empty(</span><span class="default">$filename</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; if(</span><span class="default">is_readable</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(</span><span class="default">$handle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while(!</span><span class="default">$return</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LOCK_SH</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(</span><span class="default">$return </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$handle</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; }
<br>&nbsp; &nbsp; 
<br>&nbsp; &nbsp; return </span><span class="default">$return</span><span class="keyword">;
<br>}
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="68875">  
  <a class="name">
  <strong class="user"><em>jerry at gh33 dot org</em></strong></a><div class="date" title="2006-08-14 09:30"><strong>8 years ago</strong></div>
  <div class="text" id="Hcom68875">
<div class="phpcode"><code><span class="html">
Indeed, flock() will not work reliably when the underlying filesystem is NFS. The proper way to perform file locking, in this case, would be to use PHP's link() function. From the Linux man page of open():<br><br>&nbsp; &nbsp; &nbsp;&nbsp; O_EXCL When used with O_CREAT, if the file&nbsp; already&nbsp; exists&nbsp; it&nbsp; is&nbsp; an<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; error&nbsp; and&nbsp; the open will fail. In this context, a symbolic link<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exists, regardless of where its points to.&nbsp; O_EXCL is broken&nbsp; on<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; NFS file systems, programs which rely on it for performing lock-<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ing tasks will contain a race condition.&nbsp; The solution for&nbsp; per-<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; forming&nbsp; atomic&nbsp; file&nbsp; locking&nbsp; using&nbsp; a lockfile is to create a<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unique file on the same fs&nbsp; (e.g.,&nbsp; incorporating&nbsp; hostname&nbsp; and<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; pid),&nbsp; use&nbsp; link(2)&nbsp; to&nbsp; make&nbsp; a link to the lockfile. If link()<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; returns 0, the lock is successful.&nbsp; Otherwise,&nbsp; use&nbsp; stat(2)&nbsp; on<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; the&nbsp; unique&nbsp; file to check if its link count has increased to 2,<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; in which case the lock is also successful.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="61921">  
  <a class="name">
  <strong class="user"><em>marc dot vanwoerkom at fernuni-hagen dot de</em></strong></a><div class="date" title="2006-02-15 02:00"><strong>8 years ago</strong></div>
  <div class="text" id="Hcom61921">
<div class="phpcode"><code><span class="html">
I ran into a loop because I just checked for true (= you got the lock) as return value of flock() and tried again when I got a false.
<br>
<br><span class="default">&lt;?php
<br>&nbsp; &nbsp; </span><span class="keyword">function </span><span class="default">naive_wait_for_file</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; while (</span><span class="default">true</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$k </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">$k </span><span class="keyword">* </span><span class="default">10000</span><span class="keyword">));&nbsp; </span><span class="comment"># k * 10ms
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">}
<br>&nbsp; &nbsp; }
<br></span><span class="default">?&gt;
<br></span>
<br>Unfortunately in one case the $fp I put in was invalid, so I always got false and got stuck.
<br>Lesson: check if your $fp is valid before entering the loop, or look closer if you get a false.
<br>
<br><span class="default">&lt;?php
<br>&nbsp; &nbsp; </span><span class="keyword">function </span><span class="default">wait_for_file</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">$fp </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; while (</span><span class="default">true</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$k </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">20</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">round</span><span class="keyword">(</span><span class="default">$k </span><span class="keyword">* </span><span class="default">10000</span><span class="keyword">));&nbsp; </span><span class="comment"># k * 10ms
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">}
<br>&nbsp; &nbsp; }
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="55664">  
  <a class="name">
  <strong class="user"><em>damasta at onwebworx dot net</em></strong></a><div class="date" title="2005-08-09 08:28"><strong>9 years ago</strong></div>
  <div class="text" id="Hcom55664">
<div class="phpcode"><code><span class="html">
just wanted to say that you will most likely fail if you use a separate lock file together with register_shutdown_function.<br><br>my script did some different actions... resizing pictures, rotating them and this stuff. it needed a "database" file to get the correct file locations. this database file also stored some flags. and of course the script had to save that file when it was done.<br><br>because of my script exited on many different points depending on the action i used register_shutdown_function to save the file. it wanted to use a locking system to be sure the script doesn't overwrite the data another process had written into it some microseconds before. i was running on windows 2000 and apache2 on my developing machine, and flock always returned true for some reason... so i used a separate lock file. the script looked for it at the beginning and exited if it was found. otherwise it created it. but this file had to be deleted at the end. i put the unlink command into the registered shutdown-function but it never deleted the file. i tried clearstatcache and some other stuff but it didn't help.<br><br>maybe this helps someone.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="114928">  
  <a class="name">
  <strong class="user"><em>tom dot vom dot berg at online dot de</em></strong></a><div class="date" title="2014-04-28 06:46"><strong>3 months ago</strong></div>
  <div class="text" id="Hcom114928">
<div class="phpcode"><code><span class="html">
if you are used to reply with qualified error messages by using "track_errors = 1" and $php_errormsg,&nbsp; flock() will nark you, if you use LOCK_NB .<br><br>If flock() fails due to LOCK_NB $php_errormsg will not be created and filled with an error message like 'could not lock file, file already locked'.<br><br>You can use some little workaround which does also on WIN:<br><br>#---------------------------------<br>GLOBAL $MYERRORMSG;<br><br>function some_file_operations($filename)<br>{<br>&nbsp; &nbsp; GLOBAL $MYERRORMSG;<br><br>&nbsp; &nbsp; # ...<br>&nbsp; &nbsp; # ...<br><br>&nbsp; &nbsp; if (! @flock($fh, LOCK_SH | LOCK_NB, $wb))<br>&nbsp; &nbsp; &nbsp;&nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; if (!isset($php_errormsg)) $php_errormsg = 'could not lock file, file already locked';<br>&nbsp; &nbsp; &nbsp; &nbsp; $MYERRORMSG = $php_errormsg;<br>&nbsp; &nbsp; &nbsp; &nbsp; return false;<br>&nbsp; &nbsp; }&nbsp; &nbsp; <br>}<br>#--------------------------------<br><br>In case of fail $MYERRORMSG now will hold a qualified error message</span>
</code></div>
  </div>
 </div>
  <div class="note" id="45464">  
  <a class="name">
  <strong class="user"><em>rudy dot metzger at pareto dot nl</em></strong></a><div class="date" title="2004-09-08 03:31"><strong>9 years ago</strong></div>
  <div class="text" id="Hcom45464">
<div class="phpcode"><code><span class="html">
Like a user already noted, most Linux kernels (at least the Redhat ones) will return false, even if you locked the file. This is because the lock is only ADVISORY (you can check that in /proc/locks). What you have to do there is to evalute the 3rd parameter of flock(), $eWouldBlock. See for an example below. Note however that if you<br>lock the file in non blocking mode, flock() will work as expected (and blocks the script).<br><br><span class="default">&lt;?php<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">( </span><span class="string">"/var/lock/process.pid"</span><span class="keyword">, </span><span class="string">"a" </span><span class="keyword">);<br>if ( !</span><span class="default">$fp </span><span class="keyword">|| !</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">LOCK_EX</span><span class="keyword">|</span><span class="default">LOCK_NB</span><span class="keyword">,</span><span class="default">$eWouldBlock</span><span class="keyword">) || </span><span class="default">$eWouldBlock </span><span class="keyword">) {<br>&nbsp; </span><span class="default">fputs</span><span class="keyword">( </span><span class="default">STDERR</span><span class="keyword">, </span><span class="string">"Failed to acquire lock!\n" </span><span class="keyword">);<br>&nbsp; exit;<br>}<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br></span><span class="comment">// do your work here<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br></span><span class="default">fclose</span><span class="keyword">( </span><span class="default">$fp </span><span class="keyword">);<br></span><span class="default">unlink</span><span class="keyword">( </span><span class="string">"/var/lock/process.pid" </span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="43705">  
  <a class="name">
  <strong class="user"><em>Joby &lt;god at NOSPAMPLEASE dot greentinted dot net&gt;</em></strong></a><div class="date" title="2004-06-30 05:59"><strong>10 years ago</strong></div>
  <div class="text" id="Hcom43705">
<div class="phpcode"><code><span class="html">
I'm thinking that a good way to ensure that no data is lost would be to create a buffer directory that could store the instructions for what is to be written to a file, then whenever the file is decidedly unlocked, a single execution could loop through every file in that directory and apply the indicated changes to the file.<br><br>I'm working on writing this for a flat-file based database.&nbsp; The way it works is, whenever a command is issued (addline, removeline, editline), the command is stored in a flat file stored in a folder named a shortened version of the filename to be edited and named by the time and a random number.&nbsp; In that file is a standardized set of commands that define what is to be done to what file (the likes of "file: SecuraLog/index_uid" new line "editline: 14").<br><br>Each execution will check every folder in that directory for files and a certain amount of time (I don't know how long, maybe 1-2 seconds) is spent making pending changes to unlocked files.&nbsp; This way no changes will be lost (i.e. person 1 makes a change at the same time as person 2, and person 1 loses the race by just enough to have their changed version of the file overwritten by person 2's version) and there will be no problems with opening an empty open file.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="24100">  
  <a class="name">
  <strong class="user"><em>geoff at message dot hu</em></strong></a><div class="date" title="2002-08-06 01:10"><strong>12 years ago</strong></div>
  <div class="text" id="Hcom24100">
<div class="phpcode"><code><span class="html">
You should lock the file _before_ opening it, and unlock _after_ closing it. Othervise an another process might be able to access the file between the lock/unlock and the open/close operation.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="39466">  
  <a class="name">
  <strong class="user"><em>Glip</em></strong></a><div class="date" title="2004-01-29 10:39"><strong>10 years ago</strong></div>
  <div class="text" id="Hcom39466">
<div class="phpcode"><code><span class="html">
If you don't want use secondary lock file while truncating, try this:<br><br><span class="default">&lt;?php<br><br>$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/tmp/lock.txt"</span><span class="keyword">, </span><span class="string">"a+"</span><span class="keyword">);<br><br>if (</span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_EX</span><span class="keyword">)) { </span><span class="comment">// do an exclusive lock<br>&nbsp;&nbsp; </span><span class="default">ftruncate</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br>&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"Write something here\n"</span><span class="keyword">);<br>&nbsp;&nbsp; </span><span class="default">flock</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">LOCK_UN</span><span class="keyword">); </span><span class="comment">// release the lock<br></span><span class="keyword">} else {<br>&nbsp;&nbsp; echo </span><span class="string">"Couldn't lock the file !"</span><span class="keyword">;<br>}<br><br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br><br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="99931">  
  <a class="name">
  <strong class="user"><em>mirco dot babin at gmail dot com</em></strong></a><div class="date" title="2010-09-15 10:10"><strong>3 years ago</strong></div>
  <div class="text" id="Hcom99931">
<div class="phpcode"><code><span class="html">
Because:<br>1) flock() is not safe if multiple php sessions are simultaneously locking.<br>2) fopen( , 'a') is not safe if multiple php sessions are simultaneously appending.<br>3) usleep and sleep are known for having problems.<br><br>I wrote the Weblog function, it's purpose is to append a line to logging. This function handles the concurrency as follows:<br>- Try to create a lockfile named: $directory . date('Ymd') . $logfile . 1 . lock<br>- If this fails, try to create lockfile named: $directory . date('Ymd') . $logfile . 2 . lock<br>- etc. After 100 tries return false.<br><br>- When the lockfile is acquired the file named: $directory.date('Ymd').$logfile.1 (or .2 or .3 or .25) is opened or created.<br>- If created the a "extended log file" header is written.<br>- Write out the line.<br>- Close the flie and if created set the correct access rights. (I had some problems creating files on a webserver, I did not see them when I opened a FTP session to the webdirectory. The chmod did the trick for me).<br><br>- Remove the lockfile.<br><br>There is only one drawback, multiple logfiles are created.<br>e.g. (executed on 15 september 2010)<br>&nbsp; &nbsp; Weblog('./' , 'visit', 'Somebody requested the index page');<br>Could lead to 100 files, depending how many concurrent php sessions are simultaneously trying to append a logline:<br>./20100915visit.1<br>./20100915visit.2 <br>./20100915visit.3<br>./20100915visit.4<br>...<br>./20100915visit.100<br><br>This function is donated to the public domain. Maybe you can give me some credit by leaving in the author comment, but it is not required. You may modify this as you wish.<br>(This function was inspired by the function m_lock_file presented by Kuzma dot Deretuke at gmail dot com)<br><br><span class="default">&lt;?php<br></span><span class="keyword">function </span><span class="default">Weblog</span><span class="keyword">(</span><span class="default">$directory</span><span class="keyword">, </span><span class="default">$logfile</span><span class="keyword">, </span><span class="default">$message</span><span class="keyword">)<br>{<br>&nbsp; &nbsp; </span><span class="comment">// Created 15 september 2010: Mirco Babin<br>&nbsp; &nbsp; </span><span class="default">$curtime </span><span class="keyword">= </span><span class="default">time</span><span class="keyword">();<br>&nbsp; &nbsp; </span><span class="default">$logfile </span><span class="keyword">= </span><span class="default">date</span><span class="keyword">(</span><span class="string">'Ymd'</span><span class="keyword">,</span><span class="default">$curtime</span><span class="keyword">) . </span><span class="default">$logfile</span><span class="keyword">;<br><br>&nbsp; &nbsp; if (!isset(</span><span class="default">$directory</span><span class="keyword">) || </span><span class="default">$directory </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">)<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$directory </span><span class="keyword">= </span><span class="string">'./'</span><span class="keyword">;<br>&nbsp; &nbsp; if (</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$directory</span><span class="keyword">,-</span><span class="default">1</span><span class="keyword">) !== </span><span class="string">'/'</span><span class="keyword">)<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$directory </span><span class="keyword">= </span><span class="default">$directory </span><span class="keyword">. </span><span class="string">'/'</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; </span><span class="default">$count </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br>&nbsp; &nbsp; while(</span><span class="default">1</span><span class="keyword">)<br>&nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$logfilename </span><span class="keyword">= </span><span class="default">$directory </span><span class="keyword">. </span><span class="default">$logfile </span><span class="keyword">. </span><span class="string">'.' </span><span class="keyword">. </span><span class="default">$count</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$lockfile </span><span class="keyword">= </span><span class="default">$logfilename </span><span class="keyword">. </span><span class="string">'.lock'</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$lockhandle </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; if (!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">) || @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">)) <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$lockhandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">, </span><span class="string">'xb'</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">$lockhandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">) break;<br><br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$count</span><span class="keyword">++;<br>&nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">$count </span><span class="keyword">&gt; </span><span class="default">100</span><span class="keyword">) return </span><span class="default">false</span><span class="keyword">;<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; if (</span><span class="default">file_exists</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">))<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$created&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$loghandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">, </span><span class="string">'ab'</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; else<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$loghandle </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">, </span><span class="string">'xb'</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">$loghandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">)<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$created </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="string">'#version: 1.0' </span><span class="keyword">. </span><span class="string">"\r\n" </span><span class="keyword">.<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'#Fields: date time c-ip x-msg' </span><span class="keyword">. </span><span class="string">"\r\n"</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">,</span><span class="default">$str</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; if (</span><span class="default">$loghandle </span><span class="keyword">!== </span><span class="default">false</span><span class="keyword">)<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="default">date</span><span class="keyword">(</span><span class="string">'Y-m-d'</span><span class="keyword">,</span><span class="default">$curtime</span><span class="keyword">) . </span><span class="string">"\t" </span><span class="keyword">. <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">date</span><span class="keyword">(</span><span class="string">'H:i:s'</span><span class="keyword">, </span><span class="default">$curtime</span><span class="keyword">) .&nbsp; </span><span class="string">"\t" </span><span class="keyword">.<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; (isset(</span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">]) ? </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'REMOTE_ADDR'</span><span class="keyword">] : </span><span class="string">'-'</span><span class="keyword">) . </span><span class="string">"\t" </span><span class="keyword">.<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'"' </span><span class="keyword">. </span><span class="default">str_replace</span><span class="keyword">(</span><span class="string">'"'</span><span class="keyword">, </span><span class="string">'""'</span><span class="keyword">, </span><span class="default">$message</span><span class="keyword">) . </span><span class="string">'"' </span><span class="keyword">. </span><span class="string">"\r\n"</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">,</span><span class="default">$str</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$loghandle</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">$created</span><span class="keyword">) </span><span class="default">chmod</span><span class="keyword">(</span><span class="default">$logfilename</span><span class="keyword">,</span><span class="default">0644</span><span class="keyword">); </span><span class="comment">// Read and write for owner, read for everybody else<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; else<br>&nbsp; &nbsp; &nbsp; &nbsp; {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; <br>&nbsp; &nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$lockhandle</span><span class="keyword">);<br>&nbsp; &nbsp; @</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$lockfile</span><span class="keyword">);<br><br>&nbsp; &nbsp; return </span><span class="default">$result</span><span class="keyword">;<br>}<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div></div>

 
</section>    </section><!-- layout-content -->
        


  </div><!-- layout -->
         
  

    
 <!-- External and third party libraries. -->
 







<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top%402x.png"></a>



<!-- Mirrored from php.net/manual/en/function.flock.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 16:04:26 GMT -->


</body></html>