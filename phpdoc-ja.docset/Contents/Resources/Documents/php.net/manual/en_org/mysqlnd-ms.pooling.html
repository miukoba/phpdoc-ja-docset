<html><!-- Mirrored from php.net/manual/en/mysqlnd-ms.pooling.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 17:07:08 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

  <title>Connection pooling and switching</title>

 <link rel="shortcut icon" href="../../favicon.ico">
 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="mysqlnd-ms.pooling.html">
 <link rel="shorturl" href="mysqlnd-ms.pooling.html">
 <link rel="alternate" href="mysqlnd-ms.pooling.html" hreflang="x-default">

 <link rel="contents" href="index-2.html">
 <link rel="index" href="mysqlnd-ms.concepts.html">
 <link rel="prev" href="mysqlnd-ms.architecture.html">
 <link rel="next" href="mysqlnd-ms.transaction.html">

 <link rel="alternate" href="mysqlnd-ms.pooling.html" hreflang="en">
 <link rel="alternate" href="http://php.net/manual/pt_BR/mysqlnd-ms.pooling.php" hreflang="pt_BR">
 <link rel="alternate" href="http://php.net/manual/zh/mysqlnd-ms.pooling.php" hreflang="zh">
 <link rel="alternate" href="http://php.net/manual/fr/mysqlnd-ms.pooling.php" hreflang="fr">
 <link rel="alternate" href="http://php.net/manual/de/mysqlnd-ms.pooling.php" hreflang="de">
 <link rel="alternate" href="http://php.net/manual/it/mysqlnd-ms.pooling.php" hreflang="it">
 <link rel="alternate" href="http://php.net/manual/ja/mysqlnd-ms.pooling.php" hreflang="ja">
 <link rel="alternate" href="http://php.net/manual/ro/mysqlnd-ms.pooling.php" hreflang="ro">
 <link rel="alternate" href="http://php.net/manual/ru/mysqlnd-ms.pooling.php" hreflang="ru">
 <link rel="alternate" href="http://php.net/manual/es/mysqlnd-ms.pooling.php" hreflang="es">
 <link rel="alternate" href="http://php.net/manual/tr/mysqlnd-ms.pooling.php" hreflang="tr">

<link rel="stylesheet" type="text/css" href="../../cached8fe1.css?t=1401250819&amp;f=/fonts/Fira/fira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached4b8d.css?t=1404368420&amp;f=/fonts/Font-Awesome/css/fontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached5065.css?t=1403329232&amp;f=/styles/theme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cachedc78d.css?t=1401249623&amp;f=/styles/theme-medium.css" media="screen">

 <!--[if lte IE 7]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie7.css" media="screen">
 <![endif]-->

 <!--[if lte IE 8]>
 <script type="text/javascript">
  window.brokenIE = true;
 </script>
 <![endif]-->

 <!--[if lte IE 9]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie9.css" media="screen">
 <![endif]-->

 <!--[if IE]>
 <script type="text/javascript" src="http://php.net/js/ext/html5.js"></script>
 <![endif]-->

 <base>

</head>
<body class="docs " style="">


<div class="headsup"><a href="http://php.net/index.php#id2014-08-28-1">PHP 5.6.0 released</a></div>
<nav id="trick"><div><dl>
<dt><a href="getting-started.html">Getting Started</a></dt>
	<dd><a href="introduction.html">Introduction</a></dd>
	<dd><a href="tutorial.html">A simple tutorial</a></dd>
<dt><a href="langref.html">Language Reference</a></dt>
	<dd><a href="language.basic-syntax.html">Basic syntax</a></dd>
	<dd><a href="language.types.html">Types</a></dd>
	<dd><a href="language.variables.html">Variables</a></dd>
	<dd><a href="language.constants.html">Constants</a></dd>
	<dd><a href="language.expressions.html">Expressions</a></dd>
	<dd><a href="language.operators.html">Operators</a></dd>
	<dd><a href="language.control-structures.html">Control Structures</a></dd>
	<dd><a href="language.functions.html">Functions</a></dd>
	<dd><a href="language.oop5.html">Classes and Objects</a></dd>
	<dd><a href="language.namespaces.html">Namespaces</a></dd>
	<dd><a href="language.exceptions.html">Exceptions</a></dd>
	<dd><a href="language.generators.html">Generators</a></dd>
	<dd><a href="language.references.html">References Explained</a></dd>
	<dd><a href="reserved.variables.html">Predefined Variables</a></dd>
	<dd><a href="reserved.exceptions.html">Predefined Exceptions</a></dd>
	<dd><a href="reserved.interfaces.html">Predefined Interfaces and Classes</a></dd>
	<dd><a href="context.html">Context options and parameters</a></dd>
	<dd><a href="wrappers.html">Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href="security.html">Security</a></dt>
	<dd><a href="security.intro.html">Introduction</a></dd>
	<dd><a href="security.general.html">General considerations</a></dd>
	<dd><a href="security.cgi-bin.html">Installed as CGI binary</a></dd>
	<dd><a href="security.apache.html">Installed as an Apache module</a></dd>
	<dd><a href="security.filesystem.html">Filesystem Security</a></dd>
	<dd><a href="security.database.html">Database Security</a></dd>
	<dd><a href="security.errors.html">Error Reporting</a></dd>
	<dd><a href="security.globals.html">Using Register Globals</a></dd>
	<dd><a href="security.variables.html">User Submitted Data</a></dd>
	<dd><a href="security.magicquotes.html">Magic Quotes</a></dd>
	<dd><a href="security.hiding.html">Hiding PHP</a></dd>
	<dd><a href="security.current.html">Keeping Current</a></dd>
<dt><a href="features.html">Features</a></dt>
	<dd><a href="features.http-auth.html">HTTP authentication with PHP</a></dd>
	<dd><a href="features.cookies.html">Cookies</a></dd>
	<dd><a href="features.sessions.html">Sessions</a></dd>
	<dd><a href="features.xforms.html">Dealing with XForms</a></dd>
	<dd><a href="features.file-upload.html">Handling file uploads</a></dd>
	<dd><a href="features.remote-files.html">Using remote files</a></dd>
	<dd><a href="features.connection-handling.html">Connection handling</a></dd>
	<dd><a href="features.persistent-connections.html">Persistent Database Connections</a></dd>
	<dd><a href="features.safe-mode.html">Safe Mode</a></dd>
	<dd><a href="features.commandline.html">Command line usage</a></dd>
	<dd><a href="features.gc.html">Garbage Collection</a></dd>
	<dd><a href="features.dtrace.html">DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href="funcref.html">Function Reference</a></dt>
	<dd><a href="refs.basic.php.html">Affecting PHP's Behaviour</a></dd>
	<dd><a href="refs.utilspec.audio.html">Audio Formats Manipulation</a></dd>
	<dd><a href="refs.remote.auth.html">Authentication Services</a></dd>
	<dd><a href="refs.utilspec.cmdline.html">Command Line Specific Extensions</a></dd>
	<dd><a href="refs.compression.html">Compression and Archive Extensions</a></dd>
	<dd><a href="refs.creditcard.html">Credit Card Processing</a></dd>
	<dd><a href="refs.crypto.html">Cryptography Extensions</a></dd>
	<dd><a href="refs.database.html">Database Extensions</a></dd>
	<dd><a href="refs.calendar.html">Date and Time Related Extensions</a></dd>
	<dd><a href="refs.fileprocess.file.html">File System Related Extensions</a></dd>
	<dd><a href="refs.international.html">Human Language and Character Encoding Support</a></dd>
	<dd><a href="refs.utilspec.image.html">Image Processing and Generation</a></dd>
	<dd><a href="refs.remote.mail.html">Mail Related Extensions</a></dd>
	<dd><a href="refs.math.html">Mathematical Extensions</a></dd>
	<dd><a href="refs.utilspec.nontext.html">Non-Text MIME Output</a></dd>
	<dd><a href="refs.fileprocess.process.html">Process Control Extensions</a></dd>
	<dd><a href="refs.basic.other.html">Other Basic Extensions</a></dd>
	<dd><a href="refs.remote.other.html">Other Services</a></dd>
	<dd><a href="refs.search.html">Search Engine Extensions</a></dd>
	<dd><a href="refs.utilspec.server.html">Server Specific Extensions</a></dd>
	<dd><a href="refs.basic.session.html">Session Extensions</a></dd>
	<dd><a href="refs.basic.text.html">Text Processing</a></dd>
	<dd><a href="refs.basic.vartype.html">Variable and Type Related Extensions</a></dd>
	<dd><a href="refs.webservice.html">Web Services</a></dd>
	<dd><a href="refs.utilspec.windows.html">Windows Only Extensions</a></dd>
	<dd><a href="refs.xml.html">XML Manipulation</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="row-fluid">
          
              
        <ul class="breadcrumbs-container">
            <li><a href="index-2.html">PHP Manual</a></li>      <li><a href="funcref.html">Function Reference</a></li>      <li><a href="refs.database.html">Database Extensions</a></li>      <li><a href="refs.database.vendors.html">Vendor Specific Database Extensions</a></li>      <li><a href="set.mysqlinfo.html">MySQL</a></li>      <li><a href="book.mysqlnd-ms.html">mysqlnd_ms</a></li>      <li><a href="mysqlnd-ms.concepts.html">Concepts</a></li>    </ul>
  </div>




<div id="layout">
  <section id="layout-content">
  <div id="mysqlnd-ms.pooling" class="section">
  <h2 class="title">Connection pooling and switching</h2>
  <p class="para">
   The replication and load balancing plugin changes the semantics of a PHP
   MySQL connection handle. The existing API of the PHP MySQL extensions
   (<a href="ref.mysqli.html" class="link">mysqli</a>,
  <a href="ref.mysql.html" class="link">mysql</a>, and
  <a href="ref.pdo-mysql.html" class="link">PDO_MYSQL</a>) are not changed in
  a way that functions are added or removed. But their behaviour
  changes when using the plugin. Existing applications do not need to
  be adapted to a new API, but they may need to be modified because of
  the behaviour changes.
  </p>
  <p class="para">
   The plugin breaks the one-by-one relationship between a
   <a href="ref.mysqli.html" class="link">mysqli</a>,
   <a href="ref.mysql.html" class="link">mysql</a>, and
   <a href="ref.pdo-mysql.html" class="link">PDO_MYSQL</a> connection
   handle and a MySQL network connection. And a
   <a href="ref.mysqli.html" class="link">mysqli</a>,
   <a href="ref.mysql.html" class="link">mysql</a>, and
   <a href="ref.pdo-mysql.html" class="link">PDO_MYSQL</a> connection
   handle represents a local pool of connections to the configured
   MySQL replication master and MySQL replication slave servers.
   The plugin redirects queries to the master and slave servers.
   At some point in time one and the same PHP connection handle
   may point to the MySQL master server. Later on, it may point
   to one of the slave servers or still the master. Manipulating
   and replacing the network connection referenced by a PHP MySQL
   connection handle is not a transparent operation.
  </p>
  <p class="para">
   Every MySQL connection has a state. The state of the connections in
   the connection pool of the plugin can differ. Whenever the
   plugin switches from one wire connection to another, the current state of
   the user connection may change. The applications must be aware of this.
  </p>
  <p class="para">
   The following list shows what the connection state consists of. The list
   may not be complete.
  </p>
  <p class="para">
    </p><ul class="itemizedlist">
     <li class="listitem">
      <span class="simpara">
       Transaction status
      </span>
     </li>
     <li class="listitem">
      <span class="simpara">
       Temporary tables
      </span>
    </li>
    <li class="listitem">
      <span class="simpara">
       Table locks
      </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      Session system variables and session user variables
     </span>
    </li>
    <li class="listitem">
     <span class="simpara">
      The current database set using <em>USE</em> and other state chaining SQL commands
     </span>
    </li>
    <li class="listitem">
      <span class="simpara">
       Prepared statements
      </span>
    </li>
    <li class="listitem">
      <span class="simpara">
       <em>HANDLER</em> variables
      </span>
    </li>
    <li class="listitem">
      <span class="simpara">
       Locks acquired with <em>GET_LOCK()</em>
      </span>
    </li>
   </ul>
  <p></p>
  <p class="para">
    Connection switches happen right before queries are executed. The plugin does
    not switch the current connection until the next statement is executed.
  </p>
  <blockquote class="note"><p><strong class="note">Note</strong>: 
   <strong>Replication issues</strong><br>
   </p><p class="para">
    See also the MySQL reference manual chapter about
    <a href="http://dev.mysql.com/doc/mysql/en/replication.html" class="link external">»&nbsp;replication features</a> and
    related issues. Some restrictions may not be related to the PHP plugin, but
    are properties of the MySQL replication system.
   </p>
  <p></p></blockquote>
  <p class="para">Broadcasted messages</p>
  <p class="para">
   The plugins philosophy is to align the state of connections in the
   pool only if the state is under full control of the plugin, or if it is
   necessary for security reasons. Just a few actions that change the
   state of the connection fall into this category.
  </p>
  <p class="para">
   The following is a list of connection client library calls that change state,
   and are broadcasted to all open connections in the connection pool.
  </p>
  <p class="para">
   If any of the listed calls below are to be executed, the plugin loops over all
   open master and slave connections. The loop continues until all servers
   have been contacted, and the loop does not break if a server indicates a failure.
   If possible, the failure will propagate to the called user API function, which may
   be detected depending on which underlying library function was triggered.
  </p>
  <table class="doctable informaltable">
   
    <colgroup><col width="1*">
    <col width="7*">
    <col width="2*">
    </colgroup><thead>
     <tr>
      <th>Library call</th>
      <th>Notes</th>
      <th>Version</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td>
       <em>change_user()</em>
      </td>
      <td>
       Called by the <span class="function"><a href="mysqli.change-user.html" class="function">mysqli_change_user()</a></span> user API call.
       Also triggered upon reuse of a persistent <em>mysqli</em>
       connection.
      </td>
      <td>Since 1.0.0.</td>
     </tr>

     <tr>
      <td>
       <em>select_db</em>
      </td>
      <td>
       Called by the following user API calls:
       <span class="function"><a href="function.mysql-select-db.html" class="function">mysql_select_db()</a></span>,
       <span class="function"><a href="function.mysql-list-tables.html" class="function">mysql_list_tables()</a></span>,
       <span class="function"><a href="function.mysql-db-query.html" class="function">mysql_db_query()</a></span>,
       <span class="function"><a href="function.mysql-list-fields.html" class="function">mysql_list_fields()</a></span>,
       <span class="function"><a href="mysqli.select-db.html" class="function">mysqli_select_db()</a></span>.
       Note, that SQL <em>USE</em> is not monitored.
      </td>
      <td>Since 1.0.0.</td>
     </tr>

     <tr>
      <td>
       <em>set_charset()</em>
      </td>
      <td>
       Called by the following user API calls:
       <span class="function"><a href="function.mysql-set-charset.html" class="function">mysql_set_charset()</a></span>.
       <span class="function"><a href="mysqli.set-charset.html" class="function">mysqli_set_charset()</a></span>.
       Note, that SQL <em>SET NAMES</em> is not monitored.
      </td>
      <td>Since 1.0.0.</td>
     </tr>

     <tr>
      <td>
       <em>set_server_option()</em>
      </td>
      <td>
        Called by the following user API calls:
        <span class="function"><a href="mysqli.multi-query.html" class="function">mysqli_multi_query()</a></span>,
        <span class="function"><a href="mysqli.real-query.html" class="function">mysqli_real_query()</a></span>,
        <span class="function"><a href="mysqli.query.html" class="function">mysqli_query()</a></span>,
        <span class="function"><a href="function.mysql-query.html" class="function">mysql_query()</a></span>.
      </td>
      <td>Since 1.0.0.</td>
     </tr>

     <tr>
      <td>
       <em>set_client_option()</em>
      </td>
      <td>
        Called by the following user API calls:
        <span class="function"><a href="mysqli.options.html" class="function">mysqli_options()</a></span>,
        <span class="function"><a href="mysqli.ssl-set.html" class="function">mysqli_ssl_set()</a></span>,
        <span class="function"><a href="function.mysqli-connect.html" class="function">mysqli_connect()</a></span>,
        <span class="function"><a href="function.mysql-connect.html" class="function">mysql_connect()</a></span>,
        <span class="function"><a href="function.mysql-pconnect.html" class="function">mysql_pconnect()</a></span>.
      </td>
      <td>Since 1.0.0.</td>
     </tr>

     <tr>
      <td>
       <em>set_autocommit()</em>
      </td>
      <td>
        Called by the following user API calls:
        <span class="function"><a href="mysqli.autocommit.html" class="function">mysqli_autocommit()</a></span>,
        <em>PDO::setAttribute(PDO::ATTR_AUTOCOMMIT)</em>.
      </td>
      <td>Since 1.0.0. PHP &gt;= 5.4.0.</td>
     </tr>

     <tr>
      <td>
       <em>ssl_set()</em>
      </td>
      <td>
       Called by the following user API calls:
       <span class="function"><a href="mysqli.ssl-set.html" class="function">mysqli_ssl_set()</a></span>.
      </td>
      <td>Since 1.1.0.</td>
     </tr>

    </tbody>
   
  </table>

  <p class="para">Broadcasting and lazy connections</p>
  <p class="para">
   The plugin does not proxy or
   "<span class="quote">remember</span>" all settings to apply them on connections
   opened in the future. This is important to remember, if
   using
   <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.lazy-connections" class="link">lazy connections</a>.
   Lazy connections are connections which are not
   opened before the client sends the first connection.
   Use of lazy connections is the default plugin action.
  </p>
  <p class="para">
   The following connection library calls each changed state, and their execution is
   recorded for later use when lazy connections are opened. This helps ensure that
   the connection state of all connections in the connection pool are comparable.
  </p>
  <table class="doctable informaltable">
   
    <colgroup><col width="1*">
    <col width="7*">
    <col width="2*">
    </colgroup><thead>
     <tr>
      <th>Library call</th>
      <th>Notes</th>
      <th>Version</th>
     </tr>

    </thead>

    <tbody class="tbody">
     <tr>
      <td>
       <em>change_user()</em>
      </td>
      <td>
       User, password and database recorded for future use.
      </td>
      <td>Since 1.1.0.</td>
     </tr>

     <tr>
      <td>
       <em>select_db</em>
      </td>
      <td>
       Database recorded for future use.
      </td>
      <td>Since 1.1.0.</td>
     </tr>

     <tr>
      <td>
       <em>set_charset()</em>
      </td>
      <td>
       Calls <em>set_client_option(MYSQL_SET_CHARSET_NAME, charset)</em>
       on lazy connection to ensure <em>charset</em> will be used
       upon opening the lazy connection.
      </td>
      <td>Since 1.1.0.</td>
     </tr>

     <tr>
      <td>
       <em>set_autocommit()</em>
      </td>
      <td>
       Adds <em>SET AUTOCOMMIT=0|1</em> to the list of init commands
       of a lazy connection using
       <em>set_client_option(MYSQL_INIT_COMMAND, "SET AUTOCOMMIT=...%quot;)</em>.
      </td>
      <td>Since 1.1.0. PHP &gt;= 5.4.0.</td>
     </tr>

    </tbody>
   
  </table>


  <div class="caution"><strong class="caution">Caution</strong>
   <h1 class="title">Connection state</h1>
   <p class="para">
    The connection state is not only changed by API calls. Thus, even if
    PECL mysqlnd_ms monitors all API calls, the application must still
    be aware. Ultimately, it is the applications responsibility to maintain
    the connection state, if needed.
   </p>
  </div>

  <p class="para">Charsets and string escaping</p>
  <p class="para">
   Due to the use of lazy connections, which are a default, it can happen that
   an application tries to escape a string for use within SQL statements before
   a connection has been established. In this case string escaping is not possible.
   The string escape function does not know what charset to use before a connection
   has been established.
  </p>
  <p class="para">
   To overcome the problem a new configuration setting
   <a href="mysqlnd-ms.plugin-ini-json.html#ini.mysqlnd-ms-plugin-config-v2.server-charset" class="link"><em>server_charset</em></a>
   has been introduced in version 1.4.0.
  </p>
  <p class="para">
   Attention has to be paid on escaping strings with a certain charset but using
   the result on a connection that uses a different charset. Please note,
   that PECL/mysqlnd_ms manipulates connections and one application level connection
   represents a pool of multiple connections that all may have different default charsets.
   It is recommended to configure the servers involved to use the same default charsets.
   The configuration setting <em>server_charset</em> does help with this situation as well.
   If using <em>server_charset</em>, the plugin will set the given
   charset on all newly opened connections.
  </p>
 </div>
<section id="usernotes">
 <div class="head"><h3 class="title">User Contributed Notes</h3></div>
 <div class="note">There are no user contributed notes for this page.</div></section>    </section><!-- layout-content -->
        


  </div><!-- layout -->
         
  

    
 <!-- External and third party libraries. -->
 







<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top%402x.png"></a>



<!-- Mirrored from php.net/manual/en/mysqlnd-ms.pooling.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 17:07:09 GMT -->


</body></html>