<html><!-- Mirrored from php.net/manual/en/internals2.memory.tsrm.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 15:53:18 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

  <title>Thread-Safe Resource Manager</title>

 <link rel="shortcut icon" href="../../favicon.ico">
 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="internals2.memory.tsrm.html">
 <link rel="shorturl" href="internals2.memory.tsrm.html">
 <link rel="alternate" href="internals2.memory.tsrm.html" hreflang="x-default">

 <link rel="contents" href="index-2.html">
 <link rel="index" href="internals2.memory.html">
 <link rel="prev" href="internals2.memory.persistence.html">
 <link rel="next" href="internals2.variables.html">

 <link rel="alternate" href="internals2.memory.tsrm.html" hreflang="en">
 <link rel="alternate" href="http://php.net/manual/pt_BR/internals2.memory.tsrm.php" hreflang="pt_BR">
 <link rel="alternate" href="http://php.net/manual/zh/internals2.memory.tsrm.php" hreflang="zh">
 <link rel="alternate" href="http://php.net/manual/fr/internals2.memory.tsrm.php" hreflang="fr">
 <link rel="alternate" href="http://php.net/manual/de/internals2.memory.tsrm.php" hreflang="de">
 <link rel="alternate" href="http://php.net/manual/it/internals2.memory.tsrm.php" hreflang="it">
 <link rel="alternate" href="http://php.net/manual/ja/internals2.memory.tsrm.php" hreflang="ja">
 <link rel="alternate" href="http://php.net/manual/ro/internals2.memory.tsrm.php" hreflang="ro">
 <link rel="alternate" href="http://php.net/manual/ru/internals2.memory.tsrm.php" hreflang="ru">
 <link rel="alternate" href="http://php.net/manual/es/internals2.memory.tsrm.php" hreflang="es">
 <link rel="alternate" href="http://php.net/manual/tr/internals2.memory.tsrm.php" hreflang="tr">

<link rel="stylesheet" type="text/css" href="../../cached8fe1.css?t=1401250819&amp;f=/fonts/Fira/fira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached4b8d.css?t=1404368420&amp;f=/fonts/Font-Awesome/css/fontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached5065.css?t=1403329232&amp;f=/styles/theme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cachedc78d.css?t=1401249623&amp;f=/styles/theme-medium.css" media="screen">

 <!--[if lte IE 7]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie7.css" media="screen">
 <![endif]-->

 <!--[if lte IE 8]>
 <script type="text/javascript">
  window.brokenIE = true;
 </script>
 <![endif]-->

 <!--[if lte IE 9]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie9.css" media="screen">
 <![endif]-->

 <!--[if IE]>
 <script type="text/javascript" src="http://php.net/js/ext/html5.js"></script>
 <![endif]-->

 <base>

</head>
<body class="docs " style="">


<div class="headsup"><a href="http://php.net/index.php#id2014-08-28-1">PHP 5.6.0 released</a></div>
<nav id="trick"><div><dl>
<dt><a href="getting-started.html">Getting Started</a></dt>
	<dd><a href="introduction.html">Introduction</a></dd>
	<dd><a href="tutorial.html">A simple tutorial</a></dd>
<dt><a href="langref.html">Language Reference</a></dt>
	<dd><a href="language.basic-syntax.html">Basic syntax</a></dd>
	<dd><a href="language.types.html">Types</a></dd>
	<dd><a href="language.variables.html">Variables</a></dd>
	<dd><a href="language.constants.html">Constants</a></dd>
	<dd><a href="language.expressions.html">Expressions</a></dd>
	<dd><a href="language.operators.html">Operators</a></dd>
	<dd><a href="language.control-structures.html">Control Structures</a></dd>
	<dd><a href="language.functions.html">Functions</a></dd>
	<dd><a href="language.oop5.html">Classes and Objects</a></dd>
	<dd><a href="language.namespaces.html">Namespaces</a></dd>
	<dd><a href="language.exceptions.html">Exceptions</a></dd>
	<dd><a href="language.generators.html">Generators</a></dd>
	<dd><a href="language.references.html">References Explained</a></dd>
	<dd><a href="reserved.variables.html">Predefined Variables</a></dd>
	<dd><a href="reserved.exceptions.html">Predefined Exceptions</a></dd>
	<dd><a href="reserved.interfaces.html">Predefined Interfaces and Classes</a></dd>
	<dd><a href="context.html">Context options and parameters</a></dd>
	<dd><a href="wrappers.html">Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href="security.html">Security</a></dt>
	<dd><a href="security.intro.html">Introduction</a></dd>
	<dd><a href="security.general.html">General considerations</a></dd>
	<dd><a href="security.cgi-bin.html">Installed as CGI binary</a></dd>
	<dd><a href="security.apache.html">Installed as an Apache module</a></dd>
	<dd><a href="security.filesystem.html">Filesystem Security</a></dd>
	<dd><a href="security.database.html">Database Security</a></dd>
	<dd><a href="security.errors.html">Error Reporting</a></dd>
	<dd><a href="security.globals.html">Using Register Globals</a></dd>
	<dd><a href="security.variables.html">User Submitted Data</a></dd>
	<dd><a href="security.magicquotes.html">Magic Quotes</a></dd>
	<dd><a href="security.hiding.html">Hiding PHP</a></dd>
	<dd><a href="security.current.html">Keeping Current</a></dd>
<dt><a href="features.html">Features</a></dt>
	<dd><a href="features.http-auth.html">HTTP authentication with PHP</a></dd>
	<dd><a href="features.cookies.html">Cookies</a></dd>
	<dd><a href="features.sessions.html">Sessions</a></dd>
	<dd><a href="features.xforms.html">Dealing with XForms</a></dd>
	<dd><a href="features.file-upload.html">Handling file uploads</a></dd>
	<dd><a href="features.remote-files.html">Using remote files</a></dd>
	<dd><a href="features.connection-handling.html">Connection handling</a></dd>
	<dd><a href="features.persistent-connections.html">Persistent Database Connections</a></dd>
	<dd><a href="features.safe-mode.html">Safe Mode</a></dd>
	<dd><a href="features.commandline.html">Command line usage</a></dd>
	<dd><a href="features.gc.html">Garbage Collection</a></dd>
	<dd><a href="features.dtrace.html">DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href="funcref.html">Function Reference</a></dt>
	<dd><a href="refs.basic.php.html">Affecting PHP's Behaviour</a></dd>
	<dd><a href="refs.utilspec.audio.html">Audio Formats Manipulation</a></dd>
	<dd><a href="refs.remote.auth.html">Authentication Services</a></dd>
	<dd><a href="refs.utilspec.cmdline.html">Command Line Specific Extensions</a></dd>
	<dd><a href="refs.compression.html">Compression and Archive Extensions</a></dd>
	<dd><a href="refs.creditcard.html">Credit Card Processing</a></dd>
	<dd><a href="refs.crypto.html">Cryptography Extensions</a></dd>
	<dd><a href="refs.database.html">Database Extensions</a></dd>
	<dd><a href="refs.calendar.html">Date and Time Related Extensions</a></dd>
	<dd><a href="refs.fileprocess.file.html">File System Related Extensions</a></dd>
	<dd><a href="refs.international.html">Human Language and Character Encoding Support</a></dd>
	<dd><a href="refs.utilspec.image.html">Image Processing and Generation</a></dd>
	<dd><a href="refs.remote.mail.html">Mail Related Extensions</a></dd>
	<dd><a href="refs.math.html">Mathematical Extensions</a></dd>
	<dd><a href="refs.utilspec.nontext.html">Non-Text MIME Output</a></dd>
	<dd><a href="refs.fileprocess.process.html">Process Control Extensions</a></dd>
	<dd><a href="refs.basic.other.html">Other Basic Extensions</a></dd>
	<dd><a href="refs.remote.other.html">Other Services</a></dd>
	<dd><a href="refs.search.html">Search Engine Extensions</a></dd>
	<dd><a href="refs.utilspec.server.html">Server Specific Extensions</a></dd>
	<dd><a href="refs.basic.session.html">Session Extensions</a></dd>
	<dd><a href="refs.basic.text.html">Text Processing</a></dd>
	<dd><a href="refs.basic.vartype.html">Variable and Type Related Extensions</a></dd>
	<dd><a href="refs.webservice.html">Web Services</a></dd>
	<dd><a href="refs.utilspec.windows.html">Windows Only Extensions</a></dd>
	<dd><a href="refs.xml.html">XML Manipulation</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="row-fluid">
          
              
        <ul class="breadcrumbs-container">
            <li><a href="index-2.html">PHP Manual</a></li>      <li><a href="internals2.html">PHP at the Core: A Hacker's Guide</a></li>      <li><a href="internals2.memory.html">Memory management</a></li>    </ul>
  </div>




<div id="layout">
  <section id="layout-content">
  <div id="internals2.memory.tsrm" class="sect1">
 <h2 class="title">Thread-Safe Resource Manager</h2>
 
 <p class="simpara">
  When PHP is built with Thread Safety enabled, the engine requires a way to isolate contexts from one another, such that the threads of a process may service individual requests without interference. TSRM is omnipotent within PHP, extension authors have to do very little in order to make sure their extensions can function in both a Thread Safe and Non Thread Safe architecture.
 </p>
 
 <div class="example" id="internals2.structure.globals.using.accessor2">
  <p><strong>Example #1 Accessor macros for per-module globals</strong></p>
  <div class="example-contents">
<div class="ccode"><pre class="ccode">#ifdef ZTS
#define COUNTER_G(v) TSRMG(counter_globals_id, zend_counter_globals *, v)
#else
#define COUNTER_G(v) (counter_globals.v)
#endif</pre>
</div>
  </div>

 </div>
 
 <p class="simpara">
  The snippet above shows how an extension author is expected to define their global accessors. The TSRMG macro takes an identifier, type cast and element name. The identifier is assigned by TSRM during initialization of the module. Declaring global accessors in this way ensures that an extension can operate safely in a Thread Safe and Non Thread Safe architecture using the same logic.
 </p>
 
 <p class="simpara">
  TSRM manages the isolation and safety of all global structures within PHP, from executor globals to extension globals, a pointer to the isolated storage is also passed around with most, or many of the API functions. The macros TSRMLS_C and TSRMLS_CC translate to "thread safe local storage" and "thread safe local storage prefixed with a comma" respectively.
 </p>
 
 <p class="simpara">
  If a function requires a pointer to TSRM, it is declared with the macro TSRMLS_D or TSRMLS_DC in it's prototype, which translates to "thread safe local storage only" and "thread safe local storage prefixed with a comma" respectively. Many macros within the engine reference TSRM, so it is a good idea to declare most things to accept TSRM, such that if they need to call upon TSRM they do not have to fetch a pointer during execution.
 </p>
 
 <p class="simpara">
  Because TSRM is thread local, and some functions (for compatibility reasons) are not able to accept TSRM directly, the macro TSRMLS_FETCH exists, which requests that TSRM fetches the pointer to the thread local storage. This should be avoided wherever it can be, as it is not without cost in a Thread Safe setup.
 </p>
 
 <blockquote class="note"><p><strong class="note">Note</strong>: 
  <span class="simpara">
   While developing extensions, build errors that contain "tsrm_ls is undefined" or errors to that effect stem from the fact that TSRMLS is undefined in the current scope, to fix this, declare the function to accept TSRMLS with the appropriate macro, if the prototype of the function in question cannot be changed, you must call TSRMLS_FETCH within the function body.
  </span>
 </p></blockquote>
 
 <p class="simpara">
  The functionality documented hereafter is aimed at advanced use of TSRM. It is not ordinary for extensions to have to interact with TSRM directly, the pecl programmer should use API's above TSRM such as the Module Globals API.
 </p>
 
 <table id="internals2.memory.tsrm.iapis" class="doctable table">
  <caption><strong>TSRM Internals</strong></caption>
  
   <thead>
    <tr>
     <th>Prototype</th>
     <th>Description</th>
    </tr>

   </thead>

   <tbody class="tbody">
    
    <tr> 
     <td><code class="code">typedef int ts_rsrc_id</code></td>
     <td>The type definition to represent a resource by numeric identifiers</td>
    </tr>

    
    <tr>
     <td><code class="code">int tsrm_startup(int expected_threads, int expected_resources, int debug_level, char *debug_filename)</code></td>
     <td><code class="code">expected_threads</code> and <code class="code">expected_resources</code> are not hard limits. <code class="code">debug_level</code> and <code class="code">debug_filename</code> only have an effect on windows in Debug mode or when TSRM_DEBUG is defined. Called once per process in ZTS mode during server startup.</td>
    </tr>

    
    <tr>
     <td><code class="code">void tsrm_shutdown(void)</code></td>
     <td>
      Should be the last thing called in the process to destroy and free all storage TSRM storage in ZTS mode.
     </td>
    </tr>

    
    <tr>
     <td><code class="code">ts_rsrc_id ts_allocate_id(ts_rsrc_id *rsrc_id, size_t size, ts_allocate_ctor ctor, ts_allocate_dtor dtor)</code></td>
     <td>
      Allocates and thread safe pointer of <code class="code">size</code> bytes, calling <code class="code">ctor</code> on the pointer, assigning (and returning) the id to <code class="code">rsrc_id</code>, the <code class="code">dtor</code> is called when the resource is free'd. Module globals are isolated in ZTS mode using this API.
     </td>
    </tr>

    
    <tr>
     <td><code class="code">void *ts_resource_ex(ts_rsrc_id id, THREAD_T *th_id)</code></td>
     <td>
      Fetches a resource by previously allocated <code class="code">id</code> from the entries created by the specified thread identifed by <code class="code">th_id</code>.
     </td>
    </tr>

    
    <tr>
     <td>
      <code class="code">void *ts_resource(ts_rsrc_id id)</code>
     </td>
     <td>
      Fetches a resource by previously allocated <code class="code">id</code> from the entries created by the calling thread.
     </td>
    </tr>

    
    <tr>
     <td><code class="code">void ts_free_thread(void)</code></td>
     <td>
      Destroys and frees the entries for the calling thread, currently this API is only used by ISAPI module.
     </td>
    </tr>

    
    <tr>
     <td>
      <code class="code">void ts_free_id(ts_rsrc_id id)</code>
     </td>
     <td>
      Destroys the resource identified by previously allocated <code class="code">id</code>. Module globals are cleaned up in ZTS mode using this API.
     </td>
    </tr>

   </tbody>
  
 </table>

 
 <blockquote class="note"><p><strong class="note">Note</strong>: 
  <span class="simpara">There are more TSRM API functions to enable the creation and destruction of interpreter contexts, the usage of such functionality is out of the scope of this documentation, please see TSRM/TSRM.h for more information.</span>
 </p></blockquote>
 
 <table id="internals2.memory.tsrm.mapis" class="doctable table">
  <caption><strong>TSRM Mutex API</strong></caption>
  
   <thead>
    <tr>
     <th>Prototype</th>
     <th>Description</th>
    </tr>

   </thead>

   <tbody class="tbody">
    
    <tr>
     <td><code class="code">MUTEX_T tsrm_mutex_alloc(void)</code></td>
     <td>Allocates and returns a suitable MUTEX_T for the environment.</td>
    </tr>

    
    <tr>
     <td><code class="code">int tsrm_mutex_lock(MUTEX_T mutexp)</code></td>
     <td>
      Locks <code class="code">mutexp</code> for the calling thread.
     </td>
    </tr>

    
    <tr>
     <td><code class="code">int tsrm_mutex_unlock(MUTEX_T mutexp)</code></td>
     <td>
      Unlocks <code class="code">mutexp</code> for the calling thread.
     </td>
    </tr>

    
    <tr>
     <td><code class="code">void tsrm_mutex_free(MUTEX_T mutexp);</code></td>
     <td>
      Destroys and frees the (unlocked) and previously allocated <code class="code">mutexp</code>.
     </td>
    </tr>

   </tbody>
  
 </table>

 
 <blockquote class="note"><p><strong class="note">Note</strong>: 
  <span class="simpara">The mutex API is exposed by TSRM. However, its internal usage is far too wide to document usefully here, none the less, basic functionality and prototypes are documented here.</span>
 </p></blockquote>
</div>
<section id="usernotes">
 <div class="head"><h3 class="title">User Contributed Notes</h3></div>
 <div class="note">There are no user contributed notes for this page.</div></section>    </section><!-- layout-content -->
        


  </div><!-- layout -->
         
  

    
 <!-- External and third party libraries. -->
 







<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top%402x.png"></a>



<!-- Mirrored from php.net/manual/en/internals2.memory.tsrm.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 15:53:18 GMT -->


</body></html>