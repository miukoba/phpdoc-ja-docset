<html><!-- Mirrored from php.net/manual/en/function.pcntl-fork.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 16:35:39 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

  <title>pcntl_fork</title>

 <link rel="shortcut icon" href="../../favicon.ico">
 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="function.pcntl-fork.html">
 <link rel="shorturl" href="http://php.net/pcntl-fork">
 <link rel="alternate" href="http://php.net/pcntl-fork" hreflang="x-default">

 <link rel="contents" href="index-2.html">
 <link rel="index" href="ref.pcntl.html">
 <link rel="prev" href="function.pcntl-exec.html">
 <link rel="next" href="function.pcntl-get-last-error.html">

 <link rel="alternate" href="function.pcntl-fork.html" hreflang="en">
 <link rel="alternate" href="http://php.net/manual/pt_BR/function.pcntl-fork.php" hreflang="pt_BR">
 <link rel="alternate" href="http://php.net/manual/zh/function.pcntl-fork.php" hreflang="zh">
 <link rel="alternate" href="http://php.net/manual/fr/function.pcntl-fork.php" hreflang="fr">
 <link rel="alternate" href="http://php.net/manual/de/function.pcntl-fork.php" hreflang="de">
 <link rel="alternate" href="http://php.net/manual/it/function.pcntl-fork.php" hreflang="it">
 <link rel="alternate" href="http://php.net/manual/ja/function.pcntl-fork.php" hreflang="ja">
 <link rel="alternate" href="http://php.net/manual/ro/function.pcntl-fork.php" hreflang="ro">
 <link rel="alternate" href="http://php.net/manual/ru/function.pcntl-fork.php" hreflang="ru">
 <link rel="alternate" href="http://php.net/manual/es/function.pcntl-fork.php" hreflang="es">
 <link rel="alternate" href="http://php.net/manual/tr/function.pcntl-fork.php" hreflang="tr">

<link rel="stylesheet" type="text/css" href="../../cached8fe1.css?t=1401250819&amp;f=/fonts/Fira/fira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached4b8d.css?t=1404368420&amp;f=/fonts/Font-Awesome/css/fontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached5065.css?t=1403329232&amp;f=/styles/theme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cachedc78d.css?t=1401249623&amp;f=/styles/theme-medium.css" media="screen">

 <!--[if lte IE 7]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie7.css" media="screen">
 <![endif]-->

 <!--[if lte IE 8]>
 <script type="text/javascript">
  window.brokenIE = true;
 </script>
 <![endif]-->

 <!--[if lte IE 9]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie9.css" media="screen">
 <![endif]-->

 <!--[if IE]>
 <script type="text/javascript" src="http://php.net/js/ext/html5.js"></script>
 <![endif]-->

 <base>

</head>
<body class="docs " style="">


<div class="headsup"><a href="http://php.net/index.php#id2014-08-28-1">PHP 5.6.0 released</a></div>
<nav id="trick"><div><dl>
<dt><a href="getting-started.html">Getting Started</a></dt>
	<dd><a href="introduction.html">Introduction</a></dd>
	<dd><a href="tutorial.html">A simple tutorial</a></dd>
<dt><a href="langref.html">Language Reference</a></dt>
	<dd><a href="language.basic-syntax.html">Basic syntax</a></dd>
	<dd><a href="language.types.html">Types</a></dd>
	<dd><a href="language.variables.html">Variables</a></dd>
	<dd><a href="language.constants.html">Constants</a></dd>
	<dd><a href="language.expressions.html">Expressions</a></dd>
	<dd><a href="language.operators.html">Operators</a></dd>
	<dd><a href="language.control-structures.html">Control Structures</a></dd>
	<dd><a href="language.functions.html">Functions</a></dd>
	<dd><a href="language.oop5.html">Classes and Objects</a></dd>
	<dd><a href="language.namespaces.html">Namespaces</a></dd>
	<dd><a href="language.exceptions.html">Exceptions</a></dd>
	<dd><a href="language.generators.html">Generators</a></dd>
	<dd><a href="language.references.html">References Explained</a></dd>
	<dd><a href="reserved.variables.html">Predefined Variables</a></dd>
	<dd><a href="reserved.exceptions.html">Predefined Exceptions</a></dd>
	<dd><a href="reserved.interfaces.html">Predefined Interfaces and Classes</a></dd>
	<dd><a href="context.html">Context options and parameters</a></dd>
	<dd><a href="wrappers.html">Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href="security.html">Security</a></dt>
	<dd><a href="security.intro.html">Introduction</a></dd>
	<dd><a href="security.general.html">General considerations</a></dd>
	<dd><a href="security.cgi-bin.html">Installed as CGI binary</a></dd>
	<dd><a href="security.apache.html">Installed as an Apache module</a></dd>
	<dd><a href="security.filesystem.html">Filesystem Security</a></dd>
	<dd><a href="security.database.html">Database Security</a></dd>
	<dd><a href="security.errors.html">Error Reporting</a></dd>
	<dd><a href="security.globals.html">Using Register Globals</a></dd>
	<dd><a href="security.variables.html">User Submitted Data</a></dd>
	<dd><a href="security.magicquotes.html">Magic Quotes</a></dd>
	<dd><a href="security.hiding.html">Hiding PHP</a></dd>
	<dd><a href="security.current.html">Keeping Current</a></dd>
<dt><a href="features.html">Features</a></dt>
	<dd><a href="features.http-auth.html">HTTP authentication with PHP</a></dd>
	<dd><a href="features.cookies.html">Cookies</a></dd>
	<dd><a href="features.sessions.html">Sessions</a></dd>
	<dd><a href="features.xforms.html">Dealing with XForms</a></dd>
	<dd><a href="features.file-upload.html">Handling file uploads</a></dd>
	<dd><a href="features.remote-files.html">Using remote files</a></dd>
	<dd><a href="features.connection-handling.html">Connection handling</a></dd>
	<dd><a href="features.persistent-connections.html">Persistent Database Connections</a></dd>
	<dd><a href="features.safe-mode.html">Safe Mode</a></dd>
	<dd><a href="features.commandline.html">Command line usage</a></dd>
	<dd><a href="features.gc.html">Garbage Collection</a></dd>
	<dd><a href="features.dtrace.html">DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href="funcref.html">Function Reference</a></dt>
	<dd><a href="refs.basic.php.html">Affecting PHP's Behaviour</a></dd>
	<dd><a href="refs.utilspec.audio.html">Audio Formats Manipulation</a></dd>
	<dd><a href="refs.remote.auth.html">Authentication Services</a></dd>
	<dd><a href="refs.utilspec.cmdline.html">Command Line Specific Extensions</a></dd>
	<dd><a href="refs.compression.html">Compression and Archive Extensions</a></dd>
	<dd><a href="refs.creditcard.html">Credit Card Processing</a></dd>
	<dd><a href="refs.crypto.html">Cryptography Extensions</a></dd>
	<dd><a href="refs.database.html">Database Extensions</a></dd>
	<dd><a href="refs.calendar.html">Date and Time Related Extensions</a></dd>
	<dd><a href="refs.fileprocess.file.html">File System Related Extensions</a></dd>
	<dd><a href="refs.international.html">Human Language and Character Encoding Support</a></dd>
	<dd><a href="refs.utilspec.image.html">Image Processing and Generation</a></dd>
	<dd><a href="refs.remote.mail.html">Mail Related Extensions</a></dd>
	<dd><a href="refs.math.html">Mathematical Extensions</a></dd>
	<dd><a href="refs.utilspec.nontext.html">Non-Text MIME Output</a></dd>
	<dd><a href="refs.fileprocess.process.html">Process Control Extensions</a></dd>
	<dd><a href="refs.basic.other.html">Other Basic Extensions</a></dd>
	<dd><a href="refs.remote.other.html">Other Services</a></dd>
	<dd><a href="refs.search.html">Search Engine Extensions</a></dd>
	<dd><a href="refs.utilspec.server.html">Server Specific Extensions</a></dd>
	<dd><a href="refs.basic.session.html">Session Extensions</a></dd>
	<dd><a href="refs.basic.text.html">Text Processing</a></dd>
	<dd><a href="refs.basic.vartype.html">Variable and Type Related Extensions</a></dd>
	<dd><a href="refs.webservice.html">Web Services</a></dd>
	<dd><a href="refs.utilspec.windows.html">Windows Only Extensions</a></dd>
	<dd><a href="refs.xml.html">XML Manipulation</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="row-fluid">
          
              
        <ul class="breadcrumbs-container">
            <li><a href="index-2.html">PHP Manual</a></li>      <li><a href="funcref.html">Function Reference</a></li>      <li><a href="refs.fileprocess.process.html">Process Control Extensions</a></li>      <li><a href="book.pcntl.html">PCNTL</a></li>      <li><a href="ref.pcntl.html">PCNTL Functions</a></li>    </ul>
  </div>




<div id="layout">
  <section id="layout-content">
  <div id="function.pcntl-fork" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">pcntl_fork</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.1.0, PHP 5)</p><p class="refpurpose"><span class="refname">pcntl_fork</span> — <span class="dc-title">Forks the currently running process</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.pcntl-fork-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">int</span> <span class="methodname"><strong>pcntl_fork</strong></span>
    ( <span class="methodparam">void</span>
   )</div>

  <p class="para rdfs-comment">
   The <span class="function"><strong>pcntl_fork()</strong></span> function creates a child
   process that differs from the parent process only in its PID and
   PPID. Please see your system's fork(2) man page for specific details as to
   how fork works on your system.
  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.pcntl-fork-returnvalues">
  <h3 class="title">Return Values</h3>
  <p class="para">
   On success, the PID of the child process is returned in the
   parent's thread of execution, and a 0 is returned in the child's
   thread of execution.  On failure, a -1 will be returned in the
   parent's context, no child process will be created, and a PHP
   error is raised.
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.pcntl-fork-examples">
  <h3 class="title">Examples</h3>
  <p class="para">
   </p><div class="example" id="example-3741">
    <p><strong>Example #1 <span class="function"><strong>pcntl_fork()</strong></span> example</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br><br>$pid&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">pcntl_fork</span><span style="color: #007700">();<br>if&nbsp;(</span><span style="color: #0000BB">$pid&nbsp;</span><span style="color: #007700">==&nbsp;-</span><span style="color: #0000BB">1</span><span style="color: #007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;die(</span><span style="color: #DD0000">'could&nbsp;not&nbsp;fork'</span><span style="color: #007700">);<br>}&nbsp;else&nbsp;if&nbsp;(</span><span style="color: #0000BB">$pid</span><span style="color: #007700">)&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;we&nbsp;are&nbsp;the&nbsp;parent<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">pcntl_wait</span><span style="color: #007700">(</span><span style="color: #0000BB">$status</span><span style="color: #007700">);&nbsp;</span><span style="color: #FF8000">//Protect&nbsp;against&nbsp;Zombie&nbsp;children<br></span><span style="color: #007700">}&nbsp;else&nbsp;{<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;we&nbsp;are&nbsp;the&nbsp;child<br></span><span style="color: #007700">}<br><br></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  <p></p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.pcntl-fork-seealso">
  <h3 class="title">See Also</h3>
  <p class="para">
   </p><ul class="simplelist">
    <li class="member"><span class="function"><a href="function.pcntl-waitpid.html" class="function" rel="rdfs-seeAlso">pcntl_waitpid()</a> - Waits on or returns the status of a forked child</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-signal.html" class="function" rel="rdfs-seeAlso">pcntl_signal()</a> - Installs a signal handler</span></li>
    <li class="member"><span class="function"><a href="function.setproctitle.html" class="function" rel="rdfs-seeAlso">setproctitle()</a> - Set the process title</span></li>
   </ul>
  <p></p>
 </div>


</div>
<section id="usernotes">
 <div class="head"><h3 class="title">User Contributed Notes</h3></div><div id="allnotes">
  <div class="note" id="94338">  
  <a class="name">
  <strong class="user"><em>Tony</em></strong></a><div class="date" title="2009-10-29 03:05"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom94338">
<div class="phpcode"><code><span class="html">
If you want to execute some code after your php page has been returned to the user. Try something like this -
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">function </span><span class="default">index</span><span class="keyword">()
<br>{
<br>&nbsp; &nbsp; &nbsp; &nbsp; function </span><span class="default">shutdown</span><span class="keyword">() {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">posix_kill</span><span class="keyword">(</span><span class="default">posix_getpid</span><span class="keyword">(), </span><span class="default">SIGHUP</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Do some initial processing
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">echo(</span><span class="string">"Hello World"</span><span class="keyword">);
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Switch over to daemon mode.
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if (</span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">())
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;&nbsp; &nbsp;&nbsp; </span><span class="comment">// Parent
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ob_end_clean</span><span class="keyword">(); </span><span class="comment">// Discard the output buffer and close
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">STDIN</span><span class="keyword">);&nbsp; </span><span class="comment">// Close all of the standard
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">STDOUT</span><span class="keyword">); </span><span class="comment">// file descriptors as we
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">STDERR</span><span class="keyword">); </span><span class="comment">// are running as a daemon.
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="string">'shutdown'</span><span class="keyword">);
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">posix_setsid</span><span class="keyword">() &lt; </span><span class="default">0</span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; if (</span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">())
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return;&nbsp; &nbsp;&nbsp; </span><span class="comment">// Parent
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; // Now running as a daemon. This process will even survive
<br>&nbsp; &nbsp; &nbsp; &nbsp; // an apachectl stop.
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">);
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/tmp/sdf123"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fprintf</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"PID = %s\n"</span><span class="keyword">, </span><span class="default">posix_getpid</span><span class="keyword">());
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; return;
<br>}
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="100557">  
  <a class="name">
  <strong class="user"><em>sean dot kelly at mediatile dot com</em></strong></a><div class="date" title="2010-10-22 05:36"><strong>3 years ago</strong></div>
  <div class="text" id="Hcom100557">
<div class="phpcode"><code><span class="html">
"Fatal Error" has always been the bane of my world because there is no way to capture and handle the condition in PHP. My team builds almost everything in PHP in order to leverage our core library of code, so it was of the essence to find a solution for this problem of scripts bombing unrecoverably and us never knowing about it.<br><br>One of our background automation systems creates a "task queue" of sorts and for each task in the queue, a PHP module is include()ed to handle the task. Sometimes however a poorly behaved module will nuke with a Fatal Error and take out the parent script with it.<br><br>I decided to try to use pcntl_fork() to isolate the task module from the parent code, and it seems to work: a Fatal Error generated within the module makes the child task bomb, and the waiting parent can simply catch the return code from the child and track/alert us to the problem as needed. <br><br>Naturally something similar could be done if I wanted to simply exec() the module and check the output, but then I would not have the benefit of the stateful environment that the parent script has so carefully prepared. This allows me to keep the child process within the context of the parent's running environment and not suffer the consequences of Fatal Errors stopping the task queue from continuing to process.<br><br>Here is fork_n_wait.php for your amusement:<br><br><span class="default">&lt;?php<br><br></span><span class="keyword">if (! </span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">'pcntl_fork'</span><span class="keyword">)) die(</span><span class="string">'PCNTL functions not available on this PHP installation'</span><span class="keyword">);<br><br>for (</span><span class="default">$x </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="default">$x </span><span class="keyword">&lt; </span><span class="default">5</span><span class="keyword">; </span><span class="default">$x</span><span class="keyword">++) {<br>&nbsp;&nbsp; switch (</span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">()) {<br>&nbsp; &nbsp; &nbsp; case -</span><span class="default">1</span><span class="keyword">:<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// @fail<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">die(</span><span class="string">'Fork failed'</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br><br>&nbsp; &nbsp; &nbsp; case </span><span class="default">0</span><span class="keyword">:<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// @child: Include() misbehaving code here<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">print </span><span class="string">"FORK: Child #</span><span class="keyword">{</span><span class="default">$x</span><span class="keyword">}</span><span class="string"> preparing to nuke...\n"</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">generate_fatal_error</span><span class="keyword">(); </span><span class="comment">// Undefined function<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">break;<br><br>&nbsp; &nbsp; &nbsp; default:<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// @parent<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">print </span><span class="string">"FORK: Parent, letting the child run amok...\n"</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_waitpid</span><span class="keyword">(</span><span class="default">$pid</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br>&nbsp;&nbsp; }<br>}<br><br>print </span><span class="string">"Done! :^)\n\n"</span><span class="keyword">;<br></span><span class="default">?&gt;<br></span><br>Which outputs:<br>php -q fork_n_wait.php<br>FORK: Child #1 preparing to nuke...<br>PHP Fatal error:&nbsp; Call to undefined function generate_fatal_error() in ~fork_n_wait.php on line 16<br>FORK: Parent, letting the child run amok...<br>FORK: Child #2 preparing to nuke...<br>PHP Fatal error:&nbsp; Call to undefined function generate_fatal_error() in ~/fork_n_wait.php on line 16<br>FORK: Parent, letting the child run amok...<br>FORK: Child #3 preparing to nuke...<br>PHP Fatal error:&nbsp; Call to undefined function generate_fatal_error() in ~/fork_n_wait.php on line 16<br>FORK: Parent, letting the child run amok...<br>FORK: Child #4 preparing to nuke...<br>PHP Fatal error:&nbsp; Call to undefined function generate_fatal_error() in ~/fork_n_wait.php on line 16<br>FORK: Parent, letting the child run amok...<br>Done! :^)</span>
</code></div>
  </div>
 </div>
  <div class="note" id="98844">  
  <a class="name">
  <strong class="user"><em>iulian</em></strong></a><div class="date" title="2010-07-10 11:58"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom98844">
<div class="phpcode"><code><span class="html">
When using fork to run multiple children processes on a single job queue using mysql, I used mysql_affected_rows() to prevent collisions between workers:
<br>
<br>First I find a "free" job:
<br>SELECT job_id FROM queue WHERE status="free"
<br>
<br>Then I update the queue:
<br>UPDATE queue SET worker_id={$worker_id} WHERE job_id={$job_id}
<br>
<br>Then I see if the row was changed
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">if(</span><span class="default">mysql_affected_rows</span><span class="keyword">() == </span><span class="default">0</span><span class="keyword">)
<br>{
<br></span><span class="comment">//the row hasn't changed, so it must mean that another worker has claimed the job, so I go back to the "find a free job" query
<br></span><span class="keyword">}
<br>else
<br>{
<br></span><span class="comment">//do the job
<br></span><span class="keyword">}
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="98711">  
  <a class="name">
  <strong class="user"><em>duerra at yahoo dot com</em></strong></a><div class="date" title="2010-07-01 07:06"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom98711">
<div class="phpcode"><code><span class="html">
Using pcntl_fork() can be a little tricky in some situations.&nbsp; For fast jobs, a child can finish processing before the parent process has executed some code related to the launching of the process.&nbsp; The parent can receive a signal before it's ready to handle the child process' status.&nbsp; To handle this scenario, I add an id to a "queue" of processes in the signal handler that need to be cleaned up if the parent process is not yet ready to handle them.&nbsp; 
<br>
<br>I am including a stripped down version of a job daemon that should get a person on the right track. 
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">declare(</span><span class="default">ticks</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">);
<br></span><span class="comment">//A very basic job daemon that you can extend to your needs. 
<br></span><span class="keyword">class </span><span class="default">JobDaemon</span><span class="keyword">{
<br>
<br>&nbsp; &nbsp; public </span><span class="default">$maxProcesses </span><span class="keyword">= </span><span class="default">25</span><span class="keyword">;
<br>&nbsp; &nbsp; protected </span><span class="default">$jobsStarted </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br>&nbsp; &nbsp; protected </span><span class="default">$currentJobs </span><span class="keyword">= array();
<br>&nbsp; &nbsp; protected </span><span class="default">$signalQueue</span><span class="keyword">=array();&nbsp;&nbsp; 
<br>&nbsp; &nbsp; protected </span><span class="default">$parentPID</span><span class="keyword">;
<br>&nbsp;&nbsp; 
<br>&nbsp; &nbsp; public function </span><span class="default">__construct</span><span class="keyword">(){
<br>&nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">"constructed \n"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">parentPID </span><span class="keyword">= </span><span class="default">getmypid</span><span class="keyword">();
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGCHLD</span><span class="keyword">, array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"childSignalHandler"</span><span class="keyword">));
<br>&nbsp; &nbsp; }
<br>&nbsp;&nbsp; 
<br>&nbsp; &nbsp; </span><span class="comment">/**
<br>&nbsp; &nbsp; * Run the Daemon
<br>&nbsp; &nbsp; */
<br>&nbsp; &nbsp; </span><span class="keyword">public function </span><span class="default">run</span><span class="keyword">(){
<br>&nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">"Running \n"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">10000</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$jobID </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">10000000000000</span><span class="keyword">);
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; while(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">) &gt;= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">maxProcesses</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Maximum children allowed, waiting...\n"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">); 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$launched </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">launchJob</span><span class="keyword">(</span><span class="default">$jobID</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp;&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//Wait for child processes to finish before exiting here
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">while(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">"Waiting for current jobs to finish... \n"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; }
<br>&nbsp;&nbsp; 
<br>&nbsp; &nbsp; </span><span class="comment">/**
<br>&nbsp; &nbsp; * Launch a job from the job queue
<br>&nbsp; &nbsp; */
<br>&nbsp; &nbsp; </span><span class="keyword">protected function </span><span class="default">launchJob</span><span class="keyword">(</span><span class="default">$jobID</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();
<br>&nbsp; &nbsp; &nbsp; &nbsp; if(</span><span class="default">$pid </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//Problem launching the job
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">error_log</span><span class="keyword">(</span><span class="string">'Could not launch new job, exiting'</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">false</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; else if (</span><span class="default">$pid</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Parent process
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // Sometimes you can receive a signal to the childSignalHandler function before this code executes if
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // the child script executes quickly enough!
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">] = </span><span class="default">$jobID</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// In the event that a signal for this pid was caught before we get here, it will be in our signalQueue array
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // So let's go ahead and process it now as if we'd just received the signal
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if(isset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">])){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">"found </span><span class="default">$pid</span><span class="string"> in the signal queue, processing it now \n"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">childSignalHandler</span><span class="keyword">(</span><span class="default">SIGCHLD</span><span class="keyword">, </span><span class="default">$pid</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">]);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">]);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; else{
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//Forked child, do your deeds....
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$exitStatus </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="comment">//Error code if you need to or whatever
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">echo </span><span class="string">"Doing something fun in pid "</span><span class="keyword">.</span><span class="default">getmypid</span><span class="keyword">().</span><span class="string">"\n"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(</span><span class="default">$exitStatus</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">true</span><span class="keyword">;
<br>&nbsp; &nbsp; }
<br>&nbsp;&nbsp; 
<br>&nbsp; &nbsp; public function </span><span class="default">childSignalHandler</span><span class="keyword">(</span><span class="default">$signo</span><span class="keyword">, </span><span class="default">$pid</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp;&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//If no pid is provided, that means we're getting the signal from the system.&nbsp; Let's figure out
<br>&nbsp; &nbsp; &nbsp; &nbsp; //which child process ended
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if(!</span><span class="default">$pid</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_waitpid</span><span class="keyword">(-</span><span class="default">1</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">, </span><span class="default">WNOHANG</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp;&nbsp; 
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//Make sure we get all of the exited children
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">while(</span><span class="default">$pid </span><span class="keyword">&gt; </span><span class="default">0</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(</span><span class="default">$pid </span><span class="keyword">&amp;&amp; isset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">])){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$exitCode </span><span class="keyword">= </span><span class="default">pcntl_wexitstatus</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(</span><span class="default">$exitCode </span><span class="keyword">!= </span><span class="default">0</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">"</span><span class="default">$pid</span><span class="string"> exited with status "</span><span class="keyword">.</span><span class="default">$exitCode</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">]);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; else if(</span><span class="default">$pid</span><span class="keyword">){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//Oh no, our job has finished before this parent process could even note that it had been launched!
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; //Let's make note of it and handle it when the parent process is ready for it
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">echo </span><span class="string">"..... Adding </span><span class="default">$pid</span><span class="string"> to the signal queue ..... \n"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">] = </span><span class="default">$status</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_waitpid</span><span class="keyword">(-</span><span class="default">1</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">, </span><span class="default">WNOHANG</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">true</span><span class="keyword">;
<br>&nbsp; &nbsp; }
<br>}</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="49949">  
  <a class="name">
  <strong class="user"><em>arnold at helderhosting dot nl</em></strong></a><div class="date" title="2005-02-13 07:12"><strong>9 years ago</strong></div>
  <div class="text" id="Hcom49949">
<div class="phpcode"><code><span class="html">
It is not possible to use the function 'pcntl_fork' when PHP is used as Apache module. You can only use pcntl_fork in CGI mode or from command-line.<br><br>Using this function will result in: 'Fatal error: Call to undefined function: pcntl_fork()'</span>
</code></div>
  </div>
 </div>
  <div class="note" id="110790">  
  <a class="name">
  <strong class="user"><em>manishpatel2280 at gmail dot com</em></strong></a><div class="date" title="2012-12-08 06:41"><strong>1 year ago</strong></div>
  <div class="text" id="Hcom110790">
<div class="phpcode"><code><span class="html">
Its been easy to fork process with pcntl_fork.. but how can we control or process further once all child processes gets completed.. here is the way we can do that...
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt;= </span><span class="default">5</span><span class="keyword">; ++</span><span class="default">$i</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();
<br>
<br>&nbsp; &nbsp; &nbsp; &nbsp; if (!</span><span class="default">$pid</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; print </span><span class="string">"In child </span><span class="default">$i</span><span class="string">\n"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit(</span><span class="default">$i</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; }
<br>
<br>&nbsp; &nbsp; while (</span><span class="default">pcntl_waitpid</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">) != -</span><span class="default">1</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$status </span><span class="keyword">= </span><span class="default">pcntl_wexitstatus</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">"Child </span><span class="default">$status</span><span class="string"> completed\n"</span><span class="keyword">;
<br>&nbsp; &nbsp; }
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="99369">  
  <a class="name">
  <strong class="user"><em>KrazyBox</em></strong></a><div class="date" title="2010-08-12 07:33"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom99369">
<div class="phpcode"><code><span class="html">
There are quite a few questions regarding how file descriptors get handled when processes are forked. <br><br>Remember that fork() makes a copy of the program, which means all descriptors are copied. Unfortunately, this is a rather bad situation for a PHP program because most descriptors are handled by PHP or a PHP Extension internally.<br><br>The simple, and probably "proper" way to solve this issue is to fork before hand, there really should be no need to fork at many different points among a program, you would simply fork, and then delegate the work. Use a master/worker hierarchy.<br><br>For example, if you need to have many processes that use a MySQL Connection, just fork before the connection is made, that way each child has it´s own connection to mysql that it, and it alone, manages.<br><br>With careful and correct usage, fork() can be an extremely powerful tool.<br><br>--Please remember to take proper care of your children.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="114319">  
  <a class="name">
  <strong class="user"><em>John Nicholls</em></strong></a><div class="date" title="2014-02-06 09:52"><strong>6 months ago</strong></div>
  <div class="text" id="Hcom114319">
<div class="phpcode"><code><span class="html">
The notes on <a rel="nofollow" target="_blank">http://php.net/manual/en/function.posix-setsid.php</a> describe how you can avoid accruing countless zombie processes by a simple call to posix_setsid() when a child starts.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="106860">  
  <a class="name">
  <strong class="user"><em>kexianbin at diyism dot com</em></strong></a><div class="date" title="2011-12-12 11:17"><strong>2 years ago</strong></div>
  <div class="text" id="Hcom106860">
<div class="phpcode"><code><span class="html">
Fork in foreach:
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">foreach (</span><span class="default">$tasks </span><span class="keyword">as </span><span class="default">$v</span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; {if ((</span><span class="default">$pid</span><span class="keyword">=</span><span class="default">pcntl_fork</span><span class="keyword">())===-</span><span class="default">1</span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span><span class="comment">//...
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">continue;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else if (</span><span class="default">$pid</span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span><span class="default">pcntl_wait</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">, </span><span class="default">WNOHANG</span><span class="keyword">); </span><span class="comment">//protect against zombie children, one wait vs one child
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">}
<br>&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else if (</span><span class="default">$pid</span><span class="keyword">===</span><span class="default">0</span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {</span><span class="default">ob_start</span><span class="keyword">();</span><span class="comment">//prevent output to main process
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">register_shutdown_function</span><span class="keyword">(</span><span class="default">create_function</span><span class="keyword">(</span><span class="string">'$pars'</span><span class="keyword">, </span><span class="string">'ob_end_clean();posix_kill(getmypid(), SIGKILL);'</span><span class="keyword">), array());</span><span class="comment">//to kill self before exit();, or else the resource shared with parent will be closed
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //...
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">exit();</span><span class="comment">//avoid foreach loop in child process
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">}
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="106600">  
  <a class="name">
  <strong class="user"><em>nmmm at nmmm dot nu</em></strong></a><div class="date" title="2011-11-21 10:57"><strong>2 years ago</strong></div>
  <div class="text" id="Hcom106600">
<div class="phpcode"><code><span class="html">
It was driving me crazy that the script was killed couple of hours after I logged out, even I started it as:<br><br>php server.php &gt;&amp; logfile.txt<br><br>looks like PHP somehow interact with standard input, even I do not used it.<br><br>Solution was to start it with nohup:<br><br>nohup php server.php &gt;&amp; logfile.txt<br><br>or to do demonize / run as demon (e.g. fork() and close file descriptors)</span>
</code></div>
  </div>
 </div>
  <div class="note" id="70721">  
  <a class="name">
  <strong class="user"><em>amatsak at chestnutsoftware dot com</em></strong></a><div class="date" title="2006-10-25 02:06"><strong>7 years ago</strong></div>
  <div class="text" id="Hcom70721">
<div class="phpcode"><code><span class="html">
The reason for the MySQL "Lost Connection during query" issue when forking is the fact that the child process inherits the parent's database connection. When the child exits, the connection is closed. If the parent is performing a query at this very moment, it is doing it on an already closed connection, hence the error.
<br>
<br>An easy way to avoid this is to create a new database connection in parent immediately after forking. Don't forget to force a new connection by passing true in the 4th argument of mysql_connect():
<br>
<br><span class="default">&lt;?php
<br></span><span class="comment">// Create the MySQL connection
<br></span><span class="default">$db </span><span class="keyword">= </span><span class="default">mysql_connect</span><span class="keyword">(</span><span class="default">$server</span><span class="keyword">, </span><span class="default">$username</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">);
<br>
<br></span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br>if ( </span><span class="default">$pid </span><span class="keyword">== -</span><span class="default">1 </span><span class="keyword">) {&nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; </span><span class="comment">// Fork failed&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br>&nbsp; &nbsp; </span><span class="keyword">exit(</span><span class="default">1</span><span class="keyword">);
<br>} else if ( </span><span class="default">$pid </span><span class="keyword">) {
<br>&nbsp; &nbsp; </span><span class="comment">// We are the parent
<br>&nbsp; &nbsp; // Can no longer use $db because it will be closed by the child
<br>&nbsp; &nbsp; // Instead, make a new MySQL connection for ourselves to work with
<br>&nbsp; &nbsp; </span><span class="default">$db </span><span class="keyword">= </span><span class="default">mysql_connect</span><span class="keyword">(</span><span class="default">$server</span><span class="keyword">, </span><span class="default">$username</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);
<br>} else {
<br>&nbsp; &nbsp; </span><span class="comment">// We are the child
<br>&nbsp; &nbsp; // Do something with the inherited connection here
<br>&nbsp; &nbsp; // It will get closed upon exit
<br>&nbsp; &nbsp; </span><span class="keyword">exit(</span><span class="default">0</span><span class="keyword">);
<br></span><span class="default">?&gt;
<br></span>
<br>This way, the child will inherit the old connection, will work on it and will close upon exit. The parent won't care, because it will open a new connection for itself immediately after forking.
<br>
<br>Hope this helps.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="99350">  
  <a class="name">
  <strong class="user"><em>somebody</em></strong></a><div class="date" title="2010-08-12 03:46"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom99350">
<div class="phpcode"><code><span class="html">
you should be _very_ careful with using fork in scripts beyond academic examples,
<br>or rather just avoid it alltogether, unless you are very aware of it's limitations.
<br>
<br>the problem is that it just forks the whole php process, including not only
<br>the state of the script, but also the internal state of any extensions loaded.
<br>this means that all memory is copied, but all file descriptors are shared among
<br>the parent and child processes.
<br>and that can cause major havoc if some extension internally maintains
<br>file descriptors.
<br>the primary example is ofcourse mysql, but this could be any extensions that
<br>maintains open files or network sockets.
<br>also, just reopening your connection in the parent or child isn't a safe
<br>method, because when the old connection resource is destroyed, the extension
<br>might not just close it, but for example send a request to the server to log
<br>off, making the connection unusable.
<br>this happens with mysql for example, when php exits - in the following script the query will always fail with "MySQL server has gone away":
<br>
<br><span class="default">&lt;?php
<br>mysql_connect</span><span class="keyword">(</span><span class="comment">/* enter a working server here maybe? */</span><span class="keyword">);
<br>if(</span><span class="default">pcntl_fork</span><span class="keyword">()) die(); </span><span class="comment">// fork a child and have the parent terminate
<br>//if(pcntl_fork()) posix_kill(getmypid(),9); // works, but very ugly
<br></span><span class="default">$r</span><span class="keyword">=</span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"select 1;"</span><span class="keyword">);
<br>if(!</span><span class="default">$r</span><span class="keyword">)die(</span><span class="default">mysql_error</span><span class="keyword">().</span><span class="string">"\n"</span><span class="keyword">);
<br></span><span class="default">?&gt;
<br></span>(it was suggested that processes kill themselves with SIGKILL to avoid any cleanup on shutdown)
<br>
<br>(the only save way would be to close all connections and reopen them after the fork, and even that might not be possible if an extension keeps one open internally)
<br>
<br>for a nice demonstration of the havoc fork can create, try the below script.
<br>it opens a mysql connection, then forks, and runs queries from both parent and child,
<br>verifying that it receives the correct result.
<br>run it (on the cli preferably) a few times, and you will find various possible
<br>results:
<br>- very often is just hangs and doesn't output anything anymore
<br>- also very often, the server closes the connection, probably because it
<br>&nbsp; receives interleaved requests it can't process.
<br>- sometimes one process gets the result of the OTHER processes'
<br>&nbsp; query! (because both send their queries down the same socket,
<br>&nbsp; and it's pure luck who gets the reply)
<br>
<br><span class="default">&lt;?php
<br>mysql_connect</span><span class="keyword">(</span><span class="comment">/* enter a working server here maybe? */</span><span class="keyword">);
<br></span><span class="default">$f</span><span class="keyword">=</span><span class="default">pcntl_fork</span><span class="keyword">();
<br>while(</span><span class="default">true</span><span class="keyword">){
<br>&nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">10</span><span class="keyword">)/</span><span class="default">100</span><span class="keyword">);
<br>&nbsp; &nbsp; </span><span class="default">$r</span><span class="keyword">=</span><span class="default">mysql_query</span><span class="keyword">(</span><span class="string">"select </span><span class="default">$f</span><span class="string">;"</span><span class="keyword">);
<br>&nbsp; &nbsp; if(!</span><span class="default">$r</span><span class="keyword">)die(</span><span class="default">$f</span><span class="keyword">.</span><span class="string">": "</span><span class="keyword">.</span><span class="default">mysql_error</span><span class="keyword">().</span><span class="string">"\n"</span><span class="keyword">);
<br>&nbsp; &nbsp; list(</span><span class="default">$x</span><span class="keyword">)=</span><span class="default">mysql_fetch_array</span><span class="keyword">(</span><span class="default">$r</span><span class="keyword">);
<br>&nbsp; &nbsp; echo (</span><span class="default">$f</span><span class="keyword">)?</span><span class="string">"."</span><span class="keyword">:</span><span class="string">"-"</span><span class="keyword">;
<br>&nbsp; &nbsp; if(</span><span class="default">$x</span><span class="keyword">!=</span><span class="default">$f</span><span class="keyword">) echo (</span><span class="default">$f</span><span class="keyword">.</span><span class="string">": fail: </span><span class="default">$x</span><span class="string">!=</span><span class="default">$f</span><span class="string">\n "</span><span class="keyword">);
<br>}
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="94708">  
  <a class="name">
  <strong class="user"><em>Anonymous</em></strong></a><div class="date" title="2009-11-19 10:12"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom94708">
<div class="phpcode"><code><span class="html">
With regards to the database connection, one could deal with this using kill 9 or a sleep, the real problem is if two threads make a database query at the same time, PHP starts having random database errors that are not necessarily clear as to what the problem is.<br><br>You should create a separate link per thread.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="93466">  
  <a class="name">
  <strong class="user"><em>php at mx dot magic-lamp dot org</em></strong></a><div class="date" title="2009-09-11 01:31"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom93466">
<div class="phpcode"><code><span class="html">
A workaround for the MySQL "Lost Connection during query", or any other object related problems caused by children exiting is to force the child to kill -9 itself, thus avoiding any cleanup.&nbsp; Sure - it's not too elegant, but it does work.<br><br><span class="default">&lt;?php<br>$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();<br>if ( </span><span class="default">$pid </span><span class="keyword">== </span><span class="default">0 </span><span class="keyword">) {<br>&nbsp; &nbsp; </span><span class="comment">// This is the child process.&nbsp; Do something here.<br>&nbsp; &nbsp; // Instead of calling exit(), we use posix_kill()<br>&nbsp; &nbsp; </span><span class="default">posix_kill</span><span class="keyword">(</span><span class="default">getmypid</span><span class="keyword">(),</span><span class="default">9</span><span class="keyword">);<br>}<br></span><span class="default">?&gt;<br></span><br>Watch out that you don't spawn too many processes though as this creates its own problems.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="93089">  
  <a class="name">
  <strong class="user"><em>drrota at us dot ibm dot com</em></strong></a><div class="date" title="2009-08-22 03:47"><strong>5 years ago</strong></div>
  <div class="text" id="Hcom93089">
<div class="phpcode"><code><span class="html">
I was able to get around the problem of not being able to run fork and exec from Apache php.<br><br>I got around this by calling the system 'at' command on Linux.&nbsp; "at run something now".&nbsp; and you have to set atrun -s in a crontab file (to run every minute) to insure that things get kicked off quickly even if there is a heavy load on the machine.<br><br>If you're the only one running batch jobs on a linux box, this works.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="79439">  
  <a class="name">
  <strong class="user"><em>kentmussell at mindspring dot com</em></strong></a><div class="date" title="2007-11-27 10:05"><strong>6 years ago</strong></div>
  <div class="text" id="Hcom79439">
<div class="phpcode"><code><span class="html">
Here is an interesting script I wrote.&nbsp; It demonstrates how pcntl_fork() might be used as a useful tool.<br><br><span class="default">&lt;?php<br></span><span class="comment">/* This script serves the purpose of testing an algorithm designed to:<br>a.) Compare password hashes, or try passwords efficiently where the time to try a single password is 10 seconds.&nbsp; <br>b.) Spawn threads to work simultaneously on comparing hashes.<br>c.) Restrict the number of threads open at a time.&nbsp; <br>*/<br>//checks for divisibility<br></span><span class="keyword">function </span><span class="default">divby</span><span class="keyword">(</span><span class="default">$num</span><span class="keyword">,</span><span class="default">$den</span><span class="keyword">) {<br>&nbsp; &nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">$num</span><span class="keyword">/</span><span class="default">$den</span><span class="keyword">;<br>&nbsp; &nbsp; </span><span class="default">$result2 </span><span class="keyword">= </span><span class="default">floor</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">);<br>&nbsp; &nbsp; if (</span><span class="default">$result </span><span class="keyword">== </span><span class="default">$result2</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">true</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; else {<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">false</span><span class="keyword">; <br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; }<br></span><span class="comment">//checks whether a period of time fits into 2 second intervals occuring every 10 seconds.&nbsp; Interval may increase or decrease in size to use more or less memory.&nbsp; <br></span><span class="keyword">function </span><span class="default">goodTime</span><span class="keyword">(</span><span class="default">$elapsed</span><span class="keyword">) {<br>&nbsp; &nbsp; </span><span class="default">$num </span><span class="keyword">= </span><span class="default">floor</span><span class="keyword">(</span><span class="default">$elapsed</span><span class="keyword">);<br>&nbsp; &nbsp; </span><span class="default">$num </span><span class="keyword">= </span><span class="default">$num</span><span class="keyword">/</span><span class="default">12</span><span class="keyword">;<br>&nbsp; &nbsp; </span><span class="default">$min </span><span class="keyword">= </span><span class="default">floor</span><span class="keyword">(</span><span class="default">$num</span><span class="keyword">);<br>&nbsp; &nbsp; </span><span class="default">$min </span><span class="keyword">= </span><span class="default">12</span><span class="keyword">*</span><span class="default">$min</span><span class="keyword">;<br>&nbsp; &nbsp; </span><span class="default">$max </span><span class="keyword">= </span><span class="default">$min</span><span class="keyword">+</span><span class="default">2</span><span class="keyword">;<br>&nbsp; &nbsp; if (</span><span class="default">$elapsed </span><span class="keyword">&gt;= </span><span class="default">$min </span><span class="keyword">&amp;&amp; </span><span class="default">$elapsed </span><span class="keyword">&lt;= </span><span class="default">$max</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="string">"yes"</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; else {<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="string">"no"</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; }<br><br></span><span class="default">$x </span><span class="keyword">= </span><span class="default">30</span><span class="keyword">; </span><span class="comment">//number of child threads<br></span><span class="default">$pid </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="comment">//needed to create first thread<br></span><span class="default">$xpass </span><span class="keyword">= </span><span class="default">md5</span><span class="keyword">(</span><span class="string">'29'</span><span class="keyword">);</span><span class="comment">//hash to crack<br></span><span class="default">$time </span><span class="keyword">= </span><span class="default">time</span><span class="keyword">();<br></span><span class="default">$i </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br></span><span class="comment">//parent spawns $x children.<br></span><span class="keyword">while (</span><span class="default">$i </span><span class="keyword">&lt;= </span><span class="default">$x</span><span class="keyword">) {<br>&nbsp; &nbsp; if (</span><span class="default">file_exists</span><span class="keyword">(</span><span class="string">'childcall.txt'</span><span class="keyword">)) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="string">'childcall.txt'</span><span class="keyword">);<br>&nbsp; &nbsp; &nbsp; &nbsp; exit;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; </span><span class="default">$elapsed </span><span class="keyword">= </span><span class="default">time</span><span class="keyword">()-</span><span class="default">$time</span><span class="keyword">;<br>&nbsp; &nbsp; </span><span class="comment">//children are only spawned during intervals occuring every 10 seconds leaving enough time for the previous batch of children to finish their task.<br>&nbsp; &nbsp; </span><span class="keyword">if (</span><span class="default">goodTime</span><span class="keyword">(</span><span class="default">$elapsed</span><span class="keyword">)==</span><span class="string">"yes"</span><span class="keyword">) {&nbsp; &nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//Are we the parent?<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if (</span><span class="default">$pid </span><span class="keyword">!= </span><span class="default">0</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//Give birth to a child.&nbsp; <br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//create a record of how many children have been birthed.<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$arr</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">$i</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$time2 </span><span class="keyword">= </span><span class="default">$elapsed</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//escort children out of the loop.<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if (</span><span class="default">$pid </span><span class="keyword">== </span><span class="default">0</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">$x</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$i</span><span class="keyword">++;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; }<br></span><span class="comment">//parent waits for children to finish playing. <br></span><span class="keyword">if (</span><span class="default">$pid</span><span class="keyword">) {<br>&nbsp; &nbsp; </span><span class="default">$value </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">;<br>&nbsp; &nbsp; while (!</span><span class="default">file_exists</span><span class="keyword">(</span><span class="string">'childcall.txt'</span><span class="keyword">)) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//wait<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">}<br>&nbsp; &nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="string">'childcall.txt'</span><span class="keyword">);<br>&nbsp; &nbsp; </span><span class="default">$time </span><span class="keyword">= </span><span class="default">time</span><span class="keyword">()+</span><span class="default">2</span><span class="keyword">;<br>&nbsp; &nbsp; while (</span><span class="default">time</span><span class="keyword">()&lt;</span><span class="default">$time</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">//wait<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">}<br>&nbsp; &nbsp; exit;<br>&nbsp; &nbsp; }<br></span><span class="comment">//children take turns finding the highest array value, and changing it to 0<br></span><span class="default">rsort</span><span class="keyword">(</span><span class="default">$arr</span><span class="keyword">);<br></span><span class="default">$value </span><span class="keyword">= </span><span class="default">max</span><span class="keyword">(</span><span class="default">$arr</span><span class="keyword">);<br></span><span class="default">$arr</span><span class="keyword">[</span><span class="default">$value</span><span class="keyword">] = </span><span class="default">0</span><span class="keyword">;<br></span><span class="default">$time </span><span class="keyword">= </span><span class="default">time</span><span class="keyword">()+</span><span class="default">10</span><span class="keyword">;<br></span><span class="comment">//simulate delay<br></span><span class="keyword">while (</span><span class="default">time</span><span class="keyword">() &lt; </span><span class="default">$time</span><span class="keyword">) {<br>&nbsp; &nbsp; </span><span class="comment">//wait<br>&nbsp; &nbsp; </span><span class="keyword">}<br></span><span class="comment">//compare the high array value hash to the hash we are looking to crack.<br></span><span class="keyword">if (</span><span class="default">md5</span><span class="keyword">(</span><span class="default">$value</span><span class="keyword">) == </span><span class="default">$xpass</span><span class="keyword">) {<br>&nbsp; &nbsp; echo </span><span class="string">"</span><span class="default">$value</span><span class="string"> \n"</span><span class="keyword">;<br>&nbsp; &nbsp; }<br>if (</span><span class="default">$value </span><span class="keyword">== </span><span class="default">$x </span><span class="keyword">|| </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$value</span><span class="keyword">) == </span><span class="default">$xpass</span><span class="keyword">) {<br>&nbsp; &nbsp; </span><span class="default">$file </span><span class="keyword">= </span><span class="string">"childcall.txt"</span><span class="keyword">;<br>&nbsp; &nbsp; </span><span class="default">$content </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br>&nbsp; &nbsp; </span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$file</span><span class="keyword">,</span><span class="default">$contents</span><span class="keyword">);<br>&nbsp; &nbsp; }<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="25492">  
  <a class="name">
  <strong class="user"><em>ben at gelbnet dot com</em></strong></a><div class="date" title="2002-09-25 03:54"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom25492">
<div class="phpcode"><code><span class="html">
I was writing a shell script to get input from a user, however, I needed my script to time out after a certain number of seconds if the user didn't enter enough data. The code below descibes the method I used. It's a little hairy but it does work.
<br>
<br>-Ben
<br>
<br>#!/home/ben/php/bin/php -q
<br><span class="default">&lt;?php
<br></span><span class="comment">//GLOBALS
<br></span><span class="default">$RETURN_CHAR </span><span class="keyword">= </span><span class="string">"\n"</span><span class="keyword">;
<br></span><span class="default">$TIMEOUT </span><span class="keyword">= </span><span class="default">5</span><span class="keyword">; </span><span class="comment">//number of seconds to timeout on input
<br></span><span class="default">$PID </span><span class="keyword">= </span><span class="default">getmypid</span><span class="keyword">();
<br></span><span class="default">$CHILD_PID </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;
<br>
<br></span><span class="comment">//Make sure program execution doesn't time out
<br></span><span class="default">set_time_limit</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);
<br>
<br>function </span><span class="default">set_timeout</span><span class="keyword">() {
<br>global </span><span class="default">$PID</span><span class="keyword">;
<br>global </span><span class="default">$CHILD_PID</span><span class="keyword">;
<br>global </span><span class="default">$TIMEOUT</span><span class="keyword">;
<br>
<br></span><span class="default">$CHILD_PID </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();
<br>if(</span><span class="default">$CHILD_PID </span><span class="keyword">== </span><span class="default">0</span><span class="keyword">) {
<br></span><span class="default">sleep</span><span class="keyword">(</span><span class="default">$TIMEOUT</span><span class="keyword">);
<br></span><span class="default">posix_kill</span><span class="keyword">(</span><span class="default">$PID</span><span class="keyword">, </span><span class="default">SIGTERM</span><span class="keyword">);
<br>exit;
<br>}
<br>}
<br>
<br>function </span><span class="default">clear_timeout</span><span class="keyword">() {
<br>global </span><span class="default">$CHILD_PID</span><span class="keyword">;
<br></span><span class="default">posix_kill</span><span class="keyword">(</span><span class="default">$CHILD_PID</span><span class="keyword">, </span><span class="default">SIGTERM</span><span class="keyword">);
<br>}
<br>
<br></span><span class="comment">// read_data()
<br>// gets a line of data from STDIN and returns it
<br></span><span class="keyword">function </span><span class="default">read_data</span><span class="keyword">() {
<br>
<br></span><span class="default">$in </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"php://stdin"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">);
<br></span><span class="default">set_timeout</span><span class="keyword">();
<br></span><span class="default">$in_string </span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">);
<br></span><span class="default">clear_timeout</span><span class="keyword">();
<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">);
<br>return </span><span class="default">$in_string</span><span class="keyword">;
<br>}
<br>
<br></span><span class="comment">// write_data($outstring)
<br>// writes data to STDOUT
<br></span><span class="keyword">function </span><span class="default">write_data</span><span class="keyword">(</span><span class="default">$outstring</span><span class="keyword">) {
<br></span><span class="default">$out </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"php://stdout"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);
<br></span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">, </span><span class="default">$outstring</span><span class="keyword">);
<br></span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">);
<br>}
<br>
<br>while(</span><span class="default">1</span><span class="keyword">) {
<br></span><span class="default">write_data</span><span class="keyword">(</span><span class="string">"say something-&gt;"</span><span class="keyword">);
<br></span><span class="default">$input </span><span class="keyword">= </span><span class="default">read_data</span><span class="keyword">();
<br></span><span class="default">write_data</span><span class="keyword">(</span><span class="default">$RETURN_CHAR</span><span class="keyword">.</span><span class="default">$input</span><span class="keyword">);
<br>}
<br>
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="69198">  
  <a class="name">
  <strong class="user"><em>xuecan at google dot com</em></strong></a><div class="date" title="2006-08-26 09:59"><strong>8 years ago</strong></div>
  <div class="text" id="Hcom69198">
<div class="phpcode"><code><span class="html">
I think this simple code can help understand how fork works:
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">echo </span><span class="string">"posix_getpid()="</span><span class="keyword">.</span><span class="default">posix_getpid</span><span class="keyword">().</span><span class="string">", posix_getppid()="</span><span class="keyword">.</span><span class="default">posix_getppid</span><span class="keyword">().</span><span class="string">"\n"</span><span class="keyword">;
<br>
<br></span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();
<br>if (</span><span class="default">$pid </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">) die(</span><span class="string">"could not fork"</span><span class="keyword">);
<br>if (</span><span class="default">$pid</span><span class="keyword">) {
<br>&nbsp; &nbsp; echo </span><span class="string">"pid="</span><span class="keyword">.</span><span class="default">$pid</span><span class="keyword">.</span><span class="string">", posix_getpid()="</span><span class="keyword">.</span><span class="default">posix_getpid</span><span class="keyword">().</span><span class="string">", posix_getppid()="</span><span class="keyword">.</span><span class="default">posix_getppid</span><span class="keyword">().</span><span class="string">"\n"</span><span class="keyword">;
<br>} else {
<br>&nbsp; &nbsp; echo </span><span class="string">"pid="</span><span class="keyword">.</span><span class="default">$pid</span><span class="keyword">.</span><span class="string">", posix_getpid()="</span><span class="keyword">.</span><span class="default">posix_getpid</span><span class="keyword">().</span><span class="string">", posix_getppid()="</span><span class="keyword">.</span><span class="default">posix_getppid</span><span class="keyword">().</span><span class="string">"\n"</span><span class="keyword">;
<br>}
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div></div>

 
</section>    </section><!-- layout-content -->
        


  </div><!-- layout -->
         
  

    
 <!-- External and third party libraries. -->
 







<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top%402x.png"></a>



<!-- Mirrored from php.net/manual/en/function.pcntl-fork.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 16:35:40 GMT -->


</body></html>