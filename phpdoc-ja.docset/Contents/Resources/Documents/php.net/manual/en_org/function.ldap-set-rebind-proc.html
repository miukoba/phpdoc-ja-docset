<html><!-- Mirrored from php.net/manual/en/function.ldap-set-rebind-proc.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 16:44:52 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

  <title>ldap_set_rebind_proc</title>

 <link rel="shortcut icon" href="../../favicon.ico">
 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="function.ldap-set-rebind-proc.html">
 <link rel="shorturl" href="http://php.net/ldap-set-rebind-proc">
 <link rel="alternate" href="http://php.net/ldap-set-rebind-proc" hreflang="x-default">

 <link rel="contents" href="index-2.html">
 <link rel="index" href="ref.ldap.html">
 <link rel="prev" href="function.ldap-set-option.html">
 <link rel="next" href="function.ldap-sort.html">

 <link rel="alternate" href="function.ldap-set-rebind-proc.html" hreflang="en">
 <link rel="alternate" href="http://php.net/manual/pt_BR/function.ldap-set-rebind-proc.php" hreflang="pt_BR">
 <link rel="alternate" href="http://php.net/manual/zh/function.ldap-set-rebind-proc.php" hreflang="zh">
 <link rel="alternate" href="http://php.net/manual/fr/function.ldap-set-rebind-proc.php" hreflang="fr">
 <link rel="alternate" href="http://php.net/manual/de/function.ldap-set-rebind-proc.php" hreflang="de">
 <link rel="alternate" href="http://php.net/manual/it/function.ldap-set-rebind-proc.php" hreflang="it">
 <link rel="alternate" href="http://php.net/manual/ja/function.ldap-set-rebind-proc.php" hreflang="ja">
 <link rel="alternate" href="http://php.net/manual/ro/function.ldap-set-rebind-proc.php" hreflang="ro">
 <link rel="alternate" href="http://php.net/manual/ru/function.ldap-set-rebind-proc.php" hreflang="ru">
 <link rel="alternate" href="http://php.net/manual/es/function.ldap-set-rebind-proc.php" hreflang="es">
 <link rel="alternate" href="http://php.net/manual/tr/function.ldap-set-rebind-proc.php" hreflang="tr">

<link rel="stylesheet" type="text/css" href="../../cached8fe1.css?t=1401250819&amp;f=/fonts/Fira/fira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached4b8d.css?t=1404368420&amp;f=/fonts/Font-Awesome/css/fontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached5065.css?t=1403329232&amp;f=/styles/theme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cachedc78d.css?t=1401249623&amp;f=/styles/theme-medium.css" media="screen">

 <!--[if lte IE 7]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie7.css" media="screen">
 <![endif]-->

 <!--[if lte IE 8]>
 <script type="text/javascript">
  window.brokenIE = true;
 </script>
 <![endif]-->

 <!--[if lte IE 9]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie9.css" media="screen">
 <![endif]-->

 <!--[if IE]>
 <script type="text/javascript" src="http://php.net/js/ext/html5.js"></script>
 <![endif]-->

 <base>

</head>
<body class="docs " style="">


<div class="headsup"><a href="http://php.net/index.php#id2014-08-28-1">PHP 5.6.0 released</a></div>
<nav id="trick"><div><dl>
<dt><a href="getting-started.html">Getting Started</a></dt>
	<dd><a href="introduction.html">Introduction</a></dd>
	<dd><a href="tutorial.html">A simple tutorial</a></dd>
<dt><a href="langref.html">Language Reference</a></dt>
	<dd><a href="language.basic-syntax.html">Basic syntax</a></dd>
	<dd><a href="language.types.html">Types</a></dd>
	<dd><a href="language.variables.html">Variables</a></dd>
	<dd><a href="language.constants.html">Constants</a></dd>
	<dd><a href="language.expressions.html">Expressions</a></dd>
	<dd><a href="language.operators.html">Operators</a></dd>
	<dd><a href="language.control-structures.html">Control Structures</a></dd>
	<dd><a href="language.functions.html">Functions</a></dd>
	<dd><a href="language.oop5.html">Classes and Objects</a></dd>
	<dd><a href="language.namespaces.html">Namespaces</a></dd>
	<dd><a href="language.exceptions.html">Exceptions</a></dd>
	<dd><a href="language.generators.html">Generators</a></dd>
	<dd><a href="language.references.html">References Explained</a></dd>
	<dd><a href="reserved.variables.html">Predefined Variables</a></dd>
	<dd><a href="reserved.exceptions.html">Predefined Exceptions</a></dd>
	<dd><a href="reserved.interfaces.html">Predefined Interfaces and Classes</a></dd>
	<dd><a href="context.html">Context options and parameters</a></dd>
	<dd><a href="wrappers.html">Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href="security.html">Security</a></dt>
	<dd><a href="security.intro.html">Introduction</a></dd>
	<dd><a href="security.general.html">General considerations</a></dd>
	<dd><a href="security.cgi-bin.html">Installed as CGI binary</a></dd>
	<dd><a href="security.apache.html">Installed as an Apache module</a></dd>
	<dd><a href="security.filesystem.html">Filesystem Security</a></dd>
	<dd><a href="security.database.html">Database Security</a></dd>
	<dd><a href="security.errors.html">Error Reporting</a></dd>
	<dd><a href="security.globals.html">Using Register Globals</a></dd>
	<dd><a href="security.variables.html">User Submitted Data</a></dd>
	<dd><a href="security.magicquotes.html">Magic Quotes</a></dd>
	<dd><a href="security.hiding.html">Hiding PHP</a></dd>
	<dd><a href="security.current.html">Keeping Current</a></dd>
<dt><a href="features.html">Features</a></dt>
	<dd><a href="features.http-auth.html">HTTP authentication with PHP</a></dd>
	<dd><a href="features.cookies.html">Cookies</a></dd>
	<dd><a href="features.sessions.html">Sessions</a></dd>
	<dd><a href="features.xforms.html">Dealing with XForms</a></dd>
	<dd><a href="features.file-upload.html">Handling file uploads</a></dd>
	<dd><a href="features.remote-files.html">Using remote files</a></dd>
	<dd><a href="features.connection-handling.html">Connection handling</a></dd>
	<dd><a href="features.persistent-connections.html">Persistent Database Connections</a></dd>
	<dd><a href="features.safe-mode.html">Safe Mode</a></dd>
	<dd><a href="features.commandline.html">Command line usage</a></dd>
	<dd><a href="features.gc.html">Garbage Collection</a></dd>
	<dd><a href="features.dtrace.html">DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href="funcref.html">Function Reference</a></dt>
	<dd><a href="refs.basic.php.html">Affecting PHP's Behaviour</a></dd>
	<dd><a href="refs.utilspec.audio.html">Audio Formats Manipulation</a></dd>
	<dd><a href="refs.remote.auth.html">Authentication Services</a></dd>
	<dd><a href="refs.utilspec.cmdline.html">Command Line Specific Extensions</a></dd>
	<dd><a href="refs.compression.html">Compression and Archive Extensions</a></dd>
	<dd><a href="refs.creditcard.html">Credit Card Processing</a></dd>
	<dd><a href="refs.crypto.html">Cryptography Extensions</a></dd>
	<dd><a href="refs.database.html">Database Extensions</a></dd>
	<dd><a href="refs.calendar.html">Date and Time Related Extensions</a></dd>
	<dd><a href="refs.fileprocess.file.html">File System Related Extensions</a></dd>
	<dd><a href="refs.international.html">Human Language and Character Encoding Support</a></dd>
	<dd><a href="refs.utilspec.image.html">Image Processing and Generation</a></dd>
	<dd><a href="refs.remote.mail.html">Mail Related Extensions</a></dd>
	<dd><a href="refs.math.html">Mathematical Extensions</a></dd>
	<dd><a href="refs.utilspec.nontext.html">Non-Text MIME Output</a></dd>
	<dd><a href="refs.fileprocess.process.html">Process Control Extensions</a></dd>
	<dd><a href="refs.basic.other.html">Other Basic Extensions</a></dd>
	<dd><a href="refs.remote.other.html">Other Services</a></dd>
	<dd><a href="refs.search.html">Search Engine Extensions</a></dd>
	<dd><a href="refs.utilspec.server.html">Server Specific Extensions</a></dd>
	<dd><a href="refs.basic.session.html">Session Extensions</a></dd>
	<dd><a href="refs.basic.text.html">Text Processing</a></dd>
	<dd><a href="refs.basic.vartype.html">Variable and Type Related Extensions</a></dd>
	<dd><a href="refs.webservice.html">Web Services</a></dd>
	<dd><a href="refs.utilspec.windows.html">Windows Only Extensions</a></dd>
	<dd><a href="refs.xml.html">XML Manipulation</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="row-fluid">
          
              
        <ul class="breadcrumbs-container">
            <li><a href="index-2.html">PHP Manual</a></li>      <li><a href="funcref.html">Function Reference</a></li>      <li><a href="refs.remote.other.html">Other Services</a></li>      <li><a href="book.ldap.html">LDAP</a></li>      <li><a href="ref.ldap.html">LDAP Functions</a></li>    </ul>
  </div>




<div id="layout">
  <section id="layout-content">
  <div id="function.ldap-set-rebind-proc" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">ldap_set_rebind_proc</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.2.0, PHP 5)</p><p class="refpurpose"><span class="refname">ldap_set_rebind_proc</span> â€” <span class="dc-title">Set a callback function to do re-binds on referral chasing</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.ldap-set-rebind-proc-description">
  <h3 class="title">Description</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>ldap_set_rebind_proc</strong></span>
    ( <span class="methodparam"><span class="type">resource</span> <code class="parameter">$link</code></span>
   , <span class="methodparam"><span class="type"><a href="language.types.callable.html" class="type callable">callable</a></span> <code class="parameter">$callback</code></span>
   )</div>

  <div class="warning"><strong class="warning">Warning</strong><p class="simpara">This function is
currently not documented; only its argument list is available.
</p></div>
 </div>


</div>
<section id="usernotes">
 <div class="head"><h3 class="title">User Contributed Notes</h3></div><div id="allnotes">
  <div class="note" id="111417">  
  <a class="name">
  <strong class="user"><em>mvanbeek at forgetaboutit dot net</em></strong></a><div class="date" title="2013-02-18 12:15"><strong>1 year ago</strong></div>
  <div class="text" id="Hcom111417">
<div class="phpcode"><code><span class="html">
The $referral that is used in the callback function isn't the bind dn, but the dn of the record that was being accessed (or rather it's location on the master server, I guess, if there is a difference in the two), so you need to rebind with your existing credentials. The connection ($ldap) appears to have already been made to the new server, so it is just a rebind process, nothing else more complicated than that. There must be a loop in the underlying library that re-submits the request that prompted the referral until either a success or fail is returned.
<br>
<br>I guess if the bind dn you were using in the first place won't let you edit the record on the master, then that is an ldap rather than php issue. However, at least with the rebind procedure you have a way to modify the bind dn first.
<br>
<br>So, the rebind process is really quite simple, now that I understand how it works! I was assuming it to be way more complicated. In it's simplest form, this is all you need, assuming your bind $dn and $pass are globals
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">function </span><span class="default">rebind</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">$referral</span><span class="keyword">) {
<br>&nbsp; &nbsp; </span><span class="comment">// Set ldap options
<br>&nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);
<br>&nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">, </span><span class="default">True</span><span class="keyword">);
<br>&nbsp; &nbsp; </span><span class="default">ldap_set_rebind_proc</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="string">'rebind'</span><span class="keyword">);
<br>&nbsp; &nbsp; </span><span class="comment">// Rebind
<br>&nbsp; &nbsp; </span><span class="keyword">if (!</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">$dn</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">)) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">'Could not bind to referral server'</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">1</span><span class="keyword">; </span><span class="comment">// Yes, a 1 means a failure.
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">}
<br>&nbsp; &nbsp; return </span><span class="default">0</span><span class="keyword">; </span><span class="comment">// Yes, return a 0 on success.
<br>&nbsp; &nbsp; </span><span class="keyword">}
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="104606">  
  <a class="name">
  <strong class="user"><em>leon at leonux dot co dot za</em></strong></a><div class="date" title="2011-06-25 03:26"><strong>3 years ago</strong></div>
  <div class="text" id="Hcom104606">
<div class="phpcode"><code><span class="html">
I finally have referrals working using the ldap_set_rebind_proc function. Don't connect to the referral server in your callback function. This is done for you. You only have to bind. The callback must return 0 if the bind succeeds or 1 if it fails. <br><br>Consider a master - slave LDAP setup where the slave is read-only and refers writes to the master. For the PHP on the slave, you need something like this:<br><br><span class="default">&lt;?php<br><br></span><span class="comment">// Callback function<br></span><span class="keyword">function </span><span class="default">rebind</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">$referral</span><span class="keyword">) {<br>&nbsp; &nbsp; </span><span class="comment">// ldap options<br>&nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);<br>&nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">, </span><span class="default">True</span><span class="keyword">);<br>&nbsp; &nbsp; </span><span class="default">ldap_set_rebind_proc</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="string">'rebind'</span><span class="keyword">);<br>&nbsp; &nbsp; </span><span class="comment">// The referral is of the form:<br>&nbsp; &nbsp; //&nbsp; ldaps://newhost/cn=user,ou=people,dc=example,dc=com<br>&nbsp; &nbsp; </span><span class="default">$refparts </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">'/'</span><span class="keyword">, </span><span class="default">$referral</span><span class="keyword">);<br>&nbsp; &nbsp; if (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$refparts</span><span class="keyword">) &gt; </span><span class="default">2</span><span class="keyword">) {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Get the bind dn from referral<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$dn </span><span class="keyword">= </span><span class="default">$refparts</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">];<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Bind to new host<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if (!</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">$dn</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">)) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">'Could not bind to referral server'</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">1</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; } else {<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// Try anonymous bind<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if (!</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">)) {<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">'Could not bind to referral server anonymously'</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">1</span><span class="keyword">;<br>&nbsp; &nbsp; &nbsp; &nbsp; }<br>&nbsp; &nbsp; }<br>&nbsp; &nbsp; return </span><span class="default">0</span><span class="keyword">;<br>}<br>&nbsp; &nbsp; <br></span><span class="comment">// Initial ldap connection to slave server<br></span><span class="default">$ldap_host </span><span class="keyword">= </span><span class="string">'localhost'<br></span><span class="default">$ds </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$ldap_host</span><span class="keyword">);<br></span><span class="comment">// ldap options<br></span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">)<br></span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">, </span><span class="default">True</span><span class="keyword">)<br></span><span class="comment">// Set callback function<br></span><span class="default">ldap_set_rebind_proc</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="string">'rebind'</span><span class="keyword">))<br></span><span class="comment">// bind<br></span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="default">$dn</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">)<br></span><span class="comment">// ldap write<br></span><span class="default">ldap_modify</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="default">$dn</span><span class="keyword">, </span><span class="default">$attr</span><span class="keyword">);<br><br></span><span class="default">?&gt;<br></span><br>Accessing passwords and other data from your callback is easier if you use a class method as the callback function. The callback would be initialized like this:<br><br><span class="default">&lt;?php<br><br>ldap_set_rebind_proc</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="string">'MyClass::rebind'</span><span class="keyword">);<br><br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="102653">  
  <a class="name">
  <strong class="user"><em>Anonymous</em></strong></a><div class="date" title="2011-02-26 11:40"><strong>3 years ago</strong></div>
  <div class="text" id="Hcom102653">
<div class="phpcode"><code><span class="html">
I have now spent enough time looking at this issue to say that ldap referrals, at least when trying to add, modify or delete a record on a slave server that correctly gives a referral to a master server, does not work in php. My suggestion is turn turn off ldap referrals and write your own add, modify and delete functions with built in referral handling. Something like this:
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">function </span><span class="default">ldap_referral_add</span><span class="keyword">(</span><span class="default">$connection</span><span class="keyword">,</span><span class="default">$add_dn</span><span class="keyword">,</span><span class="default">$Add_entry</span><span class="keyword">,</span><span class="default">$bind_dn</span><span class="keyword">,</span><span class="default">$bind_pw</span><span class="keyword">)
<br>&nbsp; &nbsp; {
<br>&nbsp; &nbsp; </span><span class="default">$rconnection </span><span class="keyword">= </span><span class="default">$connection</span><span class="keyword">;
<br>&nbsp; &nbsp; </span><span class="default">$loop </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">; </span><span class="comment"># max number of referral hops.
<br>&nbsp; &nbsp; # Turn off normal referrals
<br>&nbsp; &nbsp; </span><span class="default">ldap_get_option</span><span class="keyword">(</span><span class="default">$connection</span><span class="keyword">,</span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">,</span><span class="default">$old_referral_setting</span><span class="keyword">)
<br>&nbsp; &nbsp; do
<br>&nbsp; &nbsp; &nbsp; &nbsp; {
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$response </span><span class="keyword">= </span><span class="default">ldap_add</span><span class="keyword">(</span><span class="default">$rconnection</span><span class="keyword">,</span><span class="default">$dn</span><span class="keyword">,</span><span class="default">$entry</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment"># We get a success message:
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if ( </span><span class="default">$response </span><span class="keyword">) 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_unbind</span><span class="keyword">(</span><span class="default">$rconnection</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$loop </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment"># Probably not needed
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$connection</span><span class="keyword">,</span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">,</span><span class="default">$old_referral_setting</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">true</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment"># We get a referral message:
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">elseif ( !</span><span class="default">$response </span><span class="keyword">&amp;&amp; </span><span class="default">ldap_errno</span><span class="keyword">(</span><span class="default">$rconnection</span><span class="keyword">) == </span><span class="default">0x0a </span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$new_server_url </span><span class="keyword">= </span><span class="default">$server</span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'!^(ldap://[^/]+)/.*$!'</span><span class="keyword">, </span><span class="string">'\\1'</span><span class="keyword">, </span><span class="default">$ldap_error</span><span class="keyword">(</span><span class="default">$rconnection</span><span class="keyword">)); </span><span class="comment"># May need some sanity checking here
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$rconnection </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$new_server_url</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$rconnection</span><span class="keyword">,</span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$rconnection</span><span class="keyword">,</span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">)
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$rconnection</span><span class="keyword">,</span><span class="default">$bind_dn</span><span class="keyword">,</span><span class="default">$bind_pw</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$loop </span><span class="keyword">= </span><span class="default">$loop </span><span class="keyword">- </span><span class="default">1</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; else 
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; {
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_unbind</span><span class="keyword">(</span><span class="default">$rconnection</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$loop </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment"># Probably not needed
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$connection</span><span class="keyword">,</span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">,</span><span class="default">$old_referral_setting</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">false</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; } while ( </span><span class="default">$loop </span><span class="keyword">&gt; </span><span class="default">0</span><span class="keyword">);
<br>&nbsp; &nbsp; }
<br></span><span class="default">?&gt;</span>
</span>
</code></div>
  </div>
 </div>
  <div class="note" id="98432">  
  <a class="name">
  <strong class="user"><em>mvanbeek at forgetaboutit dot net</em></strong></a><div class="date" title="2010-06-15 11:13"><strong>4 years ago</strong></div>
  <div class="text" id="Hcom98432">
<div class="phpcode"><code><span class="html">
I have had quite a hard time finding good information about chasing referrals so I am adding my tuppence worth here. I still haven't got my test code working fully so please look further down the page for updates.
<br>
<br>The way this appears to have to work is that you use this function to set a callback function of your own to connect and bind to the referral server. you need to set this along with forcing v3 ldap and setting the referral chasing to on as part of setting up the initial connection, so just after the connect but before the bind, you need something like:
<br>
<br><span class="default">&lt;?php
<br>&nbsp; &nbsp; &nbsp; &nbsp; $ds </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$server</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_set_rebind_proc</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="string">"rebind"</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">,</span><span class="default">$dn</span><span class="keyword">,</span><span class="default">$pass</span><span class="keyword">);
<br></span><span class="default">?&gt;
<br></span>
<br>This callback function (called rebind in the above example needs two arguments. These arguments are preset and are supplied when the callback function is called. The first is the ldap link identifier. I assume this is supplied as the function could be used successively by a number of consecutive referrals. The second is the ldap referral URL supplied by the initial server. I have seen notes that say this function must be defined prior to being set by ldap_set_rebind_proc, but as yet I cannot confirm this.
<br>
<br>My setup is based on a master - slave ldap server configuration, with the PHP application residing on the slave where it does localhost lookups. When your try to write to the slave ldap server, the server returns a referral URL, and the internal PHP function then calls the callback function.
<br>
<br>Despite the code already on this page, which appears to also be used to test the PHP code, I believe it is wrong. I think it simply reconnects to the initial server. I believe that what the callback function should do is to connect to the new server, and bind to it. My test code currently looks like this:
<br>
<br><span class="default">&lt;?php
<br></span><span class="keyword">function </span><span class="default">rebind</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">$referral</span><span class="keyword">) {
<br>&nbsp; &nbsp; &nbsp; &nbsp; global </span><span class="default">$dn</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; global </span><span class="default">$pass</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$server</span><span class="keyword">= </span><span class="default">preg_replace</span><span class="keyword">(</span><span class="string">'!^(ldap://[^/]+)/.*$!'</span><span class="keyword">, </span><span class="string">'\\1'</span><span class="keyword">, </span><span class="default">$referral</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; if (!(</span><span class="default">$ldap </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$server</span><span class="keyword">))){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">"reconnect failed - &lt;br&gt;"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">1</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">LDAP_OPT_PROTOCOL_VERSION</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_set_option</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="default">LDAP_OPT_REFERRALS</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">ldap_set_rebind_proc</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">, </span><span class="string">"rebind"</span><span class="keyword">);
<br>&nbsp; &nbsp; &nbsp; &nbsp; if (!</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ldap</span><span class="keyword">,</span><span class="default">$dn</span><span class="keyword">,</span><span class="default">$pass</span><span class="keyword">)){
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo </span><span class="string">"rebind failed - &lt;br&gt;"</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">1</span><span class="keyword">;
<br>&nbsp; &nbsp; &nbsp; &nbsp; }
<br>&nbsp; &nbsp; &nbsp; &nbsp; return </span><span class="default">0</span><span class="keyword">;
<br>}
<br></span><span class="default">?&gt;
<br></span>
<br>As far as I can tell, a return value of 0 means success and any other value means it has failed. The complete lack of documentation doesn't help.
<br>
<br>The above code works all the way to authenticating against the new server, but at the moment I appear to be getting an unbind request before it tries to write the record to the new server, so it fails.
<br>
<br>I would also recommend adding a ldap_start_tls before the bind as well.</span>
</code></div>
  </div>
 </div>
  <div class="note" id="31731">  
  <a class="name">
  <strong class="user"><em>pearcec at commnav dot com</em></strong></a><div class="date" title="2003-05-01 04:09"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom31731">
<div class="phpcode"><code><span class="html">
PHP expects the ldap function ldap_set_rebind_proc to be the one that has tree parameters.&nbsp; As far as I can tell this isn't in the 2.0 release of OpenLDAP.&nbsp; But made it into 2.1.&nbsp; Configure will tell you<br><br>checking for 3 arg ldap_set_rebind_proc... no</span>
</code></div>
  </div>
 </div>
  <div class="note" id="30893">  
  <a class="name">
  <strong class="user"><em>night0wl at frost dot ath dot cx</em></strong></a><div class="date" title="2003-04-02 07:19"><strong>11 years ago</strong></div>
  <div class="text" id="Hcom30893">
<div class="phpcode"><code><span class="html">
Couse there was no example code for this function, i had alot of troubles to make it work properly. <br><br>So, here is working example:<br><br>function rebind_on_ref ($ds, $ldap_url) {<br>&nbsp; global $binddn;&nbsp; &nbsp; // DN used to bind<br>&nbsp; global $bindpw;&nbsp; &nbsp; // password used to bind<br><br>&nbsp; // required by most modern LDAP servers, use LDAPv3<br>&nbsp; ldap_set_option($a, LDAP_OPT_PROTOCOL_VERSION, 3);<br><br>&nbsp; if (!ldap_bind($a,$binddn,$bindpw)) {<br>&nbsp; &nbsp; &nbsp; &nbsp; print "Cannot bind";<br>&nbsp; }<br>}</span>
</code></div>
  </div>
 </div>
  <div class="note" id="21009">  
  <a class="name">
  <strong class="user"><em>randy at kotmail dot com</em></strong></a><div class="date" title="2002-04-25 04:46"><strong>12 years ago</strong></div>
  <div class="text" id="Hcom21009">
<div class="phpcode"><code><span class="html">
If rebind_proc isn't compiled in slapd, your will never get that funtction working. Check out the new alpha release of slapd and rtfm.</span>
</code></div>
  </div>
 </div></div>

 
</section>    </section><!-- layout-content -->
        


  </div><!-- layout -->
         
  

    
 <!-- External and third party libraries. -->
 







<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top%402x.png"></a>



<!-- Mirrored from php.net/manual/en/function.ldap-set-rebind-proc.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 16:44:53 GMT -->


</body></html>