<html><!-- Mirrored from php.net/manual/en/internals2.memory.management.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 15:53:18 GMT --><!-- Added by HTTrack --><head><meta http-equiv="content-type" content="text/html;charset=utf-8"><!-- /Added by HTTrack -->


  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"> 

  <title>Basic memory management</title>

 <link rel="shortcut icon" href="../../favicon.ico">
 <link rel="search" type="application/opensearchdescription+xml" href="http://php.net/phpnetimprovedsearch.src" title="Add PHP.net search">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/releases/feed.php" title="PHP Release feed">
 <link rel="alternate" type="application/atom+xml" href="http://php.net/feed.atom" title="PHP: Hypertext Preprocessor">

 <link rel="canonical" href="internals2.memory.management.html">
 <link rel="shorturl" href="internals2.memory.management.html">
 <link rel="alternate" href="internals2.memory.management.html" hreflang="x-default">

 <link rel="contents" href="index-2.html">
 <link rel="index" href="internals2.memory.html">
 <link rel="prev" href="internals2.memory.html">
 <link rel="next" href="internals2.memory.persistence.html">

 <link rel="alternate" href="internals2.memory.management.html" hreflang="en">
 <link rel="alternate" href="http://php.net/manual/pt_BR/internals2.memory.management.php" hreflang="pt_BR">
 <link rel="alternate" href="http://php.net/manual/zh/internals2.memory.management.php" hreflang="zh">
 <link rel="alternate" href="http://php.net/manual/fr/internals2.memory.management.php" hreflang="fr">
 <link rel="alternate" href="http://php.net/manual/de/internals2.memory.management.php" hreflang="de">
 <link rel="alternate" href="http://php.net/manual/it/internals2.memory.management.php" hreflang="it">
 <link rel="alternate" href="http://php.net/manual/ja/internals2.memory.management.php" hreflang="ja">
 <link rel="alternate" href="http://php.net/manual/ro/internals2.memory.management.php" hreflang="ro">
 <link rel="alternate" href="http://php.net/manual/ru/internals2.memory.management.php" hreflang="ru">
 <link rel="alternate" href="http://php.net/manual/es/internals2.memory.management.php" hreflang="es">
 <link rel="alternate" href="http://php.net/manual/tr/internals2.memory.management.php" hreflang="tr">

<link rel="stylesheet" type="text/css" href="../../cached8fe1.css?t=1401250819&amp;f=/fonts/Fira/fira.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached4b8d.css?t=1404368420&amp;f=/fonts/Font-Awesome/css/fontello.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cached5065.css?t=1403329232&amp;f=/styles/theme-base.css" media="screen">
<link rel="stylesheet" type="text/css" href="../../cachedc78d.css?t=1401249623&amp;f=/styles/theme-medium.css" media="screen">

 <!--[if lte IE 7]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie7.css" media="screen">
 <![endif]-->

 <!--[if lte IE 8]>
 <script type="text/javascript">
  window.brokenIE = true;
 </script>
 <![endif]-->

 <!--[if lte IE 9]>
 <link rel="stylesheet" type="text/css" href="http://php.net/styles/workarounds.ie9.css" media="screen">
 <![endif]-->

 <!--[if IE]>
 <script type="text/javascript" src="http://php.net/js/ext/html5.js"></script>
 <![endif]-->

 <base>

</head>
<body class="docs " style="">


<div class="headsup"><a href="http://php.net/index.php#id2014-08-28-1">PHP 5.6.0 released</a></div>
<nav id="trick"><div><dl>
<dt><a href="getting-started.html">Getting Started</a></dt>
	<dd><a href="introduction.html">Introduction</a></dd>
	<dd><a href="tutorial.html">A simple tutorial</a></dd>
<dt><a href="langref.html">Language Reference</a></dt>
	<dd><a href="language.basic-syntax.html">Basic syntax</a></dd>
	<dd><a href="language.types.html">Types</a></dd>
	<dd><a href="language.variables.html">Variables</a></dd>
	<dd><a href="language.constants.html">Constants</a></dd>
	<dd><a href="language.expressions.html">Expressions</a></dd>
	<dd><a href="language.operators.html">Operators</a></dd>
	<dd><a href="language.control-structures.html">Control Structures</a></dd>
	<dd><a href="language.functions.html">Functions</a></dd>
	<dd><a href="language.oop5.html">Classes and Objects</a></dd>
	<dd><a href="language.namespaces.html">Namespaces</a></dd>
	<dd><a href="language.exceptions.html">Exceptions</a></dd>
	<dd><a href="language.generators.html">Generators</a></dd>
	<dd><a href="language.references.html">References Explained</a></dd>
	<dd><a href="reserved.variables.html">Predefined Variables</a></dd>
	<dd><a href="reserved.exceptions.html">Predefined Exceptions</a></dd>
	<dd><a href="reserved.interfaces.html">Predefined Interfaces and Classes</a></dd>
	<dd><a href="context.html">Context options and parameters</a></dd>
	<dd><a href="wrappers.html">Supported Protocols and Wrappers</a></dd>
</dl>
<dl>
<dt><a href="security.html">Security</a></dt>
	<dd><a href="security.intro.html">Introduction</a></dd>
	<dd><a href="security.general.html">General considerations</a></dd>
	<dd><a href="security.cgi-bin.html">Installed as CGI binary</a></dd>
	<dd><a href="security.apache.html">Installed as an Apache module</a></dd>
	<dd><a href="security.filesystem.html">Filesystem Security</a></dd>
	<dd><a href="security.database.html">Database Security</a></dd>
	<dd><a href="security.errors.html">Error Reporting</a></dd>
	<dd><a href="security.globals.html">Using Register Globals</a></dd>
	<dd><a href="security.variables.html">User Submitted Data</a></dd>
	<dd><a href="security.magicquotes.html">Magic Quotes</a></dd>
	<dd><a href="security.hiding.html">Hiding PHP</a></dd>
	<dd><a href="security.current.html">Keeping Current</a></dd>
<dt><a href="features.html">Features</a></dt>
	<dd><a href="features.http-auth.html">HTTP authentication with PHP</a></dd>
	<dd><a href="features.cookies.html">Cookies</a></dd>
	<dd><a href="features.sessions.html">Sessions</a></dd>
	<dd><a href="features.xforms.html">Dealing with XForms</a></dd>
	<dd><a href="features.file-upload.html">Handling file uploads</a></dd>
	<dd><a href="features.remote-files.html">Using remote files</a></dd>
	<dd><a href="features.connection-handling.html">Connection handling</a></dd>
	<dd><a href="features.persistent-connections.html">Persistent Database Connections</a></dd>
	<dd><a href="features.safe-mode.html">Safe Mode</a></dd>
	<dd><a href="features.commandline.html">Command line usage</a></dd>
	<dd><a href="features.gc.html">Garbage Collection</a></dd>
	<dd><a href="features.dtrace.html">DTrace Dynamic Tracing</a></dd>
</dl>
<dl>
<dt><a href="funcref.html">Function Reference</a></dt>
	<dd><a href="refs.basic.php.html">Affecting PHP's Behaviour</a></dd>
	<dd><a href="refs.utilspec.audio.html">Audio Formats Manipulation</a></dd>
	<dd><a href="refs.remote.auth.html">Authentication Services</a></dd>
	<dd><a href="refs.utilspec.cmdline.html">Command Line Specific Extensions</a></dd>
	<dd><a href="refs.compression.html">Compression and Archive Extensions</a></dd>
	<dd><a href="refs.creditcard.html">Credit Card Processing</a></dd>
	<dd><a href="refs.crypto.html">Cryptography Extensions</a></dd>
	<dd><a href="refs.database.html">Database Extensions</a></dd>
	<dd><a href="refs.calendar.html">Date and Time Related Extensions</a></dd>
	<dd><a href="refs.fileprocess.file.html">File System Related Extensions</a></dd>
	<dd><a href="refs.international.html">Human Language and Character Encoding Support</a></dd>
	<dd><a href="refs.utilspec.image.html">Image Processing and Generation</a></dd>
	<dd><a href="refs.remote.mail.html">Mail Related Extensions</a></dd>
	<dd><a href="refs.math.html">Mathematical Extensions</a></dd>
	<dd><a href="refs.utilspec.nontext.html">Non-Text MIME Output</a></dd>
	<dd><a href="refs.fileprocess.process.html">Process Control Extensions</a></dd>
	<dd><a href="refs.basic.other.html">Other Basic Extensions</a></dd>
	<dd><a href="refs.remote.other.html">Other Services</a></dd>
	<dd><a href="refs.search.html">Search Engine Extensions</a></dd>
	<dd><a href="refs.utilspec.server.html">Server Specific Extensions</a></dd>
	<dd><a href="refs.basic.session.html">Session Extensions</a></dd>
	<dd><a href="refs.basic.text.html">Text Processing</a></dd>
	<dd><a href="refs.basic.vartype.html">Variable and Type Related Extensions</a></dd>
	<dd><a href="refs.webservice.html">Web Services</a></dd>
	<dd><a href="refs.utilspec.windows.html">Windows Only Extensions</a></dd>
	<dd><a href="refs.xml.html">XML Manipulation</a></dd>
</dl>
<dl>
<dt>Keyboard Shortcuts</dt><dt>?</dt>
<dd>This help</dd>
<dt>j</dt>
<dd>Next menu item</dd>
<dt>k</dt>
<dd>Previous menu item</dd>
<dt>g p</dt>
<dd>Previous man page</dd>
<dt>g n</dt>
<dd>Next man page</dd>
<dt>G</dt>
<dd>Scroll to bottom</dd>
<dt>g g</dt>
<dd>Scroll to top</dd>
<dt>g h</dt>
<dd>Goto homepage</dd>
<dt>g s</dt>
<dd>Goto search<br>(current page)</dd>
<dt>/</dt>
<dd>Focus search box</dd>
</dl></div></nav>
<div id="goto">
    <div class="search">
         <div class="text"></div>
         <div class="results"><ul></ul></div>
   </div>
</div>

  <div id="breadcrumbs" class="row-fluid">
          
              
        <ul class="breadcrumbs-container">
            <li><a href="index-2.html">PHP Manual</a></li>      <li><a href="internals2.html">PHP at the Core: A Hacker's Guide</a></li>      <li><a href="internals2.memory.html">Memory management</a></li>    </ul>
  </div>




<div id="layout">
  <section id="layout-content">
  <div id="internals2.memory.management" class="sect1">
 <h2 class="title">Basic memory management</h2>
 
 <p class="para">
  The engine's memory management is implemented with features important to a system like PHP. The exact functionality of the engine's memory management and the optmizations performed are out of the scope of this document. However, a good understanding of its functionality provides a basis for a good understanding of the rest of the <code class="code">Hacker's Guide</code>, and introduce you to terminology and functionality used throughout PHP.
 </p>
 
 <p class="para">
  The most important of its features for the <code class="code">Hacker</code>, and the first thing to mention is tracking allocations. Tracking allocations allow the memory manager to avoid leaks, a thorn in the side of most <code class="code">Hackers</code>. When PHP is built in debug mode (<code class="code">--enable-debug</code>), detected leaks are reported, in a perfect world they would never get to deployment.
 </p>
 
 <p class="para">While tracking allocations is an important, and highly useful feature, the <code class="code">Hacker</code> should not become lazy! Always attempt to resolve leaks before deploying your code, a memory leak in a SAPI environment can become a very big problem, very quickly.</p>
 
 <p class="para">Another, perhaps more incidental but still noteworthy, feature is that the memory manager is the part that allows a hard limit on memory usage for each instance of PHP. As we all know, there is no such thing as unlimited. If some code is running out of memory, it is likely to be written wrong, either by the <code class="code">Hacker</code>, or the programmer of PHP. Limiting the memory therefore is not a restriction on the language that is supposed to be experienced in production, it is simply a way from stopping development environments from spiraling out of control when mistakes are made, and equally, when bugs are found in production.</p>
 
 <p class="para">From the <code class="code">Hacker's</code> perspective, the memory management API looks very much like libc's (or whoever the <code class="code">Hacker</code> prefers !) malloc implementation.</p>
 
 <table id="internals2.memory.management.apis" class="doctable table">
  <caption><strong>Main memory APIs</strong></caption>
  
   <thead>
    <tr>
     <th>Prototype</th>
     <th>Description</th>
    </tr>

   </thead>

   <tbody class="tbody">
    
    <tr>
     <td><code class="code">void *emalloc(size_t size)</code></td>
     <td>Allocate <code class="code">size</code> bytes of memory.</td>
    </tr>

    
    <tr>
     <td><code class="code">void *ecalloc(size_t nmemb, size_t size)</code></td>
     <td>
      Allocate a buffer for <code class="code">nmemb</code> elements of
      <code class="code">size</code> bytes and makes sure it is initialized with zeros.
     </td>
    </tr>

    
    <tr>
     <td><code class="code">void *erealloc(void *ptr, size_t size)</code></td>
     <td>
      Resize the buffer <code class="code">ptr</code>, which was allocated using
      <code class="code">emalloc</code> to hold <code class="code">size</code> bytes of memory.
     </td>
    </tr>

    
    <tr>
     <td><code class="code">void efree(void *ptr)</code></td>
     <td>
      Free the buffer pointed by <code class="code">ptr</code>. The buffer had to be 
      allocated by <code class="code">emalloc</code>.
     </td>
    </tr>

    
    <tr>
     <td>
      <code class="code">void *safe_emalloc(size_t nmemb, size_t size, size_t offset)</code>
     </td>
     <td>
      Allocate a buffer for holding <code class="code">nmemb</code> blocks of each
      <code class="code">size</code> bytes and an additional <code class="code">offset</code> bytes.
      This is similar to <code class="code">emalloc(nmemb * size + offset)</code> but adds
      a special protection against overflows.
     </td>
    </tr>

    
    <tr>
     <td><code class="code">char *estrdup(const char *s)</code></td>
     <td>
      Allocate a buffer that can hold the NULL-terminated string
      <code class="code">s</code> and copy the <code class="code">s</code> into that buffer.
     </td>
    </tr>

    
    <tr>
     <td>
      <code class="code">char *estrndup(const char *s, unsigned int length)</code>
     </td>
     <td>
      Similar to <code class="code">estrdup</code> while the length of the
      NULL-terminated string is already known.
     </td>
    </tr>

   </tbody>
  
 </table>

 
 <blockquote class="note"><p><strong class="note">Note</strong>: 
  <span class="simpara">
   The engines memory management functions do not return <code class="code">NULL</code> upon failure, if memory cannot be allocated at runtime, the engine bails and raises an error.
  </span>
 </p></blockquote>
 
 <div class="caution"><strong class="caution">Caution</strong>
  <p class="simpara">
   Always use valgrind before deploying code and as a normal part of the <code class="code">Hacker's</code> process. The engine can only report and detect leaks where it has allocated the memory. All of PHP is only a thin wrapper around third parties, those third parties do not use the engines memory management. Additionally, valgrind will catch errors that do not always halt or even have an apparent effect at execution time, it is just as important that there should be no errors, as it is important that avoidable leaks should be avoided.
  </p>
 </div>
 
 <blockquote class="note"><p><strong class="note">Note</strong>: 
  <span class="simpara">Some leaks are unavoidable, some libraries rely on the end of a process to free some of their structures, this is normal under some circumstances and acceptable where it is out of the <code class="code">Hacker's</code> control.</span>
 </p></blockquote>
 
 <p class="simpara">While executing in a debug environment, configured with <code class="code">--enable-debug</code>, the leak function used in the next example is actually implemented by the engine and is available to call in userland.</p>
 
 <div class="example" id="internals2.memory.management.example.leak">
  <p><strong>Example #1 Leak Detection in Action</strong></p>
  <div class="example-contents">
<div class="ccode"><pre class="ccode">ZEND_FUNCTION(leak)
{
    long leakbytes = 3;

    if (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, "|l", &amp;leakbytes) == FAILURE) {
        return;
    }

    emalloc(leakbytes);
}</pre>
</div>
  </div>

  <div class="example-contents"><p>The above example will output
something similar to:</p></div>
  <div class="example-contents screen">
<div class="cdata"><pre>[Thu Oct 22 02:14:57 2009]  Script:  '-'
/home/johannes/src/PHP_5_3/Zend/zend_builtin_functions.c(1377) :  Freeing 0x088888D4 (3 bytes), script=-
=== Total 1 memory leaks detected ===
</pre></div>
  </div>
 </div>
 
 <blockquote class="note"><p><strong class="note">Note</strong>: 
  <span class="simpara">USE_ZEND_ALLOC=0 in the environment will stop the memory manager from functioning, all allocations fall back on the default system allocators which can be useful for debugging leaks.</span>
 </p></blockquote>
 
</div>
<section id="usernotes">
 <div class="head"><h3 class="title">User Contributed Notes</h3></div>
 <div class="note">There are no user contributed notes for this page.</div></section>    </section><!-- layout-content -->
        


  </div><!-- layout -->
         
  

    
 <!-- External and third party libraries. -->
 







<a id="toTop" href="javascript:;"><span id="toTopHover"></span><img width="40" height="40" alt="To Top" src="../../images/to-top%402x.png"></a>



<!-- Mirrored from php.net/manual/en/internals2.memory.management.php by HTTrack Website Copier/3.x [XR&CO'2013], Thu, 28 Aug 2014 15:53:18 GMT -->


</body></html>