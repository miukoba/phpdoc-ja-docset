<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>クエリに使う文字列をエスケープする</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.pg-escape-literal.html">≪ pg_escape_literal</a></li>
      <li style="float: right;"><a href="function.pg-execute.html">pg_execute ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.pgsql.html">PostgreSQL 関数</a></li>
    <li>クエリに使う文字列をエスケープする</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.pg-escape-string" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">pg_escape_string</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.2.0, PHP 5)</p><p class="refpurpose"><span class="refname">pg_escape_string</span> &mdash; <span class="dc-title">
   クエリに使う文字列をエスケープする
  </span></p>

 </div>

 <div class="refsect1 description" id="refsect1-function.pg-escape-string-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">string</span> <span class="methodname"><strong>pg_escape_string</strong></span>
    ([ <span class="methodparam"><span class="type">resource</span> <code class="parameter">$connection</code></span>
   ], <span class="methodparam"><span class="type">string</span> <code class="parameter">$data</code></span>
   )</div>

  <p class="para rdfs-comment">
   <span class="function"><strong>pg_escape_string()</strong></span> は、データベースへの問い合わせに使う文字列をエスケープします。
   PostgreSQL フォーマットにエスケープされた文字列を、クォートなしの形式で返します。
   PostgreSQL に使う SQL パラメータをエスケープするときには
   <span class="function"><a href="function.pg-escape-literal.html" class="function">pg_escape_literal()</a></span> を使うほうがよいでしょう。
   <span class="function"><a href="function.addslashes.html" class="function">addslashes()</a></span> を PostgreSQL で使ってはいけません。
   カラム型が bytea の場合は、代わりに
   <span class="function"><a href="function.pg-escape-bytea.html" class="function">pg_escape_bytea()</a></span> を使わなければなりません。
   識別子 (テーブル名やフィールド名など) のエスケープには
   <span class="function"><a href="function.pg-escape-identifier.html" class="function">pg_escape_identifier()</a></span> を使わなければなりません。
  </p>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <p class="para">
    この関数は、PostgreSQL 7.2 以降が必要です。
    </p>
  </p></blockquote>
 </div>


<div class="refsect1 parameters" id="refsect1-function.pg-escape-string-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">connection</code></dt>

     <dd>

      <p class="para">
       PostgreSQL データベース接続リソース。
       <code class="parameter">connection</code> が存在しない場合は、
       デフォルトの接続を使用します。デフォルトの接続は、
       <span class="function"><a href="function.pg-connect.html" class="function">pg_connect()</a></span> あるいは <span class="function"><a href="function.pg-pconnect.html" class="function">pg_pconnect()</a></span>
       で直近に作成されたものとなります。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">data</code></dt>

     <dd>

      <p class="para">
       エスケープするテキスト文字列。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.pg-escape-string-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   エスケープされたデータを文字列で返します。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.pg-escape-string-changelog">
  <h3 class="title">変更履歴</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>バージョン</th>
       <th>説明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>5.2.0</td>
       <td><code class="parameter">connection</code> が追加されました。</td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.pg-escape-string-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-2151">
    <p><strong>例1 <span class="function"><strong>pg_escape_string()</strong></span> の例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php&nbsp;<br />&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;データベースに接続する<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$dbconn&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">pg_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">'dbname=foo'</span><span style="color: #007700">);<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;テキストファイルを読み込む（アポストロフィやスラッシュが含まれている）<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$data&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">'letter.txt'</span><span style="color: #007700">);<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;テキストデータをエスケープする<br />&nbsp;&nbsp;</span><span style="color: #0000BB">$escaped&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">pg_escape_string</span><span style="color: #007700">(</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br />&nbsp;&nbsp;<br />&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;それをデータベースに挿入する<br />&nbsp;&nbsp;</span><span style="color: #0000BB">pg_query</span><span style="color: #007700">(</span><span style="color: #DD0000">"INSERT&nbsp;INTO&nbsp;correspondence&nbsp;(name,&nbsp;data)&nbsp;VALUES&nbsp;('My&nbsp;letter',&nbsp;'</span><span style="color: #007700">{</span><span style="color: #0000BB">$escaped</span><span style="color: #007700">}</span><span style="color: #DD0000">')"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>

 
 <div class="refsect1 seealso" id="refsect1-function.pg-escape-string-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.pg-escape-bytea.html" class="function" rel="rdfs-seeAlso">pg_escape_bytea()</a> - bytea フィールドに挿入するために文字列をエスケープする</span></li>
   </ul>
  </p>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="114478""></a>
  <div class="note">
   <strong class="user">ringerc at ringerc dot id dot au</strong>
   <a href="#114478" class="date">25-Feb-2014 04:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You should prefer to use pg_query_params, i.e. use parameterized queries, rather than using pg_escape_string. Or use the newer PDO interface with its parameterized query support.<br />
<br />
If you must substitute values directly, e.g. in DDL commands that don't support execution as parameterized queries, do so with pg_escape_literal:<br />
<br />
<a href="http://au1.php.net/manual/en/function.pg-escape-literal.php" rel="nofollow" target="_blank">http://au1.php.net/manual/en/function.pg-escape-literal.php</a><br />
<br />
Identifiers can't be used as query parameters. Always use pg_escape_identifier for these if they're substituted dynamically:<br />
<br />
<a href="http://au1.php.net/manual/en/function.pg-escape-identifier.php" rel="nofollow" target="_blank">http://au1.php.net/manual/en/function.pg-escape-identifier.php</a><br />
<br />
You should not need to change text encodings when using this function. Make sure your connection's client_encoding is set to the text encoding used by PHP, and the PostgreSQL client driver will take care of text encodings for you. No explicit utf-8 conversions should be necessary with a correctly set&nbsp; client_encoding.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105290""></a>
  <div class="note">
   <strong class="user">strata_ranger at hotmail dot com</strong>
   <a href="#105290" class="date">08-Aug-2011 05:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This may seem obvious, but remember that pg_escape_string escapes values for use as string literals in an SQL query -- if you need to escape arbitrary strings for use as SQL identifiers (column names, etc.), there doesn't seem to be a PHP function for that so you'll have to do that escaping yourself.&nbsp; (PostgreSQL has an in-database function, quote_ident(), that does this.)<br />
<br />
This can be an issue if your database contains mixed-case (or otherwise unusual) column names and you have a class interface managing your database/query interactions (for connecting to different types of databases).&nbsp; If you don't double-quote your column names then postgreSQL will match them case-insensitively, but will label the results in all-lowercase (which differs from MySQL).<br />
<br />
For example:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Plain column identifier<br />
</span><span class="default">$res </span><span class="keyword">= </span><span class="default">pg_query</span><span class="keyword">(</span><span class="string">"Select columnName from table"</span><span class="keyword">);<br />
</span><span class="default">$row </span><span class="keyword">= </span><span class="default">pg_fetch_assoc</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">);<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'columnName'</span><span class="keyword">]); </span><span class="comment">// Doesn't work (throws E_NOTICE)<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'columnname'</span><span class="keyword">]); </span><span class="comment">// Works<br />
<br />
// Escaped column identifier<br />
</span><span class="default">$res </span><span class="keyword">= </span><span class="default">pg_query</span><span class="keyword">(</span><span class="string">"Select \"columnName\" from table"</span><span class="keyword">);<br />
</span><span class="default">$row </span><span class="keyword">= </span><span class="default">pg_fetch_assoc</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">);<br />
<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'columnName'</span><span class="keyword">]); </span><span class="comment">// Works<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$row</span><span class="keyword">[</span><span class="string">'columnname'</span><span class="keyword">]); </span><span class="comment">// Doesn't<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104690""></a>
  <div class="note">
   <strong class="user">ppp</strong>
   <a href="#104690" class="date">30-Jun-2011 09:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
pg_escape_string() won't cast array arguments to the "Array" string like php usually does; it returns NULL instead. The following statements all evaluate to true:<br />
<br />
<span class="default">&lt;?php<br />
$a </span><span class="keyword">= array(</span><span class="string">'foo'</span><span class="keyword">, </span><span class="string">'bar'</span><span class="keyword">);<br />
<br />
</span><span class="string">"</span><span class="default">$a</span><span class="string">" </span><span class="keyword">== </span><span class="string">'Array'</span><span class="keyword">;<br />
(string)</span><span class="default">$a </span><span class="keyword">== </span><span class="string">'Array'</span><span class="keyword">;<br />
</span><span class="default">$a </span><span class="keyword">. </span><span class="string">'' </span><span class="keyword">== </span><span class="string">'Array'</span><span class="keyword">;<br />
<br />
</span><span class="default">is_null</span><span class="keyword">(</span><span class="default">pg_escape_string</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">));<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99023""></a>
  <div class="note">
   <strong class="user">strata_ranger at hotmail dot com</strong>
   <a href="#99023" class="date">22-Jul-2010 07:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Forthose curious, the exact escaping performed on the string may vary slightly depending on your database configuration.<br />
<br />
For example, if your database's standard_conforming_strings variable is OFF, backslashes are treated as a special character and pg_escape_string() will ensure they are properly escaped.&nbsp; If this variable is ON, backslashes will be treated as ordinary characters, and pg_escape_string() will leave them as-is.&nbsp; In either case, the behavior matches the configuration of the database connection.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80975""></a>
  <div class="note">
   <strong class="user">Nathan Bruer</strong>
   <a href="#80975" class="date">08-Feb-2008 10:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If your database is a UTF-8 database, you will run into problems trying to add some data into your database...
<br />

<br />
for securty issues and/or compatability you may need to use the: utf_encode() (<a href="http://php.net/utf8-encode" rel="nofollow" target="_blank">http://php.net/utf8-encode</a>) function.
<br />

<br />
for example:
<br />
<span class="default">&lt;?php
<br />
$my_data </span><span class="keyword">= </span><span class="default">pg_escape_string</span><span class="keyword">(</span><span class="default">utf8_encode</span><span class="keyword">(</span><span class="default">$_POST</span><span class="keyword">[</span><span class="string">'my_data'</span><span class="keyword">]));
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="77426""></a>
  <div class="note">
   <strong class="user">Gautam Khanna</strong>
   <a href="#77426" class="date">29-Aug-2007 04:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Security methods which you use depend on the specific purpose. For those who dont know, take a look at the following built-in PHP functions:<br />
<br />
strip_tags()&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; to remove HTML characters<br />
(also see htmlspecialchars)<br />
<br />
escapeshellarg()&nbsp; &nbsp; &nbsp; to escape shell commands etc<br />
escapeshellcmd()<br />
<br />
mysql_real_escape_string()&nbsp; &nbsp;&nbsp; to escape mySQL commands.<br />
<br />
Enjoy!<br />
<br />
web dot expert dot panel at gmail dot com</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="66827""></a>
  <div class="note">
   <strong class="user">johniskew2 at yahoo dot com</strong>
   <a href="#66827" class="date">30-May-2006 06:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those who escape their single quotes with a backslash (ie \') instead of two single quotes in a row (ie '') there has recently been a SERIOUS sql injection vulnerability that can be employed taking advantage of your chosen escaping method.&nbsp; More info here: <a href="http://www.postgresql.org/docs/techdocs.50" rel="nofollow" target="_blank">http://www.postgresql.org/docs/techdocs.50</a><br />
Even after the postgre update, you may still be limited to what you can do with your queries if you still insist on backslash escaping. It's a lesson to always use the PHP functions to do proper escaping instead of adhoc addslashes or magic quotes escaping.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="66750""></a>
  <div class="note">
   <strong class="user">meng</strong>
   <a href="#66750" class="date">28-May-2006 01:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Since php 5.1 the new function pg_query_params() was introduced. With this function you can use bind variables and don't have to escape strings. If you can use it, do so. If unsure why, check the changelog for Postgres 8.0.8.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="65130""></a>
  <div class="note">
   <strong class="user">otix</strong>
   <a href="#65130" class="date">25-Apr-2006 12:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Creating a double-tick is just fine. It works the same as the backslash-tick syntax. From the PostgreSQL docs:<br />
<br />
The fact that string constants are bound by single quotes presents an obvious semantic problem, however, in that if the sequence itself contains a single quote, the literal bounds of the constant are made ambiguous. To escape (make literal) a single quote within the string, you may type two adjacent single quotes. The parser will interpret the two adjacent single quotes within the string constant as a single, literal single quote. PostgreSQL will also allow single quotes to be embedded by using a C-style backslash.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
