<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>ソケット（通信時の終端）を作成する</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.socket-create-pair.html">≪ socket_create_pair</a></li>
      <li style="float: right;"><a href="function.socket-get-option.html">socket_get_option ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.sockets.html">ソケット 関数</a></li>
    <li>ソケット（通信時の終端）を作成する</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.socket-create" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">socket_create</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.1.0, PHP 5)</p><p class="refpurpose"><span class="refname">socket_create</span> &mdash; <span class="dc-title">ソケット（通信時の終端）を作成する</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.socket-create-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">resource</span> <span class="methodname"><strong>socket_create</strong></span>
    ( <span class="methodparam"><span class="type">int</span> <code class="parameter">$domain</code></span>
   , <span class="methodparam"><span class="type">int</span> <code class="parameter">$type</code></span>
   , <span class="methodparam"><span class="type">int</span> <code class="parameter">$protocol</code></span>
   )</div>

  <p class="para rdfs-comment">
   通信のエンドポイント(終端)と呼ばれることもあるソケットのリソースを作成し、
   返します。典型的なネットワーク接続は、2つのソケットから成り立ちます。
   このとき、片方はクライアント、もう片方はサーバーの役割をします。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.socket-create-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">domain</code></dt>

     <dd>

      <p class="para">
       パラメータ <code class="parameter">domain</code> には、
       ソケットが利用するプロトコルファミリーを指定します。
      </p>
      <table class="doctable table">
       <caption><strong>指定可能なアドレス/プロトコルファミリーの一覧</strong></caption>
       
        <thead>
         <tr>
          <th>ドメイン</th>
          <th>説明</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td><strong><code>AF_INET</code></strong></td>
          <td>
           IPv4 インターネットプロトコル。
           このプロトコルファミリーに属するプロトコルとしてよく知られているのは、
           TCP や UDP です。
          </td>
         </tr>

         <tr>
          <td><strong><code>AF_INET6</code></strong></td>
          <td>
           IPv6 インターネットプロトコル。TCP と UDP
           が、このプロトコルファミリーで一般的なプロトコルです。
          </td>
         </tr>

         <tr>
          <td><strong><code>AF_UNIX</code></strong></td>
          <td>
           ローカルでのコミュニケーションに用いられるプロトコルファミリーです。
           高い効率と低いオーバーヘッドを誇るため、IPC (プロセス間通信)
           でよく使われます。
          </td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    
    
     <dt>
<code class="parameter">type</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">type</code> パラメータは、
       ソケットが利用する通信方式を指定します。
      </p>
      <table class="doctable table">
       <caption><strong>利用できるソケットのタイプ</strong></caption>
       
        <thead>
         <tr>
          <th>タイプ</th>
          <th>説明</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td><strong><code>SOCK_STREAM</code></strong></td>
          <td>
           このタイプでは、時系列的、高信頼性、全二重、接続型のバイトストリームが利用できます。
           帯域外のデータ転送メカニズムがサポートされている場合もあります。
           TCP プロトコルは、このソケットタイプに基づきます。
          </td>
         </tr>

         <tr>
          <td><strong><code>SOCK_DGRAM</code></strong></td>
          <td>
           このタイプでは、データグラム(非接続型で、信頼性の高くない
           固定バイト長のメッセージ) がサポートされます。
           UDP プロトコルは、このソケットタイプに基づきます。
          </td>
         </tr>

           <tr>
          <td><strong><code>SOCK_SEQPACKET</code></strong></td>
          <td>
           このタイプでは、時系列的な、信頼性のある、
           双方向の接続指向型の固定長データグラム転送が利用できます。
           パケットを消費する側は、一つのパケット全部を一度の
           read コールで読み込む必要があります。
          </td>
         </tr>

         <tr>
          <td><strong><code>SOCK_RAW</code></strong></td>
          <td>
           このタイプでは、素のネットワークプロトコルを操作できます。
           この特殊なソケットを使って、どのタイプのプロトコルでもユーザーの手で構築することができます。
           よくある使い方として、(ping のような) ICMP リクエストの作成があります。
          </td>
         </tr>

         <tr>
          <td><strong><code>SOCK_RDM</code></strong></td>
          <td>
           このタイプでは、信頼に足る、非時系列的なデータグラム転送が利用できます。
           ほとんどのオペレーティングシステムでは実装されていないでしょう。
          </td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    
    
     <dt>
<code class="parameter">protocol</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">protocol</code> は、ソケット上の通信で使われる
       <code class="parameter">domain</code> で指定されたファミリーに属するプロトコルを指定します。
       正しい値は、<span class="function"><a href="function.getprotobyname.html" class="function">getprotobyname()</a></span>
       を使うことで取得できます。利用したいプロトコルが、TCP または UDP
       の場合は、定数 <strong><code>SOL_TCP</code></strong> と
       <strong><code>SOL_UDP</code></strong> を指定することもできます。
      </p>
      <table class="doctable table">
       <caption><strong>一般的なプロトコルの一覧</strong></caption>
       
        <thead>
         <tr>
          <th>名称</th>
          <th>説明</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td>icmp</td>
          <td>
           Internet Control Message Protocol は、主にゲートウェイやホストが、
           データグラム通信におけるエラーを報告するのに使われます。
           &quot;ping&quot; コマンド (最近のほとんどのオペーレーティングシステムに
           搭載されています) が ICMP アプリケーションの一例です。
          </td>
         </tr>

         <tr>
          <td>udp</td>
          <td>
           User Datagram Protocol は、非接続指向の、信頼性の高くない、
           固定のレコード長を用いるプロトコルです。このような側面のおかげで、
           UDP はプロトコルとして最小限のオーバーへッドしか要求しません。
          </td>
         </tr>

         <tr>
          <td>tcp</td>
          <td>
           Transmission Control Protocol は、信頼性の高い、接続指向かつ
           ストリーム指向の全二重通信プロトコルです。TCP は、
           すべてのパケットが、送信された順序で(時系列的に)受信されることを
           保証します。もし、何らかの理由でパケットが通信中に失われた場合、
           TCP では、送信先から通知があるまで、パケットが再送信されるように
           なっています。信頼性とパフォーマンス上の理由から、TCP の実装は、
           下層にあるデータグラム通信レイヤーのオクテット幅を
           適当な長さに決定します。このため、TCP アプリケーションは、
           レコードの全部が一度に転送されない場合も考慮しなければなりません。
          </td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.socket-create-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   <span class="function"><strong>socket_create()</strong></span> は、
   成功時にソケットリソース、失敗時に <strong><code>FALSE</code></strong> を返します。
   実際のエラーコードは、<span class="function"><a href="function.socket-last-error.html" class="function">socket_last_error()</a></span> を
   コールすることにより取得できます。このエラーコードをさらに
   <span class="function"><a href="function.socket-strerror.html" class="function">socket_strerror()</a></span>に渡すことにより、
   エラーの内容を文字列で取得することが可能です。
  </p>
 </div>


 <div class="refsect1 errors" id="refsect1-function.socket-create-errors">
  <h3 class="title">エラー / 例外</h3>
   <p class="para">
    <code class="parameter">domain</code> や <code class="parameter">type</code> に
    不正な値が与えられた場合、<span class="function"><strong>socket_create()</strong></span> は、これらを
    それぞれ <strong><code>AF_INET</code></strong> と <strong><code>SOCK_STREAM</code></strong>
    であるとみなし、<strong><code>E_WARNING</code></strong> メッセージを出します。
   </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.socket-create-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.socket-accept.html" class="function" rel="rdfs-seeAlso">socket_accept()</a> - ソケットへの接続を許可する</span></li>
    <li class="member"><span class="function"><a href="function.socket-bind.html" class="function" rel="rdfs-seeAlso">socket_bind()</a> - ソケットに名前をバインドする</span></li>
    <li class="member"><span class="function"><a href="function.socket-connect.html" class="function" rel="rdfs-seeAlso">socket_connect()</a> - ソケット上の接続を初期化する</span></li>
    <li class="member"><span class="function"><a href="function.socket-listen.html" class="function" rel="rdfs-seeAlso">socket_listen()</a> - ソケット上で接続待ち(listen)する</span></li>
    <li class="member"><span class="function"><a href="function.socket-last-error.html" class="function" rel="rdfs-seeAlso">socket_last_error()</a> - ソケットの直近のエラーを返す</span></li>
    <li class="member"><span class="function"><a href="function.socket-strerror.html" class="function" rel="rdfs-seeAlso">socket_strerror()</a> - ソケットエラーの内容を文字列として返す</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="108535""></a>
  <div class="note">
   <strong class="user">ab1965 at yandex dot ru</strong>
   <a href="#108535" class="date">04-May-2012 09:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It took some time to understand how one PHP process can communicate with another by means of unix udp sockets. Examples of 'server' and 'client' code are given below. Server is assumed to run before client starts.<br />
<br />
'Server' code<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">if (!</span><span class="default">extension_loaded</span><span class="keyword">(</span><span class="string">'sockets'</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">'The sockets extension is not loaded.'</span><span class="keyword">);<br />
}<br />
</span><span class="comment">// create unix udp socket<br />
</span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_UNIX</span><span class="keyword">, </span><span class="default">SOCK_DGRAM</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
if (!</span><span class="default">$socket</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to create AF_UNIX socket'</span><span class="keyword">);<br />
<br />
</span><span class="comment">// same socket will be used in recv_from and send_to<br />
</span><span class="default">$server_side_sock </span><span class="keyword">= </span><span class="default">dirname</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">).</span><span class="string">"/server.sock"</span><span class="keyword">;<br />
if (!</span><span class="default">socket_bind</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$server_side_sock</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">"Unable to bind to </span><span class="default">$server_side_sock</span><span class="string">"</span><span class="keyword">);<br />
<br />
while(</span><span class="default">1</span><span class="keyword">) </span><span class="comment">// server never exits<br />
</span><span class="keyword">{<br />
</span><span class="comment">// receive query<br />
</span><span class="keyword">if (!</span><span class="default">socket_set_block</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to set blocking mode for socket'</span><span class="keyword">);<br />
</span><span class="default">$buf </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="default">$from </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
echo </span><span class="string">"Ready to receive...\n"</span><span class="keyword">;<br />
</span><span class="comment">// will block to wait client query<br />
</span><span class="default">$bytes_received </span><span class="keyword">= </span><span class="default">socket_recvfrom</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$buf</span><span class="keyword">, </span><span class="default">65536</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$from</span><span class="keyword">);<br />
if (</span><span class="default">$bytes_received </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'An error occured while receiving from the socket'</span><span class="keyword">);<br />
echo </span><span class="string">"Received </span><span class="default">$buf</span><span class="string"> from </span><span class="default">$from</span><span class="string">\n"</span><span class="keyword">;<br />
<br />
</span><span class="default">$buf </span><span class="keyword">.= </span><span class="string">"-&gt;Response"</span><span class="keyword">; </span><span class="comment">// process client query here<br />
<br />
// send response<br />
</span><span class="keyword">if (!</span><span class="default">socket_set_nonblock</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to set nonblocking mode for socket'</span><span class="keyword">);<br />
</span><span class="comment">// client side socket filename is known from client request: $from<br />
</span><span class="default">$len </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$buf</span><span class="keyword">);<br />
</span><span class="default">$bytes_sent </span><span class="keyword">= </span><span class="default">socket_sendto</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$buf</span><span class="keyword">, </span><span class="default">$len</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$from</span><span class="keyword">);<br />
if (</span><span class="default">$bytes_sent </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'An error occured while sending to the socket'</span><span class="keyword">);<br />
else if (</span><span class="default">$bytes_sent </span><span class="keyword">!= </span><span class="default">$len</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="default">$bytes_sent </span><span class="keyword">. </span><span class="string">' bytes have been sent instead of the ' </span><span class="keyword">. </span><span class="default">$len </span><span class="keyword">. </span><span class="string">' bytes expected'</span><span class="keyword">);<br />
echo </span><span class="string">"Request processed\n"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
'Client' code<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">if (!</span><span class="default">extension_loaded</span><span class="keyword">(</span><span class="string">'sockets'</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; die(</span><span class="string">'The sockets extension is not loaded.'</span><span class="keyword">);<br />
}<br />
</span><span class="comment">// create unix udp socket<br />
</span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_UNIX</span><span class="keyword">, </span><span class="default">SOCK_DGRAM</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
if (!</span><span class="default">$socket</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to create AF_UNIX socket'</span><span class="keyword">);<br />
<br />
</span><span class="comment">// same socket will be later used in recv_from<br />
// no binding is required if you wish only send and never receive<br />
</span><span class="default">$client_side_sock </span><span class="keyword">= </span><span class="default">dirname</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">).</span><span class="string">"/client.sock"</span><span class="keyword">;<br />
if (!</span><span class="default">socket_bind</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$client_side_sock</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">"Unable to bind to </span><span class="default">$client_side_sock</span><span class="string">"</span><span class="keyword">);<br />
<br />
</span><span class="comment">// use socket to send data<br />
</span><span class="keyword">if (!</span><span class="default">socket_set_nonblock</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to set nonblocking mode for socket'</span><span class="keyword">);<br />
</span><span class="comment">// server side socket filename is known apriori<br />
</span><span class="default">$server_side_sock </span><span class="keyword">= </span><span class="default">dirname</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">).</span><span class="string">"/server.sock"</span><span class="keyword">;<br />
</span><span class="default">$msg </span><span class="keyword">= </span><span class="string">"Message"</span><span class="keyword">;<br />
</span><span class="default">$len </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$msg</span><span class="keyword">);<br />
</span><span class="comment">// at this point 'server' process must be running and bound to receive from serv.sock<br />
</span><span class="default">$bytes_sent </span><span class="keyword">= </span><span class="default">socket_sendto</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$msg</span><span class="keyword">, </span><span class="default">$len</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$server_side_sock</span><span class="keyword">);<br />
if (</span><span class="default">$bytes_sent </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'An error occured while sending to the socket'</span><span class="keyword">);<br />
else if (</span><span class="default">$bytes_sent </span><span class="keyword">!= </span><span class="default">$len</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="default">$bytes_sent </span><span class="keyword">. </span><span class="string">' bytes have been sent instead of the ' </span><span class="keyword">. </span><span class="default">$len </span><span class="keyword">. </span><span class="string">' bytes expected'</span><span class="keyword">);<br />
<br />
</span><span class="comment">// use socket to receive data<br />
</span><span class="keyword">if (!</span><span class="default">socket_set_block</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to set blocking mode for socket'</span><span class="keyword">);<br />
</span><span class="default">$buf </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="default">$from </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="comment">// will block to wait server response<br />
</span><span class="default">$bytes_received </span><span class="keyword">= </span><span class="default">socket_recvfrom</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$buf</span><span class="keyword">, </span><span class="default">65536</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$from</span><span class="keyword">);<br />
if (</span><span class="default">$bytes_received </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'An error occured while receiving from the socket'</span><span class="keyword">);<br />
echo </span><span class="string">"Received </span><span class="default">$buf</span><span class="string"> from </span><span class="default">$from</span><span class="string">\n"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// close socket and delete own .sock file<br />
</span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$client_side_sock</span><span class="keyword">);<br />
echo </span><span class="string">"Client exits\n"</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="101012""></a>
  <div class="note">
   <strong class="user">geoff at spacevs dot com</strong>
   <a href="#101012" class="date">20-Nov-2010 10:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is a ping function for PHP without using exec/system/passthrough/etc... Very useful to use to just test if a host is online before attempting to connect to it. Timeout is in seconds.<br />
<br />
<span class="default">&lt;?PHP<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">ping</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$timeout </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">/* ICMP ping packet with a pre-calculated checksum */<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$package </span><span class="keyword">= </span><span class="string">"\x08\x00\x7d\x4b\x00\x00\x00\x00PingHost"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$socket&nbsp; </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_RAW</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">SOL_SOCKET</span><span class="keyword">, </span><span class="default">SO_RCVTIMEO</span><span class="keyword">, array(</span><span class="string">'sec' </span><span class="keyword">=&gt; </span><span class="default">$timeout</span><span class="keyword">, </span><span class="string">'usec' </span><span class="keyword">=&gt; </span><span class="default">0</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_connect</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ts </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_send</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$package</span><span class="keyword">, </span><span class="default">strLen</span><span class="keyword">(</span><span class="default">$package</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">) - </span><span class="default">$ts</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else&nbsp; &nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$result</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93415""></a>
  <div class="note">
   <strong class="user">rhollencamp at gmail dot com</strong>
   <a href="#93415" class="date">09-Sep-2009 06:29</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that if you create a socket with AF_UNIX, a file will be created in the filesystem. This file is not removed when you call socket_close - you should unlink the file after you close the socket.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="81938""></a>
  <div class="note">
   <strong class="user">alexander dot krause at ed-solutions dot de</strong>
   <a href="#81938" class="date">20-Mar-2008 09:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
On UNIX systems php needs /etc/protocols for constants like SOL_UDP and SOL_TCP.<br />
<br />
This file was missing on my embedded platform.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80775""></a>
  <div class="note">
   <strong class="user">Jean Charles MAMMANA</strong>
   <a href="#80775" class="date">31-Jan-2008 01:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've written the ping() function using socket_create() with SOCK_RAW.<br />
(on Unix System, you need to have the root acces to execute this function)<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/// start ping.inc.php ///<br />
<br />
</span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"No Error"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// timeout in ms<br />
</span><span class="keyword">function </span><span class="default">ping</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$timeout</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$port </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$datasize </span><span class="keyword">= </span><span class="default">64</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$g_icmp_error</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"No Error"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ident </span><span class="keyword">= array(</span><span class="default">ord</span><span class="keyword">(</span><span class="string">'J'</span><span class="keyword">), </span><span class="default">ord</span><span class="keyword">(</span><span class="string">'C'</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$seq&nbsp;&nbsp; </span><span class="keyword">= array(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">), </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">));<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$packet </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">8</span><span class="keyword">); </span><span class="comment">// type = 8 : request<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">); </span><span class="comment">// code = 0<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">); </span><span class="comment">// checksum init<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">); </span><span class="comment">// checksum init<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$ident</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]); </span><span class="comment">// identifier<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$ident</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]); </span><span class="comment">// identifier<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$seq</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]); </span><span class="comment">// seq<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">$seq</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]); </span><span class="comment">// seq<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$datasize</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$chk </span><span class="keyword">= </span><span class="default">icmpChecksum</span><span class="keyword">(</span><span class="default">$packet</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">] = </span><span class="default">$chk</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]; </span><span class="comment">// checksum init<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$packet</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">] = </span><span class="default">$chk</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]; </span><span class="comment">// checksum init<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sock </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_RAW</span><span class="keyword">,&nbsp; </span><span class="default">getprotobyname</span><span class="keyword">(</span><span class="string">'icmp'</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$time_start </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_sendto</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">$packet</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$packet</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$read&nbsp;&nbsp; </span><span class="keyword">= array(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$write&nbsp; </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$except </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$select </span><span class="keyword">= </span><span class="default">socket_select</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">, </span><span class="default">$write</span><span class="keyword">, </span><span class="default">$except</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$timeout </span><span class="keyword">* </span><span class="default">1000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$select </span><span class="keyword">=== </span><span class="default">NULL</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Select Error"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; elseif (</span><span class="default">$select </span><span class="keyword">=== </span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Timeout"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$recv </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$time_stop </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_recvfrom</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">, </span><span class="default">$recv</span><span class="keyword">, </span><span class="default">65535</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$recv </span><span class="keyword">= </span><span class="default">unpack</span><span class="keyword">(</span><span class="string">'C*'</span><span class="keyword">, </span><span class="default">$recv</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$recv</span><span class="keyword">[</span><span class="default">10</span><span class="keyword">] !== </span><span class="default">1</span><span class="keyword">) </span><span class="comment">// ICMP proto = 1<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Not ICMP packet"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$recv</span><span class="keyword">[</span><span class="default">21</span><span class="keyword">] !== </span><span class="default">0</span><span class="keyword">) </span><span class="comment">// ICMP response = 0<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Not ICMP response"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$ident</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] !== </span><span class="default">$recv</span><span class="keyword">[</span><span class="default">25</span><span class="keyword">] || </span><span class="default">$ident</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] !== </span><span class="default">$recv</span><span class="keyword">[</span><span class="default">26</span><span class="keyword">])<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Bad identification number"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$seq</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] !== </span><span class="default">$recv</span><span class="keyword">[</span><span class="default">27</span><span class="keyword">] || </span><span class="default">$seq</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] !== </span><span class="default">$recv</span><span class="keyword">[</span><span class="default">28</span><span class="keyword">])<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Bad sequence number"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ms </span><span class="keyword">= (</span><span class="default">$time_stop </span><span class="keyword">- </span><span class="default">$time_start</span><span class="keyword">) * </span><span class="default">1000</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$ms </span><span class="keyword">&lt; </span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$g_icmp_error </span><span class="keyword">= </span><span class="string">"Response too long"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ms </span><span class="keyword">= -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$ms</span><span class="keyword">;<br />
}<br />
<br />
function </span><span class="default">icmpChecksum</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bit </span><span class="keyword">= </span><span class="default">unpack</span><span class="keyword">(</span><span class="string">'n*'</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sum </span><span class="keyword">= </span><span class="default">array_sum</span><span class="keyword">(</span><span class="default">$bit</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) % </span><span class="default">2</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$temp </span><span class="keyword">= </span><span class="default">unpack</span><span class="keyword">(</span><span class="string">'C*'</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">[</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sum </span><span class="keyword">+= </span><span class="default">$temp</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sum </span><span class="keyword">= (</span><span class="default">$sum </span><span class="keyword">&gt;&gt; </span><span class="default">16</span><span class="keyword">) + (</span><span class="default">$sum </span><span class="keyword">&amp; </span><span class="default">0xffff</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sum </span><span class="keyword">+= (</span><span class="default">$sum </span><span class="keyword">&gt;&gt; </span><span class="default">16</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">pack</span><span class="keyword">(</span><span class="string">'n*'</span><span class="keyword">, ~</span><span class="default">$sum</span><span class="keyword">);<br />
}<br />
<br />
function </span><span class="default">getLastIcmpError</span><span class="keyword">()<br />
{<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$g_icmp_error</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$g_icmp_error</span><span class="keyword">;<br />
}<br />
</span><span class="comment">/// end ping.inc.php ///<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68709""></a>
  <div class="note">
   <strong class="user">jens at surefoot dot com</strong>
   <a href="#68709" class="date">08-Aug-2006 02:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please be aware that RAW sockets (as used for the ping example) are restricted to root accounts on *nix systems. Since web servers hardly ever run as root, they won't work on webpages.<br />
<br />
On Windows based servers it should work regardless.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60438""></a>
  <div class="note">
   
   <a href="#60438" class="date">06-Jan-2006 11:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here's a ping function that uses sockets instead of exec().&nbsp; Note: I was unable to get socket_create() to work without running from CLI as root.&nbsp; I've already calculated the package's checksum to simplify the code (the message is 'ping' but it doesn't actually matter).<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">function </span><span class="default">ping</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$package </span><span class="keyword">= </span><span class="string">"\x08\x00\x19\x2f\x00\x00\x00\x00\x70\x69\x6e\x67"</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* create the socket, the last '1' denotes ICMP */&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_RAW</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* set socket receive timeout to 1 second */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_set_option</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">SOL_SOCKET</span><span class="keyword">, </span><span class="default">SO_RCVTIMEO</span><span class="keyword">, array(</span><span class="string">"sec" </span><span class="keyword">=&gt; </span><span class="default">1</span><span class="keyword">, </span><span class="string">"usec" </span><span class="keyword">=&gt; </span><span class="default">0</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* connect to socket */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_connect</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* record start time */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">list(</span><span class="default">$start_usec</span><span class="keyword">, </span><span class="default">$start_sec</span><span class="keyword">) = </span><span class="default">explode</span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">microtime</span><span class="keyword">());<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$start_time </span><span class="keyword">= ((float) </span><span class="default">$start_usec </span><span class="keyword">+ (float) </span><span class="default">$start_sec</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_send</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$package</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$package</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if(@</span><span class="default">socket_read</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">255</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; list(</span><span class="default">$end_usec</span><span class="keyword">, </span><span class="default">$end_sec</span><span class="keyword">) = </span><span class="default">explode</span><span class="keyword">(</span><span class="string">" "</span><span class="keyword">, </span><span class="default">microtime</span><span class="keyword">());<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$end_time </span><span class="keyword">= ((float) </span><span class="default">$end_usec </span><span class="keyword">+ (float) </span><span class="default">$end_sec</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$total_time </span><span class="keyword">= </span><span class="default">$end_time </span><span class="keyword">- </span><span class="default">$start_time</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$total_time</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58257""></a>
  <div class="note">
   <strong class="user">kyle gibson</strong>
   <a href="#58257" class="date">29-Oct-2005 02:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Took me about 20 minutes to figure out the proper arguments to supply for a AF_UNIX socket. Anything else, and I would get a PHP warning about the 'type' not being supported. I hope this saves someone else time.<br />
<br />
<span class="default">&lt;?php <br />
$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_UNIX</span><span class="keyword">, </span><span class="default">SOCK_STREAM</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
</span><span class="comment">// code<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="49368""></a>
  <div class="note">
   <strong class="user">david at eder dot us</strong>
   <a href="#49368" class="date">25-Jan-2005 08:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Sometimes when you are running CLI, you need to know your own ip address.<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp; $addr </span><span class="keyword">= </span><span class="default">my_ip</span><span class="keyword">();<br />
&nbsp; echo </span><span class="string">"my ip address is </span><span class="default">$addr</span><span class="string">\n"</span><span class="keyword">;<br />
<br />
&nbsp; function </span><span class="default">my_ip</span><span class="keyword">(</span><span class="default">$dest</span><span class="keyword">=</span><span class="string">'64.0.0.0'</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">=</span><span class="default">80</span><span class="keyword">)<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_DGRAM</span><span class="keyword">, </span><span class="default">SOL_UDP</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_connect</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$dest</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_getsockname</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$addr</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_close</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$addr</span><span class="keyword">;<br />
&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="43057""></a>
  <div class="note">
   <strong class="user">david at eder dot us</strong>
   <a href="#43057" class="date">08-Jun-2004 05:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Seems there aren't any examples of UDP clients out there.&nbsp; This is a tftp client.&nbsp; I hope this makes someone's life easier.<br />
<br />
<span class="default">&lt;?php<br />
&nbsp; </span><span class="keyword">function </span><span class="default">tftp_fetch</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$filename</span><span class="keyword">)<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$socket </span><span class="keyword">= </span><span class="default">socket_create</span><span class="keyword">(</span><span class="default">AF_INET</span><span class="keyword">, </span><span class="default">SOCK_DGRAM</span><span class="keyword">, </span><span class="default">SOL_UDP</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// create the request packet<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">) . </span><span class="default">chr</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">) . </span><span class="default">$filename </span><span class="keyword">. </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">) . </span><span class="string">'octet' </span><span class="keyword">. </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// UDP is connectionless, so we just send on it.<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">socket_sendto</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$packet</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$packet</span><span class="keyword">), </span><span class="default">0x100</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">69</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$buffer </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$port </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; do<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// $buffer and $port both come back with information for the ack<br />
&nbsp;&nbsp; &nbsp;&nbsp; // 516 = 4 bytes for the header + 512 bytes of data<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">socket_recvfrom</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$buffer</span><span class="keyword">, </span><span class="default">516</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// add the block number from the data packet to the ack packet<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$packet </span><span class="keyword">= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">) . </span><span class="default">chr</span><span class="keyword">(</span><span class="default">4</span><span class="keyword">) . </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// send ack<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">socket_sendto</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">, </span><span class="default">$packet</span><span class="keyword">, </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$packet</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">, </span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// append the data to the return variable<br />
&nbsp;&nbsp; &nbsp;&nbsp; // for large files this function should take a file handle as an arg<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">.= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">, </span><span class="default">4</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; while(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">) == </span><span class="default">516</span><span class="keyword">);&nbsp; </span><span class="comment">// the first non-full packet is the last.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">$ret</span><span class="keyword">;<br />
&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="19075""></a>
  <div class="note">
   <strong class="user">evan at coeus hyphen group dot com</strong>
   <a href="#19075" class="date">15-Feb-2002 03:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Okay I talked with Richard a little (via e-mail). We agree that getprotobyname() and using the constants should be the same in functionality and speed, the use of one or the other is merely coding style. Personally, we both think the constants are prettier :).<br />
<br />
The eight different protocols are the ones implemented in PHP- not the total number in existance (RFC 1340 has 98).<br />
<br />
All we disagree on is using 0- Richard says that "accordning to the official unix/bsd sockets 0 is more than fine." I think that since 0 is a reserved number according to RFC 1320, and when used usually refers to IP, not one of it's sub-protocols (TCP, UDP, etc.)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
