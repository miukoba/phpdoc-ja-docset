<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>The Pool class</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="pthreads.modifiers.html">≪ Modifiers</a></li>
      <li style="float: right;"><a href="pool.collect.html">Pool::collect ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="book.pthreads.html">pthreads</a></li>
    <li>The Pool class</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="class.pool" class="reference">

 <h1 class="title">The Pool class</h1>
 

 <div class="partintro"><p class="verinfo">(PECL pthreads &gt;= 2.0.0)</p>


  <div class="section" id="pool.intro">
   <h2 class="title">導入</h2>
   <p class="para">
   A Pool is a container for, and controller of, an adjustable number of Workers.
   </p>
   <p class="para">
   Pooling provides a higher level abstraction of the Worker functionality, including the management of references in the way required by pthreads.
   </p>
  </div>


  <div class="section" id="pool.synopsis">
   <h2 class="title">クラス概要</h2>


   <div class="classsynopsis">
    <div class="ooclass"></div>


    <div class="classsynopsisinfo">
     <span class="ooclass">
      <strong class="classname">Pool</strong>
     </span>
     {</div>

    <div class="classsynopsisinfo classsynopsisinfo_comment">/* プロパティ */</div>
    <div class="fieldsynopsis">
     <span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.size">$<var class="varname">size</var></a></var>
    ;</div>

    <div class="fieldsynopsis">
     <span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.class">$<var class="varname">class</var></a></var>
    ;</div>

    <div class="fieldsynopsis">
     <span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.workers">$<var class="varname">workers</var></a></var>
    ;</div>

    <div class="fieldsynopsis">
     <span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.work">$<var class="varname">work</var></a></var>
    ;</div>

    <div class="fieldsynopsis">
     <span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.ctor">$<var class="varname">ctor</var></a></var>
    ;</div>

    <div class="fieldsynopsis">
     <span class="modifier">protected</span>
      <var class="varname"><a href="class.pool.html#pool.props.last">$<var class="varname">last</var></a></var>
    ;</div>


    
    <div class="classsynopsisinfo classsynopsisinfo_comment">/* メソッド */</div>
    <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type">void</span> <span class="methodname"><a href="pool.collect.html" class="methodname">collect</a></span>
    ( <span class="methodparam"><span class="type"><a href="language.types.callable.html" class="type Callable">Callable</a></span> <code class="parameter">$collector</code></span>
   )</div>
<div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type">Pool</span> <span class="methodname"><a href="pool.construct.html" class="methodname">__construct</a></span>
    ( <span class="methodparam"><span class="type">integer</span> <code class="parameter">$size</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$class</code></span>
   [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$ctor</code></span>
  ] )</div>
<div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type">void</span> <span class="methodname"><a href="pool.resize.html" class="methodname">resize</a></span>
    ( <span class="methodparam"><span class="type">integer</span> <code class="parameter">$size</code></span>
   )</div>
<div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type">void</span> <span class="methodname"><a href="pool.shutdown.html" class="methodname">shutdown</a></span>
    ( <span class="methodparam">void</span>
   )</div>
<div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type">integer</span> <span class="methodname"><a href="pool.submit.html" class="methodname">submit</a></span>
    ( <span class="methodparam"><span class="type"><a href="class.threaded.html" class="type Threaded">Threaded</a></span> <code class="parameter">$task</code></span>
   )</div>
<div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type">integer</span> <span class="methodname"><a href="pool.submitTo.html" class="methodname">submitTo</a></span>
    ( <span class="methodparam"><span class="type">integer</span> <code class="parameter">$worker</code></span>
   , <span class="methodparam"><span class="type"><a href="class.threaded.html" class="type Threaded">Threaded</a></span> <code class="parameter">$task</code></span>
   )</div>

   }</div>


  </div>

  

  <div class="section" id="pool.props">
   <h2 class="title">プロパティ</h2>
   <dl>

    
     <dt id="pool.props.size"><var class="varname"><var class="varname">size</var></var></dt>

     <dd>

      <p class="para">maximum number of Workers this Pool can use</p>
     </dd>

    
    
     <dt id="pool.props.class"><var class="varname"><var class="varname">class</var></var></dt>

     <dd>

      <p class="para">the class of the Worker</p>
     </dd>

    
    
     <dt id="pool.props.ctor"><var class="varname"><var class="varname">ctor</var></var></dt>

     <dd>

      <p class="para">the arguments for constructor of new Workers</p>
     </dd>

    
    
     <dt id="pool.props.workers"><var class="varname"><var class="varname">workers</var></var></dt>

     <dd>

      <p class="para">references to Workers</p>
     </dd>

    
    
     <dt id="pool.props.work"><var class="varname"><var class="varname">work</var></var></dt>

     <dd>

      <p class="para">references to Threaded objects submitted to the Pool</p>
     </dd>

    
    
     <dt id="pool.props.last"><var class="varname"><var class="varname">last</var></var></dt>

     <dd>

      <p class="para">offset in workers of the last Worker used</p>
     </dd>

    
   </dl>

  </div>



 </div>

 











































<h2>目次</h2><ul class="chunklist chunklist_reference"><li><a href="pool.collect.html">Pool::collect</a> &mdash; Collect references to completed tasks</li><li><a href="pool.construct.html">Pool::__construct</a> &mdash; Creates a new Pool of Workers</li><li><a href="pool.resize.html">Pool::resize</a> &mdash; Resize the Pool</li><li><a href="pool.shutdown.html">Pool::shutdown</a> &mdash; Shutdown all Workers</li><li><a href="pool.submit.html">Pool::submit</a> &mdash; Submits an object for execution</li><li><a href="pool.submitTo.html">Pool::submitTo</a> &mdash; Submits an object for execution</li></ul>
</div>
<div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="115118""></a>
  <div class="note">
   <strong class="user">fajan</strong>
   <a href="#115118" class="date">28-May-2014 10:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Example class to demonstrate usage of Pool/Worker mechanism, also to show a few tricks &amp; hints ;)<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">Config </span><span class="keyword">extends </span><span class="default">Threaded</span><span class="keyword">{&nbsp; &nbsp; </span><span class="comment">// shared global object<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">protected </span><span class="default">$val</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">, </span><span class="default">$val2</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; protected function </span><span class="default">inc</span><span class="keyword">(){++</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">val</span><span class="keyword">;}&nbsp; &nbsp; </span><span class="comment">// protected synchronizes by-object<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">inc2</span><span class="keyword">(){++</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">val2</span><span class="keyword">;}&nbsp; &nbsp; </span><span class="comment">// no synchronization<br />
</span><span class="keyword">}<br />
class </span><span class="default">WorkerClass </span><span class="keyword">extends </span><span class="default">Worker</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; protected static </span><span class="default">$worker_id_next </span><span class="keyword">= -</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$worker_id</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$config</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$config</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">worker_id </span><span class="keyword">= ++static::</span><span class="default">$worker_id_next</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">// static members are not avalable in thread but are in 'main thread'<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">config </span><span class="keyword">= </span><span class="default">$config</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">run</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$config</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">config</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">// NOTE: setting by reference WON'T work<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">global </span><span class="default">$worker_id</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$worker_id </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">worker_id</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"working context </span><span class="keyword">{</span><span class="default">$worker_id</span><span class="keyword">}</span><span class="string"> is created!\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//$this-&gt;say_config();&nbsp; &nbsp; // globally synchronized function.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">}<br />
&nbsp;&nbsp;&nbsp; protected function </span><span class="default">say_config</span><span class="keyword">(){&nbsp; &nbsp; </span><span class="comment">// 'protected' is synchronized by-object so WON'T work between multiple instances<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">global </span><span class="default">$config</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// you can use the shared $config object as synchronization source.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">synchronized</span><span class="keyword">(function() use (&amp;</span><span class="default">$config</span><span class="keyword">){&nbsp; &nbsp; </span><span class="comment">// NOTE: you can use Closures here, but if you attach a Closure to a Threaded object it will be destroyed as can't be serialized<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$config</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; });<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
class </span><span class="default">Task </span><span class="keyword">extends </span><span class="default">Stackable</span><span class="keyword">{&nbsp; &nbsp; </span><span class="comment">// Stackable still exists, it's just somehow dissappeared from docs (probably by mistake). See older version's docs for more details.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">protected </span><span class="default">$set</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$set</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">set </span><span class="keyword">= </span><span class="default">$set</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">run</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$worker_id</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"task is running in </span><span class="keyword">{</span><span class="default">$worker_id</span><span class="keyword">}</span><span class="string">!\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">mt_rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">,</span><span class="default">100</span><span class="keyword">)*</span><span class="default">100</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">getConfig</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val </span><span class="keyword">= </span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">arr</span><span class="keyword">-&gt;</span><span class="default">shift</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">arr</span><span class="keyword">[] = </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">set</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0 </span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">1000</span><span class="keyword">; ++</span><span class="default">$i</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">inc</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">inc2</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">getConfig</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; global </span><span class="default">$config</span><span class="keyword">;&nbsp; &nbsp; </span><span class="comment">// WorkerClass set this on thread's scope, can be reused by Tasks for additional asynch data source. (ie: connection pool or taskqueue to demultiplexer)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">return </span><span class="default">$config</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">$config </span><span class="keyword">= new </span><span class="default">Config</span><span class="keyword">;<br />
</span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">arr </span><span class="keyword">= new \</span><span class="default">Threaded</span><span class="keyword">();<br />
</span><span class="default">$config</span><span class="keyword">-&gt;</span><span class="default">arr</span><span class="keyword">-&gt;</span><span class="default">merge</span><span class="keyword">(array(</span><span class="default">1</span><span class="keyword">,</span><span class="default">2</span><span class="keyword">,</span><span class="default">3</span><span class="keyword">,</span><span class="default">4</span><span class="keyword">,</span><span class="default">5</span><span class="keyword">,</span><span class="default">6</span><span class="keyword">));<br />
class </span><span class="default">PoolClass </span><span class="keyword">extends </span><span class="default">Pool</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">worker_list</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">workers </span><span class="keyword">!== </span><span class="default">null</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">array_keys</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">workers</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">$pool </span><span class="keyword">= new </span><span class="default">PoolClass</span><span class="keyword">(</span><span class="default">3</span><span class="keyword">, </span><span class="string">'WorkerClass'</span><span class="keyword">, [</span><span class="default">$config</span><span class="keyword">] );<br />
</span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">worker_list</span><span class="keyword">();<br />
</span><span class="comment">//$pool-&gt;submitTo(0,new Task(-10));&nbsp; &nbsp; // submitTo DOES NOT try to create worker<br />
<br />
</span><span class="default">$spammed_id </span><span class="keyword">= -</span><span class="default">1</span><span class="keyword">;<br />
for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt;= </span><span class="default">100</span><span class="keyword">; ++</span><span class="default">$i</span><span class="keyword">){&nbsp; &nbsp; </span><span class="comment">// add some jobs<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$spammed_id </span><span class="keyword">== -</span><span class="default">1 </span><span class="keyword">&amp;&amp; (</span><span class="default">$x </span><span class="keyword">= </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">worker_list</span><span class="keyword">())!= </span><span class="default">null </span><span class="keyword">&amp;&amp; @</span><span class="default">$x</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$spammed_id </span><span class="keyword">= </span><span class="default">$x</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"spamming worker </span><span class="keyword">{</span><span class="default">$spammed_id</span><span class="keyword">}</span><span class="string"> with lots of tasks from now on\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$spammed_id </span><span class="keyword">!= -</span><span class="default">1 </span><span class="keyword">&amp;&amp; (</span><span class="default">$i </span><span class="keyword">% </span><span class="default">5</span><span class="keyword">) == </span><span class="default">0</span><span class="keyword">)&nbsp; &nbsp; </span><span class="comment">// every 5th job is routed to one worker, so it has 20% of the total jobs (with 3 workers it should do ~33%, not it has (33+20)%, so only delegate to worker if you plan to do balancing as well... )<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">submitTo</span><span class="keyword">(</span><span class="default">$spammed_id</span><span class="keyword">,new </span><span class="default">Task</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">*</span><span class="default">$i</span><span class="keyword">));&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">submit</span><span class="keyword">(new </span><span class="default">Task</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">*</span><span class="default">$i</span><span class="keyword">));<br />
}<br />
</span><span class="default">$pool</span><span class="keyword">-&gt;</span><span class="default">shutdown</span><span class="keyword">();<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$config</span><span class="keyword">); </span><span class="comment">// "val" is exactly 100000, "val2" is probably a bit less<br />
// also: if you disable the spammer, you'll that the order of the "arr" is random.<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
