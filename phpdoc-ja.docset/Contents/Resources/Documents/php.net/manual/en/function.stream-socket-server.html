<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>インターネットドメインまたは Unix ドメインのサーバーソケットを作成する</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.stream-socket-sendto.html">≪ stream_socket_sendto</a></li>
      <li style="float: right;"><a href="function.stream-socket-shutdown.html">stream_socket_shutdown ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.stream.html">ストリーム 関数</a></li>
    <li>インターネットドメインまたは Unix ドメインのサーバーソケットを作成する</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.stream-socket-server" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">stream_socket_server</h1>
  <p class="verinfo">(PHP 5)</p><p class="refpurpose"><span class="refname">stream_socket_server</span> &mdash; <span class="dc-title">インターネットドメインまたは Unix ドメインのサーバーソケットを作成する</span></p>

 </div>
 <div class="refsect1 description" id="refsect1-function.stream-socket-server-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">resource</span> <span class="methodname"><strong>stream_socket_server</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$local_socket</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter reference">&$errno</code></span>
   [, <span class="methodparam"><span class="type">string</span> <code class="parameter reference">&$errstr</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code><span class="initializer"> = STREAM_SERVER_BIND | STREAM_SERVER_LISTEN</span></span>
   [, <span class="methodparam"><span class="type">resource</span> <code class="parameter">$context</code></span>
  ]]]] )</div>

  <p class="para rdfs-comment">
   <code class="parameter">local_socket</code> で指定された接続ポイントに、
   ストリームまたはデータグラムソケットによる接続を作成します。
  </p>
  <p class="para">
   この関数は、ソケットのみを作成します。接続待ちの状態に入るには、
   <span class="function"><a href="function.stream-socket-accept.html" class="function">stream_socket_accept()</a></span> 関数を使います。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.stream-socket-server-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">local_socket</code></dt>

     <dd>

      <p class="para">
       作成されるソケットのタイプは、<em>[トランスポート]://[ターゲット]</em>
       という形式の URL フォーマットによって指定された
       トランスポートによって決定されます:
      </p>
      <p class="para">
       TCP や UDP といったインターネットドメインのソケット (<strong><code>AF_INET</code></strong>)
       には、<code class="parameter">remote_socket</code> パラメータの
       <em>ターゲット</em> の部分は、ホスト名または IP アドレスと、
       それに続くコロンで区切られたポート番号から構成されていなければなりません。
       Unix ドメインのソケットの場合は、<code class="parameter">ターゲット</code>
       の部分は、ファイルシステムにおけるソケットのファイルを指定しなくては
       いけません。
      </p>
      <p class="para">
       システムの種類によって、Unix ドメインのソケットが利用できない場合があります。
       利用できるトランスポートの種類は、<span class="function"><a href="function.stream-get-transports.html" class="function">stream_get_transports()</a></span>
       によって知ることができます。
       組み込みのトランスポートのリストは、<a href="transports.html" class="xref">サポートされるソケットトランスポートのリスト</a>
       を参照ください。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">errno</code></dt>

     <dd>

      <p class="para">
       オプションの
       <code class="parameter">errno</code> と <code class="parameter">errstr</code>
       パラメータが存在するときは、そこにシステムレベルの
       <em>socket()</em>、<em>bind()</em> および
       <em>listen()</em> のコールにおいて発生した
       実際のシステムレベルのエラーを返します。
       もし、<code class="parameter">errno</code> に返された値が <em>0</em>
       で、かつ <strong><code>FALSE</code></strong> が返された場合、<em>bind()</em>
       コールを行う前にエラーが発生したことを示しており、これは多くの場合
       ソケットの初期化に失敗したことを示しています。
       <code class="parameter">errno</code> と <code class="parameter">errstr</code>
       パラメータは常に参照渡しとなることに留意してください。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">errstr</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">errno</code> の説明を参照ください。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">flags</code></dt>

     <dd>

      <p class="para">
       ソケット作成フラグの任意の組み合わせを指定できるビットフィールドです。
      </p>
      <blockquote class="note"><p><strong class="note">注意</strong>: 
       <p class="para">
        UDP ソケットに対しては、<strong><code>STREAM_SERVER_BIND</code></strong> を
        <code class="parameter">flags</code> パラメータとして使用する必要があります。
       </p>
      </p></blockquote>
     </dd>

    
    
     <dt>
<code class="parameter">context</code></dt>

     <dd>

      <p class="para">
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.stream-socket-server-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   作成したストリーム、あるいはエラー時に <strong><code>FALSE</code></strong> を返します。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.stream-socket-server-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-4162">
    <p><strong>例1 TCP サーバーソケットの使用</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$socket&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">stream_socket_server</span><span style="color: #007700">(</span><span style="color: #DD0000">"tcp://0.0.0.0:8000"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$errstr</span><span style="color: #007700">);<br />if&nbsp;(!</span><span style="color: #0000BB">$socket</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$errstr</span><span style="color: #DD0000">&nbsp;(</span><span style="color: #0000BB">$errno</span><span style="color: #DD0000">)&lt;br&nbsp;/&gt;\n"</span><span style="color: #007700">;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;while&nbsp;(</span><span style="color: #0000BB">$conn&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">stream_socket_accept</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$conn</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'The&nbsp;local&nbsp;time&nbsp;is&nbsp;'&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">date</span><span style="color: #007700">(</span><span style="color: #DD0000">'n/j/Y&nbsp;g:i&nbsp;a'</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$conn</span><span style="color: #007700">);<br />&nbsp;&nbsp;}<br />&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
  <p class="para">
   下記の例は、PHP のスクリプトが、どうやって
   <span class="function"><a href="function.stream-socket-client.html" class="function">stream_socket_client()</a></span> で示したような、
   問い合わせに応答するタイムサーバーとして機能するかを示したものです。
   <blockquote class="note"><p><strong class="note">注意</strong>: 
    <span class="simpara">
     1024 番よりも小さいポート番号のサーバーソケットを作成する場合、
     多くのシステムでは root 権限が必要となります。
    </span>
   </p></blockquote>
   <div class="example" id="example-4163">
    <p><strong>例2 UDP サーバーソケットを利用する</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$socket&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">stream_socket_server</span><span style="color: #007700">(</span><span style="color: #DD0000">"udp://127.0.0.1:1113"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$errno</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$errstr</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">STREAM_SERVER_BIND</span><span style="color: #007700">);<br />if&nbsp;(!</span><span style="color: #0000BB">$socket</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;die(</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$errstr</span><span style="color: #DD0000">&nbsp;(</span><span style="color: #0000BB">$errno</span><span style="color: #DD0000">)"</span><span style="color: #007700">);<br />}<br /><br />do&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$pkt&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">stream_socket_recvfrom</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$peer</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"</span><span style="color: #0000BB">$peer</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">stream_socket_sendto</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">date</span><span style="color: #007700">(</span><span style="color: #DD0000">"D&nbsp;M&nbsp;j&nbsp;H:i:s&nbsp;Y\r\n"</span><span style="color: #007700">),&nbsp;</span><span style="color: #0000BB">0</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$peer</span><span style="color: #007700">);<br />}&nbsp;while&nbsp;(</span><span style="color: #0000BB">$pkt&nbsp;</span><span style="color: #007700">!==&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.stream-socket-server-notes">
  <h3 class="title">注意</h3>
  <blockquote class="note"><p><strong class="note">注意</strong>: <span class="simpara">数値で IPv6 アドレスを指定するときは、
(例 <em>fe80::1</em>) アドレスを角カッコでくくらなくてはなりません。たとえば、
<em>tcp://[fe80::1]:80</em>.</span></p></blockquote>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.stream-socket-server-seealso">
  <h3 class="title">参考</h3>
  <ul class="simplelist">
   <li class="member"><span class="function"><a href="function.stream-socket-client.html" class="function" rel="rdfs-seeAlso">stream_socket_client()</a> - インターネットドメインまたは Unix ドメインのソケット接続を開く</span></li>
   <li class="member"><span class="function"><a href="function.stream-set-blocking.html" class="function" rel="rdfs-seeAlso">stream_set_blocking()</a> - ストリームのブロックモードを有効にする / 解除する</span></li>
   <li class="member"><span class="function"><a href="function.stream-set-timeout.html" class="function" rel="rdfs-seeAlso">stream_set_timeout()</a> - ストリームにタイムアウトを設定する</span></li>
   <li class="member"><span class="function"><a href="function.fgets.html" class="function" rel="rdfs-seeAlso">fgets()</a> - ファイルポインタから 1 行取得する</span></li>
   <li class="member"><span class="function"><a href="function.fgetss.html" class="function" rel="rdfs-seeAlso">fgetss()</a> - ファイルポインタから 1 行取り出し、HTML タグを取り除く</span></li>
   <li class="member"><span class="function"><a href="function.fwrite.html" class="function" rel="rdfs-seeAlso">fwrite()</a> - バイナリセーフなファイル書き込み処理</span></li>
   <li class="member"><span class="function"><a href="function.fclose.html" class="function" rel="rdfs-seeAlso">fclose()</a> - オープンされたファイルポインタをクローズする</span></li>
   <li class="member"><span class="function"><a href="function.feof.html" class="function" rel="rdfs-seeAlso">feof()</a> - ファイルポインタがファイル終端に達しているかどうか調べる</span></li>
   <li class="member"><a href="ref.curl.html" class="link">Curl 拡張モジュール</a></li>
  </ul>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="102878""></a>
  <div class="note">
   <strong class="user">Aurelien Marchand</strong>
   <a href="#102878" class="date">11-Mar-2011 08:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In the case of AF_UNIX sockets, note the named sockets that will be created respects your umask(). So if you wanted your named socket to be writeable to all, do umask(0) prior to calling stream_socket_server().<br />
<br />
AM</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98616""></a>
  <div class="note">
   <strong class="user">frxstrem</strong>
   <a href="#98616" class="date">26-Jun-2010 07:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Using the OpenSSL extension, PHP can automatically generate self-signed SSL certificates, which can be used for basic authentication and encryption (although I would recommend to use a signed certificate instead) for SSL servers.<br />
<br />
I have extended the script by 'e at osterman dot com' to automatically create self-signed certificates:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Hello World! SSL HTTP Server.<br />
// Tested on PHP 5.1.2-1+b1 (cli) (built: Mar 20 2006 04:17:24)<br />
<br />
// Certificate data:<br />
</span><span class="default">$dn </span><span class="keyword">= array(<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"countryName" </span><span class="keyword">=&gt; </span><span class="string">"UK"</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"stateOrProvinceName" </span><span class="keyword">=&gt; </span><span class="string">"Somerset"</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"localityName" </span><span class="keyword">=&gt; </span><span class="string">"Glastonbury"</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"organizationName" </span><span class="keyword">=&gt; </span><span class="string">"The Brain Room Limited"</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"organizationalUnitName" </span><span class="keyword">=&gt; </span><span class="string">"PHP Documentation Team"</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"commonName" </span><span class="keyword">=&gt; </span><span class="string">"Wez Furlong"</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; </span><span class="string">"emailAddress" </span><span class="keyword">=&gt; </span><span class="string">"wez@example.com"<br />
</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Generate certificate<br />
</span><span class="default">$privkey </span><span class="keyword">= </span><span class="default">openssl_pkey_new</span><span class="keyword">();<br />
</span><span class="default">$cert&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">openssl_csr_new</span><span class="keyword">(</span><span class="default">$dn</span><span class="keyword">, </span><span class="default">$privkey</span><span class="keyword">);<br />
</span><span class="default">$cert&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">openssl_csr_sign</span><span class="keyword">(</span><span class="default">$cert</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">$privkey</span><span class="keyword">, </span><span class="default">365</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Generate PEM file<br />
# Optionally change the passphrase from 'comet' to whatever you want, or leave it empty for no passphrase<br />
</span><span class="default">$pem_passphrase </span><span class="keyword">= </span><span class="string">'comet'</span><span class="keyword">;<br />
</span><span class="default">$pem </span><span class="keyword">= array();<br />
</span><span class="default">openssl_x509_export</span><span class="keyword">(</span><span class="default">$cert</span><span class="keyword">, </span><span class="default">$pem</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
</span><span class="default">openssl_pkey_export</span><span class="keyword">(</span><span class="default">$privkey</span><span class="keyword">, </span><span class="default">$pem</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">$pem_passphrase</span><span class="keyword">);<br />
</span><span class="default">$pem </span><span class="keyword">= </span><span class="default">implode</span><span class="keyword">(</span><span class="default">$pem</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Save PEM file<br />
</span><span class="default">$pemfile </span><span class="keyword">= </span><span class="string">'./server.pem'</span><span class="keyword">;<br />
</span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$pemfile</span><span class="keyword">, </span><span class="default">$pem</span><span class="keyword">);<br />
<br />
</span><span class="default">$context </span><span class="keyword">= </span><span class="default">stream_context_create</span><span class="keyword">();<br />
<br />
</span><span class="comment">// local_cert must be in PEM format<br />
</span><span class="default">stream_context_set_option</span><span class="keyword">(</span><span class="default">$context</span><span class="keyword">, </span><span class="string">'ssl'</span><span class="keyword">, </span><span class="string">'local_cert'</span><span class="keyword">, </span><span class="default">$pemfile</span><span class="keyword">);<br />
</span><span class="comment">// Pass Phrase (password) of private key<br />
</span><span class="default">stream_context_set_option</span><span class="keyword">(</span><span class="default">$context</span><span class="keyword">, </span><span class="string">'ssl'</span><span class="keyword">, </span><span class="string">'passphrase'</span><span class="keyword">, </span><span class="default">$pem_passphrase</span><span class="keyword">);<br />
<br />
</span><span class="default">stream_context_set_option</span><span class="keyword">(</span><span class="default">$context</span><span class="keyword">, </span><span class="string">'ssl'</span><span class="keyword">, </span><span class="string">'allow_self_signed'</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
</span><span class="default">stream_context_set_option</span><span class="keyword">(</span><span class="default">$context</span><span class="keyword">, </span><span class="string">'ssl'</span><span class="keyword">, </span><span class="string">'verify_peer'</span><span class="keyword">, </span><span class="default">false</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Create the server socket<br />
</span><span class="default">$server </span><span class="keyword">= </span><span class="default">stream_socket_server</span><span class="keyword">(</span><span class="string">'ssl://0.0.0.0:9001'</span><span class="keyword">, </span><span class="default">$errno</span><span class="keyword">, </span><span class="default">$errstr</span><span class="keyword">, </span><span class="default">STREAM_SERVER_BIND</span><span class="keyword">|</span><span class="default">STREAM_SERVER_LISTEN</span><span class="keyword">, </span><span class="default">$context</span><span class="keyword">);<br />
<br />
while(</span><span class="default">true</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$buffer </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">"waiting..."</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$client </span><span class="keyword">= </span><span class="default">stream_socket_accept</span><span class="keyword">(</span><span class="default">$server</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; print </span><span class="string">"accepted " </span><span class="keyword">. </span><span class="default">stream_socket_get_name</span><span class="keyword">( </span><span class="default">$client</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">) . </span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; if( </span><span class="default">$client </span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Read until double CRLF<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while( !</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">'/\r?\n\r?\n/'</span><span class="keyword">, </span><span class="default">$buffer</span><span class="keyword">) )<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buffer </span><span class="keyword">.= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$client</span><span class="keyword">, </span><span class="default">2046</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Respond to client<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$client</span><span class="keyword">,&nbsp; </span><span class="string">"200 OK HTTP/1.1\r\n"<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">. </span><span class="string">"Connection: close\r\n"<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">. </span><span class="string">"Content-Type: text/html\r\n"<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">. </span><span class="string">"\r\n"<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">. </span><span class="string">"Hello World! " </span><span class="keyword">. </span><span class="default">microtime</span><span class="keyword">(</span><span class="default">true</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; . </span><span class="string">"&lt;pre&gt;</span><span class="keyword">{</span><span class="default">$buffer</span><span class="keyword">}</span><span class="string">&lt;/pre&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$client</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print </span><span class="string">"error.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95417""></a>
  <div class="note">
   <strong class="user">peterjb at me dot com</strong>
   <a href="#95417" class="date">02-Jan-2010 12:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I had a horrible time trying to shove a TLS socket into an existing TCP program.&nbsp; It appears to me that functions like stream_socket_recvfrom and stream_socket_sendto don't work with TLS/SSL (which may be obvious to PHP gurus...sorry if it is, I'm in a bit over my head here).<br />
<br />
In the end I ended up doing all my IO with fread() and fwrite(), which solved all my problems.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="94749""></a>
  <div class="note">
   <strong class="user">davidm at marketo dot com</strong>
   <a href="#94749" class="date">23-Nov-2009 01:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In some specialized scenarios, you may want to create an AF_INET socket (UDP or TCP) but let the system select an unused port for you.&nbsp; This is a standard feature of internet sockets but it doesn't seem to be documented how to do this for the stream_socket_server function.&nbsp; It appears you can get this behavior by selecting zero for the port number, for example, my test below printed "127.0.0.1:4960".
<br />

<br />
<span class="default">&lt;?php
<br />
&nbsp; $sock </span><span class="keyword">= </span><span class="default">stream_socket_server</span><span class="keyword">(</span><span class="string">"udp://127.0.0.1:0"</span><span class="keyword">); 
<br />
&nbsp; </span><span class="default">$name </span><span class="keyword">= </span><span class="default">stream_socket_get_name</span><span class="keyword">(</span><span class="default">$sock</span><span class="keyword">);
<br />
&nbsp; echo </span><span class="default">$name</span><span class="keyword">;
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91079""></a>
  <div class="note">
   <strong class="user">Julien Picalausa</strong>
   <a href="#91079" class="date">24-May-2009 10:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You may have noticed that, unlike socket_listen, stream_socket_server doesn't have a backlog parameter. From the source code of php 5.2.9, it looks like the backlog parameter to the actual listen call is hardcoded to be 5. If this value doesn't suit your needs, you'll have to use the lower-level socket functions.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="67837""></a>
  <div class="note">
   <strong class="user">Neil Munro</strong>
   <a href="#67837" class="date">05-Jul-2006 10:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want a high speed socket server, use the low-level sockets instead (socket_create/bind/listen). The stream_socket_server version appears to have internal fixed 8k buffers that will overflow if you don't keep up by reading.<br />
<br />
This is a serious problem if you an application that reads the socket for messages and then, say, saves the result in a database. The delay while it is busy processing means you can't read the data in time unless you get involved in muti-threading.<br />
<br />
With the the low-level functions, the OS quietly buffers TCP/IP packets so there is no problem (tested on Windows XP Professional).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="44501""></a>
  <div class="note">
   <strong class="user">andrey at php dot net</strong>
   <a href="#44501" class="date">08-Aug-2004 06:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a small example how to use this function and also stream_select() to make a server that accepts more than one connections (can have many clients connected):<br />
In master we hold all opened connections. Just before calling stream select we copy the array to $read and then pass it ot stream_select(). In case that we may read from at least one socket, $read will contain socket descriptors. $master is needed not to lose references to the opened connections we have.<br />
stream_server.php : <br />
<span class="default">&lt;?php<br />
<br />
$master </span><span class="keyword">= array();<br />
</span><span class="default">$socket </span><span class="keyword">= </span><span class="default">stream_socket_server</span><span class="keyword">(</span><span class="string">"tcp://0.0.0.0:8000"</span><span class="keyword">, </span><span class="default">$errno</span><span class="keyword">, </span><span class="default">$errstr</span><span class="keyword">);<br />
if (!</span><span class="default">$socket</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"</span><span class="default">$errstr</span><span class="string"> (</span><span class="default">$errno</span><span class="string">)&lt;br /&gt;\n"</span><span class="keyword">;<br />
} else {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$master</span><span class="keyword">[] = </span><span class="default">$socket</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$read </span><span class="keyword">= </span><span class="default">$master</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; while (</span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$read </span><span class="keyword">= </span><span class="default">$master</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$mod_fd </span><span class="keyword">= </span><span class="default">stream_select</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">, </span><span class="default">$_w </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">, </span><span class="default">$_e </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">, </span><span class="default">5</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$mod_fd </span><span class="keyword">=== </span><span class="default">FALSE</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for (</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$mod_fd</span><span class="keyword">; ++</span><span class="default">$i</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$read</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] === </span><span class="default">$socket</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$conn </span><span class="keyword">= </span><span class="default">stream_socket_accept</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$conn</span><span class="keyword">, </span><span class="string">"Hello! The time is "</span><span class="keyword">.</span><span class="default">date</span><span class="keyword">(</span><span class="string">"n/j/Y g:i a"</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$master</span><span class="keyword">[] = </span><span class="default">$conn</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sock_data </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$sock_data</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$sock_data</span><span class="keyword">) === </span><span class="default">0</span><span class="keyword">) { </span><span class="comment">// connection closed<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key_to_del </span><span class="keyword">= </span><span class="default">array_search</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">$master</span><span class="keyword">, </span><span class="default">TRUE</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$master</span><span class="keyword">[</span><span class="default">$key_to_del</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else if (</span><span class="default">$sock_data </span><span class="keyword">=== </span><span class="default">FALSE</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Something bad happened"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$key_to_del </span><span class="keyword">= </span><span class="default">array_search</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">$master</span><span class="keyword">, </span><span class="default">TRUE</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$master</span><span class="keyword">[</span><span class="default">$key_to_del</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"The client has sent :"</span><span class="keyword">; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$sock_data</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="string">"You have sent :["</span><span class="keyword">.</span><span class="default">$sock_data</span><span class="keyword">.</span><span class="string">"]\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; unset(</span><span class="default">$master</span><span class="keyword">[</span><span class="default">array_search</span><span class="keyword">(</span><span class="default">$read</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">], </span><span class="default">$master</span><span class="keyword">)]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;<br />
</span>stream_client.php:<br />
<span class="default">&lt;?php<br />
$fp </span><span class="keyword">= </span><span class="default">stream_socket_client</span><span class="keyword">(</span><span class="string">"tcp://127.0.0.1:8000"</span><span class="keyword">, </span><span class="default">$errno</span><span class="keyword">, </span><span class="default">$errstr</span><span class="keyword">, </span><span class="default">30</span><span class="keyword">);<br />
if (!</span><span class="default">$fp</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"</span><span class="default">$errstr</span><span class="string"> (</span><span class="default">$errno</span><span class="string">)&lt;br /&gt;\n"</span><span class="keyword">;<br />
} else {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"Aloha"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; while (!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Thanks</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
