<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>既存のラージオブジェクトのストリームをオープンする</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="pdo.pgsqllobcreate.html">≪ PDO::pgsqlLOBCreate</a></li>
      <li style="float: right;"><a href="pdo.pgsqllobunlink.html">PDO::pgsqlLOBUnlink ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.pdo-pgsql.html">PostgreSQL (PDO)</a></li>
    <li>既存のラージオブジェクトのストリームをオープンする</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="pdo.pgsqllobopen" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">PDO::pgsqlLOBOpen</h1>
  <p class="verinfo">(PHP 5 &gt;= 5.1.2, PECL pdo_pgsql &gt;= 1.0.2)</p><p class="refpurpose"><span class="refname">PDO::pgsqlLOBOpen</span> &mdash; <span class="dc-title">既存のラージオブジェクトのストリームをオープンする</span></p>

 </div>
 <div class="refsect1 description" id="refsect1-pdo.pgsqllobopen-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type">resource</span> <span class="methodname"><strong>PDO::pgsqlLOBOpen</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$oid</code></span>
   [, <span class="methodparam"><span class="type">string</span> <code class="parameter">$mode</code><span class="initializer"> = &quot;rb&quot;</span></span>
  ] )</div>

  <p class="para rdfs-comment">
   <span class="function"><strong>PDO::pgsqlLOBOpen()</strong></span> は、<code class="parameter">oid</code>
   が指すデータにアクセスするためのストリームをオープンします。
   <code class="parameter">mode</code> が <em>r</em> の場合、
   ストリームは読み込み用にオープンされます。
   <code class="parameter">mode</code> が <em>w</em> の場合、
   ストリームは書き込み用にオープンされます。
   <span class="function"><a href="function.fread.html" class="function">fread()</a></span>、<span class="function"><a href="function.fwrite.html" class="function">fwrite()</a></span> および
   <span class="function"><a href="function.fgets.html" class="function">fgets()</a></span> のような通常のファイルシステム関数を使用して、
   ストリームの内容を操作することができます。
  </p>
   <blockquote class="note"><p><strong class="note">注意</strong>: 
   <span class="simpara">
    この関数およびラージオブジェクトに対するすべての操作は、
    トランザクション内で処理される必要があります。
   </span>
  </p></blockquote>
</div>

 <div class="refsect1 parameters" id="refsect1-pdo.pgsqllobopen-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">oid</code></dt>

     <dd>

      <p class="para">
       ラージオブジェクトの ID。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">mode</code></dt>

     <dd>

      <p class="para">
       モードが <em>r</em> の場合、読み込み用のストリームをオープンします。
       モードが <em>w</em> の場合、書き込み用のストリームをオープンします。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>

 <div class="refsect1 returnvalues" id="refsect1-pdo.pgsqllobopen-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   成功した場合にストリームリソース、失敗した場合に <strong><code>FALSE</code></strong> を返します。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-pdo.pgsqllobopen-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-1033">
    <p><strong>例1 <span class="function"><strong>PDO::pgsqlLOBOpen()</strong></span> の例</strong></p>
    <div class="example-contents"><p>
     <span class="function"><a href="pdo.pgsqllobcreate.html" class="function">PDO::pgsqlLOBCreate()</a></span> の例に引き続き、
     このコード片はデータベースからラージオブジェクトを取得して
     それをブラウザに出力します。
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$db&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">(</span><span style="color: #DD0000">'pgsql:dbname=test&nbsp;host=localhost'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$user</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$pass</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setAttribute</span><span style="color: #007700">(</span><span style="color: #0000BB">PDO</span><span style="color: #007700">::</span><span style="color: #0000BB">ATTR_ERRMODE</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">::</span><span style="color: #0000BB">ERRMODE_EXCEPTION</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">beginTransaction</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$stmt&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">"select&nbsp;oid&nbsp;from&nbsp;BLOBS&nbsp;where&nbsp;ident&nbsp;=&nbsp;?"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">(array(</span><span style="color: #0000BB">$some_id</span><span style="color: #007700">));<br /></span><span style="color: #0000BB">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bindColumn</span><span style="color: #007700">(</span><span style="color: #DD0000">'oid'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$oid</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">PDO</span><span style="color: #007700">::</span><span style="color: #0000BB">PARAM_STR</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch</span><span style="color: #007700">(</span><span style="color: #0000BB">PDO</span><span style="color: #007700">::</span><span style="color: #0000BB">FETCH_BOUND</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$stream&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$db</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">pgsqlLOBOpen</span><span style="color: #007700">(</span><span style="color: #0000BB">$oid</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'r'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">header</span><span style="color: #007700">(</span><span style="color: #DD0000">"Content-type:&nbsp;application/octet-stream"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fpassthru</span><span style="color: #007700">(</span><span style="color: #0000BB">$stream</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>



 <div class="refsect1 seealso" id="refsect1-pdo.pgsqllobopen-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="pdo.pgsqllobcreate.html" class="function" rel="rdfs-seeAlso">PDO::pgsqlLOBCreate()</a> - 新しいラージオブジェクトを作成する</span></li>
    <li class="member"><span class="function"><a href="pdo.pgsqllobunlink.html" class="function" rel="rdfs-seeAlso">PDO::pgsqlLOBUnlink()</a> - ラージオブジェクトを削除する</span></li>
    <li class="member"><span class="function"><a href="function.pg-lo-open.html" class="function" rel="rdfs-seeAlso">pg_lo_open()</a> - ラージオブジェクトをオープンする</span></li>
   </ul>
  </p>
 </div>



</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="89398""></a>
  <div class="note">
   <strong class="user">binaryexp at gmail</strong>
   <a href="#89398" class="date">06-Mar-2009 01:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is what worked for me. If you have the oid, then all you need to do is:<br />
<br />
<span class="default">&lt;?php<br />
$pdo </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="default">$dsn</span><span class="keyword">, </span><span class="default">$user</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">);<br />
</span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">beginTransaction</span><span class="keyword">();<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">pgsqlLOBOpen</span><span class="keyword">(</span><span class="default">$oid</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">);<br />
<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-Type: </span><span class="default">$mime</span><span class="string">"</span><span class="keyword">);<br />
</span><span class="comment">// any other headers...<br />
<br />
</span><span class="default">fpassthru</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);&nbsp; </span><span class="comment">// echo stream_get_contents($data); also works<br />
</span><span class="default">?&gt;<br />
</span><br />
The beginTransaction() is required, if you want to $pdo-&gt;commit() (it's not required) then do it after the fpassthru.<br />
<br />
On a side note, those using Zend Framework can call getConnection() on the standard PDO database object which will get them the $pdo object as above. Then just remember to disableLayout() and setNoRender() as necessary.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85952""></a>
  <div class="note">
   <strong class="user">knl at bitflop dot com</strong>
   <a href="#85952" class="date">26-Sep-2008 02:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Also remember that fread() will only parse the first 8192 bytes from the stream. Use..<br />
<br />
<span class="default">&lt;?php<br />
$data </span><span class="keyword">= </span><span class="default">stream_get_contents</span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
.. if you have a larger output to parse.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85945""></a>
  <div class="note">
   <strong class="user">knl at bitflop dot com</strong>
   <a href="#85945" class="date">26-Sep-2008 12:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The above example is missing some data. After spending several hours trying to get it to work in vain, Jeff Davis from the PostgreSQL channel on IRC (freenode) figured out what was missing.<br />
<br />
The below example will work, but you have to insert the MIME type and file size of the large object that you are storing, so you can use that data for extraction.<br />
<br />
<span class="default">&lt;?php<br />
$db </span><span class="keyword">= new </span><span class="default">PDO</span><span class="keyword">(</span><span class="string">'pgsql:dbname=test host=localhost'</span><span class="keyword">, </span><span class="default">$user</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">);<br />
</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">setAttribute</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">ATTR_ERRMODE</span><span class="keyword">, </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">ERRMODE_EXCEPTION</span><span class="keyword">);<br />
</span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">beginTransaction</span><span class="keyword">();<br />
</span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$db</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"SELECT oid, blob_type, filesize FROM BLOBS WHERE ident = ?"</span><span class="keyword">);<br />
</span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">(array(</span><span class="default">$some_id</span><span class="keyword">));<br />
</span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">bindColumn</span><span class="keyword">(</span><span class="string">'oid'</span><span class="keyword">, </span><span class="default">$lob</span><span class="keyword">, </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_LOB</span><span class="keyword">);<br />
</span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">bindColumn</span><span class="keyword">(</span><span class="string">'blob_type'</span><span class="keyword">, </span><span class="default">$blob_type</span><span class="keyword">, </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_STR</span><span class="keyword">);<br />
</span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">bindColumn</span><span class="keyword">(</span><span class="string">'filesize'</span><span class="keyword">, </span><span class="default">$filesize</span><span class="keyword">, </span><span class="default">PDO</span><span class="keyword">::</span><span class="default">PARAM_STR</span><span class="keyword">);<br />
</span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">(</span><span class="default">PDO</span><span class="keyword">::</span><span class="default">FETCH_BOUND</span><span class="keyword">);<br />
</span><span class="default">$stream </span><span class="keyword">= </span><span class="default">$pdo</span><span class="keyword">-&gt;</span><span class="default">pgsqlLOBOpen</span><span class="keyword">(</span><span class="default">$lob</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">);<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">, </span><span class="default">$filesize</span><span class="keyword">);<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">"Content-type: </span><span class="default">$blob_type</span><span class="string">"</span><span class="keyword">);<br />
echo </span><span class="default">$data</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
Also fpassthru() will just give this result: Warning: fpassthru(): supplied argument is not a valid stream resource in ...<br />
<br />
Use echo or print instead.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
