<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>OAuth で保護されたリソースを取得する</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="oauth.enablesslchecks.html">≪ OAuth::enableSSLChecks</a></li>
      <li style="float: right;"><a href="oauth.generatesignature.html">OAuth::generateSignature ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="class.oauth.html">OAuth</a></li>
    <li>OAuth で保護されたリソースを取得する</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="oauth.fetch" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">OAuth::fetch</h1>
  <p class="verinfo">(PECL OAuth &gt;= 0.99.1)</p><p class="refpurpose"><span class="refname">OAuth::fetch</span> &mdash; <span class="dc-title">OAuth で保護されたリソースを取得する</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-oauth.fetch-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <span class="methodname"><strong>OAuth::fetch</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$protected_resource_url</code></span>
   [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$extra_parameters</code></span>
   [, <span class="methodparam"><span class="type">string</span> <code class="parameter">$http_method</code></span>
   [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$http_headers</code></span>
  ]]] )</div>

  <p class="para rdfs-comment">
   リソースを取得します。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-oauth.fetch-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">protected_resource_url</code></dt>

     <dd>

      <p class="para">
       OAuth で保護されたリソースへの URL。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">extra_parameters</code></dt>

     <dd>

      <p class="para">
       リソースへのリクエストとともに送信する追加パラメータ。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">http_method</code></dt>

     <dd>

      <p class="para">
       <strong><code>OAUTH_HTTP_METHOD_*</code></strong>
       <a href="oauth.constants.html" class="link">OAUTH 定数</a> のいずれか。
       GET、POST、PUT、HEAD そして DELETE があります。
      </p>
      <p class="para">
       HEAD (<strong><code>OAUTH_HTTP_METHOD_HEAD</code></strong>) は、
       実際のリクエストの前に
       (OAuth 認証情報が <em>Authorization</em> ヘッダにあるかどうかなどの)
       情報を取得するときに有用です。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">http_headers</code></dt>

     <dd>

      <p class="para">
       HTTP クライアントヘッダ (User-Agent や Accept など)。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-oauth.fetch-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   成功した場合に <strong><code>TRUE</code></strong> を、失敗した場合に <strong><code>FALSE</code></strong> を返します。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-oauth.fetch-changelog">
  <h3 class="title">変更履歴</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>バージョン</th>
       <th>説明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>1.0.0</td>
       <td>
        以前は、失敗したときに <strong><code>FALSE</code></strong> ではなく <strong><code>NULL</code></strong> を返していました。
       </td>
      </tr>

      <tr>
       <td>0.99.5</td>
       <td>
        <code class="parameter">http_method</code> パラメータが追加されました。
       </td>
      </tr>

      <tr>
       <td>0.99.8</td>
       <td>
        <code class="parameter">http_headers</code> パラメータが追加されました。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-oauth.fetch-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-5389">
    <p><strong>例1 <span class="function"><strong>OAuth::fetch()</strong></span> の例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #007700">try&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$oauth&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">OAuth</span><span style="color: #007700">(</span><span style="color: #DD0000">"consumer_key"</span><span style="color: #007700">,</span><span style="color: #DD0000">"consumer_secret"</span><span style="color: #007700">,</span><span style="color: #0000BB">OAUTH_SIG_METHOD_HMACSHA1</span><span style="color: #007700">,</span><span style="color: #0000BB">OAUTH_AUTH_TYPE_AUTHORIZATION</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$oauth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">setToken</span><span style="color: #007700">(</span><span style="color: #DD0000">"access_token"</span><span style="color: #007700">,</span><span style="color: #DD0000">"access_token_secret"</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$oauth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch</span><span style="color: #007700">(</span><span style="color: #DD0000">"http://photos.example.net/photo?file=vacation.jpg"</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$response_info&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$oauth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getLastResponseInfo</span><span style="color: #007700">();<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">header</span><span style="color: #007700">(</span><span style="color: #DD0000">"Content-Type:&nbsp;</span><span style="color: #007700">{</span><span style="color: #0000BB">$response_info</span><span style="color: #007700">[</span><span style="color: #DD0000">"content_type"</span><span style="color: #007700">]}</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">$oauth</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">getLastResponse</span><span style="color: #007700">();<br />}&nbsp;catch(</span><span style="color: #0000BB">OAuthException&nbsp;$E</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Exception&nbsp;caught!\n"</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Response:&nbsp;"</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">$E</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">lastResponse&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-oauth.fetch-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="methodname"><a href="oauth.getlastresponse.html" class="methodname" rel="rdfs-seeAlso">OAuth::getLastResponse()</a> - 直近のレスポンスを取得する</span></li>
    <li class="member"><span class="methodname"><a href="oauth.getlastresponseinfo.html" class="methodname" rel="rdfs-seeAlso">OAuth::getLastResponseInfo()</a> - 直近のレスポンスの HTTP 情報を取得する</span></li>
    <li class="member"><span class="methodname"><a href="oauth.settoken.html" class="methodname" rel="rdfs-seeAlso">OAuth::setToken()</a> - トークンと secret を設定する</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="114737""></a>
  <div class="note">
   <strong class="user">zverik at textual dot ru</strong>
   <a href="#114737" class="date">01-Apr-2014 05:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If $extra_parameters is not an array, you have to specify Content-Type header, or else you'll get HTTP 401 error. Example:<br />
<br />
<span class="default">&lt;?php<br />
$oauth</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">(</span><span class="default">ENDPOINT</span><span class="keyword">, </span><span class="string">'{"action": "get_user_info"}'</span><span class="keyword">, </span><span class="default">OAUTH_HTTP_METHOD_PUT</span><span class="keyword">, array(</span><span class="string">'Content-Type' </span><span class="keyword">=&gt; </span><span class="string">'application/json'</span><span class="keyword">));<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111574""></a>
  <div class="note">
   <strong class="user">chris dot barr at ntlworld dot com</strong>
   <a href="#111574" class="date">06-Mar-2013 02:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The fetch() method will throw an OAuthException if the returned http status code is in the 4xx or 5xx range:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Querying Twitter with bad login details<br />
</span><span class="keyword">try {<br />
&nbsp; </span><span class="default">$oauth</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">(</span><span class="string">'https://api.twitter.com/1.1/favorites/list.json'</span><span class="keyword">);<br />
}<br />
catch(</span><span class="default">Exception $e</span><span class="keyword">) {<br />
&nbsp; echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getCode</span><span class="keyword">(); </span><span class="comment">// 401<br />
&nbsp; // Message generated by OAuth class<br />
&nbsp; </span><span class="keyword">echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">(); </span><span class="comment">// Invalid auth/bad request (got a 401, expected HTTP/1.1 20X or a redirect)<br />
&nbsp; // Message returned from Twitter<br />
&nbsp; </span><span class="keyword">echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">lastResponse</span><span class="keyword">; </span><span class="comment">// {"errors":[{"message":"Could not authenticate you","code":32}]}<br />
</span><span class="keyword">}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="105332""></a>
  <div class="note">
   <strong class="user">sun at drupal dot org</strong>
   <a href="#105332" class="date">10-Aug-2011 03:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Make sure that your $extra_parameters is an array.<br />
<br />
If it's not, then OAuth will silently skip the malformed data type and produce a signature base string that is invalid (doesn't contain POST parameters, as defined in the RFC).<br />
<br />
You should file a critical bug report against any REST API you find in the wild that accepts such a bogus signature to pass authentication.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103074""></a>
  <div class="note">
   <strong class="user">contact info  at  mech dot cx</strong>
   <a href="#103074" class="date">24-Mar-2011 01:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was having troubles getting fetch() to post, the remote server (Twitter, in this case) complained at me that their "resource only supports POST". Turned out to be a known bug in OAuth 1.1, downgrading to 1.0 fixed it.<br />
<br />
Don't lose as much time over this as I did :-)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99627""></a>
  <div class="note">
   <strong class="user">Lyuben Penkovski (l_penkovski at yahoo dot com)</strong>
   <a href="#99627" class="date">27-Aug-2010 08:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If the provider's web server is configured to use Keep-Alive extension to HTTP protocol (HTTP 1.1), there can be a big delay in the response time from the provider. By default Apache is configured to use Keep-Alive for 5 seconds. This is the delay after which the response will come back to the consumer. If you have this issue of delayed result, you can pass in HTTP headers when calling $consumer-&gt;fetch():<br />
<br />
<span class="default">&lt;?php<br />
$consumer </span><span class="keyword">= new </span><span class="default">OAuth</span><span class="keyword">(</span><span class="string">"consumer_key"</span><span class="keyword">, </span><span class="string">"consumer_secret"</span><span class="keyword">, </span><span class="default">OAUTH_SIG_METHOD_HMACSHA1</span><span class="keyword">, </span><span class="default">OAUTH_AUTH_TYPE_FORM</span><span class="keyword">);<br />
</span><span class="default">$consumer</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">(</span><span class="string">'<a href="http://example.com/api/" rel="nofollow" target="_blank">http://example.com/api/</a>'</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">OAUTH_HTTP_METHOD_POST</span><span class="keyword">, array(</span><span class="string">'Connection'</span><span class="keyword">=&gt;</span><span class="string">'close'</span><span class="keyword">));<br />
</span><span class="default">?&gt;<br />
</span><br />
Then the provider will send the result immediately after it's ready with the processing and the connection will be closed. Unfortunately, when calling $consumer-&gt;getRequestToken() and $consumer-&gt;getAccessToken() there's no way provided to pass in HTTP headers and this delay (if present) cannot be avoided, or at least we could not find a way to avoid it.<br />
<br />
The solution that worked for us is to send this header from the provider when returning result to the consumer:<br />
<br />
<span class="default">&lt;?php<br />
$result </span><span class="keyword">= </span><span class="string">'oauth_callback_accepted=true&amp;oauth_token=' </span><span class="keyword">. </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">urlencode</span><span class="keyword">(</span><span class="default">$token</span><span class="keyword">-&gt;</span><span class="default">oauth_token</span><span class="keyword">) .<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'&amp;oauth_token_secret='</span><span class="keyword">.</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">urlencode</span><span class="keyword">(</span><span class="default">$token</span><span class="keyword">-&gt;</span><span class="default">oauth_token_secret</span><span class="keyword">);<br />
<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">'HTTP/1.1 200 OK'</span><span class="keyword">);<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">'Content-Length: '</span><span class="keyword">.</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$result</span><span class="keyword">));<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">'Content-Type: application/x-www-form-urlencoded'</span><span class="keyword">);<br />
</span><span class="default">header</span><span class="keyword">(</span><span class="string">'Connection:close'</span><span class="keyword">);<br />
echo </span><span class="default">$result</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
This can work if you have the possibility to modify the code of the provider, e.g. if you are the provider yourself or if you can talk with the people that develop it and ask them to send this header for your request.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
