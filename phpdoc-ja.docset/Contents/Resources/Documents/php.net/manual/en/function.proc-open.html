<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>コマンドを実行し、入出力用にファイルポインタを開く</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.proc-nice.html">≪ proc_nice</a></li>
      <li style="float: right;"><a href="function.proc-terminate.html">proc_terminate ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.exec.html">プログラム実行関数</a></li>
    <li>コマンドを実行し、入出力用にファイルポインタを開く</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.proc-open" class="refentry">
   <div class="refnamediv">
    <h1 class="refname">proc_open</h1>
    <p class="verinfo">(PHP 4 &gt;= 4.3.0, PHP 5)</p><p class="refpurpose"><span class="refname">proc_open</span> &mdash; <span class="dc-title">
     コマンドを実行し、入出力用にファイルポインタを開く
    </span></p>

   </div>
   <div class="refsect1 description" id="refsect1-function.proc-open-description">
    <h3 class="title">説明</h3>
     <div class="methodsynopsis dc-description">
      <span class="type">resource</span> <span class="methodname"><strong>proc_open</strong></span>
       ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$cmd</code></span>
      , <span class="methodparam"><span class="type">array</span> <code class="parameter">$descriptorspec</code></span>
      , <span class="methodparam"><span class="type">array</span> <code class="parameter reference">&$pipes</code></span>
      [, <span class="methodparam"><span class="type">string</span> <code class="parameter">$cwd</code></span>
      [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$env</code></span>
      [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$other_options</code></span>
     ]]] )</div>

    <p class="para rdfs-comment">
     <span class="function"><strong>proc_open()</strong></span> は <span class="function"><a href="function.popen.html" class="function">popen()</a></span> と
     よく似ていますが、プログラムの実行をさらに細かく制御できる点で違います。
    </p>



   </div>


 <div class="refsect1 parameters" id="refsect1-function.proc-open-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">cmd</code></dt>

     <dd>

      <p class="para">
       実行されるコマンド。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">descriptorspec</code></dt>

     <dd>

      <p class="para">
       数値添字の配列で、ディスクリプタ番号をキーとし、PHP がその
       ディスクリプタをどのように子プロセスに渡すかを表すのが
       対応する値となります。
       0 が標準入力 (stdin)、1 が標準出力 (stdout) で、
       2 が標準エラー出力 (stderr) となります。
      </p>
      <p class="para">
       各要素は、次のようになります。
       <ul class="simplelist">
        <li class="member">
         プロセスに渡すパイプをあらわす配列。
         最初の要素はディスクリプタの型で、2 番目の要素がその型に対応するオプションとなります。
         使用できる型は <em>pipe</em> (2 番目の要素は、
         プロセスにパイプの読み込み側を渡すのなら <em>r</em>、
         書き込み側を渡すのなら <em>w</em>)
         および <em>file</em> (2 番目の要素はファイル名)
         です。
        </li>
        <li class="member">
         実際のファイルディスクリプタ (オープンしたファイルやソケット、
         <strong><code>STDIN</code></strong> など) をあらわすストリームリソース。
        </li>
       </ul>
      </p>
      <p class="para">
       ファイルディスクリプタの番号は、特に 0, 1, 2 に限られているわけでは
       ありません。有効であるどのようなファイルディスクリプタの番号も指定でき、
       それは子プロセスに渡されます。これにより、あるスクリプトと、
       子プロセスとして起動している別のスクリプトとの間で通信ができます。
       特に、これは PGP や GPG、openssl といったプログラムにパスフレーズを
       より安全な方法で渡したいとき威力を発揮します。
       補助的なファイルディスクリプタを介して、そのようなプログラムの
       状態を取得するのにも便利です。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">pipes</code></dt>

     <dd>

      <p class="para">
       PHP 側で生成されたパイプの終端にあたる
       ファイルポインタの配列。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">cwd</code></dt>

     <dd>

      <p class="para">
       コマンドの初期作業ディレクトリ。
       <em class="emphasis">完全</em>パスである必要があります。
       デフォルト値 (現在の PHP プロセスの作業ディレクトリ) を使用したい場合は
       <strong><code>NULL</code></strong> を指定します。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">env</code></dt>

     <dd>

      <p class="para">
       実行するコマンドのための環境変数の配列。
       現在の PHP プロセスと同じ環境変数を使用する場合は
       <strong><code>NULL</code></strong> を指定します。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">other_options</code></dt>

     <dd>

      <p class="para">
       その他の追加オプションを指定することが可能です。
       現在サポートされているオプションは次の通りです。
       <ul class="simplelist">
        <li class="member">
         <em>suppress_errors</em> (windows のみ):
         <strong><code>TRUE</code></strong> にすると、この関数が出力するエラーを抑制します。
        </li>
        <li class="member">
         <em>bypass_shell</em> (windows のみ):
         <strong><code>TRUE</code></strong> にすると、<em>cmd.exe</em> シェルをバイパスします。
        </li>
       </ul>
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.proc-open-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   プロセスを表すリソースを返します。このリソースは、使用し終えた際に
   <span class="function"><a href="function.proc-close.html" class="function">proc_close()</a></span> を使用して開放する必要があります。
   失敗した場合は <strong><code>FALSE</code></strong> を返します。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.proc-open-changelog">
  <h3 class="title">変更履歴</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>バージョン</th>
       <th>説明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>5.2.1</td>
       <td>
        <code class="parameter">other_options</code> パラメータに
        オプション <em>bypass_shell</em> が追加されました。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.proc-open-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-3773">
    <p><strong>例1 A <span class="function"><strong>proc_open()</strong></span> の例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$descriptorspec&nbsp;</span><span style="color: #007700">=&nbsp;array(<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">0&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"r"</span><span style="color: #007700">),&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;stdin&nbsp;は、子プロセスが読み込むパイプです。<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">1&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"pipe"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"w"</span><span style="color: #007700">),&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;stdout&nbsp;は、子プロセスが書き込むパイプです。<br />&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">2&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(</span><span style="color: #DD0000">"file"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"/tmp/error-output.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"a"</span><span style="color: #007700">)&nbsp;</span><span style="color: #FF8000">//&nbsp;はファイルで、そこに書き込みます。<br /></span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$cwd&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'/tmp'</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$env&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">'some_option'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'aeiou'</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$process&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">proc_open</span><span style="color: #007700">(</span><span style="color: #DD0000">'php'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$descriptorspec</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$pipes</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$cwd</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$env</span><span style="color: #007700">);<br /><br />if&nbsp;(</span><span style="color: #0000BB">is_resource</span><span style="color: #007700">(</span><span style="color: #0000BB">$process</span><span style="color: #007700">))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;$pipes&nbsp;はこの時点で次のような形を取っています。<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;0&nbsp;=&gt;&nbsp;子プロセスの&nbsp;stdin&nbsp;に繋がれた書き込み可能なハンドル<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;1&nbsp;=&gt;&nbsp;子プロセスの&nbsp;stdout&nbsp;に繋がれた読み込み可能なハンドル<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;すべてのエラー出力は&nbsp;/tmp/error-output.txt&nbsp;に書き込みされます。<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$pipes</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">],&nbsp;</span><span style="color: #DD0000">'&lt;?php&nbsp;print_r($_ENV);&nbsp;?&gt;'</span><span style="color: #007700">);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$pipes</span><span style="color: #007700">[</span><span style="color: #0000BB">0</span><span style="color: #007700">]);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #0000BB">stream_get_contents</span><span style="color: #007700">(</span><span style="color: #0000BB">$pipes</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]);<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$pipes</span><span style="color: #007700">[</span><span style="color: #0000BB">1</span><span style="color: #007700">]);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;デッドロックを避けるため、proc_close&nbsp;を呼ぶ前に<br />&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;すべてのパイプを閉じることが重要です。<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$return_value&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">proc_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$process</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"command&nbsp;returned&nbsp;</span><span style="color: #0000BB">$return_value</span><span style="color: #DD0000">\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>上の例の出力は、
たとえば以下のようになります。</p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
Array
(
    [some_option] =&gt; aeiou
    [PWD] =&gt; /tmp
    [SHLVL] =&gt; 1
    [_] =&gt; /usr/local/bin/php
)
command returned 0
</pre></div>
    </div>
   </div>
  </p>



 </div>


 <div class="refsect1 notes" id="refsect1-function.proc-open-notes">
  <h3 class="title">注意</h3>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <p class="para">
    Windows における互換性: 2 (stderr) よりも大きな番号のディスクリプタは
    子プロセスに継承可能なハンドルとして渡されますが、
    Windows のアーキテクチャは、ファイルディスクリプタの番号と
    より低レベルなハンドルを関連付けないので、子プロセスは、
    それらのハンドルにアクセスする術を持ちません。stdin, stdout, stderr
    は期待通り動きます。
   </p>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <p class="para">
    もし単方向(一方向)のパイプを利用したいだけでしたら、
    <span class="function"><a href="function.popen.html" class="function">popen()</a></span> を使うほうがより簡単です。
   </p>
  </p></blockquote>
 </div>

 
 <div class="refsect1 seealso" id="refsect1-function.proc-open-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.popen.html" class="function" rel="rdfs-seeAlso">popen()</a> - プロセスへのファイルポインタをオープンする</span></li>
    <li class="member"><span class="function"><a href="function.exec.html" class="function" rel="rdfs-seeAlso">exec()</a> - 外部プログラムを実行する</span></li>
    <li class="member"><span class="function"><a href="function.system.html" class="function" rel="rdfs-seeAlso">system()</a> - 外部プログラムを実行し、出力を表示する</span></li>
    <li class="member"><span class="function"><a href="function.passthru.html" class="function" rel="rdfs-seeAlso">passthru()</a> - 外部プログラムを実行し、未整形の出力を表示する</span></li>
    <li class="member"><span class="function"><a href="function.stream-select.html" class="function" rel="rdfs-seeAlso">stream_select()</a> - select() システムコールと同等の操作を、
   ストリームの配列に対して tv_sec と tv_usec で指定されたタイムアウト時間をもって行う</span></li>
    <li class="member"><a href="language.operators.execution.html" class="link">バックティック演算子</a></li>
   </ul>
  </p>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="115541""></a>
  <div class="note">
   <strong class="user">sergioshev at gmail dot com</strong>
   <a href="#115541" class="date">13-Aug-2014 01:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want make use of double pipe. As prove of concept something like this...<br />
<br />
"Double pipe example."<br />
cat in_data | cat | cat &gt; out_data <br />
<br />
here is an example how to achieve that<br />
<br />
<span class="default">&lt;?php<br />
<br />
$d2 </span><span class="keyword">= array (<br />
&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">,</span><span class="string">'r'</span><span class="keyword">),<br />
&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">'file'</span><span class="keyword">,</span><span class="string">'/var/tmp/test_gen_trans.log'</span><span class="keyword">,</span><span class="string">'w'</span><span class="keyword">)<br />
);<br />
<br />
</span><span class="default">$proc_2 </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">'cat'</span><span class="keyword">, </span><span class="default">$d2</span><span class="keyword">, </span><span class="default">$p2</span><span class="keyword">);<br />
<br />
</span><span class="default">$d </span><span class="keyword">= array(<br />
&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'file'</span><span class="keyword">,</span><span class="string">'/var/tmp/test.log'</span><span class="keyword">,</span><span class="string">'r'</span><span class="keyword">),<br />
&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; </span><span class="default">$p2</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]<br />
);<br />
<br />
</span><span class="default">$proc </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">"cat"</span><span class="keyword">, </span><span class="default">$d</span><span class="keyword">, </span><span class="default">$p</span><span class="keyword">);<br />
</span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$proc</span><span class="keyword">);<br />
</span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$proc_2</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="113319""></a>
  <div class="note">
   <strong class="user">exel at example dot com</strong>
   <a href="#113319" class="date">26-Sep-2013 07:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
pipe communications may break brains off. i want to share some stuff to avoid such result.<br />
for proper control of the communications through the "in" and "out" pipes of the opened sub-process, remember to set both of them into non-blocking mode and especially notice that fwrite may return (int)0 but it's not an error, just process might not except input at that moment. <br />
<br />
so, let us consider an example of decoding gz-encoded file by using funzip as sub-process: (this is not the final version, just to show important things)<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// make gz file<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fd</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/tmp/testPipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">100000</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">, </span><span class="default">md5</span><span class="keyword">(</span><span class="default">$i</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">is_file</span><span class="keyword">(</span><span class="string">"/tmp/testPipe.gz"</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="string">"/tmp/testPipe.gz"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">system</span><span class="keyword">(</span><span class="string">"gzip /tmp/testPipe"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// open process<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pipesDescr</span><span class="keyword">=array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"file"</span><span class="keyword">, </span><span class="string">"/tmp/testPipe.log"</span><span class="keyword">, </span><span class="string">"a"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; );<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$process</span><span class="keyword">=</span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">"zcat"</span><span class="keyword">, </span><span class="default">$pipesDescr</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">)) throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"popen error"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// set both pipes non-blocking<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">////////////////////////////////////////////////////////////////////<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$text</span><span class="keyword">=</span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fd</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/tmp/testPipe.gz"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">, </span><span class="default">16384</span><span class="keyword">*</span><span class="default">4</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$try</span><span class="keyword">=</span><span class="default">3</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">$str</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$len</span><span class="keyword">=</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">$str</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">$s</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">16384</span><span class="keyword">*</span><span class="default">4</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$text</span><span class="keyword">.=</span><span class="default">$s</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">$len</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// if yo remove this paused retries, process may fail<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">200000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$try</span><span class="keyword">--;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">$try</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"fwrite error"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str</span><span class="keyword">=</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">, </span><span class="default">$len</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">).</span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fd</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// reading the rest of output stream<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$s</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">16384</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$text</span><span class="keyword">.=</span><span class="default">$s</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$text</span><span class="keyword">).</span><span class="string">" / 3 300 000\n"</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111858""></a>
  <div class="note">
   <strong class="user">mcuadros at gmail dot com</strong>
   <a href="#111858" class="date">05-Apr-2013 07:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This is a example of how run a command using as output the TTY, just like crontab -e or git commit does.<br />
<br />
<span class="default">&lt;?php<br />
<br />
$descriptors </span><span class="keyword">= array(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="string">'file'</span><span class="keyword">, </span><span class="string">'/dev/tty'</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="string">'file'</span><span class="keyword">, </span><span class="string">'/dev/tty'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; array(</span><span class="string">'file'</span><span class="keyword">, </span><span class="string">'/dev/tty'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">)<br />
);<br />
<br />
</span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">'vim'</span><span class="keyword">, </span><span class="default">$descriptors</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">);</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="110993""></a>
  <div class="note">
   <strong class="user">michael dot gross at NOSPAM dot flexlogic dot at</strong>
   <a href="#110993" class="date">04-Jan-2013 05:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Please note that if you plan to spawn multiple processes you have to save all the results in different variables (in an array for example). If you for example would call $proc = proc_open..... multiple times the script will block after the second time until the child process exits (proc_close is called implicitly).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109951""></a>
  <div class="note">
   <strong class="user">bilge at boontex dot com</strong>
   <a href="#109951" class="date">05-Sep-2012 11:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
$cmd can actually be multiple commands by separating each command with a newline. However, due to this it is not possible to split up one very long command over multiple lines, even when using "\\\n" syntax.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107856""></a>
  <div class="note">
   <strong class="user">devel at romanr dot info</strong>
   <a href="#107856" class="date">10-Mar-2012 05:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The call works as should. No bugs.<br />
But. In most cases you won't able to work with pipes in blocking mode.<br />
When your output pipe (process' input one, $pipes[0]) is blocking, there is a case, when you and the process are blocked on output.<br />
When your input pipe (process' output one, $pipes[1]) is blocking, there is a case, when you and the process both are blocked on own input.<br />
So you should switch pipes into NONBLOCKING mode (stream_set_blocking).<br />
Then, there is a case, when you're not able to read anything (fread($pipes[1],...) == "") either write (fwrite($pipes[0],...) == 0). In this case, you better check the process is alive (proc_get_status) and if it still is - wait for some time (stream_select). The situation is truly asynchronous, the process may be busy working, processing your data.<br />
Using shell effectively makes not possible to know whether the command is exists - proc_open always returns valid resource. You may even write some data into it (into shell, actually). But eventually it will terminate, so check the process status regularly.<br />
I would advice not using mkfifo-pipes, because filesystem fifo-pipe (mkfifo) blocks open/fopen call (!!!) until somebody opens other side (unix-related behavior). In case the pipe is opened not by shell and the command is crashed or is not exists you will be blocked forever.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="106502""></a>
  <div class="note">
   <strong class="user">toby at globaloptima dot co dot uk</strong>
   <a href="#106502" class="date">14-Nov-2011 10:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If script A is spawning script B and script B pushes a lot of data to stdout without script A consuming that data, script B is likely to hang but the result of proc_get_status on that process seems to continue to indicate it's running.<br />
<br />
So either don't write to stdout i the spawned process (I write to log files instead now) or try to read in the stdout in a non-blocking way if your script A is spawning many instances of script B, I couldn't get this second option to work sadly.<br />
<br />
PHP 5.3.8 CLI on Windows 7 64.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="102239""></a>
  <div class="note">
   <strong class="user">mattis at xait dot no</strong>
   <a href="#102239" class="date">03-Feb-2011 04:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are, like me, tired of the buggy way proc_open handles streams and exit codes; this example demonstrate the power of pcntl, posix and some simple output redirection:<br />
<br />
<span class="default">&lt;?php<br />
$outpipe </span><span class="keyword">= </span><span class="string">'/tmp/outpipe'</span><span class="keyword">;<br />
</span><span class="default">$inpipe </span><span class="keyword">= </span><span class="string">'/tmp/inpipe'</span><span class="keyword">;<br />
</span><span class="default">posix_mkfifo</span><span class="keyword">(</span><span class="default">$inpipe</span><span class="keyword">, </span><span class="default">0600</span><span class="keyword">);<br />
</span><span class="default">posix_mkfifo</span><span class="keyword">(</span><span class="default">$outpipe</span><span class="keyword">, </span><span class="default">0600</span><span class="keyword">);<br />
<br />
</span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();<br />
<br />
</span><span class="comment">//parent<br />
</span><span class="keyword">if(</span><span class="default">$pid</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$in </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$inpipe</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">, </span><span class="string">"A message for the inpipe reader\n"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$in</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$out </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$outpipe</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"From out pipe: " </span><span class="keyword">. </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">) . </span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$out</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">pcntl_waitpid</span><span class="keyword">(</span><span class="default">$pid</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if(</span><span class="default">pcntl_wifexited</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Reliable exit code: " </span><span class="keyword">. </span><span class="default">pcntl_wexitstatus</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">) . </span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$outpipe</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$inpipe</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">//child<br />
</span><span class="keyword">else {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//parent<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_exec</span><span class="keyword">(</span><span class="string">'/bin/sh'</span><span class="keyword">, array(</span><span class="string">'-c'</span><span class="keyword">, </span><span class="string">"printf 'A message for the outpipe reader' &gt; </span><span class="default">$outpipe</span><span class="string"> 2&gt;&amp;1 &amp;&amp; exit 12"</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//child<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_exec</span><span class="keyword">(</span><span class="string">'/bin/sh'</span><span class="keyword">, array(</span><span class="string">'-c'</span><span class="keyword">, </span><span class="string">"printf 'From in pipe: '; cat </span><span class="default">$inpipe</span><span class="string">"</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }&nbsp; &nbsp; <br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Output:<br />
<br />
From in pipe: A message for the inpipe reader<br />
From out pipe: A message for the outpipe reader<br />
Reliable exit code: 12</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97379""></a>
  <div class="note">
   <strong class="user">php at keith tyler dot com</strong>
   <a href="#97379" class="date">16-Apr-2010 08:32</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Interestingly enough, it seems you actually have to store the return value in order for your streams to exist. You can't throw it away.<br />
<br />
In other words, this works:<br />
<br />
<span class="default">&lt;?php<br />
$proc</span><span class="keyword">=</span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">"echo foo"</span><span class="keyword">,<br />
&nbsp; array(<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">)<br />
&nbsp; ),<br />
&nbsp; </span><span class="default">$pipes</span><span class="keyword">);<br />
print </span><span class="default">stream_get_contents</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
</span><span class="default">?&gt;<br />
</span><br />
prints:<br />
foo<br />
<br />
but this doesn't work:<br />
<br />
<span class="default">&lt;?php<br />
proc_open</span><span class="keyword">(</span><span class="string">"echo foo"</span><span class="keyword">,<br />
&nbsp; array(<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"pipe"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">)<br />
&nbsp; ),<br />
&nbsp; </span><span class="default">$pipes</span><span class="keyword">);<br />
print </span><span class="default">stream_get_contents</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
</span><span class="default">?&gt;<br />
</span><br />
outputs:<br />
Warning: stream_get_contents(): &lt;n&gt; is not a valid stream resource in Command line code on line 1<br />
<br />
The only difference is that in the second case we don't save the output of proc_open to a variable.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97329""></a>
  <div class="note">
   <strong class="user">Matou Havlena - matous at havlena dot net</strong>
   <a href="#97329" class="date">14-Apr-2010 10:03</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
There is some smart object Processes Manager which i have created for my application. It can control the maximum of simultaneously running processes.<br />
<br />
Proccesmanager class:<br />
<span class="default">&lt;?php <br />
</span><span class="keyword">class </span><span class="default">Processmanager </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$executable </span><span class="keyword">= </span><span class="string">"C:\\www\\_PHP5_2_10\\php"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$root </span><span class="keyword">= </span><span class="string">"C:\\www\\parallelprocesses\\"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$scripts </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$processesRunning </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$processes </span><span class="keyword">= </span><span class="default">3</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$running </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$sleep_time </span><span class="keyword">= </span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">addScript</span><span class="keyword">(</span><span class="default">$script</span><span class="keyword">, </span><span class="default">$max_execution_time </span><span class="keyword">= </span><span class="default">300</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">[] = array(</span><span class="string">"script_name" </span><span class="keyword">=&gt; </span><span class="default">$script</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"max_execution_time" </span><span class="keyword">=&gt; </span><span class="default">$max_execution_time</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">exec</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(;;) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Fill up the slots<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while ((</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">processesRunning</span><span class="keyword">&lt;</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">processes</span><span class="keyword">) and (</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">))) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"&lt;span style='color: orange;'&gt;Adding script: "</span><span class="keyword">.</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">"script_name"</span><span class="keyword">].</span><span class="string">"&lt;/span&gt;&lt;br /&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">ob_flush</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flush</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">running</span><span class="keyword">[] =&amp; new </span><span class="default">Process</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">executable</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">root</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">"script_name"</span><span class="keyword">], </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="string">"max_execution_time"</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">processesRunning</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Check if done<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if ((</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">processesRunning</span><span class="keyword">==</span><span class="default">0</span><span class="keyword">) and (</span><span class="default">$i</span><span class="keyword">&gt;=</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">scripts</span><span class="keyword">))) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// sleep, this duration depends on your script execution time, the longer execution time, the longer sleep time<br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sleep_time</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; </span><span class="comment">// check what is done<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">foreach (</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">running </span><span class="keyword">as </span><span class="default">$key </span><span class="keyword">=&gt; </span><span class="default">$val</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">isRunning</span><span class="keyword">() or </span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">isOverExecuted</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">isRunning</span><span class="keyword">()) echo </span><span class="string">"&lt;span style='color: green;'&gt;Done: "</span><span class="keyword">.</span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">script</span><span class="keyword">.</span><span class="string">"&lt;/span&gt;&lt;br /&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else echo </span><span class="string">"&lt;span style='color: red;'&gt;Killed: "</span><span class="keyword">.</span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">script</span><span class="keyword">.</span><span class="string">"&lt;/span&gt;&lt;br /&gt;"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$val</span><span class="keyword">-&gt;</span><span class="default">resource</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">running</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">processesRunning</span><span class="keyword">--;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">ob_flush</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">flush</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Process class:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">Process </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$resource</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$pipes</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$script</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$max_execution_time</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$start_time</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">__construct</span><span class="keyword">(&amp;</span><span class="default">$executable</span><span class="keyword">, &amp;</span><span class="default">$root</span><span class="keyword">, </span><span class="default">$script</span><span class="keyword">, </span><span class="default">$max_execution_time</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">script </span><span class="keyword">= </span><span class="default">$script</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">max_execution_time </span><span class="keyword">= </span><span class="default">$max_execution_time</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$descriptorspec&nbsp; &nbsp; </span><span class="keyword">= array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">resource&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">$executable</span><span class="keyword">.</span><span class="string">" "</span><span class="keyword">.</span><span class="default">$root</span><span class="keyword">.</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">script</span><span class="keyword">, </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">pipes</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">$_ENV</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">start_time </span><span class="keyword">= </span><span class="default">mktime</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// is still running?<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">isRunning</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$status </span><span class="keyword">= </span><span class="default">proc_get_status</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">resource</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$status</span><span class="keyword">[</span><span class="string">"running"</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// long execution time, proccess is going to be killer<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">isOverExecuted</span><span class="keyword">() {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">start_time</span><span class="keyword">+</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">max_execution_time</span><span class="keyword">&lt;</span><span class="default">mktime</span><span class="keyword">()) return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Example of using:<br />
<span class="default">&lt;?php<br />
$manager </span><span class="keyword">= new </span><span class="default">Processmanager</span><span class="keyword">();<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">executable </span><span class="keyword">= </span><span class="string">"C:\\www\\_PHP5_2_10\\php"</span><span class="keyword">;<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">path </span><span class="keyword">= </span><span class="string">"C:\\www\\parallelprocesses\\"</span><span class="keyword">;<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">processes </span><span class="keyword">= </span><span class="default">3</span><span class="keyword">;<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">sleep_time </span><span class="keyword">= </span><span class="default">2</span><span class="keyword">;<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script1.php"</span><span class="keyword">, </span><span class="default">10</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script2.php"</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script3.php"</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script4.php"</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script5.php"</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">addScript</span><span class="keyword">(</span><span class="string">"script6.php"</span><span class="keyword">);<br />
</span><span class="default">$manager</span><span class="keyword">-&gt;</span><span class="default">exec</span><span class="keyword">();<br />
</span><span class="default">?&gt;<br />
</span><br />
And possible output:<br />
<br />
Adding script: script1.php<br />
Adding script: script2.php<br />
Adding script: script3.php<br />
Done: script2.php<br />
Adding script: script4.php<br />
Killed: script1.php<br />
Done: script3.php<br />
Done: script4.php<br />
Adding script: script5.php<br />
Adding script: script6.php<br />
Done: script5.php<br />
Done: script6.php</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="97012""></a>
  <div class="note">
   <strong class="user">Luceo</strong>
   <a href="#97012" class="date">28-Mar-2010 04:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It seems that stream_get_contents() on STDOUT blocks infinitly under Windows when STDERR is filled under some circumstances.<br />
<br />
The trick is to open STDERR in append mode ("a"), then this will work, too.<br />
<br />
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">), </span><span class="comment">// stdin<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">), </span><span class="comment">// stdout<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">) </span><span class="comment">// stderr<br />
</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95207""></a>
  <div class="note">
   <strong class="user">cbn at grenet dot org</strong>
   <a href="#95207" class="date">18-Dec-2009 04:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Display output (stdout/stderr) in real time, and get the real exit code in pure PHP (no shell workaround!). It works well on my machines (debian mostly).<br />
<br />
#!/usr/bin/php<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/*<br />
&nbsp;* Execute and display the output in real time (stdout + stderr).<br />
&nbsp;*<br />
&nbsp;* Please note this snippet is prepended with an appropriate shebang for the <br />
&nbsp;* CLI. You can re-use only the function.<br />
&nbsp;* <br />
&nbsp;* Usage example:<br />
&nbsp;* chmod u+x proc_open.php<br />
&nbsp;* ./proc_open.php "ping -c 5 google.fr"; echo RetVal=$?<br />
&nbsp;*/<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="default">BUF_SIZ</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment"># max buffer size<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="default">FD_WRITE</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment"># stdin<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="default">FD_READ</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment"># stdout<br />
</span><span class="default">define</span><span class="keyword">(</span><span class="default">FD_ERR</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment"># stderr<br />
<br />
/*<br />
&nbsp;* Wrapper for proc_*() functions.<br />
&nbsp;* The first parameter $cmd is the command line to execute.<br />
&nbsp;* Return the exit code of the process.<br />
&nbsp;*/<br />
</span><span class="keyword">function </span><span class="default">proc_exec</span><span class="keyword">(</span><span class="default">$cmd</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; );<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ptr </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">$cmd</span><span class="keyword">, </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">, </span><span class="default">NULL</span><span class="keyword">, </span><span class="default">$_ENV</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (!</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; while ((</span><span class="default">$buffer </span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">FD_READ</span><span class="keyword">], </span><span class="default">BUF_SIZ</span><span class="keyword">)) != </span><span class="default">NULL <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">|| (</span><span class="default">$errbuf </span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">FD_ERR</span><span class="keyword">], </span><span class="default">BUF_SIZ</span><span class="keyword">)) != </span><span class="default">NULL</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!isset(</span><span class="default">$flag</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pstatus </span><span class="keyword">= </span><span class="default">proc_get_status</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$first_exitcode </span><span class="keyword">= </span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"exitcode"</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$flag </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$buffer</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">$buffer</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$errbuf</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"ERR: " </span><span class="keyword">. </span><span class="default">$errbuf</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$pipes </span><span class="keyword">as </span><span class="default">$pipe</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipe</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/* Get the expected *exit* code to return the value */<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pstatus </span><span class="keyword">= </span><span class="default">proc_get_status</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (!</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"exitcode"</span><span class="keyword">]) || </span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"running"</span><span class="keyword">]) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">/* we can trust the retval of proc_close() */<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"running"</span><span class="keyword">])<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">proc_terminate</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (((</span><span class="default">$first_exitcode </span><span class="keyword">+ </span><span class="default">256</span><span class="keyword">) % </span><span class="default">256</span><span class="keyword">) == </span><span class="default">255 <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">&amp;&amp; ((</span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"exitcode"</span><span class="keyword">] + </span><span class="default">256</span><span class="keyword">) % </span><span class="default">256</span><span class="keyword">) != </span><span class="default">255</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"exitcode"</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; elseif (!</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$first_exitcode</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">$pstatus</span><span class="keyword">[</span><span class="string">"exitcode"</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; elseif (((</span><span class="default">$first_exitcode </span><span class="keyword">+ </span><span class="default">256</span><span class="keyword">) % </span><span class="default">256</span><span class="keyword">) != </span><span class="default">255</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">$first_exitcode</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ret </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="comment">/* we "deduce" an EXIT_SUCCESS ;) */<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$ptr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; return (</span><span class="default">$ret </span><span class="keyword">+ </span><span class="default">256</span><span class="keyword">) % </span><span class="default">256</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">/* __init__ */<br />
</span><span class="keyword">if (isset(</span><span class="default">$argv</span><span class="keyword">) &amp;&amp; </span><span class="default">count</span><span class="keyword">(</span><span class="default">$argv</span><span class="keyword">) &gt; </span><span class="default">1 </span><span class="keyword">&amp;&amp; !empty(</span><span class="default">$argv</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) {<br />
&nbsp;&nbsp;&nbsp; if ((</span><span class="default">$ret </span><span class="keyword">= </span><span class="default">proc_exec</span><span class="keyword">(</span><span class="default">$argv</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) === </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">"Error: not enough FD or out of memory.\n"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; elseif (</span><span class="default">$ret </span><span class="keyword">== </span><span class="default">127</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">"Command not found (returned by sh).\n"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; exit(</span><span class="default">$ret</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89338""></a>
  <div class="note">
   <strong class="user">simeonl at dbc dot co dot nz</strong>
   <a href="#89338" class="date">04-Mar-2009 03:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that when you call an external script and retrieve large amounts of data from STDOUT and STDERR, you may need to retrieve from both alternately in non-blocking mode (with appropriate pauses if no data is retrieved), so that your PHP script doesn't lock up. This can happen if you waiting on activity on one pipe while the external script is waiting for you to empty the other, e.g:<br />
<br />
<span class="default">&lt;?php<br />
$read_output </span><span class="keyword">= </span><span class="default">$read_error </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
</span><span class="default">$buffer_len&nbsp; </span><span class="keyword">= </span><span class="default">$prev_buffer_len </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; <br />
</span><span class="default">$ms&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;<br />
</span><span class="default">$output&nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="default">$read_output </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
</span><span class="default">$error&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
</span><span class="default">$read_error&nbsp; </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
</span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
<br />
</span><span class="comment">// dual reading of STDOUT and STDERR stops one full pipe blocking the other, because the external script is waiting<br />
</span><span class="keyword">while (</span><span class="default">$read_error </span><span class="keyword">!= </span><span class="default">false </span><span class="keyword">or </span><span class="default">$read_output </span><span class="keyword">!= </span><span class="default">false</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$read_output </span><span class="keyword">!= </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$read_output </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$len </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$len</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$output </span><span class="keyword">.= </span><span class="default">$str</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buffer_len </span><span class="keyword">+= </span><span class="default">$len</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$read_error </span><span class="keyword">!= </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">])) <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$read_error </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str </span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$len </span><span class="keyword">= </span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$str</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$len</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">.= </span><span class="default">$str</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$buffer_len </span><span class="keyword">+= </span><span class="default">$len</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$buffer_len </span><span class="keyword">&gt; </span><span class="default">$prev_buffer_len</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$prev_buffer_len </span><span class="keyword">= </span><span class="default">$buffer_len</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ms </span><span class="keyword">= </span><span class="default">10</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; else <br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">$ms </span><span class="keyword">* </span><span class="default">1000</span><span class="keyword">); </span><span class="comment">// sleep for $ms milliseconds<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$ms </span><span class="keyword">&lt; </span><span class="default">160</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ms </span><span class="keyword">= </span><span class="default">$ms </span><span class="keyword">* </span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
return </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83635""></a>
  <div class="note">
   <strong class="user">snowleopard at amused dot NOSPAMPLEASE dot com dot au</strong>
   <a href="#83635" class="date">05-Jun-2008 04:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I managed to make a set of functions to work with GPG, since my hosting provider refused to use GPG-ME.<br />
Included below is an example of decryption using a higher descriptor to push a passphrase.<br />
Comments and emails welcome. :)<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">GPGDecrypt</span><span class="keyword">(</span><span class="default">$InputData</span><span class="keyword">, </span><span class="default">$Identity</span><span class="keyword">, </span><span class="default">$PassPhrase</span><span class="keyword">, </span><span class="default">$HomeDir</span><span class="keyword">=</span><span class="string">"~/.gnupg"</span><span class="keyword">, </span><span class="default">$GPGPath</span><span class="keyword">=</span><span class="string">"/usr/bin/gpg"</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if(!</span><span class="default">is_executable</span><span class="keyword">(</span><span class="default">$GPGPath</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="default">$GPGPath </span><span class="keyword">. </span><span class="string">" is not executable"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">E_USER_ERROR</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; die();<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Set up the descriptors<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$Descriptors </span><span class="keyword">= array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">3 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">) </span><span class="comment">// This is the pipe we can feed the password into<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Build the command line and start the process<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$CommandLine </span><span class="keyword">= </span><span class="default">$GPGPath </span><span class="keyword">. </span><span class="string">' --homedir ' </span><span class="keyword">. </span><span class="default">$HomeDir </span><span class="keyword">. </span><span class="string">' --quiet --batch --local-user "' </span><span class="keyword">. </span><span class="default">$Identity </span><span class="keyword">. </span><span class="string">'" --passphrase-fd 3 --decrypt -'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ProcessHandle </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">( </span><span class="default">$CommandLine</span><span class="keyword">, </span><span class="default">$Descriptors</span><span class="keyword">, </span><span class="default">$Pipes</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$ProcessHandle</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Push passphrase to custom pipe<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">], </span><span class="default">$PassPhrase</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Push input into StdIn<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">$InputData</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Read StdOut<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$StdOut </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$StdOut </span><span class="keyword">.= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Read StdErr<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$StdErr </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]))&nbsp; &nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$StdErr </span><span class="keyword">.= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$Pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Close the process<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ReturnCode </span><span class="keyword">= </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$ProcessHandle</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">trigger_error</span><span class="keyword">(</span><span class="string">"cannot create resource"</span><span class="keyword">, </span><span class="default">E_USER_ERROR</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; die();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$StdOut</span><span class="keyword">) &gt;= </span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$ReturnCode </span><span class="keyword">&lt;= </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ReturnValue </span><span class="keyword">= </span><span class="default">$StdOut</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ReturnValue </span><span class="keyword">= </span><span class="string">"Return Code: " </span><span class="keyword">. </span><span class="default">$ReturnCode </span><span class="keyword">. </span><span class="string">"\nOutput on StdErr:\n" </span><span class="keyword">. </span><span class="default">$StdErr </span><span class="keyword">. </span><span class="string">"\n\nStandard Output Follows:\n\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$ReturnCode </span><span class="keyword">&lt;= </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ReturnValue </span><span class="keyword">= </span><span class="default">$StdErr</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ReturnValue </span><span class="keyword">= </span><span class="string">"Return Code: " </span><span class="keyword">. </span><span class="default">$ReturnCode </span><span class="keyword">. </span><span class="string">"\nOutput on StdErr:\n" </span><span class="keyword">. </span><span class="default">$StdErr</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$ReturnValue</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83436""></a>
  <div class="note">
   <strong class="user">radone at gmail dot com</strong>
   <a href="#83436" class="date">26-May-2008 02:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To complete the examples below that use proc_open to encrypt a string using GPG, here is a decrypt function:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">function </span><span class="default">gpg_decrypt</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$secret</span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$homedir </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">; </span><span class="comment">// path to you gpg keyrings
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$tmp_file </span><span class="keyword">= </span><span class="string">'/tmp/gpg_tmp.asc' </span><span class="keyword">; </span><span class="comment">// tmp file to write to&nbsp; &nbsp; &nbsp; &nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$tmp_file</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">);
<br />

<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$text </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$descriptorspec </span><span class="keyword">= array(
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),&nbsp; </span><span class="comment">// stdin
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),&nbsp; </span><span class="comment">// stdout
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">)&nbsp;&nbsp; </span><span class="comment">// stderr ?? instead of a file
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$command </span><span class="keyword">= </span><span class="string">'gpg --homedir ' </span><span class="keyword">. </span><span class="default">$homedir </span><span class="keyword">. </span><span class="string">' --batch --no-verbose --passphrase-fd 0 -d ' </span><span class="keyword">. </span><span class="default">$tmp_file </span><span class="keyword">. </span><span class="string">' '</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">$command</span><span class="keyword">, </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="default">$secret</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">$s</span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// read from the pipe
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$text </span><span class="keyword">.= </span><span class="default">$s</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// optional:
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while(</span><span class="default">$s</span><span class="keyword">= </span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">1024</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$error </span><span class="keyword">.= </span><span class="default">$s </span><span class="keyword">. </span><span class="string">"\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$tmp_file</span><span class="keyword">, </span><span class="string">''</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">'/decryption failed/i'</span><span class="keyword">, </span><span class="default">$error</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; } else {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$text</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82951""></a>
  <div class="note">
   <strong class="user">jonah at whalehosting dot ca</strong>
   <a href="#82951" class="date">03-May-2008 07:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
@joachimb: The descriptorspec describes the i/o from the perspective of the process you are opening.&nbsp; That is why stdin is read: you are writing, the process is reading.&nbsp; So you want to open descriptor 2 (stderr) in write mode so that the process can write to it and you can read it.&nbsp; In your case where you want all descriptors to be pipes you should always use:<br />
<br />
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">), </span><span class="comment">// stdin<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">), </span><span class="comment">// stdout<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">) </span><span class="comment">// stderr<br />
</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
The examples below where stderr is opened as 'r' is a mistake.<br />
<br />
I would like to see examples of using higher descriptor numbers than 2.&nbsp; Specifically GPG as mentioned in the documentation.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82889""></a>
  <div class="note">
   <strong class="user">joachimb at gmail dot com</strong>
   <a href="#82889" class="date">30-Apr-2008 05:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I'm confused by the direction of the pipes. Most of the examples in this documentation opens pipe #2 as "r", because they want to read from stderr. That sounds logical to me, and that's what I tried to do. That didn't work, though. When I changed it to w, as in<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">), </span><span class="comment">// stdin<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">), </span><span class="comment">// stdout<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">) </span><span class="comment">// stderr<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">escapeshellarg</span><span class="keyword">(</span><span class="default">$scriptFile</span><span class="keyword">), </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">wd</span><span class="keyword">);<br />
...<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (!</span><span class="default">feof</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; foreach(</span><span class="default">$pipes </span><span class="keyword">as </span><span class="default">$key </span><span class="keyword">=&gt;</span><span class="default">$pipe</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$line </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipe</span><span class="keyword">, </span><span class="default">128</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$line</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print(</span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">log</span><span class="keyword">(</span><span class="default">$line</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">0.5</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
...<br />
</span><span class="default">?&gt;<br />
</span><br />
everything works fine.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82130""></a>
  <div class="note">
   <strong class="user">jaroslaw at pobox dot sk</strong>
   <a href="#82130" class="date">28-Mar-2008 11:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Some functions stops working proc_open() to me.<br />
This i made to work for me to communicate between two php scripts:<br />
<br />
<span class="default">&lt;?php<br />
$abs_path </span><span class="keyword">= </span><span class="string">'/var/www/domain/filename.php'</span><span class="keyword">;<br />
</span><span class="default">$spec </span><span class="keyword">= array(array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">), array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">), array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">)); <br />
</span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">'php '</span><span class="keyword">.</span><span class="default">$abs_path</span><span class="keyword">, </span><span class="default">$spec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">$_ENV</span><span class="keyword">); <br />
if (</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># wait till something happens on other side<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># send command<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">'echo $test;'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fflush</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># wait till something happens on other side<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">1000</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># read pipe for result<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">1024</span><span class="keyword">).</span><span class="string">'&lt;hr&gt;'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># close pipes<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$return_value </span><span class="keyword">= </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
filename.php then contains this:<br />
<br />
<span class="default">&lt;?php<br />
$test </span><span class="keyword">= </span><span class="string">'test data generated here&lt;br&gt;'</span><span class="keyword">;<br />
while(</span><span class="default">true</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># read incoming command<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$fh </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">'php://stdin'</span><span class="keyword">,</span><span class="string">'rb'</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val_in </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fh</span><span class="keyword">,</span><span class="default">1024</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fh</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># execute incoming command<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$val_in</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; eval(</span><span class="default">$val_in</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">usleep</span><span class="keyword">(</span><span class="default">1000</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment"># prevent neverending cycle<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">$tmp_counter</span><span class="keyword">++ &gt; </span><span class="default">100</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="81317""></a>
  <div class="note">
   <strong class="user">chris AT w3style DOT co.uk</strong>
   <a href="#81317" class="date">22-Feb-2008 11:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It took me a long time (and three consecutive projects) to figure this out.&nbsp; Because popen() and proc_open() return valid processes even when the command failed it's awkward to determine when it really has failed if you're opening a non-interactive process like "sendmail -t".<br />
<br />
I had previously guess that reading from STDERR immediately after starting the process would work, and it does... but when the command is successful PHP just hangs because STDERR is empty and it's waiting for data to be written to it.<br />
<br />
The solution is a simple stream_set_blocking($pipes[2], 0) immediately after calling proc_open().<br />
<br />
<span class="default">&lt;?php<br />
<br />
&nbsp;&nbsp;&nbsp; $this</span><span class="keyword">-&gt;</span><span class="default">_proc </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="default">$command</span><span class="keyword">, </span><span class="default">$descriptorSpec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$err </span><span class="keyword">= </span><span class="default">stream_get_contents</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]))<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; throw new </span><span class="default">Swift_Transport_TransportException</span><span class="keyword">(<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">'Process could not be started [' </span><span class="keyword">. </span><span class="default">$err </span><span class="keyword">. </span><span class="string">']'<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
If the process is opened successfully $pipes[2] will be empty, but if it failed the bash/sh error will be in it.<br />
<br />
Finally I can drop all my "workaround" error checking.<br />
<br />
I realise this solution is obvious and I'm not sure how it took me 18 months to figure it out, but hopefully this will help someone else.<br />
<br />
NOTE: Make sure your descriptorSpec has ( 2 =&gt; array('pipe', 'w')) for this to work.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80064""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#80064" class="date">27-Dec-2007 04:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I needed to emulate a tty for a process (it wouldnt write to stdout or read from stdin), so I found this:<br />
<br />
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(</span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'pty'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">'pty'</span><span class="keyword">),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">'pty'</span><span class="keyword">));&nbsp; <br />
</span><span class="default">?&gt;<br />
</span><br />
pipes are bidirectional then</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79665""></a>
  <div class="note">
   <strong class="user">John Wehin</strong>
   <a href="#79665" class="date">07-Dec-2007 07:52</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
STDIN STDOUT example<br />
test.php<br />
<br />
<span class="default">&lt;?php<br />
$descriptorspec </span><span class="keyword">= array(<br />
&nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">), <br />
&nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">), <br />
&nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">)<br />
);<br />
</span><span class="default">$process </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">'php test_gen.php'</span><span class="keyword">, </span><span class="default">$descriptorspec</span><span class="keyword">, </span><span class="default">$pipes</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">); </span><span class="comment">//run test_gen.php<br />
</span><span class="keyword">echo (</span><span class="string">"Start process:\n"</span><span class="keyword">);<br />
if (</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">)) <br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">"start\n"</span><span class="keyword">);&nbsp; &nbsp; </span><span class="comment">// send start<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo (</span><span class="string">"\n\nStart ...."</span><span class="keyword">.</span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">4096</span><span class="keyword">)); </span><span class="comment">//get answer<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">"get\n"</span><span class="keyword">);&nbsp; &nbsp; </span><span class="comment">// send get<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo (</span><span class="string">"Get: "</span><span class="keyword">.</span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">4096</span><span class="keyword">));&nbsp; &nbsp; </span><span class="comment">//get answer<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">"stop\n"</span><span class="keyword">);&nbsp; &nbsp; </span><span class="comment">//send stop<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo (</span><span class="string">"\n\nStop ...."</span><span class="keyword">.</span><span class="default">fgets</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">],</span><span class="default">4096</span><span class="keyword">));&nbsp; </span><span class="comment">//get answer<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$pipes</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$return_value </span><span class="keyword">= </span><span class="default">proc_close</span><span class="keyword">(</span><span class="default">$process</span><span class="keyword">);&nbsp; </span><span class="comment">//stop test_gen.php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo (</span><span class="string">"Returned:"</span><span class="keyword">.</span><span class="default">$return_value</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
test_gen.php<br />
<span class="default">&lt;?php<br />
$keys</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
function </span><span class="default">play_stop</span><span class="keyword">()<br />
{<br />
global </span><span class="default">$keys</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stdin_stat_arr</span><span class="keyword">=</span><span class="default">fstat</span><span class="keyword">(</span><span class="default">STDIN</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$stdin_stat_arr</span><span class="keyword">[</span><span class="default">size</span><span class="keyword">]!=</span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$val_in</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">STDIN</span><span class="keyword">,</span><span class="default">4096</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; switch(</span><span class="default">$val_in</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case </span><span class="string">"start\n"</span><span class="keyword">:&nbsp; &nbsp; echo </span><span class="string">"Started\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case </span><span class="string">"stop\n"</span><span class="keyword">:&nbsp; &nbsp; echo </span><span class="string">"Stopped\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$keys</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case </span><span class="string">"pause\n"</span><span class="keyword">:&nbsp; &nbsp; echo </span><span class="string">"Paused\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case </span><span class="string">"get\n"</span><span class="keyword">:&nbsp; &nbsp; echo (</span><span class="default">$keys</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; default:&nbsp; &nbsp; echo(</span><span class="string">"Передан не верный параметр: "</span><span class="keyword">.</span><span class="default">$val_in</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; exit();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }else{return </span><span class="default">true</span><span class="keyword">;}<br />
}<br />
while(</span><span class="default">true</span><span class="keyword">)<br />
{<br />
while(</span><span class="default">play_stop</span><span class="keyword">()){</span><span class="default">usleep</span><span class="keyword">(</span><span class="default">1000</span><span class="keyword">);}<br />
while(</span><span class="default">play_stop</span><span class="keyword">()){</span><span class="default">$keys</span><span class="keyword">++;</span><span class="default">usleep</span><span class="keyword">(</span><span class="default">10</span><span class="keyword">);}<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="76711""></a>
  <div class="note">
   <strong class="user">Antti Kauppinen</strong>
   <a href="#76711" class="date">27-Jul-2007 09:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
missilesilo at gmail dot com had a great example. However error messages didn't work because of wrong stderr argument.
<br />

<br />
I changed last value 'r' of
<br />

<br />
<span class="default">&lt;?php
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $descriptorspec </span><span class="keyword">= array(
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">),
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">),
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">'pipe'</span><span class="keyword">, </span><span class="string">'r'</span><span class="keyword">)
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; );
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
to 'w' so that error messages are actually written.
<br />

<br />
<span class="default">&lt;?php
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $descriptorspec </span><span class="keyword">= array(
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">0 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">),&nbsp; </span><span class="comment">// stdin is a pipe that the child will read from
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">1 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">),&nbsp; </span><span class="comment">// stdout is a pipe that the child will write to
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">2 </span><span class="keyword">=&gt; array(</span><span class="string">"pipe"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">) </span><span class="comment">// stderr is a file to write to
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">);
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="70429""></a>
  <div class="note">
   <strong class="user">mjutras at beenox dot com</strong>
   <a href="#70429" class="date">16-Oct-2006 03:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The best way on windows to open a process then to let the php script continue is to call your process with the start command then to kill the "start" process and let your program run.<br />
<br />
&lt;?<br />
$descriptorspec = array(<br />
&nbsp;&nbsp; &nbsp; &nbsp; 0 =&gt; array("pipe", "r"),&nbsp;&nbsp; // stdin<br />
&nbsp;&nbsp; &nbsp; &nbsp; 1 =&gt; array("pipe", "w"),&nbsp; // stdout<br />
&nbsp;&nbsp; &nbsp; &nbsp; 2 =&gt; array("pipe", "w")&nbsp;&nbsp; // stderr<br />
);<br />
$process = proc_open('start notepad.exe', $descriptorspec, $pipes);<br />
sleep(1);<br />
proc_close($process);<br />
?&gt;<br />
<br />
The start command will be called then open notepad, after 1 second the "start" command will be killed but the notepad will still opened and your php script can continue!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="68372""></a>
  <div class="note">
   <strong class="user">Docey</strong>
   <a href="#68372" class="date">25-Jul-2006 02:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if your writing a function that processes a resource from<br />
another function its a good idea not only to check whether<br />
a resource has been passed to your function but also if its<br />
of the good type like so:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">workingonit</span><span class="keyword">(</span><span class="default">$resource</span><span class="keyword">){<br />
&nbsp;if(</span><span class="default">is_resource</span><span class="keyword">(</span><span class="default">$resource</span><span class="keyword">)){<br />
&nbsp;&nbsp; if(</span><span class="default">get_resource_type</span><span class="keyword">(</span><span class="default">$resource</span><span class="keyword">) == </span><span class="string">"resource_type"</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// resource is a resource and of the good type. continue<br />
&nbsp;&nbsp; </span><span class="keyword">}else{<br />
&nbsp;&nbsp;&nbsp; print(</span><span class="string">"resource is of the wrong type."</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; }<br />
&nbsp;}else{<br />
&nbsp; print(</span><span class="string">"resource passed is not a resource at all."</span><span class="keyword">);<br />
&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;}<br />
<br />
&nbsp;</span><span class="comment">// do your stuff with the resource here and return<br />
</span><span class="keyword">}<br />
</span><span class="default">?&gt;<br />
</span><br />
this is extra true for working with files and process pipes.<br />
so always check whats being passed to your functions.<br />
<br />
here's a small snipppet of a few resource types:<br />
files are of type 'file' in php4 and 'stream' in php5<br />
'prossess' are resources opened by proc_open.<br />
'pipe' are resource opened by popen.<br />
<br />
btw the 'prossess' resource type was not mentioned in <br />
the documentation. i make a bug-report for this.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="67109""></a>
  <div class="note">
   <strong class="user">php dot net_manual at reimwerker dot de</strong>
   <a href="#67109" class="date">03-Jun-2006 01:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you are going to allow data coming from user input to be passed to this function, then you should keep in mind the following warning that also applies to exec() and system():<br />
<br />
<a href="http://www.php.net/manual/en/function.exec.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/function.exec.php</a><br />
<a href="http://www.php.net/manual/en/function.system.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/function.system.php</a><br />
<br />
Warning:<br />
<br />
If you are going to allow data coming from user input to be passed to this function, then you should be using escapeshellarg() or escapeshellcmd() to make sure that users cannot trick the system into executing arbitrary commands.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="64116""></a>
  <div class="note">
   <strong class="user">richard at 2006 dot atterer dot net</strong>
   <a href="#64116" class="date">07-Apr-2006 09:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
[Again, please delete my previous comment, the code still contained bugs (sorry). This version now includes Frederick Leitner&amp;#039;s fix from below, and also fixes another bug: If an empty file was piped into the process, the loop would hang indefinitely.]
<br />

<br />
The following code works for piping large amounts of data through a filtering program. I find it very weird that such a lot of code is needed for this task... On entry, $stdin contains the standard input for the program. Tested on Debian Linux with PHP 5.1.2.
<br />

<br />
&amp;lt;?php
<br />
&nbsp; $descriptorSpec = array(0 =&amp;gt; array(&amp;quot;pipe&amp;quot;, &amp;quot;r&amp;quot;),
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 1 =&amp;gt; array(&amp;#039;pipe&amp;#039;, &amp;#039;w&amp;#039;),
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 2 =&amp;gt; array(&amp;#039;pipe&amp;#039;, &amp;#039;w&amp;#039;));
<br />
&nbsp; $process = proc_open($command, $descriptorSpec, $pipes);
<br />
&nbsp; $txOff = 0; $txLen = strlen($stdin);
<br />
&nbsp; $stdout = &amp;#039;&amp;#039;; $stdoutDone = FALSE;
<br />
&nbsp; $stderr = &amp;#039;&amp;#039;; $stderrDone = FALSE;
<br />
&nbsp; stream_set_blocking($pipes[0], 0); // Make stdin/stdout/stderr non-blocking
<br />
&nbsp; stream_set_blocking($pipes[1], 0);
<br />
&nbsp; stream_set_blocking($pipes[2], 0);
<br />
&nbsp; if ($txLen == 0) fclose($pipes[0]);
<br />
&nbsp; while (TRUE) {
<br />
&nbsp;&nbsp;&nbsp; $rx = array(); // The program&amp;#039;s stdout/stderr
<br />
&nbsp;&nbsp;&nbsp; if (!$stdoutDone) $rx[] = $pipes[1];
<br />
&nbsp;&nbsp;&nbsp; if (!$stderrDone) $rx[] = $pipes[2];
<br />
&nbsp;&nbsp;&nbsp; $tx = array(); // The program&amp;#039;s stdin
<br />
&nbsp;&nbsp;&nbsp; if ($txOff &amp;lt; $txLen) $tx[] = $pipes[0];
<br />
&nbsp;&nbsp;&nbsp; stream_select($rx, $tx, $ex = NULL, NULL, NULL); // Block til r/w possible
<br />
&nbsp;&nbsp;&nbsp; if (!empty($tx)) {
<br />
&nbsp;&nbsp; &nbsp;&nbsp; $txRet = fwrite($pipes[0], substr($stdin, $txOff, 8192));
<br />
&nbsp;&nbsp; &nbsp;&nbsp; if ($txRet !== FALSE) $txOff += $txRet;
<br />
&nbsp;&nbsp; &nbsp;&nbsp; if ($txOff &amp;gt;= $txLen) fclose($pipes[0]);
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; foreach ($rx as $r) {
<br />
&nbsp;&nbsp; &nbsp;&nbsp; if ($r == $pipes[1]) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $stdout .= fread($pipes[1], 8192);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (feof($pipes[1])) { fclose($pipes[1]); $stdoutDone = TRUE; }
<br />
&nbsp;&nbsp; &nbsp;&nbsp; } else if ($r == $pipes[2]) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $stderr .= fread($pipes[2], 8192);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (feof($pipes[2])) { fclose($pipes[2]); $stderrDone = TRUE; }
<br />
&nbsp;&nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; if (!is_resource($process)) break;
<br />
&nbsp;&nbsp;&nbsp; if ($txOff &amp;gt;= $txLen &amp;amp;&amp;amp; $stdoutDone &amp;amp;&amp;amp; $stderrDone) break;
<br />
&nbsp; }
<br />
&nbsp; $returnValue = proc_close($process);
<br />
?&amp;gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62663""></a>
  <div class="note">
   <strong class="user">Kevin Barr</strong>
   <a href="#62663" class="date">06-Mar-2006 09:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I found that with disabling stream blocking I was sometimes attempting to read a return line before the external application had responded. So, instead, I left blocking alone and used this simple function to add a timeout to the fgets function:<br />
<br />
// fgetsPending( $in,$tv_sec ) - Get a pending line of data from stream $in, waiting a maximum of $tv_sec seconds<br />
function fgetsPending(&amp;$in,$tv_sec=10) {<br />
&nbsp;&nbsp;&nbsp; if ( stream_select($read = array($in),$write=NULL,$except=NULL,$tv_sec) ) return fgets($in);<br />
&nbsp;&nbsp;&nbsp; else return FALSE;&nbsp; &nbsp; <br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="60187""></a>
  <div class="note">
   <strong class="user">andrew dot budd at adsciengineering dot com</strong>
   <a href="#60187" class="date">29-Dec-2005 06:55</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The pty option is actually disabled in the source for some reason via a #if 0 &amp;&amp; condition.&nbsp; I'm not sure why it's disabled.&nbsp; I removed the 0 &amp;&amp; and recompiled, after which the pty option works perfectly.&nbsp; Just a note.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58044""></a>
  <div class="note">
   <strong class="user">mendoza at pvv dot ntnu dot no</strong>
   <a href="#58044" class="date">22-Oct-2005 07:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Since I don't have access to PAM via Apache, suexec on, nor access to /etc/shadow I coughed up this way of authenticating users based on the system users details. It's really hairy and ugly, but it works.<br />
<br />
&lt;?<br />
function authenticate($user,$password) {<br />
&nbsp; $descriptorspec = array(<br />
&nbsp;&nbsp; &nbsp; 0 =&gt; array("pipe", "r"),&nbsp; // stdin is a pipe that the child will read from<br />
&nbsp;&nbsp; &nbsp; 1 =&gt; array("pipe", "w"),&nbsp; // stdout is a pipe that the child will write to<br />
&nbsp;&nbsp; &nbsp; 2 =&gt; array("file","/dev/null", "w") // stderr is a file to write to<br />
&nbsp; );<br />
<br />
&nbsp; $process = proc_open("su ".escapeshellarg($user), $descriptorspec, $pipes);<br />
<br />
&nbsp; if (is_resource($process)) {<br />
&nbsp;&nbsp;&nbsp; // $pipes now looks like this:<br />
&nbsp;&nbsp;&nbsp; // 0 =&gt; writeable handle connected to child stdin<br />
&nbsp;&nbsp;&nbsp; // 1 =&gt; readable handle connected to child stdout<br />
&nbsp;&nbsp;&nbsp; // Any error output will be appended to /tmp/error-output.txt<br />
<br />
&nbsp;&nbsp;&nbsp; fwrite($pipes[0],$password);<br />
&nbsp;&nbsp;&nbsp; fclose($pipes[0]);<br />
&nbsp;&nbsp;&nbsp; fclose($pipes[1]);<br />
<br />
&nbsp;&nbsp;&nbsp; // It is important that you close any pipes before calling<br />
&nbsp;&nbsp;&nbsp; // proc_close in order to avoid a deadlock<br />
&nbsp;&nbsp;&nbsp; $return_value = proc_close($process);<br />
<br />
&nbsp;&nbsp;&nbsp; return !$return_value;<br />
&nbsp; }<br />
}<br />
?&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57857""></a>
  <div class="note">
   <strong class="user">picaune at hotmail dot com</strong>
   <a href="#57857" class="date">17-Oct-2005 01:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The above note on Windows compatibility is not entirely correct.<br />
<br />
Windows will dutifully pass on additional handles above 2 onto the child process, starting with Windows 95 and Windows NT 3.5. It even supports this capability (starting with Windows 2000) from the command line using a special syntax (prefacing the redirection operator with the handle number).<br />
<br />
These handles will be, when passed to the child, preopened for low-level IO (e.g. _read) by number. The child can reopen them for high-level (e.g. fgets) using the _fdopen or _wfdopen methods. The child can then read from or write to them the same way they would stdin or stdout.<br />
<br />
However, child processes must be specially coded to use these handles, and if the end user is not intelligent enough to use them (e.g. "openssl &lt; commands.txt 3&lt; cacert.der") and the program not smart enough to check, it could cause errors or hangs.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57456""></a>
  <div class="note">
   <strong class="user">Chapman Flack</strong>
   <a href="#57456" class="date">04-Oct-2005 09:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
One can learn from the source code in ext/standard/exec.c that the right-hand side of a descriptor assignment does not have to be an array ('file', 'pipe', or 'pty') - it can also be an existing open stream.<br />
<br />
<span class="default">&lt;?php<br />
$p </span><span class="keyword">= </span><span class="default">proc_open</span><span class="keyword">(</span><span class="string">'myfilter'</span><span class="keyword">, array( </span><span class="default">0 </span><span class="keyword">=&gt; </span><span class="default">$infile</span><span class="keyword">, ...), </span><span class="default">$pipes</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
I was glad to learn that because it solves the race condition in a scenario like this: you get a file name, open the file, read a little to make sure it's OK to serve to this client, then rewind the file and pass it as input to the filter. Without this feature, you would be limited to <span class="default">&lt;?php </span><span class="keyword">array(</span><span class="string">'file'</span><span class="keyword">, </span><span class="default">$fname</span><span class="keyword">) </span><span class="default">?&gt;</span> or passing the name to the filter command. Those choices both involve a race (because the file will be reopened after you have checked it's OK), and the last one invites surprises if not carefully quoted, too.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55502""></a>
  <div class="note">
   <strong class="user">Kyle Gibson</strong>
   <a href="#55502" class="date">05-Aug-2005 09:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
proc_open is hard coded to use "/bin/sh". So if you're working in a chrooted environment, you need to make sure that /bin/sh exists, for now.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="54047""></a>
  <div class="note">
   <strong class="user">mib at post dot com</strong>
   <a href="#54047" class="date">22-Jun-2005 03:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I thought it was highly not recommended to fork from your web server?<br />
<br />
Apart from that, one caveat is that the child process inherits anything that is preserved over fork from the parent (apart from the file descriptors which are explicitly closed).<br />
<br />
Importantly, it inherits the signal handling setup, which at least with apache means that SIGPIPE is ignored.&nbsp; Child processes that expect SIGPIPE to kill them in order to get sensible pipe handling and not go into a tight write loop will have problems unless they reset SIGPIPE themselves.<br />
<br />
Similar caveats probably apply to other signals like SIGHUP, SIGINT, etc.<br />
<br />
Other things preserved over fork include shared memory segments, umask and rlimits.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="51124""></a>
  <div class="note">
   <strong class="user">falstaff at arragon dot biz</strong>
   <a href="#51124" class="date">21-Mar-2005 02:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Using this function under windows with large amounts of data is apparently futile.<br />
<br />
these functions are returning 0 but do not appear to be doing anything useful.<br />
stream_set_write_buffer($pipes[0],0);<br />
stream_set_write_buffer($pipes[1],0);<br />
<br />
these functions are returning false and are also apparently useless under windows.<br />
stream_set_blocking($pipes[0], FALSE);<br />
stream_set_blocking($pipes[1], FALSE);<br />
<br />
The magic max buffer size I found with winxp is 63488 bytes, (62k). Anything larger than this results in a system hang.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="42647""></a>
  <div class="note">
   <strong class="user">Andre Caldas</strong>
   <a href="#42647" class="date">25-May-2004 12:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
About the comment by&nbsp; ch at westend dot com<br />
of 28-Aug-2003 08:46<br />
<br />
File streams are buffers. The data is not actualy written if you do not flush the buffer. In your case, fclose has the side effect of flushing the buffer you are closing.<br />
<br />
The program "hangs" because it tries to read some data that was not written (since it is buffered).<br />
<br />
You must do something like:<br />
<span class="default">&lt;?php<br />
&nbsp; fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp; </span><span class="default">fflush</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp; </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Good luck,<br />
&nbsp;&nbsp;&nbsp; Andre Caldas.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="42310""></a>
  <div class="note">
   <strong class="user">list[at]public[dot]lt</strong>
   <a href="#42310" class="date">12-May-2004 12:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if you push a little bit more data through the pipe, it will be hanging forever. One simple solution&nbsp; on RH linux was to do this:<br />
<br />
&nbsp;stream_set_blocking($pipes[0], FALSE);<br />
&nbsp;stream_set_blocking($pipes[1], FALSE);<br />
<br />
This did not work on windows XP though.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="38870""></a>
  <div class="note">
   <strong class="user">ralf at dreesen[*NO*SPAM*] dot net</strong>
   <a href="#38870" class="date">09-Jan-2004 08:49</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The behaviour described in the following may depend on the system php runs on. Our platform was "Intel with Debian 3.0 linux".<br />
<br />
If you pass huge amounts of data (ca. &gt;&gt;10k) to the application you run and the application for example echos them directly to stdout (without buffering the input), you will get a deadlock. This is because there are size-limited buffers (so called pipes) between php and the application you run. The application will put data into the stdout buffer until it is filled, then it blocks waiting for php to read from the stdout buffer. In the meantime Php filled the stdin buffer and waits for the application to read from it. That is the deadlock.<br />
<br />
A solution to this problem may be to set the stdout stream to non blocking (stream_set_blocking) and alternately write to stdin and read from stdout.<br />
<br />
Just imagine the following example:<br />
<br />
&lt;?<br />
/* assume that strlen($in) is about 30k<br />
*/<br />
<br />
$descriptorspec = array(<br />
&nbsp;&nbsp; 0 =&gt; array("pipe", "r"),<br />
&nbsp;&nbsp; 1 =&gt; array("pipe", "w"),<br />
&nbsp;&nbsp; 2 =&gt; array("file", "/tmp/error-output.txt", "a")<br />
);<br />
<br />
$process = proc_open("cat", $descriptorspec, $pipes);<br />
<br />
if (is_resource($process)) {<br />
&nbsp;<br />
&nbsp;&nbsp; fwrite($pipes[0], $in);<br />
&nbsp;&nbsp;&nbsp; /* fwrite writes to stdin, 'cat' will immediately write the data from stdin<br />
&nbsp;&nbsp;&nbsp; * to stdout and blocks, when the stdout buffer is full. Then it will not<br />
&nbsp;&nbsp;&nbsp; * continue reading from stdin and php will block here.<br />
&nbsp;&nbsp;&nbsp; */<br />
<br />
&nbsp;&nbsp; fclose($pipes[0]);<br />
<br />
&nbsp;&nbsp; while (!feof($pipes[1])) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; $out .= fgets($pipes[1], 1024);<br />
&nbsp;&nbsp; }<br />
&nbsp;&nbsp; fclose($pipes[1]);<br />
<br />
&nbsp;&nbsp; $return_value = proc_close($process);<br />
}<br />
?&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="38496""></a>
  <div class="note">
   <strong class="user">MagicalTux at FF.ST</strong>
   <a href="#38496" class="date">24-Dec-2003 01:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that if you need to be "interactive" with the user *and* the opened application, you can use stream_select to see if something is waiting on the other side of the pipe.<br />
<br />
Stream functions can be used on pipes like :<br />
&nbsp;- pipes from popen, proc_open<br />
&nbsp;- pipes from fopen('php://stdin') (or stdout)<br />
&nbsp;- sockets (unix or tcp/udp)<br />
&nbsp;- many other things probably but the most important is here<br />
<br />
More informations about streams (you'll find many useful functions there) :<br />
<a href="http://www.php.net/manual/en/ref.stream.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/ref.stream.php</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="35355""></a>
  <div class="note">
   <strong class="user">ch at westend dot com</strong>
   <a href="#35355" class="date">28-Aug-2003 05:46</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I had trouble with this function as my script always hung like in a deadlock until I figured out that I had to strictly keep the following<br />
order. Trying to close all at the end did not work!<br />
&nbsp; proc_open();<br />
&nbsp; fwrite(pipes[0]); fclose(pipes[0]); # stdin<br />
&nbsp; fread(pipes[1]);&nbsp; fclose(pipes[1]); # stdout<br />
&nbsp; fread(pipes[2]);&nbsp; flcose(pipes[2]); # stderr<br />
&nbsp; proc_close();</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31276""></a>
  <div class="note">
   <strong class="user">daniela at itconnect dot net dot au</strong>
   <a href="#31276" class="date">16-Apr-2003 11:01</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Just a small note in case it isn't obvious, its possible to treat the filename as in fopen, thus you can pass through the standard input from php like<br />
&nbsp;&nbsp;&nbsp; $descs = array (<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 0 =&gt; array ("file", "php://stdin", "r"),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 1 =&gt; array ("pipe", "w"),<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 2 =&gt; array ("pipe", "w")<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; );<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $proc = proc_open ("myprogram", $descs, $fp);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
