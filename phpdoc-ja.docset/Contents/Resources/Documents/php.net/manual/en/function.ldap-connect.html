<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>LDAP サーバーへ接続する</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.ldap-compare.html">≪ ldap_compare</a></li>
      <li style="float: right;"><a href="function.ldap-control-paged-result-response.html">ldap_control_paged_result_response ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.ldap.html">LDAP 関数</a></li>
    <li>LDAP サーバーへ接続する</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.ldap-connect" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">ldap_connect</h1>
  <p class="verinfo">(PHP 4, PHP 5)</p><p class="refpurpose"><span class="refname">ldap_connect</span> &mdash; <span class="dc-title">LDAP サーバーへ接続する</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.ldap-connect-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">resource</span> <span class="methodname"><strong>ldap_connect</strong></span>
    ([ <span class="methodparam"><span class="type">string</span> <code class="parameter">$hostname</code><span class="initializer"> = <strong><code>NULL</code></strong></span></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$port</code><span class="initializer"> = 389</span></span>
  ]] )</div>

  <p class="para rdfs-comment">
   指定した
   <code class="parameter">hostname</code> および <code class="parameter">port</code>
   上の LDAP サーバーとの接続を確立します。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.ldap-connect-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">hostname</code></dt>

     <dd>

      <p class="para">
       OpenLDAP 2.x.x を使用している場合、ホスト名の代わりに URL を指定する
       ことが可能です。SSL と組み合わせて LDAP を使用するには、SSL
       サポートを指定して OpenLDAP 2.x.x をコンパイルし、PHP の configure で
       SSL を指定し、このパラメータを <em>ldaps://hostname/</em> とします。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">port</code></dt>

     <dd>

      <p class="para">
       接続するポート。URL を用いる場合は使用しません。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.ldap-connect-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   成功した場合に正の LDAP リンク ID 、エラーの場合に <strong><code>FALSE</code></strong>
   を返します。OpenLDAP 2.x.x を使用している場合は、
   <span class="function"><strong>ldap_connect()</strong></span> は常に <span class="type"><a href="language.types.resource.html" class="type resource">resource</a></span>
   を返しますが、実際には接続せずにパラメータの初期化だけを行います。
   実際に接続するのは次に ldap_* 関数がコールされた際で、これは
   通常は <span class="function"><a href="function.ldap-bind.html" class="function">ldap_bind()</a></span> です。
  </p>
  <p class="para">
   引数が指定されない場合、既に開かれているリンクのリンク ID を返します。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.ldap-connect-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-4496">
    <p><strong>例1 LDAP サーバーに接続する例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">//&nbsp;LDAP&nbsp;変数<br /></span><span style="color: #0000BB">$ldaphost&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"ldap.example.com"</span><span style="color: #007700">;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;ldap&nbsp;サーバー<br /></span><span style="color: #0000BB">$ldapport&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">389</span><span style="color: #007700">;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;ldap&nbsp;サーバーのポート番号<br /><br />//&nbsp;LDAP&nbsp;に接続します<br /></span><span style="color: #0000BB">$ldapconn&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">ldap_connect</span><span style="color: #007700">(</span><span style="color: #0000BB">$ldaphost</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$ldapport</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;die(</span><span style="color: #DD0000">"Could&nbsp;not&nbsp;connect&nbsp;to&nbsp;</span><span style="color: #0000BB">$ldaphost</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
   <div class="example" id="example-4497">
    <p><strong>例2 LDAP サーバーへのセキュアな接続の例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br /></span><span style="color: #FF8000">//&nbsp;サーバー証明書が証明するホストであることを<br />//&nbsp;確認する<br /></span><span style="color: #0000BB">$ldaphost&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"ldaps://ldap.example.com/"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">//&nbsp;LDAP&nbsp;に接続します<br /></span><span style="color: #0000BB">$ldapconn&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">ldap_connect</span><span style="color: #007700">(</span><span style="color: #0000BB">$ldaphost</span><span style="color: #007700">)<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;die(</span><span style="color: #DD0000">"Could&nbsp;not&nbsp;connect&nbsp;to&nbsp;</span><span style="color: #007700">{</span><span style="color: #0000BB">$ldaphost</span><span style="color: #007700">}</span><span style="color: #DD0000">"</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.ldap-connect-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.ldap-bind.html" class="function" rel="rdfs-seeAlso">ldap_bind()</a> - LDAP ディレクトリにバインドする</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="109829""></a>
  <div class="note">
   <strong class="user">ac dot russell at live dot com</strong>
   <a href="#109829" class="date">25-Aug-2012 03:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In order to connect to an ldap server via ssl I needed to use a certificate. For this to work the ldap admin sent me a .der file which I put into /etc/openldap/cacerts. <br />
&nbsp;&nbsp;&nbsp; cp ldap-server.der /etc/openldap/cacerts<br />
That directory must be chmod 755. Then the following entries had to be in /etc/openldap/ldap.conf <br />
&nbsp;&nbsp;&nbsp; TLS_REQCERT&nbsp;&nbsp; never&nbsp; <br />
&nbsp;&nbsp;&nbsp; TLS_CACERTDIR /etc/openldap/cacerts<br />
"TLS_REQCERT never" should only be required if there is a self-signed certificate in the certificate chain.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103372""></a>
  <div class="note">
   <strong class="user">verikono</strong>
   <a href="#103372" class="date">11-Apr-2011 10:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
PHP:LDAP does not support persistent connections.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96660""></a>
  <div class="note">
   <strong class="user">miki at qex dot cz</strong>
   <a href="#96660" class="date">10-Mar-2010 01:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I had terrible problems with "Unable to bind to server: Invalid credentials" error - everything seemed to be OK (login/pwd used in other apps).
<br />
Solved by adding domain to login (instead "username" I used "username@example.com").</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="93317""></a>
  <div class="note">
   <strong class="user">mharting at micahtek dot com</strong>
   <a href="#93317" class="date">02-Sep-2009 10:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
An addition to trying to setup failover. After doing the ldap_connect, do the ldap_bind.&nbsp; If ldap_bind fails, use the command ldap_errno to get the error number.&nbsp; If the error number is 81, that represents the server is down.&nbsp; That is the only time we do a failover to our backup ldap server.<br />
<br />
Another thing to consider is the error could be 49, then do<br />
ldap_get_option($this-&gt;ds,LDAP_OPT_ERROR_NUMBER,$optErrorNumber);. This will return extended data and if the data code in that is 532 or 773, the bind failure will be caused by the password being expired and requiring a password update before the bind will succeed.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90303""></a>
  <div class="note">
   <strong class="user">csnyder at fcny dot org</strong>
   <a href="#90303" class="date">15-Apr-2009 06:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It bears repeating (and the examples should probably be updated) that ldap_connect() doesn't actually test the connection to the specified ldap server. This is important if you're trying to build failover into your ldap-based authentication routine.
<br />

<br />
The only way to test the connection is to actually call ldap_bind( $ds, $username, $password ). But if that fails, is it because you have the wrong username/password or is it because the connection is down? As far as I can see there isn't any way to tell.
<br />

<br />
It seems that if ldap_bind() fails against your primary server, you have no choice but to try ldap_bind() with the same credentials against the backup. And yet, if your organization limits failed login attempts, a single bad password counts as two failed login attempts. Not good.
<br />

<br />
One possible workaround is to try an anonymous bind first:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="comment">// connect to primary
<br />
</span><span class="default">$ds </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">( </span><span class="string">'ldap://10.0.0.7/' </span><span class="keyword">);
<br />
</span><span class="comment">// note: $ds is always a resource even if primary is down
<br />

<br />
// try anonymous login to test connection
<br />
</span><span class="default">$anon </span><span class="keyword">= @</span><span class="default">ldap_bind</span><span class="keyword">( </span><span class="default">$ds </span><span class="keyword">);
<br />
if ( !</span><span class="default">$anon </span><span class="keyword">) {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// test failed, connect to failover host
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ds </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">( </span><span class="string">'ldap://10.0.0.8/' </span><span class="keyword">);
<br />
}
<br />
else {
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// test passed, unbind anonymous and reconnect to primary
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ldap_unbind</span><span class="keyword">( </span><span class="default">$ds </span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$ds </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">( </span><span class="string">'ldap://10.0.0.7/' </span><span class="keyword">);
<br />
}
<br />

<br />
</span><span class="comment">// now try a real login
<br />
</span><span class="default">$login </span><span class="keyword">= @</span><span class="default">ldap_bind</span><span class="keyword">( </span><span class="default">$ds</span><span class="keyword">, </span><span class="default">$username</span><span class="keyword">, </span><span class="default">$password </span><span class="keyword">);
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
Note that this workaround relies on anonymous login being enabled, which may not always be the case. It's a little sad that there is no other way to test the connection. Hopefully this can be remedied in some future implementation of ldap_connect().</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="88508""></a>
  <div class="note">
   <strong class="user">peter dot burden at gmail dot com</strong>
   <a href="#88508" class="date">27-Jan-2009 01:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The host name parameter can be a space separated list of host names. This means that the LDAP code will talk to a backup server if the main server is not operational. There will be a delay while the code times out trying to talk to the main server but things will still work. This is particularly useful with a typical Microsoft Active Directory setup of primary and backup domain controllers.<br />
<span class="default">&lt;?php<br />
$ldaphost </span><span class="keyword">= </span><span class="string">"192.168.0.100 192.168.0.101"</span><span class="keyword">;<br />
</span><span class="default">$ldapconn </span><span class="keyword">= </span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$ldaphost</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82918""></a>
  <div class="note">
   <strong class="user">geigers at binghamton dot edu</strong>
   <a href="#82918" class="date">01-May-2008 10:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you have oci8 and are trying to use openldap for ldap you *may* run into a problem.&nbsp; I have an Oracle database that I connect to from apache.&nbsp; Oracle also has ldap libs which were taking precedence over the openldap libs.&nbsp; This would cause a seg fault when calling ldap_connect with a uri style connect string; e.g. ldap_connect("ldaps://myldapserver.host");<br />
<br />
After using gdb to debug a core dump and a lot of googling I found that the solution was to add an env-var to apachectl startup.<br />
<br />
I am using Apache 2.2.8 with PHP 5.2.5 on RHEL.&nbsp; I added:<br />
<br />
LD_PRELOAD=/path/to/libldap.so<br />
export LD_PRELOAD<br />
<br />
in /usr/sbin/envvars which is read when apachectl starts.&nbsp; You can read more on this here: <a href="http://www.mail-archive.com/php-bugs@lists.php.net/msg02201.html" rel="nofollow" target="_blank">http://www.mail-archive.com/php-bugs@lists.php.net/msg02201.html</a><br />
<br />
Scott Geiger</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="81427""></a>
  <div class="note">
   <strong class="user">bleathem at gmail dot com</strong>
   <a href="#81427" class="date">27-Feb-2008 11:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Everyone is posting about getting ldaps:// working in a WAMP/AD stack, I had a tough time finding how to get it going in RHEL 5.1 (w/ all stock rpms).&nbsp; Good old strace did the trick and helped me find the problem...<br />
<br />
Turns out php was looking for the CA file in /etc/pki/CA, and I didn't have the correct permissions on the folder.&nbsp; chmod'ing it to 755 solved my "Can't contact LDAP server" message.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75571""></a>
  <div class="note">
   <strong class="user">andreas dot a dot sandberg at gmail dot com</strong>
   <a href="#75571" class="date">06-Jun-2007 02:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be careful when using ldap_connect with the sun client libraries that come bundled with solaris.&nbsp;&nbsp; When specifyng the host with the ldap protocol, my connection failed and it took me a good day to trouble shoot.&nbsp; ie. ldap_connect("ldap://somwhere.com");&nbsp; Just remove the 'ldap://' and specify the host.&nbsp;&nbsp; This was on Solaris 10 sparc.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="74941""></a>
  <div class="note">
   <strong class="user">vandervoord at planet dot nl</strong>
   <a href="#74941" class="date">05-May-2007 03:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The previous note concerning searching the whole AD tree works fully. Though you must be sure that the server you're authenticating/searching is a Global Catalog server. If not, connecting and binding will fail. Usually there is at least one Global Catalog server in your domain, so if the connect fails try another server it will work. The reason it works is that the Global Catalog server searches the whole domain as where the domain catalog only searches a given OU, offcourse this opposes a security threat as well :)...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73691""></a>
  <div class="note">
   <strong class="user">allie  at  lsu  dot  edu</strong>
   <a href="#73691" class="date">06-Mar-2007 11:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I sure do wish there was some way I could get this information out to all programmers in the world about binding and searching MS AD.&nbsp; This is the second time I was bit by the "I need to search the entire tree" problem.<br />
<br />
For php (and apache auth_ldap ) you need to specify port 3268 when you want to search the entire tree.&nbsp; Otherwise it will spit out the partial results error.<br />
<br />
ldap_connect($server,3268);<br />
<br />
I'm just fortunate enough to have won this same battle with apache searching the whole directory.&nbsp; When I noticed our php application failing auth's for users, I was immediately able to fix the problem by adding this port specification (and the ldap_set_option($ldapserver, LDAP_OPT_REFERRALS, 0)&nbsp; option).<br />
<br />
I really hope this helps someone else before they pull all their hair out.&nbsp; I know I miss mine.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69807""></a>
  <div class="note">
   <strong class="user">elsint at yahoo dot com</strong>
   <a href="#69807" class="date">21-Sep-2006 10:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be careful about the certificate's permission if you are using Windows.<br />
<br />
Set certificates' permissions for everyone to Read and Read&amp;Execute or you may get binding errors because of this.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="58473""></a>
  <div class="note">
   <strong class="user">baroque at citromail dot hu</strong>
   <a href="#58473" class="date">05-Nov-2005 10:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This code sample shows how to connect and bind to eDirectory in PHP using LDAP for Netware.<br />
<br />
<span class="default">&lt;?php<br />
<br />
$server</span><span class="keyword">=</span><span class="string">'137.65.138.159'</span><span class="keyword">;<br />
</span><span class="default">$admin</span><span class="keyword">=</span><span class="string">'cn=admin,o=novell'</span><span class="keyword">;<br />
</span><span class="default">$passwd</span><span class="keyword">=</span><span class="string">'novell'</span><span class="keyword">;<br />
<br />
</span><span class="default">$ds</span><span class="keyword">=</span><span class="default">ldap_connect</span><span class="keyword">(</span><span class="default">$server</span><span class="keyword">);&nbsp; </span><span class="comment">// assuming the LDAP server is on this host<br />
<br />
</span><span class="keyword">if (</span><span class="default">$ds</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// bind with appropriate dn to give update access<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$r</span><span class="keyword">=</span><span class="default">ldap_bind</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">, </span><span class="default">$admin</span><span class="keyword">, </span><span class="default">$passwd</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if(!</span><span class="default">$r</span><span class="keyword">) die(</span><span class="string">"ldap_bind failed&lt;br&gt;"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"ldap_bind success"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">ldap_close</span><span class="keyword">(</span><span class="default">$ds</span><span class="keyword">);<br />
} else {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Unable to connect to LDAP server"</span><span class="keyword">; <br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="54082""></a>
  <div class="note">
   <strong class="user">Srivathsa M</strong>
   <a href="#54082" class="date">23-Jun-2005 12:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Using LDAP over SSL on NetWare:<br />
<br />
1. Copy the server certificates to sys:/php5/cert directory. This location is configurable in php.ini file.<br />
<br />
2. Use "ldaps://" prefix for host name argument or a value of 636 for port number argument in ldap_connect call.<br />
<br />
For more details, visit, NetWare specific PHP documentation at <a href="http://developer.novell.com/ndk/doc/php/index.html" rel="nofollow" target="_blank">http://developer.novell.com/ndk/doc/php/index.html</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52253""></a>
  <div class="note">
   <strong class="user">nigelf at esp dot co dot uk</strong>
   <a href="#52253" class="date">26-Apr-2005 12:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As mentioned above, openLDAP will always return a resource, even if the server name isn't valid.&nbsp; <br />
<br />
If you then bind with errors suppressed (@ldap_bind) and it fails, it's not obvious what caused the failure (ie: connection or credentials).&nbsp; As the bind doesn't return a resource you can't get the last error from ldap_error etc. either.<br />
<br />
If you display just a message about login failure to the user they may get frustrated re-typing a valid username/password when it's the connection that's at fault.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="46054""></a>
  <div class="note">
   <strong class="user">blizzards at libero dot it</strong>
   <a href="#46054" class="date">28-Sep-2004 12:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To complete questions about how to connect to a LDAP ACTIVE DIRECTORY 2000/2003 server with SASL on port 636, you can refer to prevous notes, and the following directives:<br />
<br />
A)Create CA certificates from AD;<br />
B)Export in .pem (DER) format;<br />
C)Install OPENSSL,CYRUS SASL,OPENLDAP,KERBEROS 5;<br />
D)Copy exported AD ca cert into openssl certs dir on your unix system;<br />
E)Reash with c_reash command;<br />
F)Get a kerberos ticket form AD for your user;<br />
G)Compile PHP with SSL and LDAP support;<br />
H)Test with ldapsearch -D &lt;binddn&gt; -W -H ldaps://ad.secure.com:636 -x<br />
<br />
If all works right, create your php script.<br />
<br />
Note: For writing parameters to AD you need to renew ticket each 10 hours or less (AD default lifetime ticket), for reading pourpose you can maintain expired ticket.<br />
When querying a windows 2000/2003 AD you MUST use only SASL and not TLS (non supported).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="36156""></a>
  <div class="note">
   <strong class="user">Andrew (a.whyte at cqu.edu.au)</strong>
   <a href="#36156" class="date">29-Sep-2003 09:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To be able to make modifications to Active Directory via the LDAP connector you must bind to the LDAP service over SSL. Otherwise Active Directory provides a mostly readonly connection. You cannot add objects or modify certain properties without LDAPS, e.g. passwords can only be changed using LDAPS connections to Active Directory.<br />
<br />
Therefore, for those wishing to securely connect to Active Directory, from a Unix host using PHP+OpenLDAP+OpenSSL I spent some time getting this going myself, and came across a few gotcha's. Hope this proves fruitfull for others like me when you couldn't find answers out there.<br />
<br />
Make sure you compile OpenLDAP with OpenSSL support, and that you compile PHP with OpenLDAP and OpenSSL.<br />
<br />
This provides PHP with what it needs to make use of ldaps:// connections.<br />
<br />
Configure OpenSSL:<br />
<br />
Extract your Root CA certificate from Active Directory, this is achived through the use of Certificate Services, a startard component of Windows 2000 Server, but may not be installed by default, (The usual Add/Remove Software method will work here). I extracted this in Base64 not DER format.<br />
<br />
Place the extracted CAcert into the certs folder for openssl. (e.g. /usr/local/ssl/certs) and setup the hashed symlinks. This is easily done by simply running:<br />
<br />
&nbsp; /usr/local/ssl/bin/c_rehash<br />
<br />
Once this is done you can test it is worked by running:<br />
<br />
&nbsp; /usr/local/ssl/bin/openssl verify -verbose -CApath /usr/local/ssl/certs /tmp/exported_cacert.pem<br />
<br />
(Should return: OK).<br />
<br />
Configure OpenLDAP:<br />
<br />
Add the following to your ldap.conf file.<br />
(found as /usr/local/openldap/etc/openldap/ldap.conf)<br />
<br />
&nbsp; #--begin--<br />
<br />
&nbsp; # Instruct client to NOT request a server's cert.<br />
&nbsp; TLS_REQCERT never<br />
<br />
&nbsp; # Define location of CA Cert<br />
&nbsp; TLS_CACERT /usr/local/ssl/certs/AD_CA_CERT.pem<br />
&nbsp; TLS_CACERTDIR /usr/local/ssl/certs<br />
<br />
&nbsp; #--end--<br />
<br />
You also need to place those same settings in a file within the Apache Web user homedir called .ldaprc<br />
<br />
&nbsp; e.g.:<br />
&nbsp; <br />
&nbsp; cp /usr/local/openldap/etc/openldap/ldap.conf ~www/.ldaprc )<br />
<br />
You can then test that you're able to establish a LDAPS connection to Active Directory from the OpenLDAP command tools:<br />
<br />
&nbsp; /usr/local/openldap/bin/ldapsearch -H "ldaps://adserver.ad.com"<br />
<br />
This should return some output in extended LDIF format and will indicate no matching objects, but it proves the connection works.<br />
<br />
The name of the server you're connecting to is important. If they server name you specify in the "ldaps://" URI does not match the name of the server in it's certificate, it will complain like so:<br />
<br />
&nbsp; ldap_bind: Can't contact LDAP server (81)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; additional info: TLS: hostname does not match CN in peer certificate<br />
<br />
Once you've gotten the ldapsearch tool working correctly PHP should work also.<br />
<br />
One important gotcha however is that the Web user must be able to locate it's HOME folder. You must check that Apache is providing a HOME variable set to the Web users home directory, so that php can locate the .ldaprc file and the settings contained within. This may well be different between Unix variants but it is such a simple and stupid thing if you miss it and it causes you grief. Simply use a SetEnv directive in Apache's httpd.conf:<br />
<br />
&nbsp; SetEnv HOME /usr/local/www<br />
<br />
With all that done, you can now code up a simple connect function:<br />
<br />
&nbsp; function connect_AD()<br />
&nbsp; {<br />
&nbsp;&nbsp;&nbsp; $ldap_server = "ldaps://adserver.ad.com" ;<br />
&nbsp;&nbsp;&nbsp; $ldap_user&nbsp;&nbsp; = "CN=web service account,OU=Service Accounts,DC=ad,DC=com" ;<br />
&nbsp;&nbsp;&nbsp; $ldap_pass&nbsp;&nbsp; = "password" ;<br />
<br />
&nbsp;&nbsp;&nbsp; $ad = ldap_connect($ldap_server) ;<br />
&nbsp;&nbsp;&nbsp; ldap_set_option($ad, LDAP_OPT_PROTOCOL_VERSION, 3) ;<br />
&nbsp;&nbsp;&nbsp; $bound = ldap_bind($ad, $ldap_user, $ldap_pass);<br />
<br />
&nbsp;&nbsp;&nbsp; return $ad ;<br />
&nbsp; }<br />
<br />
Optionally you can avoid the URI style server string and use something like ldap_connect("adserver.ad.com", 636) ;&nbsp; But work fine with Active Directory servers.<br />
<br />
Hope this proves usefull.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="23654""></a>
  <div class="note">
   <strong class="user">avel at noc uoa gr</strong>
   <a href="#23654" class="date">24-Jul-2002 04:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that hostname can be a space-separated list of LDAP host names. This is very useful for failover; if the first ldap host is down, ldap_connect will ask the second LDAP host. Of course, you _must_ have LDAP replicates before doing this. :) Read the LDAP API documentation for more information.
<br />

<br />
This can also be useful, apart from failover, for LDAP load balancing. Just use a random generator function that will return a different space-separated list every time. This is because the first host in the list is always tried first.
<br />

<br />
Be careful when doing LDAP writes; be sure to always connect to your master host when you are about to modify the database, so that the replicates will get the changes as expected.
<br />

<br />
Alexandros Vellis</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="20984""></a>
  <div class="note">
   
   <a href="#20984" class="date">24-Apr-2002 06:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A resource ID is always returned when using URLs for the host parameter<br />
even if the host does not exist.<br />
<br />
"When using an URI to describe the connection, the (open)ldap library<br />
only parses the url and checks if it's valid, _no connection_ is<br />
established in that case."<br />
-mfischer@php.net<br />
<a href="http://bugs.php.net/bug.php?id=15637" rel="nofollow" target="_blank">http://bugs.php.net/bug.php?id=15637</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
