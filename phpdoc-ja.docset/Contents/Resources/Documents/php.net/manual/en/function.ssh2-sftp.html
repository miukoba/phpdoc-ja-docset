<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>SFTP サブシステムを初期化する</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.ssh2-sftp-unlink.html">≪ ssh2_sftp_unlink</a></li>
      <li style="float: right;"><a href="function.ssh2-shell.html">ssh2_shell ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.ssh2.html">SSH2 関数</a></li>
    <li>SFTP サブシステムを初期化する</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.ssh2-sftp" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">ssh2_sftp</h1>
  <p class="verinfo">(PECL ssh2 &gt;= 0.9.0)</p><p class="refpurpose"><span class="refname">ssh2_sftp</span> &mdash; <span class="dc-title">SFTP サブシステムを初期化する</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.ssh2-sftp-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">resource</span> <span class="methodname"><strong>ssh2_sftp</strong></span>
    ( <span class="methodparam"><span class="type">resource</span> <code class="parameter">$session</code></span>
   )</div>

  <p class="para rdfs-comment">
   すでに接続された SSH2 サーバーから SFTP サブシステムを要求します。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.ssh2-sftp-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">session</code></dt>

     <dd>

      <p class="para">
       <span class="function"><a href="function.ssh2-connect.html" class="function">ssh2_connect()</a></span> のコールによって取得した
       SSH 接続リンク ID。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.ssh2-sftp-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   このメソッドは全ての他の ssh2_sftp_*() や
   <a href="wrappers.ssh2.html" class="link">ssh2.sftp://</a> fopen
   ラッパーで使用する <em>SSH2 SFTP</em> リソースを返します。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.ssh2-sftp-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-4736">
    <p><strong>例1 SFTP 経由でのファイルのオープン</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$connection&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">ssh2_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">'shell.example.com'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">22</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">ssh2_auth_password</span><span style="color: #007700">(</span><span style="color: #0000BB">$connection</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'username'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'password'</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$sftp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">ssh2_sftp</span><span style="color: #007700">(</span><span style="color: #0000BB">$connection</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$stream&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"ssh2.sftp://</span><span style="color: #0000BB">$sftp</span><span style="color: #DD0000">/path/to/file"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'r'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>   
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.ssh2-sftp-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.ssh2-scp-recv.html" class="function" rel="rdfs-seeAlso">ssh2_scp_recv()</a> - SCP 経由でファイルを要求する</span></li>
    <li class="member"><span class="function"><a href="function.ssh2-scp-send.html" class="function" rel="rdfs-seeAlso">ssh2_scp_send()</a> - SCP 経由でファイルを送信する</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="114773""></a>
  <div class="note">
   <strong class="user">Jaybee</strong>
   <a href="#114773" class="date">04-Apr-2014 07:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
When uploading (writing) a file you must use an absolute path, not a relative one. <br />
<br />
If, like me, you want to use a relative path, you can use the following code: <br />
<br />
$fh=fopen("ssh2.s<a href="ftp://$sftp" rel="nofollow" target="_blank">ftp://$sftp</a>".ssh2_sftp_realpath($sftp,".")."/fileinmyhomedir.txt");</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="94651""></a>
  <div class="note">
   <strong class="user">sandipshah at vthrive dot com</strong>
   <a href="#94651" class="date">17-Nov-2009 12:05</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In<br />
<br />
$stream = fopen("ssh2.s<a href="ftp://$sftp/path/to/file" rel="nofollow" target="_blank">ftp://$sftp/path/to/file</a>", 'r');<br />
<br />
please make sure that you are specifying the "absolute" path to a file.<br />
<br />
If not, you'll get errors like<br />
<br />
"Unable to open file ..."<br />
<br />
The reasoning is simple ... ssh2.s<a href="ftp://$sftp points to the " rel="nofollow" target="_blank">ftp://$sftp points to the </a>"root" directory on the remote server, where, most likely, one does not have access.<br />
<br />
It is necessary to point it to your "home" directory.&nbsp; For example, "ssh2.s<a href="ftp://$sftp/home/username/filename" rel="nofollow" target="_blank">ftp://$sftp/home/username/filename</a>" ... where "/home/username" is where your home directory is.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84311""></a>
  <div class="note">
   <strong class="user">bas weerman</strong>
   <a href="#84311" class="date">09-Jul-2008 12:13</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I changed the read function to:<br />
<br />
&nbsp;&nbsp;&nbsp; public function receiveFile($remote_file, $local_file)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $sftp = $this-&gt;sftp;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $stream = @fopen("ssh2.s<a href="ftp://$sftp$remote_file" rel="nofollow" target="_blank">ftp://$sftp$remote_file</a>", 'r');<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (! $stream)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new Exception("Could not open file: $remote_file");<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $size = $this-&gt;getFileSize($remote_file);&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $contents = '';<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $read = 0;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $len = $size;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while ($read &lt; $len &amp;&amp; ($buf = fread($stream, $len - $read))) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $read += strlen($buf);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $contents .= $buf;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; file_put_contents ($local_file, $contents);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; @fclose($stream);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function getFileSize($file){<br />
&nbsp;&nbsp; &nbsp;&nbsp; $sftp = $this-&gt;sftp;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return filesize("ssh2.s<a href="ftp://$sftp$file" rel="nofollow" target="_blank">ftp://$sftp$file</a>");<br />
&nbsp;&nbsp;&nbsp; }</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84188""></a>
  <div class="note">
   <strong class="user">tom at r dot je</strong>
   <a href="#84188" class="date">02-Jul-2008 06:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Not sure if this is a bug of some kind of security feature.<br />
<br />
When reading files using ssh2.sftp anything inside php tags is inexplicably stripped.<br />
<br />
foo.php<br />
one<br />
&lt;?<br />
echo 'two';<br />
?&gt;<br />
echo 'three';<br />
<br />
$stream = fopen("ssh2.s<a href="ftp://$sftp$file" rel="nofollow" target="_blank">ftp://$sftp$file</a>", 'r');<br />
echo filesize("ssh2.s<a href="ftp://$sftp$file" rel="nofollow" target="_blank">ftp://$sftp$file</a>"); //CORRECT<br />
echo fread($stream, filesize("ssh2.s<a href="ftp://$sftp$file" rel="nofollow" target="_blank">ftp://$sftp$file</a>")); //prints "onethree"<br />
<br />
Not sure why this happens and haven't found a workaround.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83174""></a>
  <div class="note">
   <strong class="user">bas weerman</strong>
   <a href="#83174" class="date">14-May-2008 09:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I added some functionality for scanning the filesystem and receiving and deleting files.<br />
<br />
class SFTPConnection<br />
{<br />
&nbsp;&nbsp;&nbsp; private $connection;<br />
&nbsp;&nbsp;&nbsp; private $sftp;<br />
<br />
&nbsp;&nbsp;&nbsp; public function __construct($host, $port=22)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $this-&gt;connection = @ssh2_connect($host, $port);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (! $this-&gt;connection)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new Exception("Could not connect to $host on port $port.");<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function login($username, $password)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (! @ssh2_auth_password($this-&gt;connection, $username, $password))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new Exception("Could not authenticate with username $username " . "and password $password.");<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $this-&gt;sftp = @ssh2_sftp($this-&gt;connection);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (! $this-&gt;sftp)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new Exception("Could not initialize SFTP subsystem.");<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function uploadFile($local_file, $remote_file)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $sftp = $this-&gt;sftp;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $stream = @fopen("ssh2.s<a href="ftp://$sftp$remote_file" rel="nofollow" target="_blank">ftp://$sftp$remote_file</a>", 'w');<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (! $stream)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new Exception("Could not open file: $remote_file");<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $data_to_send = @file_get_contents($local_file);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ($data_to_send === false)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new Exception("Could not open local file: $local_file.");<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (@fwrite($stream, $data_to_send) === false)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new Exception("Could not send data from file: $local_file.");<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; @fclose($stream);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function scanFilesystem($remote_file) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $sftp = $this-&gt;sftp;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $dir = "ssh2.s<a href="ftp://$sftp$remote_file" rel="nofollow" target="_blank">ftp://$sftp$remote_file</a>";&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $tempArray = array();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $handle = opendir($dir);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // List all the files<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while (false !== ($file = readdir($handle))) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (substr("$file", 0, 1) != "."){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(is_dir($file)){<br />
//&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $tempArray[$file] = $this-&gt;scanFilesystem("$dir/$file");<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $tempArray[]=$file;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; closedir($handle);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return $tempArray;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }&nbsp; &nbsp; <br />
<br />
&nbsp;&nbsp;&nbsp; public function receiveFile($remote_file, $local_file)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $sftp = $this-&gt;sftp;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $stream = @fopen("ssh2.s<a href="ftp://$sftp$remote_file" rel="nofollow" target="_blank">ftp://$sftp$remote_file</a>", 'r');<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (! $stream)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new Exception("Could not open file: $remote_file");<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $contents = fread($stream, filesize("ssh2.s<a href="ftp://$sftp$remote_file" rel="nofollow" target="_blank">ftp://$sftp$remote_file</a>"));&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; file_put_contents ($local_file, $contents);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; @fclose($stream);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; public function deleteFile($remote_file){<br />
&nbsp;&nbsp; &nbsp;&nbsp; $sftp = $this-&gt;sftp;<br />
&nbsp;&nbsp; &nbsp;&nbsp; unlink("ssh2.s<a href="ftp://$sftp$remote_file" rel="nofollow" target="_blank">ftp://$sftp$remote_file</a>");<br />
&nbsp;&nbsp;&nbsp; }<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="82726""></a>
  <div class="note">
   <strong class="user">duke1 at drakkon dot net</strong>
   <a href="#82726" class="date">23-Apr-2008 05:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if anyone is interested on how to get a directory listing:<br />
$SSH_CONNECTION= ssh2_connect('shell.example.com', 22);<br />
ssh2_auth_password($SSH_CONNECTION, 'username', 'password');<br />
//------------------------------------------------------------------- <br />
//this function finds all files within&nbsp; given directory and returns them<br />
function scanFilesystem($dir) {<br />
&nbsp;&nbsp;&nbsp; $tempArray = array();<br />
&nbsp;&nbsp;&nbsp; $handle = opendir($dir);<br />
&nbsp; // List all the files<br />
&nbsp;&nbsp;&nbsp; while (false !== ($file = readdir($handle))) {<br />
&nbsp;&nbsp;&nbsp; if (substr("$file", 0, 1) != "."){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(is_dir($file)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $tempArray[$file]=scanFilesystem("$dir/$file");<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $tempArray[]=$file;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp; closedir($handle); <br />
&nbsp; return $tempArray;<br />
}<br />
<br />
//------------------------------------------------------------------- <br />
$sftp = ssh2_sftp($SSH_CONNECTION);<br />
<br />
//code to get listing of all OUTGOING files<br />
$dir = "ssh2.s<a href="ftp://$sftp/outgoing" rel="nofollow" target="_blank">ftp://$sftp/outgoing</a>";<br />
$outgoing = scanFilesystem($dir);<br />
sort($outgoing);<br />
print_r($outgoing);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80671""></a>
  <div class="note">
   <strong class="user">Curtis Wyatt</strong>
   <a href="#80671" class="date">28-Jan-2008 04:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The sftp class provided by David Barnes works great.&nbsp; However, if you get errors about fopen and it failing to open a stream, try the fully qualified path on the remote server.<br />
<br />
For example, if you are uploading a file to /Users/username/Sites/file.txt this may not work:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">try {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sftp </span><span class="keyword">= new </span><span class="default">SFTPConnection</span><span class="keyword">(</span><span class="string">"localhost"</span><span class="keyword">, </span><span class="default">22</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sftp</span><span class="keyword">-&gt;</span><span class="default">login</span><span class="keyword">(</span><span class="string">"username"</span><span class="keyword">, </span><span class="string">"password"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sftp</span><span class="keyword">-&gt;</span><span class="default">uploadFile</span><span class="keyword">(</span><span class="string">"/tmp/to_be_sent"</span><span class="keyword">, </span><span class="string">"Sites/file.txt"</span><span class="keyword">);<br />
}<br />
catch (</span><span class="default">Exception $e</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">"\n"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
but this will:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">try {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sftp </span><span class="keyword">= new </span><span class="default">SFTPConnection</span><span class="keyword">(</span><span class="string">"localhost"</span><span class="keyword">, </span><span class="default">22</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sftp</span><span class="keyword">-&gt;</span><span class="default">login</span><span class="keyword">(</span><span class="string">"username"</span><span class="keyword">, </span><span class="string">"password"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sftp</span><span class="keyword">-&gt;</span><span class="default">uploadFile</span><span class="keyword">(</span><span class="string">"/tmp/to_be_sent"</span><span class="keyword">, </span><span class="string">"/Users/username/Sites/file.txt"</span><span class="keyword">);<br />
}<br />
catch (</span><span class="default">Exception $e</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">"\n"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Don't assume that since you are connecting as that user that you are starting in its home space.<br />
<br />
Another possible option is that you need to use <a href="http://us.php.net/manual/en/function.ssh2-sftp-mkdir.php first to make the directory if it does not exist already, and then upload the file into it." rel="nofollow" target="_blank">http://us.php.net/manual/en/function.ssh2-sftp-mkdir.php first to make the directory if it does not exist already, and then upload the file into it.</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="71197""></a>
  <div class="note">
   <strong class="user">David Barnes</strong>
   <a href="#71197" class="date">16-Nov-2006 12:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is an example of how to send a file with SFTP:<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">SFTPConnection<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$connection</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$sftp</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">=</span><span class="default">22</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection </span><span class="keyword">= @</span><span class="default">ssh2_connect</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (! </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"Could not connect to </span><span class="default">$host</span><span class="string"> on port </span><span class="default">$port</span><span class="string">."</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">login</span><span class="keyword">(</span><span class="default">$username</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (! @</span><span class="default">ssh2_auth_password</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection</span><span class="keyword">, </span><span class="default">$username</span><span class="keyword">, </span><span class="default">$password</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"Could not authenticate with username </span><span class="default">$username</span><span class="string"> " </span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"and password </span><span class="default">$password</span><span class="string">."</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sftp </span><span class="keyword">= @</span><span class="default">ssh2_sftp</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (! </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sftp</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"Could not initialize SFTP subsystem."</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">uploadFile</span><span class="keyword">(</span><span class="default">$local_file</span><span class="keyword">, </span><span class="default">$remote_file</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sftp </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">sftp</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stream </span><span class="keyword">= @</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"ssh2.s<a href="ftp://" rel="nofollow" target="_blank">ftp://</a></span><span class="default">$sftp$remote_file</span><span class="string">"</span><span class="keyword">, </span><span class="string">'w'</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (! </span><span class="default">$stream</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"Could not open file: </span><span class="default">$remote_file</span><span class="string">"</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data_to_send </span><span class="keyword">= @</span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="default">$local_file</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$data_to_send </span><span class="keyword">=== </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"Could not open local file: </span><span class="default">$local_file</span><span class="string">."</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (@</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">, </span><span class="default">$data_to_send</span><span class="keyword">) === </span><span class="default">false</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">"Could not send data from file: </span><span class="default">$local_file</span><span class="string">."</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; @</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
try<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sftp </span><span class="keyword">= new </span><span class="default">SFTPConnection</span><span class="keyword">(</span><span class="string">"localhost"</span><span class="keyword">, </span><span class="default">22</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sftp</span><span class="keyword">-&gt;</span><span class="default">login</span><span class="keyword">(</span><span class="string">"username"</span><span class="keyword">, </span><span class="string">"password"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sftp</span><span class="keyword">-&gt;</span><span class="default">uploadFile</span><span class="keyword">(</span><span class="string">"/tmp/to_be_sent"</span><span class="keyword">, </span><span class="string">"/tmp/to_be_received"</span><span class="keyword">);<br />
}<br />
catch (</span><span class="default">Exception $e</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">$e</span><span class="keyword">-&gt;</span><span class="default">getMessage</span><span class="keyword">() . </span><span class="string">"\n"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
