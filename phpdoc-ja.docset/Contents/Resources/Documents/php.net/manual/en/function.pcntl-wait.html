<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>待つかフォークした子プロセスのステータスを返す</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.pcntl-strerror.html">≪ pcntl_strerror</a></li>
      <li style="float: right;"><a href="function.pcntl-waitpid.html">pcntl_waitpid ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.pcntl.html">PCNTL 関数</a></li>
    <li>待つかフォークした子プロセスのステータスを返す</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.pcntl-wait" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">pcntl_wait</h1>
  <p class="verinfo">(PHP 5)</p><p class="refpurpose"><span class="refname">pcntl_wait</span> &mdash; <span class="dc-title">待つかフォークした子プロセスのステータスを返す</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.pcntl-wait-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">int</span> <span class="methodname"><strong>pcntl_wait</strong></span>
    ( <span class="methodparam"><span class="type">int</span> <code class="parameter reference">&$status</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$options</code><span class="initializer"> = 0</span></span>
  ] )</div>

  <p class="para rdfs-comment">
   この関数は、子プロセスが終了する・
   カレントのプロセスを終了させるシグナルが送信される・シグナル処理関数を
   コールするシグナルが送信される
   のいずれかが発生するまでカレントのプロセスの実行を中断します。
   子プロセスが、 コール時に
   既に終了している場合(&quot;ゾンビ&quot;プロセスと呼ばれます)、この関数は
   直ちに処理を返します。子プロセスにより使用される全てのシステム
   リソースは、解放されます。waitpid のシステムでの動作に関する詳細は、
   システムの wait(2) についての man ページを参照ください。
  </p>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <p class="para">
    この関数は、<code class="parameter">pid</code> に <em>-1</em>
    を指定し、<code class="parameter">options</code> を何も設定せずに
    <span class="function"><a href="function.pcntl-waitpid.html" class="function">pcntl_waitpid()</a></span> をコールするのと等価です。
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.pcntl-wait-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">status</code></dt>

     <dd>

      <p class="para">
       <span class="function"><strong>pcntl_wait()</strong></span> は、パラメータ
       <code class="parameter">status</code> の中にステータス情報を保存します。
       このステータスは、次の関数を用いて評価可能です。
       <span class="function"><a href="function.pcntl-wifexited.html" class="function">pcntl_wifexited()</a></span>、
       <span class="function"><a href="function.pcntl-wifstopped.html" class="function">pcntl_wifstopped()</a></span>、
       <span class="function"><a href="function.pcntl-wifsignaled.html" class="function">pcntl_wifsignaled()</a></span>、
       <span class="function"><a href="function.pcntl-wexitstatus.html" class="function">pcntl_wexitstatus()</a></span>、
       <span class="function"><a href="function.pcntl-wtermsig.html" class="function">pcntl_wtermsig()</a></span> および
       <span class="function"><a href="function.pcntl-wstopsig.html" class="function">pcntl_wstopsig()</a></span> 。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">options</code></dt>

     <dd>

      <p class="para">
       システム上で wait3 が使用可能な場合 (ほとんどの BSD 系システムが
       該当します)、オプションのパラメータ <code class="parameter">options</code>
       を使用可能です。このパラメータが指定されない場合、wait はシステムコールに
       対して使用されます。wait3 が使用できない場合、<code class="parameter">options
       </code> に値を設定しても何の影響も及ぼしません。
       <code class="parameter">options</code> の値は、次の 2 つのグローバル定数の
       ゼロまたはそれ以上の論理和です。
       <table class="doctable table">
        <caption><strong><code class="parameter">options</code> のとりうる値</strong></caption>
        
         <tbody class="tbody">
          <tr>
           <td><em>WNOHANG</em></td>
           <td>
            子プロセスが終了していない場合に直ちに処理を返します。
           </td>
          </tr>

          <tr>
           <td><em>WUNTRACED</em></td>
           <td>
            停止した子プロセスの場合に処理を返します。
            そして、ステータスは報告されません。
           </td>
          </tr>

         </tbody>
        
       </table>

      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.pcntl-wait-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   <span class="function"><strong>pcntl_wait()</strong></span> は、終了した子プロセスの
   プロセス ID を返します。エラーの場合は -1、(wait3 が使用可能なシステムで)
   WNOHANG が使用され、子プロセスが利用できない場合に 0 を返します。
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.pcntl-wait-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.pcntl-fork.html" class="function" rel="rdfs-seeAlso">pcntl_fork()</a> - 現在実行中のプロセスをフォークする</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-signal.html" class="function" rel="rdfs-seeAlso">pcntl_signal()</a> - シグナルハンドラを設定する</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wifexited.html" class="function" rel="rdfs-seeAlso">pcntl_wifexited()</a> - ステータスコードが正常終了を表しているかどうかを調べる</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wifstopped.html" class="function" rel="rdfs-seeAlso">pcntl_wifstopped()</a> - 子プロセスが現在停止しているかどうかを調べる</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wifsignaled.html" class="function" rel="rdfs-seeAlso">pcntl_wifsignaled()</a> - ステータスコードがシグナルによる終了を表しているかどうかを調べる</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wexitstatus.html" class="function" rel="rdfs-seeAlso">pcntl_wexitstatus()</a> - 終了した子プロセスのリターンコードを返す</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wtermsig.html" class="function" rel="rdfs-seeAlso">pcntl_wtermsig()</a> - 子プロセスを終了させたシグナルを返す</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-wstopsig.html" class="function" rel="rdfs-seeAlso">pcntl_wstopsig()</a> - 子プロセスを停止させたシグナルを返す</span></li>
    <li class="member"><span class="function"><a href="function.pcntl-waitpid.html" class="function" rel="rdfs-seeAlso">pcntl_waitpid()</a> - 待つかフォークした子プロセスのステータスを返す</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="98712""></a>
  <div class="note">
   <strong class="user">duerra at yahoo dot com</strong>
   <a href="#98712" class="date">02-Jul-2010 04:12</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Oops, I stripped just a little much from the job daemon code in the previous comment.&nbsp; You'll want to add a little line before the -&gt;launchJob() method is called:<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">while(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">) &gt;= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">maxProcesses</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Maximum children allowed, waiting...\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">); <br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98710""></a>
  <div class="note">
   <strong class="user">duerra at yahoo dot com</strong>
   <a href="#98710" class="date">02-Jul-2010 03:45</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Using pcntl_fork() can be a little tricky in some situations.&nbsp; For fast jobs, a child can finish processing before the parent process has executed some code related to the launching of the process.&nbsp; The parent can receive a signal before it's ready to handle the child process' status.&nbsp; To handle this scenario, I add an id to a "queue" of processes in the signal handler that need to be cleaned up if the parent process is not yet ready to handle them.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">declare(</span><span class="default">ticks</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">);<br />
</span><span class="comment">//A very basic job daemon that you can extend to your needs.&nbsp; <br />
</span><span class="keyword">class </span><span class="default">JobDaemon</span><span class="keyword">{<br />
<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$maxProcesses </span><span class="keyword">= </span><span class="default">25</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$jobsStarted </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; <br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$currentJobs </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$signalQueue</span><span class="keyword">=array();&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; protected </span><span class="default">$parentPID</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__construct</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"constructed \n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">parentPID </span><span class="keyword">= </span><span class="default">getmypid</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGCHLD</span><span class="keyword">, array(</span><span class="default">$this</span><span class="keyword">, </span><span class="string">"childSignalHandler"</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/** <br />
&nbsp;&nbsp;&nbsp; * Run the Daemon<br />
&nbsp;&nbsp;&nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">run</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Running \n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">10000</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$jobID </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">,</span><span class="default">10000000000000</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$launched </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">launchJob</span><span class="keyword">(</span><span class="default">$jobID</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Wait for child processes to finish before exiting here<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while(</span><span class="default">count</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Waiting for current jobs to finish... \n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/** <br />
&nbsp;&nbsp;&nbsp; * Launch a job from the job queue<br />
&nbsp;&nbsp;&nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">protected function </span><span class="default">launchJob</span><span class="keyword">(</span><span class="default">$jobID</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$pid </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Problem launching the job<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">error_log</span><span class="keyword">(</span><span class="string">'Could not launch new job, exiting'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else if (</span><span class="default">$pid</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Parent process<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // Sometimes you can receive a signal to the childSignalHandler function before this code executes if <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // the child script executes quickly enough!<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">] = </span><span class="default">$jobID</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// In the event that a signal for this pid was caught before we get here, it will be in our signalQueue array<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // So let's go ahead and process it now as if we'd just received the signal<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(isset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">])){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"found </span><span class="default">$pid</span><span class="string"> in the signal queue, processing it now \n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">childSignalHandler</span><span class="keyword">(</span><span class="default">SIGCHLD</span><span class="keyword">, </span><span class="default">$pid</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Forked child, do your deeds.... <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$exitStatus </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="comment">//Error code if you need to or whatever<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"Doing something fun in pid "</span><span class="keyword">.</span><span class="default">getmypid</span><span class="keyword">().</span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; exit(</span><span class="default">$exitStatus</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">childSignalHandler</span><span class="keyword">(</span><span class="default">$signo</span><span class="keyword">, </span><span class="default">$pid</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">=</span><span class="default">null</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//If no pid is provided, that means we're getting the signal from the system.&nbsp; Let's figure out<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; //which child process ended<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if(!</span><span class="default">$pid</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_waitpid</span><span class="keyword">(-</span><span class="default">1</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">, </span><span class="default">WNOHANG</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Make sure we get all of the exited children<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">while(</span><span class="default">$pid </span><span class="keyword">&gt; </span><span class="default">0</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$pid </span><span class="keyword">&amp;&amp; isset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">])){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$exitCode </span><span class="keyword">= </span><span class="default">pcntl_wexitstatus</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$exitCode </span><span class="keyword">!= </span><span class="default">0</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"</span><span class="default">$pid</span><span class="string"> exited with status "</span><span class="keyword">.</span><span class="default">$exitCode</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; unset(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">currentJobs</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; else if(</span><span class="default">$pid</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Oh no, our job has finished before this parent process could even note that it had been launched!<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //Let's make note of it and handle it when the parent process is ready for it<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"..... Adding </span><span class="default">$pid</span><span class="string"> to the signal queue ..... \n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">signalQueue</span><span class="keyword">[</span><span class="default">$pid</span><span class="keyword">] = </span><span class="default">$status</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_waitpid</span><span class="keyword">(-</span><span class="default">1</span><span class="keyword">, </span><span class="default">$status</span><span class="keyword">, </span><span class="default">WNOHANG</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98534""></a>
  <div class="note">
   <strong class="user">digitalaudiorock at gmail dot com</strong>
   <a href="#98534" class="date">21-Jun-2010 11:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was unable to get pcntl_wait or pcntl_waitpid to terminate when I had an active signal handler.&nbsp; I then noticed the post below from gaylord at 100days dot de, however I'm a little confused by that post as I found the exact opposite to be true.&nbsp; The default value of the third parameter of pcntl_signal (the restart_syscalls parameter) is true and this seems to cause the wait to continue when the signal arrives.&nbsp; In order to prevent this I had to expressly set it to false.&nbsp; That is:<br />
<br />
pcntl_signal(SIGTERM, 'my_handler_function', false);</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98450""></a>
  <div class="note">
   <strong class="user">gaylord at 100days dot de</strong>
   <a href="#98450" class="date">16-Jun-2010 02:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
pcntl_wait will not terminate on signals if you have a PHP signal handler activated (pcntl_signal).<br />
This is unless the signal handler was activated with 3rd parameter=true.<br />
<br />
Example:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">declare(</span><span class="default">ticks</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">);<br />
</span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGTERM</span><span class="keyword">, </span><span class="string">"myHandler"</span><span class="keyword">);<br />
</span><span class="default">$pid</span><span class="keyword">=</span><span class="default">pcntl_wait</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
This will not terminate on SIGTERM sent to the process, because "wait" will be restarted after php recieves the signal. The signal handler "myHandler" will not be called unless pcntl_wait terminates for some other reason.<br />
<br />
Change to:<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">declare(</span><span class="default">ticks</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">);<br />
</span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGTERM</span><span class="keyword">, </span><span class="string">"myHandler"</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
</span><span class="default">$pid</span><span class="keyword">=</span><span class="default">pcntl_wait</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Now the pcntl_wait terminates when a signal comes in and "myHandler" will be called on SIGTERM. (Make sure to put the wait in a loop though, because it will now not only terminate when a child exits but also when a signal arrives. Test for $pid&gt;0 to detect a exit message from a child)<br />
(thanks to Andrey for helping me debugging this)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="63594""></a>
  <div class="note">
   <strong class="user">thomas dot nicolai at unisg dot ch</strong>
   <a href="#63594" class="date">24-Mar-2006 08:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The code before isnt working for me cause the children are correctly started but not refreshed after they died. So keep in mind to use this instead and use the signal handler to know when a child exits to know when you have to start a new one. I added a few lines to the posting from {andy at cbeyond dot net} cause his post wasnt working for me as well (PHP5.1). Same effect like the one below.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">declare(</span><span class="default">ticks </span><span class="keyword">= </span><span class="default">1</span><span class="keyword">);<br />
<br />
</span><span class="default">$max</span><span class="keyword">=</span><span class="default">5</span><span class="keyword">;<br />
</span><span class="default">$child</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
<br />
</span><span class="comment">// function for signal handler<br />
</span><span class="keyword">function </span><span class="default">sig_handler</span><span class="keyword">(</span><span class="default">$signo</span><span class="keyword">) {<br />
&nbsp; global </span><span class="default">$child</span><span class="keyword">;<br />
&nbsp; switch (</span><span class="default">$signo</span><span class="keyword">) {<br />
&nbsp;&nbsp; case </span><span class="default">SIGCHLD</span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; echo </span><span class="string">"SIGCHLD received\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$child</span><span class="keyword">--;<br />
&nbsp; }<br />
}<br />
<br />
</span><span class="comment">// install signal handler for dead kids<br />
</span><span class="default">pcntl_signal</span><span class="keyword">(</span><span class="default">SIGCHLD</span><span class="keyword">, </span><span class="string">"sig_handler"</span><span class="keyword">);<br />
<br />
while (</span><span class="default">1</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$child</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$pid</span><span class="keyword">=</span><span class="default">pcntl_fork</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; if (</span><span class="default">$pid </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; die(</span><span class="string">"could not fork"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; } else if (</span><span class="default">$pid</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// we are the parent<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">if ( </span><span class="default">$child </span><span class="keyword">&gt;= </span><span class="default">$max </span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">pcntl_wait</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$child</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// we are the child<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">echo </span><span class="string">"\t Starting new child | now we de have </span><span class="default">$child</span><span class="string"> child processes\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="comment">// presumably doing something interesting<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">3</span><span class="keyword">,</span><span class="default">5</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; exit;<br />
&nbsp;&nbsp; &nbsp; &nbsp; }<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62099""></a>
  <div class="note">
   <strong class="user">federico at nextware dot it</strong>
   <a href="#62099" class="date">20-Feb-2006 01:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This a simple multi process application where you can choose 
<br />
the maximun process that can run at the same time.
<br />
This is useful when you need to limit the fork of process.
<br />
When the MAXPROCESS is reached the program wait on pcntl_wait()
<br />

<br />
<span class="default">&lt;?php
<br />

<br />
DEFINE</span><span class="keyword">(</span><span class="default">MAXPROCESS</span><span class="keyword">,</span><span class="default">25</span><span class="keyword">);
<br />

<br />
for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">100</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++){
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$pid </span><span class="keyword">== -</span><span class="default">1</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; die(</span><span class="string">"could not fork"</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; } elseif (</span><span class="default">$pid</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"I'm the Parent </span><span class="default">$i</span><span class="string">\n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$execute</span><span class="keyword">++;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$execute</span><span class="keyword">&gt;=</span><span class="default">MAXPROCESS</span><span class="keyword">){
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_wait</span><span class="keyword">(</span><span class="default">$status</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$execute</span><span class="keyword">--;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; } else {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; echo </span><span class="string">"I am the child, </span><span class="default">$i</span><span class="string"> pid = </span><span class="default">$pid</span><span class="string"> \n"</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">rand</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">,</span><span class="default">3</span><span class="keyword">));
<br />
&nbsp;&nbsp; &nbsp; &nbsp; echo </span><span class="string">"Bye Bye from </span><span class="default">$i</span><span class="string">\n"</span><span class="keyword">;&nbsp; &nbsp; &nbsp; &nbsp; 
<br />
&nbsp;&nbsp; &nbsp; &nbsp; exit;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57932""></a>
  <div class="note">
   <strong class="user">thisisroot at gmail dot com</strong>
   <a href="#57932" class="date">19-Oct-2005 04:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Below is a simple example of forking some children and timing the total duration (useful for stress tests).<br />
<br />
<span class="default">&lt;?php<br />
<br />
$isParent&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
</span><span class="default">$children&nbsp; &nbsp; </span><span class="keyword">= array();<br />
</span><span class="default">$start&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">microtime</span><span class="keyword">( </span><span class="default">true</span><span class="keyword">);<br />
<br />
</span><span class="comment">/* Fork you!<br />
&nbsp;* (Sorry, I had to)<br />
&nbsp;*/<br />
</span><span class="default">$ceiling </span><span class="keyword">= </span><span class="default">$CONCURRENCY </span><span class="keyword">- </span><span class="default">1</span><span class="keyword">;<br />
<br />
for ( </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; (( </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">$ceiling</span><span class="keyword">) &amp;&amp; ( </span><span class="default">$isParent</span><span class="keyword">)); </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();<br />
&nbsp;&nbsp;&nbsp; if ( </span><span class="default">$pid </span><span class="keyword">=== </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$isParent </span><span class="keyword">= </span><span class="default">false</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; } elseif ( </span><span class="default">$pid </span><span class="keyword">!= -</span><span class="default">1</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$children</span><span class="keyword">[] = </span><span class="default">$pid</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
}<br />
<br />
</span><span class="comment">/* Process body */<br />
</span><span class="keyword">echo </span><span class="string">"Do stuff here\n"</span><span class="keyword">;<br />
<br />
</span><span class="comment">/* Cleanup */<br />
</span><span class="keyword">if ( </span><span class="default">$isParent</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$status </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; while ( </span><span class="default">count</span><span class="keyword">( </span><span class="default">$children</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">pcntl_wait</span><span class="keyword">( </span><span class="default">$status</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">array_pop</span><span class="keyword">( </span><span class="default">$children</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Completed in " </span><span class="keyword">. ( </span><span class="default">microtime</span><span class="keyword">( </span><span class="default">true</span><span class="keyword">) - </span><span class="default">$start</span><span class="keyword">) . </span><span class="string">" seconds.\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
