<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>SSH サーバーに接続する</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.ssh2-auth-pubkey-file.html">≪ ssh2_auth_pubkey_file</a></li>
      <li style="float: right;"><a href="function.ssh2-exec.html">ssh2_exec ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.ssh2.html">SSH2 関数</a></li>
    <li>SSH サーバーに接続する</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.ssh2-connect" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">ssh2_connect</h1>
  <p class="verinfo">(PECL ssh2 &gt;= 0.9.0)</p><p class="refpurpose"><span class="refname">ssh2_connect</span> &mdash; <span class="dc-title">SSH サーバーに接続する</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.ssh2-connect-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">resource</span> <span class="methodname"><strong>ssh2_connect</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$host</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$port</code><span class="initializer"> = 22</span></span>
   [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$methods</code></span>
   [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$callbacks</code></span>
  ]]] )</div>

  <p class="para rdfs-comment">
   リモートの SSH サーバーとの接続を確立します。
  </p>
  <p class="para">
   一度接続すると、クライアントは <span class="function"><a href="function.ssh2-fingerprint.html" class="function">ssh2_fingerprint()</a></span>
   を使用してサーバーのホスト鍵を検証し、
   パスワードもしくは公開鍵を使用して認証します。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.ssh2-connect-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">host</code></dt>

     <dd>

      <p class="para">
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">port</code></dt>

     <dd>

      <p class="para">
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">methods</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">methods</code>
       は以下に示された4つのパラメータを持つ連想配列です。
      </p>
      <p class="para">
       <table class="doctable table">
        <caption><strong><code class="parameter">methods</code>
        は以下のパラメータのいくつかあるいは全てを含む連想配列</strong></caption>
        
         <thead>
          <tr>
           <th>インデックス</th>
           <th>意味</th>
           <th>サポートする値*</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>kex</td>
           <td>
            通知する鍵交換メソッドのリスト。優先する順にカンマ区切りにする。
           </td>
           <td>
            <em>diffie-hellman-group1-sha1</em>、
            <em>diffie-hellman-group14-sha1</em> および
            <em>diffie-hellman-group-exchange-sha1</em>
           </td>
          </tr>

          <tr>
           <td>hostkey</td>
           <td>
            通知するホスト鍵メソッドのリスト。優先する順にカンマ区切りにする。
           </td>
           <td>
            <em>ssh-rsa</em> および
            <em>ssh-dss</em>
           </td>
          </tr>

          <tr>
           <td>client_to_server</td>
           <td>
            クライアントからサーバーに送信されるメッセージのために優先する暗号化、
            圧縮、メッセージ認証コード (MAC) メソッドを含む連想配列。
           </td>
           <td class="empty">&nbsp;</td>
          </tr>

          <tr>
           <td>server_to_client</td>
           <td>
            サーバーからクライアントに送信されるメッセージのために優先する暗号化、
            圧縮、メッセージ認証コード (MAC) メソッドを含む連想配列。
           </td>
           <td class="empty">&nbsp;</td>
          </tr>

         </tbody>
        
       </table>

      </p>
      <p class="para">
       * - サポートする値は、
       構成するライブラリがサポートしているメソッドに依存します。
       追加情報については <a href="http://libssh2.org/" class="link external" title="Link : http://libssh2.org/">&raquo;&nbsp;libssh2</a>
       ドキュメントを参照ください。
      </p>
      <p class="para">
       <table class="doctable table">
        <caption><strong>
         <code class="parameter">client_to_server</code> と
         <code class="parameter">server_to_client</code>
         は以下のパラメータのいくつかあるいは全てを含む連想配列
        </strong></caption>
        
         <thead>
          <tr>
           <th>インデックス</th>
           <th>意味</th>
           <th>サポートする値*</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>crypt</td>
           <td>通知する暗号化メソッドのリスト。
           優先する順にカンマ区切りにする。</td>
           <td>
            <em>rijndael-cbc@lysator.liu.se</em>、
            <em>aes256-cbc</em>、
            <em>aes192-cbc</em>、
            <em>aes128-cbc</em>、
            <em>3des-cbc</em>、
            <em>blowfish-cbc</em>、
            <em>cast128-cbc</em>、
            <em>arcfour</em> および
            <em>none**</em>
           </td>
          </tr>

          <tr>
           <td>comp</td>
           <td>通知する圧縮メソッドのリスト。
           優先する順にカンマ区切りにする。</td>
           <td>
            <em>zlib</em> および
            <em>none</em>
           </td>
          </tr>

          <tr>
           <td>mac</td>
           <td>通知する MAC メソッドのリスト。
           優先する順にカンマ区切りにする。</td>
           <td>
            <em>hmac-sha1</em>、
            <em>hmac-sha1-96</em>、
            <em>hmac-ripemd160</em>、
            <em>hmac-ripemd160@openssh.com</em> および
            <em>none**</em>
           </td>
          </tr>

         </tbody>
        
       </table>

      </p>
      <p class="para">
       <blockquote class="note"><p><strong class="note">注意</strong>: 
        <strong>暗号化、MAC メソッドの &quot;<em>none</em>&quot;</strong><br />
        <p class="para">
         セキュリティ上の問題で、<em>none</em> は
         ビルド時に適切な ./configure
         オプションを使用して明示的に有効にしない限り、構成している
         <a href="http://libssh2.org/" class="link external" title="Link : http://libssh2.org/">&raquo;&nbsp;libssh2</a> によって無効にされます。
         詳細は構成するライブラリのドキュメントを参照ください。
        </p>
       </p></blockquote>
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">callbacks</code></dt>

     <dd>

      <p class="para">
       <code class="parameter">callbacks</code>
       は以下のパラメータのいくつかあるいは全てを含む連想配列
       <table class="doctable table">
        <caption><strong>
         コールバックパラメータ
        </strong></caption>
        
         <thead>
          <tr>
           <th>インデックス</th>
           <th>意味</th>
           <th>プロトタイプ</th>
          </tr>

         </thead>

         <tbody class="tbody">
          <tr>
           <td>ignore</td>
           <td>
            <strong><code>SSH2_MSG_IGNORE</code></strong>
            パケットを受信したときにコールする関数名
           </td>
           <td>void ignore_cb($message)</td>
          </tr>

          <tr>
           <td>debug</td>
           <td>
            <strong><code>SSH2_MSG_DEBUG</code></strong>
            パケットを受信したときにコールする関数名
           </td>
           <td>void debug_cb($message, $language, $always_display)</td>
          </tr>

          <tr>
           <td>macerror</td>
           <td>
            パケットを受信したがメッセージ認証コードに失敗した場合にコールされる関数名。
            もしコールバックが <strong><code>TRUE</code></strong> を返す場合、不整合は無視されます。
            そうでない場合、接続は終了します。
           </td>
           <td>bool macerror_cb($packet)</td>
          </tr>

          <tr>
           <td>disconnect</td>
           <td>
            <strong><code>SSH2_MSG_DISCONNECT</code></strong>
            パケットを受信したときにコールする関数名
           </td>
           <td>void disconnect_cb($reason, $message, $language)</td>
          </tr>

         </tbody>
        
       </table>

      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.ssh2-connect-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   成功した場合にリソース、エラー時に <strong><code>FALSE</code></strong> を返します。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.ssh2-connect-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-4717">
    <p><strong>例1 <span class="function"><strong>ssh2_connect()</strong></span> の例</strong></p>
    <div class="example-contents"><p>
     パケット送信時に 3des-cbc 、
     パケット受信時に任意の強度の aes cipher、
     両方向で無圧縮、
     Group1 での鍵交換という設定で強制的に接続をオープンします。
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;もしサーバーが接続を終了した場合、ユーザーに通知する&nbsp;*/<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">my_ssh_disconnect</span><span style="color: #007700">(</span><span style="color: #0000BB">$reason</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$message</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$language</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Server&nbsp;disconnected&nbsp;with&nbsp;reason&nbsp;code&nbsp;[%d]&nbsp;and&nbsp;message:&nbsp;%s\n"</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$reason</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$message</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #0000BB">$methods&nbsp;</span><span style="color: #007700">=&nbsp;array(<br />&nbsp;&nbsp;</span><span style="color: #DD0000">'kex'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'diffie-hellman-group1-sha1'</span><span style="color: #007700">,<br />&nbsp;&nbsp;</span><span style="color: #DD0000">'client_to_server'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'crypt'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'3des-cbc'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'comp'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'none'</span><span style="color: #007700">),<br />&nbsp;&nbsp;</span><span style="color: #DD0000">'server_to_client'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;array(<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'crypt'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'aes256-cbc,aes192-cbc,aes128-cbc'</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">'comp'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'none'</span><span style="color: #007700">));<br /><br /></span><span style="color: #0000BB">$callbacks&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">'disconnect'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">'my_ssh_disconnect'</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">$connection&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">ssh2_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">'shell.example.com'</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">22</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$methods</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$callbacks</span><span style="color: #007700">);<br />if&nbsp;(!</span><span style="color: #0000BB">$connection</span><span style="color: #007700">)&nbsp;die(</span><span style="color: #DD0000">'Connection&nbsp;failed'</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.ssh2-connect-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"><span class="function"><a href="function.ssh2-fingerprint.html" class="function" rel="rdfs-seeAlso">ssh2_fingerprint()</a> - リモートサーバーのフィンガープリントを処理する</span></li>
    <li class="member"><span class="function"><a href="function.ssh2-auth-none.html" class="function" rel="rdfs-seeAlso">ssh2_auth_none()</a> - &quot;none&quot; として認証する</span></li>
    <li class="member"><span class="function"><a href="function.ssh2-auth-password.html" class="function" rel="rdfs-seeAlso">ssh2_auth_password()</a> - SSH 上でプレーンなパスワードを使用した認証を行う</span></li>
    <li class="member"><span class="function"><a href="function.ssh2-auth-pubkey-file.html" class="function" rel="rdfs-seeAlso">ssh2_auth_pubkey_file()</a> - 公開鍵を使用した認証を行う</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="115172""></a>
  <div class="note">
   <strong class="user">rainerkrauss at googlemail dot com</strong>
   <a href="#115172" class="date">08-Jun-2014 08:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Warning! If you open a ssh connection and execute an external program opening another ssh connection it may result in very strange behavior.<br />
<br />
I used an sftp connection to get a file list and used "exec" to download the files afterwards with an external sftp. lftp downloaded zeros with no comment, psftp exits with error code 11 most of the time, but sometimes it works - probably depending on how quickly php collects garbage and closes the unused connection first.<br />
<br />
As there is no function to close a connection, you need to be sure to destroy all references (unset) to close it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="112820""></a>
  <div class="note">
   <strong class="user">Trev White</strong>
   <a href="#112820" class="date">26-Jul-2013 06:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hi,<br />
If you are having problems with running a ssh2 session and it waits forever during the execution of stream_get_contents, it might be because the remote system has run the command and is now sitting at a # prompt waiting for the next command.&nbsp; I had this issue on a HP MSA box, here is the code to get around the issue.<br />
<br />
Assuming you are connected with your authentication method and $ssh contains the handle.<br />
<br />
<span class="default">&lt;?php<br />
$command </span><span class="keyword">= </span><span class="string">"check disk"</span><span class="keyword">;<br />
</span><span class="comment">// Open a nice large window to stop wrapping<br />
</span><span class="default">$stream </span><span class="keyword">= </span><span class="default">ssh2_shell </span><span class="keyword">(</span><span class="default">$ssh</span><span class="keyword">, </span><span class="string">'xterm'</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">200</span><span class="keyword">, </span><span class="default">200</span><span class="keyword">, </span><span class="default">SSH2_TERM_UNIT_CHARS</span><span class="keyword">); <br />
<br />
</span><span class="comment">// Hook into the error stream<br />
</span><span class="default">$errorStream </span><span class="keyword">= </span><span class="default">ssh2_fetch_stream</span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">, </span><span class="default">SSH2_STREAM_STDERR</span><span class="keyword">);&nbsp; <br />
<br />
</span><span class="comment">// Block the streams so we wait until they complete<br />
</span><span class="default">stream_set_blocking </span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
</span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$errorStream</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Send the commands to the terminal<br />
</span><span class="default">fwrite </span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">, </span><span class="default">$command </span><span class="keyword">. </span><span class="default">PHP_EOL </span><span class="keyword">);<br />
<br />
</span><span class="comment">// Wait give the terminal a chance to accept and start processing the command, this is a slow storage device after all<br />
</span><span class="default">sleep</span><span class="keyword">(</span><span class="default">2</span><span class="keyword">);<br />
<br />
</span><span class="comment">// IMPORTANT BIT!!&nbsp; Send exit to the terminal to close the connection BEFORE WE WAIT FOR THE STREAM<br />
</span><span class="default">fwrite </span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">, </span><span class="string">"exit" </span><span class="keyword">. </span><span class="default">PHP_EOL </span><span class="keyword">);<br />
</span><span class="default">sleep </span><span class="keyword">(</span><span class="default">2</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Print the output<br />
</span><span class="keyword">echo </span><span class="default">stream_get_contents</span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">);<br />
</span><span class="default">$errortext</span><span class="keyword">=</span><span class="default">stream_get_contents</span><span class="keyword">(</span><span class="default">$errorStream</span><span class="keyword">);<br />
<br />
if (</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$errortext</span><span class="keyword">) &gt; </span><span class="default">0</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Error Data<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="keyword">echo </span><span class="string">"Error Data: </span><span class="default">$errortext</span><span class="string">"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; exit (</span><span class="default">1</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">// All Good<br />
</span><span class="keyword">exit (</span><span class="default">0</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
You can't use ssh2_exec with this method (well at lease I couldn't) because on executing the first command the stream gets blocked and then you can't run the exit command, whereas a terminal seems to use one session.<br />
<br />
I hope this helps someone.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104758""></a>
  <div class="note">
   <strong class="user">Steve Kamerman</strong>
   <a href="#104758" class="date">06-Jul-2011 12:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Due to a lack of complete examples, here's a simple SSH2 class for connecting to a server, authenticating with public key authentication, verifying the server's fingerprint, issuing commands and reading their STDOUT and properly disconnecting.&nbsp; Note: You may need to make sure you commands produce output so the response can be pulled.&nbsp; Some people suggest that the command is not executed until you pull the response back.
<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">class </span><span class="default">NiceSSH </span><span class="keyword">{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// SSH Host
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$ssh_host </span><span class="keyword">= </span><span class="string">'myserver.example.com'</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// SSH Port
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$ssh_port </span><span class="keyword">= </span><span class="default">22</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// SSH Server Fingerprint
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$ssh_server_fp </span><span class="keyword">= </span><span class="string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// SSH Username
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$ssh_auth_user </span><span class="keyword">= </span><span class="string">'username'</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// SSH Public Key File
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$ssh_auth_pub </span><span class="keyword">= </span><span class="string">'/home/username/.ssh/id_rsa.pub'</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// SSH Private Key File
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$ssh_auth_priv </span><span class="keyword">= </span><span class="string">'/home/username/.ssh/id_rsa'</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// SSH Private Key Passphrase (null == no passphrase)
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$ssh_auth_pass</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// SSH Connection
<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private </span><span class="default">$connection</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; 
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">connect</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection </span><span class="keyword">= </span><span class="default">ssh2_connect</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">ssh_host</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">ssh_port</span><span class="keyword">))) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'Cannot connect to server'</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fingerprint </span><span class="keyword">= </span><span class="default">ssh2_fingerprint</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection</span><span class="keyword">, </span><span class="default">SSH2_FINGERPRINT_MD5 </span><span class="keyword">| </span><span class="default">SSH2_FINGERPRINT_HEX</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">strcmp</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">ssh_server_fp</span><span class="keyword">, </span><span class="default">$fingerprint</span><span class="keyword">) !== </span><span class="default">0</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'Unable to verify server identity!'</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!</span><span class="default">ssh2_auth_pubkey_file</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">ssh_auth_user</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">ssh_auth_pub</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">ssh_auth_priv</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">ssh_auth_pass</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'Autentication rejected by server'</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">exec</span><span class="keyword">(</span><span class="default">$cmd</span><span class="keyword">) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (!(</span><span class="default">$stream </span><span class="keyword">= </span><span class="default">ssh2_exec</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection</span><span class="keyword">, </span><span class="default">$cmd</span><span class="keyword">))) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; throw new </span><span class="default">Exception</span><span class="keyword">(</span><span class="string">'SSH command failed'</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">, </span><span class="default">true</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (</span><span class="default">$buf </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">, </span><span class="default">4096</span><span class="keyword">)) {
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">.= </span><span class="default">$buf</span><span class="keyword">;
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$stream</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$data</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">disconnect</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">exec</span><span class="keyword">(</span><span class="string">'echo "EXITING" &amp;&amp; exit;'</span><span class="keyword">);
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;
<br />
&nbsp;&nbsp;&nbsp; }
<br />
&nbsp;&nbsp;&nbsp; public function </span><span class="default">__destruct</span><span class="keyword">() {
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">disconnect</span><span class="keyword">();
<br />
&nbsp;&nbsp;&nbsp; }
<br />
}
<br />
</span><span class="default">?&gt;
<br />
</span>
<br />
[EDIT BY danbrown AT php DOT net: Contains two bugfixes suggested by 'AlainC' in user note #109185 (removed) on 26-JUN-2012.]</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="50311""></a>
  <div class="note">
   <strong class="user">suri dot suribala dot com</strong>
   <a href="#50311" class="date">24-Feb-2005 02:00</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
With Sara's help, I have the following SS2 class that is quite flexible. If anyone improves it, please feel free to let me know.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">// ssh protocols<br />
// note: once openShell method is used, cmdExec does not work<br />
<br />
</span><span class="keyword">class </span><span class="default">ssh2 </span><span class="keyword">{<br />
<br />
&nbsp; private </span><span class="default">$host </span><span class="keyword">= </span><span class="string">'host'</span><span class="keyword">;<br />
&nbsp; private </span><span class="default">$user </span><span class="keyword">= </span><span class="string">'user'</span><span class="keyword">;<br />
&nbsp; private </span><span class="default">$port </span><span class="keyword">= </span><span class="string">'22'</span><span class="keyword">;<br />
&nbsp; private </span><span class="default">$password </span><span class="keyword">= </span><span class="string">'password'</span><span class="keyword">;<br />
&nbsp; private </span><span class="default">$con </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp; private </span><span class="default">$shell_type </span><span class="keyword">= </span><span class="string">'xterm'</span><span class="keyword">;<br />
&nbsp; private </span><span class="default">$shell </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">;<br />
&nbsp; private </span><span class="default">$log </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
<br />
&nbsp; function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">, </span><span class="default">$port</span><span class="keyword">=</span><span class="string">''&nbsp; </span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; &nbsp; if( </span><span class="default">$host</span><span class="keyword">!=</span><span class="string">'' </span><span class="keyword">) </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">host&nbsp; </span><span class="keyword">= </span><span class="default">$host</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; if( </span><span class="default">$port</span><span class="keyword">!=</span><span class="string">'' </span><span class="keyword">) </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">port&nbsp; </span><span class="keyword">= </span><span class="default">$port</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">con&nbsp; </span><span class="keyword">= </span><span class="default">ssh2_connect</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">host</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">port</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; if( !</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">con </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">log </span><span class="keyword">.= </span><span class="string">"Connection failed !"</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; }<br />
<br />
&nbsp; }<br />
<br />
&nbsp; function </span><span class="default">authPassword</span><span class="keyword">( </span><span class="default">$user </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">, </span><span class="default">$password </span><span class="keyword">= </span><span class="string">'' </span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; &nbsp; if( </span><span class="default">$user</span><span class="keyword">!=</span><span class="string">'' </span><span class="keyword">) </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">user&nbsp; </span><span class="keyword">= </span><span class="default">$user</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; if( </span><span class="default">$password</span><span class="keyword">!=</span><span class="string">'' </span><span class="keyword">) </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">password&nbsp; </span><span class="keyword">= </span><span class="default">$password</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; if( !</span><span class="default">ssh2_auth_password</span><span class="keyword">( </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">con</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">user</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">password </span><span class="keyword">) ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">log </span><span class="keyword">.= </span><span class="string">"Authorization failed !"</span><span class="keyword">; <br />
&nbsp;&nbsp; &nbsp; }<br />
<br />
&nbsp; }<br />
<br />
&nbsp; function </span><span class="default">openShell</span><span class="keyword">( </span><span class="default">$shell_type </span><span class="keyword">= </span><span class="string">'' </span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ( </span><span class="default">$shell_type </span><span class="keyword">!= </span><span class="string">'' </span><span class="keyword">) </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">shell_type </span><span class="keyword">= </span><span class="default">$shell_type</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">shell </span><span class="keyword">= </span><span class="default">ssh2_shell</span><span class="keyword">( </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">con</span><span class="keyword">,&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">shell_type </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if( !</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">shell </span><span class="keyword">) </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">log </span><span class="keyword">.= </span><span class="string">" Shell connection failed !"</span><span class="keyword">;<br />
<br />
&nbsp; }<br />
<br />
&nbsp; function </span><span class="default">writeShell</span><span class="keyword">( </span><span class="default">$command </span><span class="keyword">= </span><span class="string">'' </span><span class="keyword">) {<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">shell</span><span class="keyword">, </span><span class="default">$command</span><span class="keyword">.</span><span class="string">"\n"</span><span class="keyword">);<br />
<br />
&nbsp; }<br />
<br />
&nbsp; function </span><span class="default">cmdExec</span><span class="keyword">( ) {<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$argc </span><span class="keyword">= </span><span class="default">func_num_args</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$argv </span><span class="keyword">= </span><span class="default">func_get_args</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$cmd </span><span class="keyword">= </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; for( </span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">$argc </span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if( </span><span class="default">$i </span><span class="keyword">!= (</span><span class="default">$argc</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">) ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cmd </span><span class="keyword">.= </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">].</span><span class="string">" &amp;&amp; "</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cmd </span><span class="keyword">.= </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">$cmd</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stream </span><span class="keyword">= </span><span class="default">ssh2_exec</span><span class="keyword">( </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">con</span><span class="keyword">, </span><span class="default">$cmd </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">stream_set_blocking</span><span class="keyword">( </span><span class="default">$stream</span><span class="keyword">, </span><span class="default">true </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">fread</span><span class="keyword">( </span><span class="default">$stream</span><span class="keyword">, </span><span class="default">4096 </span><span class="keyword">);<br />
<br />
&nbsp; }<br />
<br />
&nbsp; function </span><span class="default">getLog</span><span class="keyword">() {<br />
<br />
&nbsp;&nbsp; &nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">log</span><span class="keyword">; <br />
<br />
&nbsp; }<br />
<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
