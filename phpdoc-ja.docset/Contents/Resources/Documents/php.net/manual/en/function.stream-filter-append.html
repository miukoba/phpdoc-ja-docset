<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>ストリームにフィルタを付加する</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.stream-encoding.html">≪ stream_encoding</a></li>
      <li style="float: right;"><a href="function.stream-filter-prepend.html">stream_filter_prepend ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="ref.stream.html">ストリーム 関数</a></li>
    <li>ストリームにフィルタを付加する</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="function.stream-filter-append" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">stream_filter_append</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.3.0, PHP 5)</p><p class="refpurpose"><span class="refname">stream_filter_append</span> &mdash; <span class="dc-title">ストリームにフィルタを付加する</span></p>

 </div>
 <div class="refsect1 description" id="refsect1-function.stream-filter-append-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">resource</span> <span class="methodname"><strong>stream_filter_append</strong></span>
    ( <span class="methodparam"><span class="type">resource</span> <code class="parameter">$stream</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$filtername</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$read_write</code></span>
   [, <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <code class="parameter">$params</code></span>
  ]] )</div>

  <p class="para rdfs-comment">
   <code class="parameter">filtername</code> で指定されたフィルタを、
   <code class="parameter">stream</code> に付加されているフィルタのリストに加えます。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.stream-filter-append-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    
     <dt>
<code class="parameter">stream</code></dt>

     <dd>

      <p class="para">
       対象となるストリーム。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">filtername</code></dt>

     <dd>

      <p class="para">
       フィルタ名。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">read_write</code></dt>

     <dd>

      <p class="para">
       デフォルトでは、 <span class="function"><strong>stream_filter_append()</strong></span> は
       ストリームが読み込み用に開かれている場合は (つまり、オープンモードが
       <em>r</em> あるいは <em>+</em> を伴う場合は)、
       フィルタを <em>リードフィルタチェイン</em> に追加し、
       ストリームが書き出し用に開かれている場合は(つまり、オープンモードが
       <em>w</em> か <em>a</em>か、あるいは<em>+</em> を伴う場合は)、
       <em>ライトフィルターチェィン</em>にも追加します。
       <strong><code>STREAM_FILTER_READ</code></strong>・
       <strong><code>STREAM_FILTER_WRITE</code></strong>・
       <strong><code>STREAM_FILTER_ALL</code></strong> を <code class="parameter">read_write</code>パラメータに渡すことで、この挙動を変えることができます。
      </p>
     </dd>

    
    
     <dt>
<code class="parameter">params</code></dt>

     <dd>

      <p class="para">
       このフィルタは、指定された <code class="parameter">params</code> と共に、
       リストの<em class="emphasis">末尾</em>に追加され、ストリームに対する操作の中で最後に呼び出されます。
       フィルタをリストの先頭に加えたいときは、<span class="function"><a href="function.stream-filter-prepend.html" class="function">stream_filter_prepend()</a></span>
       を使ってください。
      </p>
     </dd>

    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.stream-filter-append-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   リソースを返します。
   このリソースは、<span class="function"><a href="function.stream-filter-remove.html" class="function">stream_filter_remove()</a></span>
   をコールする際にこのフィルタインスタンスを参照するために使用可能です。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.stream-filter-append-changelog">
  <h3 class="title">変更履歴</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>バージョン</th>
       <th>説明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>5.1.0</td>
       <td>
        PHP 5.1.0 より前のバージョンでは、この関数は成功した場合に <strong><code>TRUE</code></strong>、
        失敗した場合に <strong><code>FALSE</code></strong> を返します。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.stream-filter-append-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-4139">
    <p><strong>例1 フィルタの適用される場所を制御する</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">/*&nbsp;ファイルを読み書き用に開く&nbsp;*/<br /></span><span style="color: #0000BB">$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">'test.txt'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'w+'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;ROT13&nbsp;フィルタをライトフィルタチェインに付加する。<br />&nbsp;*&nbsp;リードフィルタチェインには付加しない。*/<br /></span><span style="color: #0000BB">stream_filter_append</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"string.rot13"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">STREAM_FILTER_WRITE</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;単純な文字列をファイルに書き出す。<br />&nbsp;*&nbsp;この文字列には、出口で&nbsp;ROT13&nbsp;変換が適用される。<br />&nbsp;*/<br /></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"This&nbsp;is&nbsp;a&nbsp;test\n"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;ファイルの最初に戻る&nbsp;*/<br /></span><span style="color: #0000BB">rewind</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;書き出した内容を読み戻す。<br />&nbsp;*&nbsp;もし、フィルタがリードフィルタチェインにも<br />&nbsp;*&nbsp;付加されていれば、再び読み出し時に&nbsp;ROT13&nbsp;が適用され、<br />&nbsp;*&nbsp;テキストは元の状態に戻るはず。&nbsp;*/<br /></span><span style="color: #0000BB">fpassthru</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;期待される出力<br />&nbsp;&nbsp;&nbsp;---------------<br /><br />Guvf&nbsp;vf&nbsp;n&nbsp;grfg<br /><br />&nbsp;*/<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.stream-filter-append-notes">
  <h3 class="title">注意</h3>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <strong>カスタム(ユーザー)フィルタを使うには</strong><br />
   <span class="simpara">
    カスタムフィルタを <code class="parameter">filtername</code> に指定するためには、
    まず <span class="function"><a href="function.stream-filter-register.html" class="function">stream_filter_register()</a></span> 関数でそれを登録しておく
    必要があります。
   </span>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <span class="simpara">
    ストリームデータは（ローカルおよびリモートの）リソースからチャンク単位で
    読み込まれ、内部バッファに保持されます。新しいフィルタがストリームに
    追加されると、内部バッファのデータがその時点でフィルタリングされます。
    これは <span class="function"><a href="function.stream-filter-prepend.html" class="function">stream_filter_prepend()</a></span> の挙動とは違います。
   </span>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <span class="simpara">
    フィルタが読み込み用および書き込み用に追加されると、フィルタのインスタンスが
    2 つ作成されます。両方のフィルタリソースを取得するには、
    <strong><code>STREAM_FILTER_READ</code></strong> と
    <strong><code>STREAM_FILTER_WRITE</code></strong> で
    <span class="function"><strong>stream_filter_append()</strong></span> を 2 回コールしなければなりません。
   </span>
  </p></blockquote>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.stream-filter-append-seealso">
  <h3 class="title">参考</h3>
  <ul class="simplelist">
   <li class="member"><span class="function"><a href="function.stream-filter-register.html" class="function" rel="rdfs-seeAlso">stream_filter_register()</a> - ユーザー定義のストリームフィルタを登録する</span></li>
   <li class="member"><span class="function"><a href="function.stream-filter-prepend.html" class="function" rel="rdfs-seeAlso">stream_filter_prepend()</a> - フィルタをストリームに付加する</span></li>
   <li class="member"><span class="function"><a href="function.stream-get-filters.html" class="function" rel="rdfs-seeAlso">stream_get_filters()</a> - 登録されているフィルタのリストを取得する</span></li>
  </ul>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="84637""></a>
  <div class="note">
   <strong class="user">dlvoy</strong>
   <a href="#84637" class="date">23-Jul-2008 09:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
While using compression filters on a large set of files during one script invocation i've got
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; Fatal error: Allowed memory size of xxx bytes exhausted
<br />
even when my max memory limit settings was insane high (128MB)
<br />

<br />
Workaround is to remember to remove filter after work done with stream_filter_remove:
<br />

<br />
<span class="default">&lt;?php
<br />
</span><span class="keyword">foreach(</span><span class="default">$lot_of_files </span><span class="keyword">as </span><span class="default">$filename</span><span class="keyword">)
<br />
{
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$filename</span><span class="keyword">, </span><span class="string">'rb'</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$filter_params </span><span class="keyword">= array(</span><span class="string">'level' </span><span class="keyword">=&gt; </span><span class="default">2</span><span class="keyword">, </span><span class="string">'window' </span><span class="keyword">=&gt; </span><span class="default">15</span><span class="keyword">, </span><span class="default">$memory </span><span class="keyword">=&gt; </span><span class="default">6</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$s_filter </span><span class="keyword">= </span><span class="default">stream_filter_append</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'zlib.deflate'</span><span class="keyword">, </span><span class="default">STREAM_FILTER_READ</span><span class="keyword">, </span><span class="default">$filter_params</span><span class="keyword">);
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// here stream-operating code&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; 
<br />

<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">stream_filter_remove</span><span class="keyword">(</span><span class="default">$s_filter</span><span class="keyword">);
<br />

<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);
<br />
}
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="59674""></a>
  <div class="note">
   <strong class="user">net_navard at yahoo dot com</strong>
   <a href="#59674" class="date">13-Dec-2005 07:47</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hello firends<br />
<br />
The difference betweem adding a stream filter first or last in the filte list in only the order they will be applied to streams.<br />
<br />
For example, if you're reading data from a file, and a given filter is placed in first place with stream_filter_prepend()the data will be processed by that filter first.<br />
<br />
This example reads out file data and the filter is applied at the beginning of the reading operation:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/* Open a test file for reading */<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"test.txt"</span><span class="keyword">, </span><span class="string">"r"</span><span class="keyword">);<br />
</span><span class="comment">/* Apply the ROT13 filter to the<br />
&nbsp;* read filter chain, but not the<br />
&nbsp;* write filter chain */<br />
</span><span class="default">stream_filter_prepend</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"string.rot13"</span><span class="keyword">,<br />
</span><span class="default">STREAM_FILTER_READ</span><span class="keyword">);<br />
</span><span class="comment">// read file data<br />
</span><span class="default">$contents</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="comment">// file data is first filtered and stored in $contents<br />
</span><span class="keyword">echo </span><span class="default">$contents</span><span class="keyword">;<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
On the other hand, if stream_filter_append() is used, then the filter will be applied at the end of the data operation. The thing about this is only the order filters are applied to streams. Back to the example, it's not the same thing removing new lines from file data and then counting the number of characters, than performing the inverse process. In this case, the order that filters are applied to stream is important.<br />
<br />
This example writes a test string to a file. The filter is applied at the end of the writing operation:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">/* Open a test file for writing */<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"test.txt"</span><span class="keyword">, </span><span class="string">"w+"</span><span class="keyword">);<br />
</span><span class="comment">/* Apply the ROT13 filter to the<br />
&nbsp;* write filter chain, but not the<br />
&nbsp;* read filter chain */<br />
</span><span class="default">stream_filter_append</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"string.rot13"</span><span class="keyword">,<br />
</span><span class="default">STREAM_FILTER_WRITE</span><span class="keyword">);<br />
</span><span class="comment">/* Write a simple string to the file<br />
&nbsp;* it will be ROT13 transformed at the end of the<br />
stream operation<br />
&nbsp;* way out */<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">"This is a test\n"</span><span class="keyword">); </span><span class="comment">// string data is<br />
</span><span class="default">first written</span><span class="keyword">, </span><span class="default">then ROT13 tranformed </span><span class="keyword">and </span><span class="default">lastly<br />
written to file<br />
</span><span class="comment">/* Back up to the beginning of the file */<br />
</span><span class="default">rewind</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
</span><span class="default">$contents</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">512</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
echo </span><span class="default">$contents</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
In the first case, data is transformed at the end of the writing operation, while in the second one, data is first filtered and then stored in $contents.<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; With Regards <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; Hossein</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
