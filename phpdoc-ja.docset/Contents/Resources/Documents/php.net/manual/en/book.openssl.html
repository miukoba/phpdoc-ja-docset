<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; CHARSET=shift-jis">
  <title>OpenSSL</title>

  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs" class="docs"><div class="navbar navbar-fixed-top">
  <div class="navbar-inner clearfix">
    <ul class="nav" style="width: 100%">
      <li style="float: left;"><a href="function.mhash.html">≪ mhash</a></li>
      <li style="float: right;"><a href="intro.openssl.html">導入 ≫</a></li>
    </ul>
  </div>
</div>
<div id="breadcrumbs" class="clearfix">
  <ul class="breadcrumbs-container">
    <li><a href="index.html">PHP Manual</a></li>
    <li><a href="refs.crypto.html">暗号</a></li>
    <li>OpenSSL</li>
  </ul>
</div>
<div id="layout">
  <div id="layout-content"><div id="book.openssl" class="book">
 
 <h1 class="title">OpenSSL</h1>
 
 
 
 
 
 









 








 









 




 




 










<ul class="chunklist chunklist_book"><li><a href="intro.openssl.html">導入</a></li><li><a href="openssl.setup.html">インストール/設定</a><ul class="chunklist chunklist_book chunklist_children"><li><a href="openssl.requirements.html">要件</a></li><li><a href="openssl.installation.html">インストール手順</a></li><li><a href="openssl.configuration.html">実行時設定</a></li><li><a href="openssl.resources.html">リソース型</a></li></ul></li><li><a href="openssl.constants.html">定義済み定数</a><ul class="chunklist chunklist_book chunklist_children"><li><a href="openssl.purpose-check.html">目的を調べるフラグ</a></li><li><a href="openssl.padding.html">非対称暗号化のパディングフラグ</a></li><li><a href="openssl.key-types.html">キーの型</a></li><li><a href="openssl.pkcs7.flags.html">PKCS7 フラグ/定数</a></li><li><a href="openssl.signature-algos.html">署名アルゴリズム</a></li><li><a href="openssl.ciphers.html">暗号化方式</a></li><li><a href="openssl.constversion.html">バージョン定数</a></li><li><a href="openssl.constsni.html">Server Name Indication 定数</a></li></ul></li><li><a href="openssl.certparams.html">キー/証明書パラメータ</a></li><li><a href="openssl.cert.verification.html">証明書の認証</a></li><li><a href="ref.openssl.html">OpenSSL 関数</a><ul class="chunklist chunklist_book chunklist_children"><li><a href="function.openssl-cipher-iv-length.html">openssl_cipher_iv_length</a> &mdash; 暗号 iv の長さを取得</li><li><a href="function.openssl-csr-export-to-file.html">openssl_csr_export_to_file</a> &mdash; CSR をファイルにエクスポートする</li><li><a href="function.openssl-csr-export.html">openssl_csr_export</a> &mdash; CSR を文字列としてエクスポートする</li><li><a href="function.openssl-csr-get-public-key.html">openssl_csr_get_public_key</a> &mdash; CERT の公開鍵を返す</li><li><a href="function.openssl-csr-get-subject.html">openssl_csr_get_subject</a> &mdash; CERT の subject を返す</li><li><a href="function.openssl-csr-new.html">openssl_csr_new</a> &mdash; CSR を作成する</li><li><a href="function.openssl-csr-sign.html">openssl_csr_sign</a> &mdash; 他の CERT（あるいは自分自身）で証明書をサインする</li><li><a href="function.openssl-decrypt.html">openssl_decrypt</a> &mdash; データを復号</li><li><a href="function.openssl-dh-compute-key.html">openssl_dh_compute_key</a> &mdash; リモート DH キー及びローカル DH キーの公開値に関して、共有される秘密を計算</li><li><a href="function.openssl-digest.html">openssl_digest</a> &mdash; ダイジェストを計算</li><li><a href="function.openssl-encrypt.html">openssl_encrypt</a> &mdash; データを暗号化</li><li><a href="function.openssl-error-string.html">openssl_error_string</a> &mdash; OpenSSL エラーメッセージを返す</li><li><a href="function.openssl-free-key.html">openssl_free_key</a> &mdash; キーリソースを開放する</li><li><a href="function.openssl-get-cipher-methods.html">openssl_get_cipher_methods</a> &mdash; 利用可能な暗号メソッドを取得</li><li><a href="function.openssl-get-md-methods.html">openssl_get_md_methods</a> &mdash; 利用可能なダイジェスト・メソッドを取得</li><li><a href="function.openssl-get-privatekey.html">openssl_get_privatekey</a> &mdash; openssl_pkey_get_private のエイリアス</li><li><a href="function.openssl-get-publickey.html">openssl_get_publickey</a> &mdash; openssl_pkey_get_public のエイリアス</li><li><a href="function.openssl-open.html">openssl_open</a> &mdash; シール(暗号化)されたデータをオープン(復号)する</li><li><a href="function.openssl-pbkdf2.html">openssl_pbkdf2</a> &mdash; PKCS5 v2 の PBKDF2 文字列を生成する。デフォルトは SHA-1</li><li><a href="function.openssl-pkcs12-export-to-file.html">openssl_pkcs12_export_to_file</a> &mdash; PKCS#12 互換の証明書保存ファイルをエクスポートする</li><li><a href="function.openssl-pkcs12-export.html">openssl_pkcs12_export</a> &mdash; PKCS#12 互換の証明書保存ファイルを変数にエクスポートする</li><li><a href="function.openssl-pkcs12-read.html">openssl_pkcs12_read</a> &mdash; PKCS#12 認証ストアをパースして配列形式にする</li><li><a href="function.openssl-pkcs7-decrypt.html">openssl_pkcs7_decrypt</a> &mdash; S/MIME 暗号化されたメッセージを復号する</li><li><a href="function.openssl-pkcs7-encrypt.html">openssl_pkcs7_encrypt</a> &mdash; S/MIME メッセージを暗号化する</li><li><a href="function.openssl-pkcs7-sign.html">openssl_pkcs7_sign</a> &mdash; S/MIME メッセージにサインする</li><li><a href="function.openssl-pkcs7-verify.html">openssl_pkcs7_verify</a> &mdash; S/MIME でサインされたメッセージの署名を検証する</li><li><a href="function.openssl-pkey-export-to-file.html">openssl_pkey_export_to_file</a> &mdash; エクスポート可能な形式で、キーをファイルに取得する</li><li><a href="function.openssl-pkey-export.html">openssl_pkey_export</a> &mdash; エクスポート可能な形式で、キーを文字列に取得する</li><li><a href="function.openssl-pkey-free.html">openssl_pkey_free</a> &mdash; 秘密鍵を開放する</li><li><a href="function.openssl-pkey-get-details.html">openssl_pkey_get_details</a> &mdash; キーの詳細の配列を返す</li><li><a href="function.openssl-pkey-get-private.html">openssl_pkey_get_private</a> &mdash; 秘密鍵を取得する</li><li><a href="function.openssl-pkey-get-public.html">openssl_pkey_get_public</a> &mdash; 証明書から公開鍵を抽出し、使用できるようにする</li><li><a href="function.openssl-pkey-new.html">openssl_pkey_new</a> &mdash; 新規に秘密鍵を生成する</li><li><a href="function.openssl-private-decrypt.html">openssl_private_decrypt</a> &mdash; 秘密鍵でデータを復号する</li><li><a href="function.openssl-private-encrypt.html">openssl_private_encrypt</a> &mdash; 秘密鍵でデータを暗号化する</li><li><a href="function.openssl-public-decrypt.html">openssl_public_decrypt</a> &mdash; 公開鍵でデータを復号する</li><li><a href="function.openssl-public-encrypt.html">openssl_public_encrypt</a> &mdash; 公開鍵でデータを暗号化する</li><li><a href="function.openssl-random-pseudo-bytes.html">openssl_random_pseudo_bytes</a> &mdash; 疑似乱数のバイト文字列を生成する</li><li><a href="function.openssl-seal.html">openssl_seal</a> &mdash; データをシール(暗号化)する</li><li><a href="function.openssl-sign.html">openssl_sign</a> &mdash; 署名を生成する</li><li><a href="function.openssl-spki-export-challenge.html">openssl_spki_export_challenge</a> &mdash; Exports the challenge assoicated with a signed public key and challenge</li><li><a href="function.openssl-spki-export.html">openssl_spki_export</a> &mdash; Exports a valid PEM formatted public key signed public key and challenge</li><li><a href="function.openssl-spki-new.html">openssl_spki_new</a> &mdash; Generate a new signed public key and challenge</li><li><a href="function.openssl-spki-verify.html">openssl_spki_verify</a> &mdash; Verifies a signed public key and challenge</li><li><a href="function.openssl-verify.html">openssl_verify</a> &mdash; 署名を検証する</li><li><a href="function.openssl-x509-check-private-key.html">openssl_x509_check_private_key</a> &mdash; 秘密鍵が証明書に対応するかを確認する</li><li><a href="function.openssl-x509-checkpurpose.html">openssl_x509_checkpurpose</a> &mdash; 証明書が特定の目的に使用可能かどうか確認する</li><li><a href="function.openssl-x509-export-to-file.html">openssl_x509_export_to_file</a> &mdash; 証明書をファイルにエクスポートする</li><li><a href="function.openssl-x509-export.html">openssl_x509_export</a> &mdash; 証明書を文字列としてエクスポートする</li><li><a href="function.openssl-x509-fingerprint.html">openssl_x509_fingerprint</a> &mdash; Calculates the fingerprint, or digest, of a given X.509 certificate</li><li><a href="function.openssl-x509-free.html">openssl_x509_free</a> &mdash; 証明書リソースを開放する</li><li><a href="function.openssl-x509-parse.html">openssl_x509_parse</a> &mdash; X509 証明書をパースし、配列として情報を返す</li><li><a href="function.openssl-x509-read.html">openssl_x509_read</a> &mdash; X.509 証明書をパースし、リソース ID を返す</li></ul></li></ul></div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="93946""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#93946" class="date">08-Oct-2009 02:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
OpenSSL creates asynchronous key pairs, however I wanted to have the private key something that was human-memorizable. With the standard keys generated, this is not possible. How I achieved it was to use two types of encryption.
<br />

<br />
After generating a key pair with OpenSSL, the public key can be stored in plain text format. I then encrypted the private key itself using regular mcrypt with the human-memorizable key of my choice and converted it to ACSII using base64_encode. Then to get the private key back, I just decrypted it with mcrypt. This way I could store the encrypted private key on the server without worrying about having things stored unencrypted.
<br />

<br />
Of course, this will only be as good as your human-memorizable key is and can potentially reduce the security of your script if you choose something simple or don't use salts.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="91210""></a>
  <div class="note">
   <strong class="user">bdh dot hall at gmail dot com</strong>
   <a href="#91210" class="date">30-May-2009 12:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was having a heck of a time finding help on making asynchronous encryption/decryption using private key/public key systems working, and I had to have it for creating a credit card module that uses recurring billing.<br />
<br />
You'd be a fool to use normal, 'synchronous' or two-way encryption for this, so the whole mcrypt library won't help.<br />
<br />
But, it turns out OpenSSL is extremely easy to use...yet it is so sparsely documented that it seems it would be incredibly hard.<br />
<br />
So I share my day of hacking with you - I hope you find it helpful!<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">if (isset(</span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'HTTPS'</span><span class="keyword">]) )<br />
{<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"SECURE: This page is being accessed through a secure connection.&lt;br&gt;&lt;br&gt;"</span><span class="keyword">;<br />
}<br />
else<br />
{<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"UNSECURE: This page is being access through an unsecure connection.&lt;br&gt;&lt;br&gt;"</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="comment">// Create the keypair<br />
</span><span class="default">$res</span><span class="keyword">=</span><span class="default">openssl_pkey_new</span><span class="keyword">();<br />
<br />
</span><span class="comment">// Get private key<br />
</span><span class="default">openssl_pkey_export</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">, </span><span class="default">$privatekey</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Get public key<br />
</span><span class="default">$publickey</span><span class="keyword">=</span><span class="default">openssl_pkey_get_details</span><span class="keyword">(</span><span class="default">$res</span><span class="keyword">);<br />
</span><span class="default">$publickey</span><span class="keyword">=</span><span class="default">$publickey</span><span class="keyword">[</span><span class="string">"key"</span><span class="keyword">];<br />
<br />
echo </span><span class="string">"Private Key:&lt;BR&gt;</span><span class="default">$privatekey</span><span class="string">&lt;br&gt;&lt;br&gt;Public Key:&lt;BR&gt;</span><span class="default">$publickey</span><span class="string">&lt;BR&gt;&lt;BR&gt;"</span><span class="keyword">;<br />
<br />
</span><span class="default">$cleartext </span><span class="keyword">= </span><span class="string">'1234 5678 9012 3456'</span><span class="keyword">;<br />
<br />
echo </span><span class="string">"Clear text:&lt;br&gt;</span><span class="default">$cleartext</span><span class="string">&lt;BR&gt;&lt;BR&gt;"</span><span class="keyword">;<br />
<br />
</span><span class="default">openssl_public_encrypt</span><span class="keyword">(</span><span class="default">$cleartext</span><span class="keyword">, </span><span class="default">$crypttext</span><span class="keyword">, </span><span class="default">$publickey</span><span class="keyword">);<br />
<br />
echo </span><span class="string">"Crypt text:&lt;br&gt;</span><span class="default">$crypttext</span><span class="string">&lt;BR&gt;&lt;BR&gt;"</span><span class="keyword">;<br />
<br />
</span><span class="default">openssl_private_decrypt</span><span class="keyword">(</span><span class="default">$crypttext</span><span class="keyword">, </span><span class="default">$decrypted</span><span class="keyword">, </span><span class="default">$privatekey</span><span class="keyword">);<br />
<br />
echo </span><span class="string">"Decrypted text:&lt;BR&gt;</span><span class="default">$decrypted</span><span class="string">&lt;br&gt;&lt;br&gt;"</span><span class="keyword">;<br />
</span><span class="default">?&gt;<br />
</span><br />
Many thanks to other contributors in the docs for making this less painful.<br />
<br />
Note that you will want to use these sorts of functions to generate a key ONCE - save your privatekey offline for decryption, and put your public key in your scripts/configuration file. If your data is compromised you don't care about the encrypted stuff or the public key, it's only the private key and cleartext that really matter.<br />
<br />
Good luck!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85444""></a>
  <div class="note">
   <strong class="user">koen dot thomeer at pubmed dot be</strong>
   <a href="#85444" class="date">31-Aug-2008 07:27</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For checking the status of a client certificate using OCSP, you can use this script:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// User variables:<br />
</span><span class="default">$dir </span><span class="keyword">= </span><span class="string">'/path/to/temp/'</span><span class="keyword">; </span><span class="comment">// Directory where apache has access to (chmod 777).<br />
</span><span class="default">$RootCA </span><span class="keyword">= </span><span class="string">'/path/to/Root.cer'</span><span class="keyword">; </span><span class="comment">// Points to the Root CA in PEM format.<br />
</span><span class="default">$OCSPUrl </span><span class="keyword">= </span><span class="string">'<a href="http://ocsp.url" rel="nofollow" target="_blank">http://ocsp.url</a>'</span><span class="keyword">; </span><span class="comment">//Points to the OCSP URL<br />
// Script:<br />
</span><span class="default">$a </span><span class="keyword">= </span><span class="default">rand</span><span class="keyword">(</span><span class="default">1000</span><span class="keyword">,</span><span class="default">99999</span><span class="keyword">); </span><span class="comment">// Needed if you expect more page clicks in one second!<br />
</span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$dir</span><span class="keyword">.</span><span class="default">$a</span><span class="keyword">.</span><span class="string">'cert_i.pem'</span><span class="keyword">, </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'SSL_CLIENT_CERT_CHAIN_0'</span><span class="keyword">]); </span><span class="comment">// Issuer certificate.<br />
</span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="default">$dir</span><span class="keyword">.</span><span class="default">$a</span><span class="keyword">.</span><span class="string">'cert_c.pem'</span><span class="keyword">, </span><span class="default">$_SERVER</span><span class="keyword">[</span><span class="string">'SSL_CLIENT_CERT'</span><span class="keyword">]); </span><span class="comment">// Client (authentication) certificate.<br />
</span><span class="default">$output </span><span class="keyword">= </span><span class="default">shell_exec</span><span class="keyword">(</span><span class="string">'openssl ocsp -CAfile '</span><span class="keyword">.</span><span class="default">$RootCA</span><span class="keyword">.</span><span class="string">' -issuer '</span><span class="keyword">.</span><span class="default">$dir</span><span class="keyword">.</span><span class="default">$a</span><span class="keyword">.</span><span class="string">'cert_i.pem -cert '</span><span class="keyword">.</span><span class="default">$dir</span><span class="keyword">.</span><span class="default">$a</span><span class="keyword">.</span><span class="string">'cert_c.pem -url '</span><span class="keyword">.</span><span class="default">$OCSPUrl</span><span class="keyword">);<br />
</span><span class="default">$output2 </span><span class="keyword">= </span><span class="default">preg_split</span><span class="keyword">(</span><span class="string">'/[\r\n]/'</span><span class="keyword">, </span><span class="default">$output</span><span class="keyword">);<br />
</span><span class="default">$output3 </span><span class="keyword">= </span><span class="default">preg_split</span><span class="keyword">(</span><span class="string">'/: /'</span><span class="keyword">, </span><span class="default">$output2</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
</span><span class="default">$ocsp </span><span class="keyword">= </span><span class="default">$output3</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">];<br />
echo </span><span class="string">"OCSP status: "</span><span class="keyword">.</span><span class="default">$ocsp</span><span class="keyword">; </span><span class="comment">// will be "good", "revoked", or "unknown"<br />
</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$dir</span><span class="keyword">.</span><span class="default">$a</span><span class="keyword">.</span><span class="string">'cert_i.pem'</span><span class="keyword">);<br />
</span><span class="default">unlink</span><span class="keyword">(</span><span class="default">$dir</span><span class="keyword">.</span><span class="default">$a</span><span class="keyword">.</span><span class="string">'cert_c.pem'</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
It can be ameliorated, but it's just a beginning!<br />
<br />
Normally, you can extract the ocsp url from the client certificate. Also, an OCSP request contains only the hash of the issuer name, the hash of the issuer's key, and the serial number of the client certificate. All three can be extracted directly from the client certificate.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
</div></div></body></html>
