<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>CBC モードでデータを暗号化/復号する</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="ref.mcrypt.html">Mcrypt 関数</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.mcrypt-cfb.html">mcrypt_cfb</a></div>
 <div class="up"><a href="ref.mcrypt.html">Mcrypt 関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.mcrypt-cbc" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mcrypt_cbc</h1>
  <p class="verinfo">(PHP 4, PHP 5)</p><p class="refpurpose"><span class="refname">mcrypt_cbc</span> &mdash; <span class="dc-title">CBC モードでデータを暗号化/復号する</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.mcrypt-cbc-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">string</span> <span class="methodname"><strong>mcrypt_cbc</strong></span>
    ( <span class="methodparam"><span class="type">int</span> <code class="parameter">$cipher</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$key</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$data</code></span>
   , <span class="methodparam"><span class="type">int</span> <code class="parameter">$mode</code></span>
   [, <span class="methodparam"><span class="type">string</span> <code class="parameter">$iv</code></span>
  ] )</div>

  <div class="methodsynopsis dc-description">
   <span class="type">string</span> <span class="methodname"><strong>mcrypt_cbc</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$cipher</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$key</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$data</code></span>
   , <span class="methodparam"><span class="type">int</span> <code class="parameter">$mode</code></span>
   [, <span class="methodparam"><span class="type">string</span> <code class="parameter">$iv</code></span>
  ] )</div>

  <p class="para rdfs-comment">
   最初のプロトタイプは libmcrypt 2.2.x とリンクした場合、2 番目は、
   libmcrypt 2.4.x とリンクした場合のものです。
   <em><code class="parameter">mode</code></em> は
   <strong><code>MCRYPT_ENCRYPT</code></strong> あるいは
   <strong><code>MCRYPT_DECRYPT</code></strong> のいずれかです。
  </p>
  <p class="para">
   この関数は使用すべきではありません。代替となる関数については
    <span class="function"><a href="function.mcrypt-generic.html" class="function">mcrypt_generic()</a></span> および
    <span class="function"><a href="function.mdecrypt-generic.html" class="function">mdecrypt_generic()</a></span> を参照ください。
  </p>
  <div class="warning"><strong class="warning">警告</strong>
<p class="simpara">この関数は PHP 5.5.0 で <em class="emphasis">非推奨</em> となりました。
この関数に頼らないことを強く推奨します。</p></div>
 </div>

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="109490""></a>
  <div class="note">
   <strong class="user">Bubba at hines57 dot com</strong>
   <a href="#109490" class="date">22-Jul-2012 01:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The PERL libraries have changed a little bit and getting PHP and PERL to mcrypt together can be confusing, so here is a current example;<br />
<br />
PHP<br />
===<br />
<span class="default">&lt;?php<br />
$string </span><span class="keyword">= </span><span class="string">'Some Secret thing I want to encrypt'</span><span class="keyword">;<br />
</span><span class="default">$iv </span><span class="keyword">= </span><span class="string">'12345678'</span><span class="keyword">;<br />
</span><span class="default">$passphrase </span><span class="keyword">= </span><span class="string">'8chrsLng'</span><span class="keyword">;<br />
<br />
</span><span class="default">$encryptedString </span><span class="keyword">= </span><span class="default">encryptString</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$passphrase</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
</span><span class="comment">// Expect: 7DjnpOXG+FrUaOuc8x6vyrkk3atSiAf425ly5KpG7lOYgwouw2UATw== <br />
<br />
</span><span class="keyword">function </span><span class="default">encryptString</span><span class="keyword">(</span><span class="default">$unencryptedText</span><span class="keyword">, </span><span class="default">$passphrase</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">) {<br />
&nbsp; </span><span class="default">$enc </span><span class="keyword">= </span><span class="default">mcrypt_encrypt</span><span class="keyword">(</span><span class="default">MCRYPT_BLOWFISH</span><span class="keyword">, </span><span class="default">$passphrase</span><span class="keyword">, </span><span class="default">$unencryptedText</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_CBC</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp; return </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$enc</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
PERL<br />
====<br />
$encryptedString = '7DjnpOXG+FrUaOuc8x6vyrkk3atSiAf425ly5KpG7lOYgwouw2UATw==';<br />
$iv = '12345678';<br />
$passphrase = '8chrsLng';<br />
<br />
$string = &amp;decryptPhpEncrypted $encryptedString, $passphrase, $iv;<br />
# Expect: Some Secret thing I want to encrypt<br />
<br />
sub decryptPhpEncrypted() {<br />
&nbsp; my ($encryptedString, $passphrase, $iv) = @_;<br />
&nbsp; my $keysize = length($passphrase);<br />
&nbsp; use Crypt::CBC;<br />
&nbsp; $cipher = Crypt::CBC-&gt;new( {'key' =&gt; $encryptedString,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 'cipher'=&gt; 'Blowfish',<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 'iv' =&gt; $iv,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 'keysize' =&gt; $keysize,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 'regenerate_key' =&gt; 0,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 'padding' =&gt; 'null',<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 'prepend_iv' =&gt; 0});<br />
<br />
&nbsp; return $cipher-&gt;decrypt($encryptedString);<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108418""></a>
  <div class="note">
   <strong class="user">dafuk at dafuk dot co dot il</strong>
   <a href="#108418" class="date">25-Apr-2012 08:20</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
if you use blowfish and somehow when you compare strings before and after it was&nbsp; (usually when it's shorter than 8 or 16 bytes) you might notice the difference, it comes out that this function does not remove padding, as a result you get a bunch of nulls at the end.<br />
<br />
use<br />
$decrypted = rtrim($decrypted,"\0"); <br />
to fix it</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90938""></a>
  <div class="note">
   <strong class="user">Othman</strong>
   <a href="#90938" class="date">17-May-2009 06:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The following code is to <br />
encrypt--&gt;encode <br />
decode--&gt;decrypt<br />
<br />
<span class="default">&lt;?php<br />
$stuff</span><span class="keyword">=</span><span class="string">"String to enc/enc/dec/dec =,=,"</span><span class="keyword">;<br />
</span><span class="default">$key</span><span class="keyword">=</span><span class="string">"XiTo74dOO09N48YeUmuvbL0E"</span><span class="keyword">;<br />
<br />
function </span><span class="default">nl</span><span class="keyword">() {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"&lt;br/&gt; \n"</span><span class="keyword">;<br />
}<br />
</span><span class="default">$iv </span><span class="keyword">= </span><span class="default">mcrypt_create_iv </span><span class="keyword">(</span><span class="default">mcrypt_get_block_size </span><span class="keyword">(</span><span class="default">MCRYPT_TripleDES</span><span class="keyword">, </span><span class="default">MCRYPT_MODE_CBC</span><span class="keyword">), </span><span class="default">MCRYPT_DEV_RANDOM</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Encrypting<br />
</span><span class="keyword">function </span><span class="default">encrypt</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$enc </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; global </span><span class="default">$iv</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$enc</span><span class="keyword">=</span><span class="default">mcrypt_cbc </span><span class="keyword">(</span><span class="default">MCRYPT_TripleDES</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">, </span><span class="default">MCRYPT_ENCRYPT</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
<br />
&nbsp; return </span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$enc</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">// Decrypting <br />
</span><span class="keyword">function </span><span class="default">decrypt</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dec </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$string </span><span class="keyword">= </span><span class="default">trim</span><span class="keyword">(</span><span class="default">base64_decode</span><span class="keyword">(</span><span class="default">$string</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; global </span><span class="default">$iv</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$dec </span><span class="keyword">= </span><span class="default">mcrypt_cbc </span><span class="keyword">(</span><span class="default">MCRYPT_TripleDES</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">, </span><span class="default">MCRYPT_DECRYPT</span><span class="keyword">, </span><span class="default">$iv</span><span class="keyword">);<br />
&nbsp; return </span><span class="default">$dec</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">$encrypted </span><span class="keyword">= </span><span class="default">encrypt</span><span class="keyword">(</span><span class="default">$stuff</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">);<br />
</span><span class="default">$decrypted </span><span class="keyword">= </span><span class="default">decrypt</span><span class="keyword">(</span><span class="default">$encrypted</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">);<br />
<br />
echo </span><span class="string">"Encrypted is "</span><span class="keyword">.</span><span class="default">$encrypted </span><span class="keyword">. </span><span class="default">nl</span><span class="keyword">(); <br />
echo </span><span class="string">"Decrypted is "</span><span class="keyword">.</span><span class="default">$decrypted </span><span class="keyword">. </span><span class="default">nl</span><span class="keyword">(); <br />
</span><span class="default">?&gt;<br />
</span><br />
Notes on the result <br />
-o running the script from the command line 1 time <br />
&nbsp;&nbsp;&nbsp; php script.php works correct<br />
-o if i ran the script in a loop i.e.<br />
<br />
#!/bin/bash<br />
for x in `seq 100` <br />
do<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo $x<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; php script.php &gt;&gt; LOG.text <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; sleep 1<br />
<br />
done<br />
it gets slower after the 10th time<br />
+ inconsistent output <br />
sometimes correct some with encrypted characters at the end of the decrypted string <br />
<br />
-o Firefox on Linux it decrypts to the original string but appends <br />
&nbsp;&nbsp;&nbsp; some encryption at the end of the decrypted sting<br />
-o running the script on the browser from windows on Firefox, <br />
&nbsp;&nbsp;&nbsp; Google Chrome, IE7 works fine for just few times <br />
&nbsp;&nbsp;&nbsp; "refresh every few seconds" <br />
&nbsp;&nbsp;&nbsp; if refresh fast it doesn't work correctly, <br />
&nbsp;&nbsp;&nbsp; some times returns the decrypted as encrypted!<br />
&nbsp;&nbsp;&nbsp; some times returns mix of encrypted &amp; decrypted<br />
<br />
I thought if sharing that test for those functions might be <br />
useful for some body</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="ref.mcrypt.html">Mcrypt 関数</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.mcrypt-cfb.html">mcrypt_cfb</a></div>
 <div class="up"><a href="ref.mcrypt.html">Mcrypt 関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
