<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>ドキュメントをコレクションに追加する</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mongocollection.group.html">MongoCollection::group</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mongocollection.remove.html">MongoCollection::remove</a></div>
 <div class="up"><a href="class.mongocollection.html">MongoCollection</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="mongocollection.insert" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">MongoCollection::insert</h1>
  <p class="verinfo">(PECL mongo &gt;=0.9.0)</p><p class="refpurpose"><span class="refname">MongoCollection::insert</span> &mdash; <span class="dc-title">ドキュメントをコレクションに追加する</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-mongocollection.insert-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="modifier">public</span> <span class="type"><span class="type bool|array">bool|array</span></span> <span class="methodname"><strong>MongoCollection::insert</strong></span>
    ( <span class="methodparam"><span class="type"><span class="type array|object">array|object</span></span> <code class="parameter">$a</code></span>
   [, <span class="methodparam"><span class="type">array</span> <code class="parameter">$options</code><span class="initializer"> = array()</span></span>
  ] )</div>

  <p class="para rdfs-comment">
   データベースに送信する文字列は UTF-8 でなければなりません。
   UTF-8 以外の文字列を送信した場合は
   <a href="class.mongoexception.html" class="classname">MongoException</a> がスローされます。非 UTF-8 文字列を追加
   (あるいは問い合わせ) するには <a href="class.mongobindata.html" class="classname">MongoBinData</a> を使います。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-mongocollection.insert-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term">
      <em><code class="parameter">a</code></em>
     </span>
     <dd>

      <p class="para">
       配列あるいはオブジェクト。オブジェクトを使う場合は、
       protected や private のプロパティは保持できません。
      </p>
      <blockquote class="note"><p><strong class="note">注意</strong>: 
       <p class="para">
        <em>_id</em> のキーあるいはプロパティを持たない場合は、
        新しい <a href="class.mongoid.html" class="classname">MongoId</a> インスタンスを作ってそれを代入します。
        ただし、パラメータを参照で渡した場合は別です。
       </p>
      </p></blockquote>
     </dd>

    </dt>

    <dt>

     <span class="term">
      <em><code class="parameter">options</code></em>
     </span>
     <dd>

      <p class="para">
       追加時のオプション。
       <ul class="itemizedlist">
        <li class="listitem">
<p class="para"><em>&quot;fsync&quot;</em></p>
<p class="para">デフォルトは <strong><code>FALSE</code></strong> です。
これを指定すると、追加をディスクに同期させるまで成功したと見なさないようになります。
<strong><code>TRUE</code></strong> にすると、<em>w</em> の設定を <em>0</em> に上書きします。</p>
</li>
        <li class="listitem"><p class="para"><em>&quot;j&quot;</em></p>
<p class="para">デフォルトは <strong><code>FALSE</code></strong> です。
これを指定すると、追加をジャーナルに同期させるまで成功したと見なさないようになります。
<strong><code>TRUE</code></strong> にすると確認付き書き込みと見なされ、<em>w</em> の設定を <em>0</em> に上書きします。</p></li>

        <li class="listitem">
<p class="para"><em>&quot;w&quot;</em></p>
<p class="para"><a href="mongo.writeconcerns.html" class="link">WriteConcerns</a> を参照ください。<a href="class.mongoclient.html" class="classname">MongoClient</a> でのデフォルト値は <em>1</em> です。
</p></li>
        <li class="listitem"><p class="para"><em>&quot;wtimeout&quot;</em></p>
<p class="para"><a href="mongo.writeconcerns.html" class="link">WriteConcern</a> の確認をいつまで待つか。
<a href="class.mongoclient.html" class="classname">MongoClient</a> のデフォルトは <em>10000</em> ミリ秒です。</p></li>
        <li class="listitem"><p class="para"><em>&quot;safe&quot;</em></p><p class="para"><em class="emphasis">非推奨</em>。<a href="mongo.writeconcerns.html" class="link">WriteConcern</a> の <em>w</em> オプションを使いましょう。</p></li>
        <li class="listitem"><p class="para"><em>&quot;timeout&quot;</em></p>
<p class="para">整数で、デフォルトは <em>MongoCursor::$timeout</em> です。
確認付き書き込みを使っている場合、これはクライアントがデータベースからのレスポンスを待ち続ける時間 (ミリ秒) を表します。
この時間内にデータベースからの反応がなければ、<a href="class.mongocursortimeoutexception.html" class="classname">MongoCursorTimeoutException</a> をスローします。</p></li>
       </ul>
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-mongocollection.insert-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   <em>&quot;w&quot;</em> オプションが設定されている場合は、
   追加の状況を含む配列を返します。
   設定されていない場合は、
   もし追加された配列が空でない場合に <strong><code>TRUE</code></strong> を返します
   (追加された配列が空の場合は <a href="class.mongoexception.html" class="classname">MongoException</a> をスローします)。
  </p>
  <p class="para">
   配列が返された場合、その中に含まれる要素は次のようになります。
   <dl>

    <dt>

     <span class="term">
      <em><code class="parameter">ok</code></em>
     </span>
     <dd>

      <p class="para">
       これはほぼ常に 1 です (ただし last_error 自体が失敗した場合は除く)。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term">
      <em><code class="parameter">err</code></em>
     </span>
     <dd>

      <p class="para">
       このフィールドに null 以外の値が入っている場合は、直前の操作でエラーが発生しています。
       このフィールドが設定されている場合、その内容は発生したエラーを表す文字列となります。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term">
      <em><code class="parameter">code</code></em>
     </span>
     <dd>

      <p class="para">
       データベースのエラーが発生した場合に、そのエラーコードをクライアントに戻します。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term">
      <em><code class="parameter">errmsg</code></em>
     </span>
     <dd>

      <p class="para">
       このフィールドが設定されるのは、データベースコマンドで何か問題が発生したときです。
       <em>ok</em> を 0 にすることと組み合わせて使います。
       たとえば、もし <em>w</em> が設定されているときにタイムアウトが発生すると、
       errmsg は &quot;timed out waiting for slaves&quot; そして <em>ok</em> は 0 になります。
       このフィールドが設定されている場合、その内容は発生したエラーを表す文字列となります。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term">
      <em><code class="parameter">n</code></em>
     </span>
     <dd>

      <p class="para">
       直近の操作が insert、update あるいは remove だった場合に、影響を受けたドキュメントの数を返します。
       追加操作の場合は、この値は常に <em>0</em> です。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term">
      <em><code class="parameter">wtimeout</code></em>
     </span>
     <dd>

      <p class="para">
       直近の操作がレプリケーション待ちでタイムアウトしたかどうか。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term">
      <em><code class="parameter">waited</code></em>
     </span>
     <dd>

      <p class="para">
       操作がタイムアウトするまでにどれだか待ったか。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term">
      <em><code class="parameter">wtime</code></em>
     </span>
     <dd>

      <p class="para">
       <em>w</em> を設定して、かつ操作が成功した場合に、
       <em>w</em> サーバーへのレプリケートにかかった時間。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term">
      <em><code class="parameter">upserted</code></em>
     </span>
     <dd>

      <p class="para">
       upsert が発生した場合は、このフィールドに新しいレコードの
       <em>_id</em> が格納されます。upsert の場合は、このフィールドあるいは
       <em>updatedExisting</em> のいずれかが (エラーが発生しない限り) 必ず存在します。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term">
      <em><code class="parameter">updatedExisting</code></em>
     </span>
     <dd>

      <p class="para">
       upsert が既存の要素を更新した場合に、このフィールドが true となります。
       <em>_id</em> が格納されます。upsert の場合は、このフィールドあるいは
       upsearted のいずれかが (エラーが発生しない限り) 必ず存在します。
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 errors" id="refsect1-mongocollection.insert-errors">
  <h3 class="title">エラー / 例外</h3>
  <p class="para">
   追加したドキュメントが空だったり長さがゼロのキーが含まれていたりした場合に
   <a href="class.mongoexception.html" class="classname">MongoException</a> をスローします。
   protected や private なプロパティを持つオブジェクトを追加しようとすると、
   キーの長さがゼロのエラーを引き起こします。
  </p>
  <p class="para">&quot;w&quot; オプションが設定されていて書き込みが失敗した場合に <a href="class.mongocursorexception.html" class="classname">MongoCursorException</a> をスローします。</p><p class="para">&quot;w&quot; オプションの値が 1 より大きく設定されていて、操作の完了までの時間が <var class="varname"><var class="varname">MongoCursor::$timeout</var></var> ミリ秒をこえた場合に <a href="class.mongocursortimeoutexception.html" class="classname">MongoCursorTimeoutException</a> をスローします。サーバー上での操作は止めません。これはクライアント側でのタイムアウトです。<em>MongoCollection::$wtimeout</em> はミリ秒です。</p>
 </div>


 <div class="refsect1 changelog" id="refsect1-mongocollection.insert-changelog">
  <h3 class="title">変更履歴</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>バージョン</th>
       <th>説明</th>
      </tr>

     </thead>

     <tbody class="tbody">

      <tr>
       <td>1.3.0</td>
       <td>
        <em><code class="parameter">options</code></em> パラメータで、boolean
        だけを渡して確認付きの書き込みを指定することができなくなりました。
        同じことをするには <em>array(&#039;w&#039; =&gt; 1)</em>
        (<a href="class.mongoclient.html" class="classname">MongoClient</a> のデフォルト) としなければなりません。
       </td>
      </tr>

      <tr>
       <td>1.2.0</td>
       <td><em>&quot;timeout&quot;</em> オプションが追加されました。</td>
      </tr>

      <tr>
       <td>1.0.11</td>
       <td>
        <em>&quot;safe&quot;</em> が設定されている場合は、&quot;not master&quot; エラーで接続を切断するようになりました。
       </td>
      </tr>

      <tr>
       <td>1.0.9</td>
       <td>
        <p class="para">
         <em>&quot;safe&quot;</em> オプションに整数値がわたせるようになりました (以前は boolean のみでした)。
        </p>
        <p class="para">
         <em>&quot;fsync&quot;</em> オプションが追加されました。
        </p>
        <p class="para">
         <em>&quot;safe&quot;</em> オプションを使っている場合の返り値の型が配列に変わりました。
         配列にはエラー情報が含まれています。<em>&quot;safe&quot;</em> オプションを使わない場合は、今までどおり
         boolean のままです。
        </p>
       </td>
      </tr>

      <tr>
       <td>1.0.5</td>
       <td>
        二番目のパラメータがオプションの配列に変わりました。1.0.5
        より前のバージョンでは、二番目のパラメータは <em>&quot;safe&quot;</em>
        オプションを表す boolean 値でした。
       </td>
      </tr>

      <tr>
       <td>1.0.1</td>
       <td>
        <em>&quot;safe&quot;</em> オプションが設定されていて追加に失敗した場合に
        <a href="class.mongocursorexception.html" class="classname">MongoCursorException</a> をスローするようになりました。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-mongocollection.insert-examples">
  <h3 class="title">例</h3>
  <div class="example" id="example-1459">
   <p><strong>例1  <span class="function"><strong>MongoCollection::insert()</strong></span> の <em>_id</em> の例</strong></p>
   <div class="example-contents"><p>
    すでに存在しない場合は、<em>_id</em> フィールドを追加します。
    パラメータの渡しかたによって、生成された
    <em>_id</em> に呼び出し元のコードからアクセスできるかどうかが変わります。
   </p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$m&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">MongoClient</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">$collection&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">$m</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">selectCollection</span><span style="color: #007700">(</span><span style="color: #DD0000">'test'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'phpmanual'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;配列リテラルを使った場合は、生成された&nbsp;_id&nbsp;にはアクセスできません<br /></span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(array(</span><span style="color: #DD0000">'x'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">));<br /><br /></span><span style="color: #FF8000">//&nbsp;値渡しした配列には&nbsp;_id&nbsp;が追加されています<br /></span><span style="color: #0000BB">$a&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">'x'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">2</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$a</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$a</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;参照渡しした配列からは&nbsp;_id&nbsp;は見えません<br /></span><span style="color: #0000BB">$b&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">'x'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">3</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$ref&nbsp;</span><span style="color: #007700">=&nbsp;&amp;</span><span style="color: #0000BB">$b</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$ref</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$ref</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;ラップする関数がコピーオンライトを引き起こさない場合は&nbsp;_id&nbsp;にアクセスできます<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">insert_no_cow</span><span style="color: #007700">(</span><span style="color: #0000BB">$collection</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$document</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$document</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #0000BB">$c&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">'x'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">4</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">insert_no_cow</span><span style="color: #007700">(</span><span style="color: #0000BB">$collection</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$c</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$c</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;ラップする関数がコピーオンライトを引き起こす場合は&nbsp;_id&nbsp;にアクセスできません<br /></span><span style="color: #007700">function&nbsp;</span><span style="color: #0000BB">insert_cow</span><span style="color: #007700">(</span><span style="color: #0000BB">$collection</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$document</span><span style="color: #007700">)<br />{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$document</span><span style="color: #007700">[</span><span style="color: #DD0000">'y'</span><span style="color: #007700">]&nbsp;=&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">;<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$document</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #0000BB">$d&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">'x'&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">5</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">insert_cow</span><span style="color: #007700">(</span><span style="color: #0000BB">$collection</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$d</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">var_dump</span><span style="color: #007700">(</span><span style="color: #0000BB">$d</span><span style="color: #007700">);<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>上の例の出力は、
たとえば以下のようになります。</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
array(2) {
  [&quot;x&quot;]=&gt;
  int(2)
  [&quot;_id&quot;]=&gt;
  object(MongoId)#4 (0) {
  }
}
array(1) {
  [&quot;x&quot;]=&gt;
  int(3)
}
array(2) {
  [&quot;x&quot;]=&gt;
  int(4)
  [&quot;_id&quot;]=&gt;
  object(MongoId)#5 (0) {
  }
}
array(1) {
  [&quot;x&quot;]=&gt;
  int(5)
}
</pre></div>
   </div>
  </div>

  <div class="example" id="example-1460">
   <p><strong>例2  <span class="function"><strong>MongoCollection::insert()</strong></span> での確認つき書き込みの例</strong></p>
   <div class="example-contents"><p>
    この例は、同じ _id を持つ二つの要素を追加しようとするものです。
    <em><code class="parameter">w</code></em> が設定されていれば、
    <a href="class.mongocursorexception.html" class="classname">MongoCursorException</a> がスローされます。
   </p></div>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /><br />$person&nbsp;</span><span style="color: #007700">=&nbsp;array(</span><span style="color: #DD0000">"name"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"Joe"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"age"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">20</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$person</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;$person&nbsp;には&nbsp;_id&nbsp;フィールドができたので、<br />//&nbsp;もう一度追加しようとすると例外が発生します<br /></span><span style="color: #007700">try&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$collection</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">insert</span><span style="color: #007700">(</span><span style="color: #0000BB">$person</span><span style="color: #007700">,&nbsp;array(</span><span style="color: #DD0000">"w"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #0000BB">1</span><span style="color: #007700">));<br />}&nbsp;catch(</span><span style="color: #0000BB">MongoCursorException&nbsp;$e</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Can't&nbsp;save&nbsp;the&nbsp;same&nbsp;person&nbsp;twice!\n"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
 </div>


 <div class="refsect1 seealso" id="refsect1-mongocollection.insert-seealso">
  <h3 class="title">参考</h3>
  <ul class="simplelist">
   <li class="member"> <span class="function"><a href="mongocollection.batchinsert.html" class="function" rel="rdfs-seeAlso">MongoCollection::batchInsert()</a> - 複数のドキュメントをコレクションに追加する</span></li>
   <li class="member"> <span class="function"><a href="mongocollection.update.html" class="function" rel="rdfs-seeAlso">MongoCollection::update()</a> - 指定した条件にもとづいてレコードを更新する</span></li>
   <li class="member"> <span class="function"><a href="mongocollection.find.html" class="function" rel="rdfs-seeAlso">MongoCollection::find()</a> - コレクションに問い合わせ、結果セットの MongoCursor を返す</span></li>
   <li class="member"> <span class="function"><a href="mongocollection.remove.html" class="function" rel="rdfs-seeAlso">MongoCollection::remove()</a> - レコードをコレクションから削除する</span></li>
   <li class="member">MongoDB コアドキュメントの <a href="http://docs.mongodb.org/manual/applications/create/#insert" class="link external" title="Link : http://docs.mongodb.org/manual/applications/create/#insert">&raquo;&nbsp;insert</a></li>
  </ul>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="111848""></a>
  <div class="note">
   <strong class="user">root at php dot net</strong>
   <a href="#111848" class="date">04-Apr-2013 08:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
_id and MongoId can be a source of problems that can make what would seem a trivial operation potentially complicated.<br />
<br />
MongoId is not as predictable or safe as mysql's auto increment (an example that most PHP developers will be familiar with). _id is generated by the client rather than the server and so does not guarantee that it will be collision free.<br />
<br />
By comparison, server side auto_increment mechanisms that PHP programmers might typically be used to wont collide until every single id had been used and with 64bits you can ensure this will almost never happen. You will also know when your table is getting full, and you can predict the rate. Most importantly, no matter the mechanism, being server side guarantees two clients wont collide. Mongo's behaviour is different to this.<br />
<br />
Generally speaking inserting without specifying _id will tend to work, but there are some cases where is can fail or is particularly prone to failure.<br />
<br />
The total size I believe is 96 bits. This might seem like a lot but the value is not created randomly. It is generated like this:<br />
<br />
$unixtime . $machine_id . $pid . $counter<br />
<br />
The counter starts from zero and is attached to each instance of MongoClient thus two MongoClient connections to the same server will almost certainly not work (produce a collision):<br />
<br />
$m=new MongoWrapper();<br />
$m-&gt;insert([0]);<br />
$m=new MongoWrapper();<br />
$m-&gt;insert([1]);<br />
<br />
If MongoWrapper is not using a singleton for the connection or something to the same effect, the second call will most likely have the same unixtime. It will certainly have the same machine_id, pid and counter. The insert will fail.<br />
<br />
If you are not using a singleton, this will work:<br />
<br />
$m=new MongoWrapper();<br />
$m-&gt;insert([0]);<br />
$m-&gt;insert([1]);<br />
<br />
You may also have difficulties in a multiple machine environment.<br />
<br />
machine_id is a hash of gethostname. This is not guaranteed to be unique across machines. Some people do not set hostnames at all. If you do not ensure that your machines all have unique hostnames then if in the same second, two machines run a script that inserts, the second will have a 1 in 2^15 chance of colliding (assuming the most common PID max). Depending on how the system handles pids, the probability may actually be a little less. In short, make sure any host accessing your mongodb has a hostname that is unique among any other host accessing your mongodb.<br />
<br />
I've seen some specs specify that counter should start from a random value but I highly recommend against this as it merely hides/obscures the problem.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="111172""></a>
  <div class="note">
   <strong class="user">gmail.com@mspreij</strong>
   <a href="#111172" class="date">23-Jan-2013 01:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
"Note: If the parameter does not have an _id key or property, a new MongoId instance will be created and assigned to it."<br />
<br />
Note on note: this is true even if the insert *fails* (because of, say, duplicate key error). So even if no new document was inserted, the supplied array will still have a new MongoID key -&gt;_id after the -&gt;insert().<br />
<br />
(which can make an attempted update after that fail, because you cannot update the _id value of a document..)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="110745""></a>
  <div class="note">
   <strong class="user">cuisdy at gmail dot com</strong>
   <a href="#110745" class="date">01-Dec-2012 02:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Another rarity to keep in mind. Passing references has the same effect as passing a referenced object. Even if there's no different for PHP between those two, it's probably not evident. So, this code would not have the _id field added to $a:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$b </span><span class="keyword">= &amp;</span><span class="default">$a</span><span class="keyword">;<br />
<br />
</span><span class="comment">/* ... more code here ... */<br />
<br />
</span><span class="default">$m </span><span class="keyword">= new </span><span class="default">MongoClient</span><span class="keyword">;<br />
</span><span class="default">$collection </span><span class="keyword">= </span><span class="default">$m</span><span class="keyword">-&gt;</span><span class="default">test</span><span class="keyword">-&gt;</span><span class="default">phpmanual</span><span class="keyword">;<br />
<br />
</span><span class="default">$a </span><span class="keyword">= array(</span><span class="string">'x' </span><span class="keyword">=&gt; </span><span class="default">12</span><span class="keyword">);<br />
<br />
</span><span class="default">$collection</span><span class="keyword">-&gt;</span><span class="default">insert</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">);<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$a</span><span class="keyword">);<br />
</span><span class="comment">// array(1) { ["x"]=&gt; int(12) }<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
I've made the assignment above to show how this situation could happen, if you reassigned a var, for example. But it could be some normal referencing after giving $a its final value (but before calling insert), and the consequence would be the same: if a var is referenced, it won't get the _id appended.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="109868""></a>
  <div class="note">
   <strong class="user">John S.</strong>
   <a href="#109868" class="date">29-Aug-2012 11:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note, that the _id field will only be added to an inserted array if it does not already exist in the supplied array:<br />
<br />
<span class="default">&lt;?php<br />
$data </span><span class="keyword">= array(</span><span class="string">'x' </span><span class="keyword">=&gt; </span><span class="default">12</span><span class="keyword">);<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">$collection</span><span class="keyword">-&gt;</span><span class="default">insert</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
Will output something like:<br />
<br />
array(1) {<br />
&nbsp; ["x"]=&gt;<br />
&nbsp; int(12)<br />
}<br />
array(2) {<br />
&nbsp; ["x"]=&gt;<br />
&nbsp; int(12)<br />
&nbsp; ["_id"]=&gt;<br />
&nbsp; object(MongoId)#196 (1) {<br />
&nbsp;&nbsp;&nbsp; ["$id"]=&gt;<br />
&nbsp;&nbsp;&nbsp; string(24) "503e21fc0605290912000000"<br />
&nbsp; }<br />
}<br />
<br />
however,<br />
<br />
$data = array('x' =&gt; 12, '_id' =&gt; NULL);<br />
var_dump($data);<br />
$collection-&gt;insert($data);<br />
var_dump($data);<br />
<br />
will not have the same result:<br />
<br />
array(2) {<br />
&nbsp; ["x"]=&gt;<br />
&nbsp; int(12)<br />
&nbsp; ["_id"]=&gt;<br />
&nbsp; NULL<br />
}<br />
array(2) {<br />
&nbsp; ["x"]=&gt;<br />
&nbsp; int(12)<br />
&nbsp; ["_id"]=&gt;<br />
&nbsp; NULL<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103220""></a>
  <div class="note">
   <strong class="user">Christer Edvartsen</strong>
   <a href="#103220" class="date">01-Apr-2011 05:54</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Also worth noting is that the MongoCollection::insert() method accepts objects as the first argument as well as arrays.<br />
<br />
<span class="default">&lt;?php<br />
$data </span><span class="keyword">= new </span><span class="default">stdClass</span><span class="keyword">;<br />
</span><span class="default">$data</span><span class="keyword">-&gt;</span><span class="default">foo </span><span class="keyword">= </span><span class="string">'foo'</span><span class="keyword">;<br />
</span><span class="default">$data</span><span class="keyword">-&gt;</span><span class="default">bar </span><span class="keyword">= </span><span class="string">'bar'</span><span class="keyword">;<br />
</span><span class="default">$collection</span><span class="keyword">-&gt;</span><span class="default">insert</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">-&gt;</span><span class="default">_id</span><span class="keyword">); </span><span class="comment">// An instance of MongoId<br />
</span><span class="default">?&gt;<br />
</span><br />
You can use other classes as well, but MongoCollection::insert() will fail if the object contains any protected or private properties. Public properties listed in the class will also be inserted:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">SomeClass </span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$foo </span><span class="keyword">= </span><span class="string">'bar'</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$bar </span><span class="keyword">= </span><span class="string">'foo'</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">$data </span><span class="keyword">= new </span><span class="default">SomeClass</span><span class="keyword">;<br />
</span><span class="default">$data</span><span class="keyword">-&gt;</span><span class="default">foobar </span><span class="keyword">= </span><span class="default">42</span><span class="keyword">;<br />
</span><span class="default">$collection</span><span class="keyword">-&gt;</span><span class="default">insert</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">var_dump</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">-&gt;</span><span class="default">_id</span><span class="keyword">); </span><span class="comment">// An instance of MongoId<br />
</span><span class="default">?&gt;<br />
</span><br />
will result in a document with four elements:<br />
<br />
_id =&gt; some mongoid<br />
foo =&gt; 'bar'<br />
bar =&gt; 'foo'<br />
foobar =&gt; 42</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mongocollection.group.html">MongoCollection::group</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mongocollection.remove.html">MongoCollection::remove</a></div>
 <div class="up"><a href="class.mongocollection.html">MongoCollection</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
