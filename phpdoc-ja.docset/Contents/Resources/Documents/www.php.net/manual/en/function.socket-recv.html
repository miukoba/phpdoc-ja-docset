<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>接続したソケットからデータを受信する</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.socket-read.html">socket_read</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.socket-recvfrom.html">socket_recvfrom</a></div>
 <div class="up"><a href="ref.sockets.html">ソケット 関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.socket-recv" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">socket_recv</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.1.0, PHP 5)</p><p class="refpurpose"><span class="refname">socket_recv</span> &mdash; <span class="dc-title">接続したソケットからデータを受信する</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.socket-recv-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">int</span> <span class="methodname"><strong>socket_recv</strong></span>
    ( <span class="methodparam"><span class="type">resource</span> <code class="parameter">$socket</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter reference">&$buf</code></span>
   , <span class="methodparam"><span class="type">int</span> <code class="parameter">$len</code></span>
   , <span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code></span>
   )</div>

  <p class="para rdfs-comment">
    <span class="function"><strong>socket_recv()</strong></span> 関数は、
   <em><code class="parameter">socket</code></em> から
   <em><code class="parameter">len</code></em> バイトのデータを受信して
   <em><code class="parameter">buf</code></em> に格納します。
    <span class="function"><strong>socket_recv()</strong></span> を使うと、
   接続したソケットからデータを収集することができます。
   さらに、フラグを指定して関数の挙動を変更することもできます。
  </p>
  <p class="para">
   <em><code class="parameter">buf</code></em> は参照渡しなので、
   引数リストには変数で渡さなければなりません。
   <em><code class="parameter">socket</code></em> から  <span class="function"><strong>socket_recv()</strong></span>
   で読み込んだデータが <em><code class="parameter">buf</code></em> に入ります。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.socket-recv-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term"><em><code class="parameter">socket</code></em></span>
     <dd>

      <p class="para">
       <em><code class="parameter">socket</code></em> は、事前に
       socket_create() で作成したソケットリソースでなければなりません。
      </p>
     </dd>

    </dt>


    <dt>

     <span class="term"><em><code class="parameter">buf</code></em></span>
     <dd>

      <p class="para">
       受信したデータが、
       <em><code class="parameter">buf</code></em> で指定した変数に格納されます。
       エラーが発生したり接続がリセットされたりデータが存在しなかったりした場合は、
       <em><code class="parameter">buf</code></em> には <strong><code>NULL</code></strong> が設定されます。
      </p>
     </dd>

    </dt>


    <dt>

     <span class="term"><em><code class="parameter">len</code></em></span>
     <dd>

      <p class="para">
       最大 <em><code class="parameter">len</code></em> バイトまでをリモートホストから取得します。
      </p>
     </dd>

    </dt>


    <dt>

     <span class="term"><em><code class="parameter">flags</code></em></span>
     <dd>

      <p class="para">
       <em><code class="parameter">flags</code></em> の値は、次のフラグを論理 OR
       (<em>|</em>) 演算子で組み合わせたものとなります。
      </p>
      
      <table class="doctable table">
       <caption><strong><em><code class="parameter">flags</code></em> のとりうる値</strong></caption>
       
        <thead>
         <tr>
          <th>フラグ</th>
          <th>説明</th>
         </tr>

        </thead>

        <tbody class="tbody">
         <tr>
          <td><strong><code>MSG_OOB</code></strong></td>
          <td>
           out-of-band を処理します。
          </td>
         </tr>

         <tr>
          <td><strong><code>MSG_PEEK</code></strong></td>
          <td>
           受信キューの先頭からデータを取得し、受信したデータをキューから削除しません。
          </td>
         </tr>

         <tr>
          <td><strong><code>MSG_WAITALL</code></strong></td>
          <td>
           最低 <em><code class="parameter">len</code></em> バイト受信するまでブロックします。
           しかし、シグナルを受け取ったりリモートホストが接続を切断したりした場合は、
           この関数が返すデータがそれより少なくなる可能性があります。
          </td>
         </tr>

         <tr>
          <td><strong><code>MSG_DONTWAIT</code></strong></td>
          <td>
           このフラグを設定すると、正常にブロックされている状態でも関数が結果を返します。
          </td>
         </tr>

        </tbody>
       
      </table>

     </dd>

    </dt>
    
   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.socket-recv-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
    <span class="function"><strong>socket_recv()</strong></span> は、受信したバイト数を返します。
   エラーが発生した場合は <strong><code>FALSE</code></strong> を返します。
   実際のエラーコードを取得するには
    <span class="function"><a href="function.socket-last-error.html" class="function">socket_last_error()</a></span> をコールします。
   このエラーコードを  <span class="function"><a href="function.socket-strerror.html" class="function">socket_strerror()</a></span>
   に渡すと、エラーに関する説明テキストを取得することができます。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.socket-recv-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-4574">
    <p><strong>例1  <span class="function"><strong>socket_recv()</strong></span> の例</strong></p>
    <div class="example-contents"><p>
     この例は、
     <a href="sockets.examples.html" class="xref">例</a> の最初の例を書き換えて
      <span class="function"><strong>socket_recv()</strong></span> を使う形式にしたものです。
    </p></div>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />error_reporting</span><span style="color: #007700">(</span><span style="color: #0000BB">E_ALL</span><span style="color: #007700">);<br /><br />echo&nbsp;</span><span style="color: #DD0000">"&lt;h2&gt;TCP/IP&nbsp;Connection&lt;/h2&gt;\n"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/*&nbsp;WWW&nbsp;サービスのポートを取得します&nbsp;*/<br /></span><span style="color: #0000BB">$service_port&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">getservbyname</span><span style="color: #007700">(</span><span style="color: #DD0000">'www'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'tcp'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;対象となるホストの&nbsp;IP&nbsp;アドレスを取得します&nbsp;*/<br /></span><span style="color: #0000BB">$address&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">gethostbyname</span><span style="color: #007700">(</span><span style="color: #DD0000">'www.example.com'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;TCP/IP&nbsp;ソケットを作成します&nbsp;*/<br /></span><span style="color: #0000BB">$socket&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">socket_create</span><span style="color: #007700">(</span><span style="color: #0000BB">AF_INET</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">SOCK_STREAM</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">SOL_TCP</span><span style="color: #007700">);<br />if&nbsp;(</span><span style="color: #0000BB">$socket&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"socket_create()&nbsp;failed:&nbsp;reason:&nbsp;"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">())&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"OK.\n"</span><span style="color: #007700">;<br />}<br /><br />echo&nbsp;</span><span style="color: #DD0000">"Attempting&nbsp;to&nbsp;connect&nbsp;to&nbsp;'</span><span style="color: #0000BB">$address</span><span style="color: #DD0000">'&nbsp;on&nbsp;port&nbsp;'</span><span style="color: #0000BB">$service_port</span><span style="color: #DD0000">'..."</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">socket_connect</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$address</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$service_port</span><span style="color: #007700">);<br />if&nbsp;(</span><span style="color: #0000BB">$result&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"socket_connect()&nbsp;failed.\nReason:&nbsp;(</span><span style="color: #0000BB">$result</span><span style="color: #DD0000">)&nbsp;"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">))&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"OK.\n"</span><span style="color: #007700">;<br />}<br /><br /></span><span style="color: #0000BB">$in&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"HEAD&nbsp;/&nbsp;HTTP/1.1\r\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$in&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #DD0000">"Host:&nbsp;www.example.com\r\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$in&nbsp;</span><span style="color: #007700">.=&nbsp;</span><span style="color: #DD0000">"Connection:&nbsp;Close\r\n\r\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$out&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">''</span><span style="color: #007700">;<br /><br />echo&nbsp;</span><span style="color: #DD0000">"Sending&nbsp;HTTP&nbsp;HEAD&nbsp;request..."</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">socket_write</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$in</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">strlen</span><span style="color: #007700">(</span><span style="color: #0000BB">$in</span><span style="color: #007700">));<br />echo&nbsp;</span><span style="color: #DD0000">"OK.\n"</span><span style="color: #007700">;<br /><br />echo&nbsp;</span><span style="color: #DD0000">"Reading&nbsp;response:\n\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">$buf&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">'This&nbsp;is&nbsp;my&nbsp;buffer.'</span><span style="color: #007700">;<br />if&nbsp;(</span><span style="color: #0000BB">false&nbsp;</span><span style="color: #007700">!==&nbsp;(</span><span style="color: #0000BB">$bytes&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">socket_recv</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$buf</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">2048</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">MSG_WAITALL</span><span style="color: #007700">)))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"Read&nbsp;</span><span style="color: #0000BB">$bytes</span><span style="color: #DD0000">&nbsp;bytes&nbsp;from&nbsp;socket_recv().&nbsp;Closing&nbsp;socket..."</span><span style="color: #007700">;<br />}&nbsp;else&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;</span><span style="color: #DD0000">"socket_recv()&nbsp;failed;&nbsp;reason:&nbsp;"&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #0000BB">socket_strerror</span><span style="color: #007700">(</span><span style="color: #0000BB">socket_last_error</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">))&nbsp;.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />}<br /></span><span style="color: #0000BB">socket_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$socket</span><span style="color: #007700">);<br /><br />echo&nbsp;</span><span style="color: #0000BB">$buf&nbsp;</span><span style="color: #007700">.&nbsp;</span><span style="color: #DD0000">"\n"</span><span style="color: #007700">;<br />echo&nbsp;</span><span style="color: #DD0000">"OK.\n\n"</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

    <div class="example-contents"><p>
     上の例の出力は、このようになります。
    </p></div>
    <div class="example-contents screen">
<div class="cdata"><pre>
&lt;h2&gt;TCP/IP Connection&lt;/h2&gt;
OK.
Attempting to connect to &#039;208.77.188.166&#039; on port &#039;80&#039;...OK.
Sending HTTP HEAD request...OK.
Reading response:

Read 123 bytes from socket_recv(). Closing socket...HTTP/1.1 200 OK
Date: Mon, 14 Sep 2009 08:56:36 GMT
Server: Apache/2.2.3 (Red Hat)
Last-Modified: Tue, 15 Nov 2005 13:24:10 GMT
ETag: &quot;b80f4-1b6-80bfd280&quot;
Accept-Ranges: bytes
Content-Length: 438
Connection: close
Content-Type: text/html; charset=UTF-8

OK.
</pre></div>
    </div>
   </div>
  </p>
 </div>

                     
</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="112728""></a>
  <div class="note">
   <strong class="user">ss-130 at yandex dot ru</strong>
   <a href="#112728" class="date">17-Jul-2013 08:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
$er </span><span class="keyword">= </span><span class="default">error_reporting</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
</span><span class="default">$bytes&nbsp; &nbsp; </span><span class="keyword">= </span><span class="default">socket_recv</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">,</span><span class="default">$buffer</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">,</span><span class="default">MSG_WAITALL</span><span class="keyword">);<br />
</span><span class="default">error_reporting</span><span class="keyword">(</span><span class="default">$er</span><span class="keyword">);<br />
<br />
</span><span class="comment">// MEGA BUG HERE<br />
// this statuses are wrong and swapped, closed socket must be with "FALSE"<br />
// but in fact he swap the values:<br />
// <a href="http://php.net/manual/en/function.socket-recv.php" rel="nofollow" target="_blank">http://php.net/manual/en/function.socket-recv.php</a><br />
// <br />
</span><span class="keyword">if(</span><span class="default">$bytes</span><span class="keyword">===</span><span class="default">false</span><span class="keyword">){ </span><span class="comment">// no data available, socket not closed<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">'WS_READ_ERR1: '</span><span class="keyword">.</span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">)).</span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// print when no data available:<br />
&nbsp;&nbsp;&nbsp; // WS_READ_ERR1: Resource temporarily unavailable<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">continue;<br />
}else if(</span><span class="default">$bytes</span><span class="keyword">===</span><span class="default">0</span><span class="keyword">){ </span><span class="comment">// socket closed<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">'WS_READ_ERR2: '</span><span class="keyword">.</span><span class="default">socket_strerror</span><span class="keyword">(</span><span class="default">socket_last_error</span><span class="keyword">(</span><span class="default">$socket</span><span class="keyword">)).</span><span class="default">PHP_EOL</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// print when socket closed:<br />
&nbsp;&nbsp;&nbsp; // WS_READ_ERR2: Success<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$process</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">();<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107740""></a>
  <div class="note">
   <strong class="user">davide dot renzi at gmail dot com</strong>
   <a href="#107740" class="date">01-Mar-2012 05:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In PHP version 5.* there is a bug: MSG_DONTWAIT flag is not defined (see https://bugs.php.net/bug.php?id=48326)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="56161""></a>
  <div class="note">
   <strong class="user">rathamahata at rathamahata dot net</strong>
   <a href="#56161" class="date">25-Aug-2005 01:44</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It looks like that mysterious flags are just the recv(2) flags passed to your OS syscall and nothing more...<br />
<br />
ext/sockets/sockets.c:PHP_FUNCTION(socket_recv)<br />
...<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ((retval = recv(php_sock-&gt;bsd_socket, recv_buf, len, flags)) &lt; 1) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; efree(recv_buf);<br />
...<br />
<br />
for linux you can type `man 2 recv' and you will see complete description of thouse flags.<br />
<br />
Sergey S. Kosrtyliov &lt;rathamahata@rathamahata.net&gt;<br />
<a href="http://www.rathamahata.net/" rel="nofollow" target="_blank">http://www.rathamahata.net/</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52582""></a>
  <div class="note">
   
   <a href="#52582" class="date">06-May-2005 01:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
My last post was incorrect. The int flag set to 2 apparently reset the file position pointer so what I was reading was the first record repeatedly. <br />
<br />
My workaroud ended up being the following:<br />
<br />
for($ct=1; $ct&lt;=$numrecs; $ct++) {<br />
&nbsp;&nbsp;&nbsp; $rec = "";<br />
&nbsp;&nbsp;&nbsp; $nr=socket_recv($fp,$rec,76,0);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; //grab the extra bytes.<br />
&nbsp;&nbsp;&nbsp; $terminator = "";<br />
&nbsp;&nbsp;&nbsp; while ($terminator != ".") {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $nr=socket_recv($fp,$terminator,1,0);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; $custarray[]=substr($rec,0,76);&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
}<br />
<br />
Martin K.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="52552""></a>
  <div class="note">
   
   <a href="#52552" class="date">05-May-2005 04:42</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I'm glad that Bastion left the above post about the mysterious int flag. He just helped to fix a problem that I've spent six hours on. Here's my code:<br />
<br />
for($ct=1; $ct&lt;=$numrecs; $ct++) {<br />
&nbsp;&nbsp; &nbsp; $rec = "";<br />
&nbsp;&nbsp; &nbsp; $nr=socket_recv($fp,$rec,77,0);<br />
&nbsp;&nbsp; &nbsp; print "Rec # $ct --&gt;";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; print "$rec";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; print "&lt;br&gt;";<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
<br />
The code is pretty simple, it just loops through all my records and prints them out. All records are 77 bytes and all end with a period. The first 36 records print perfectly then at 37 things go bad. The records start to get offset. The last few characters of the 37th record end up printing on the 38th record. The data on the sending side was perfect, so I knew that the problem was with socked_recv.<br />
<br />
After reading the above post I tried changing the int flag. Changing the flag to 2 worked:<br />
$nr=socket_recv($fp,$rec,77,2);<br />
<br />
Now everything lines up perfectly. I had always left int flag as 0 since it's undocumented. <br />
<br />
Martin K.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="47789""></a>
  <div class="note">
   <strong class="user">engine at [NO SPAM] illusiononly dot com</strong>
   <a href="#47789" class="date">30-Nov-2004 01:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To read from socket both on linux and windows OS having&nbsp; flash as a client I use function bellow. $length is the size of&nbsp; a chunk, not the max length to read. It will continue reading until EOL char&nbsp; occures or client disconnects (or in case of error), so it works for bigger packets as well.<br />
<br />
&nbsp;&nbsp; &nbsp; function read($descriptor, $length = 1024) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $this-&gt;method = "read";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(!$client){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo("No valid socket descriptor !\n");<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return false;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $read ='';<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while(($flag=socket_recv($descriptor, $buf, $length,0))&gt;0){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $asc=ord(substr($buf, -1));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if ($asc==0) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $read.=substr($buf,0,-1);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $read.=$buf;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($flag&lt;0){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //error<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return false;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }elseif ($flag==0){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //Client disconnected<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return&nbsp; false;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return $read;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; }</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="47182""></a>
  <div class="note">
   <strong class="user">dgk at tcde dot ru</strong>
   <a href="#47182" class="date">05-Nov-2004 12:57</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I've used socket_select and socket_recv with a while loop and found myself in trouble when remote side closed connection. The code below produced infinite loop and socket_select returned immediately (which lead to high cpu time consumption).<br />
<br />
&lt;?<br />
<br />
socket_set_nonblock($my_socket);<br />
$streams = array($my_socket/*, ... */);<br />
<br />
$lastAccess = time();<br />
while (socket_select($streams, $write = NULL, $except = NULL, SLEEP_TIME_SECONDS, SLEEP_TIME_MILLISECONDS) !== FALSE) {<br />
&nbsp;&nbsp;&nbsp; if (in_array($my_socket, $streams)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (@socket_recv($my_socket, $data, 8192, 0)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo $data;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $lastAccess = time();<br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (time()-$lastAccess &gt; LAST_ACCESS_TIMEOUT) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; // ...<br />
&nbsp;&nbsp;&nbsp; $streams = array($my_socket/*, ... */);<br />
}<br />
<br />
?&gt;<br />
<br />
The solution was simple, but quite hard to find because socket_recv is not documented. socket_recv returns FALSE if there is no data and 0 if the socket is widowed (disconnected by remote side). So I had just to check return value of socket_recv. The problem now sounds stupid, but I've spend some time to find it out.<br />
I hope this will save some of somebody's hair ;)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="41278""></a>
  <div class="note">
   <strong class="user">bastiaan at [no-spam] megabass dot nl</strong>
   <a href="#41278" class="date">05-Apr-2004 06:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
in case you want to empty/unset $buffer, but failing to do so, try using 0 as flag.<br />
PHP_NORMAL_READ and PHP_BINARY_READ respectively hold 1 and 2 as value.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.socket-read.html">socket_read</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.socket-recvfrom.html">socket_recvfrom</a></div>
 <div class="up"><a href="ref.sockets.html">ソケット 関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
