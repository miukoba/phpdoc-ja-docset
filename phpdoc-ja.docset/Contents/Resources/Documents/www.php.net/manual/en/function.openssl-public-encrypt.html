<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>公開鍵でデータを暗号化する</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.openssl-public-decrypt.html">openssl_public_decrypt</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.openssl-random-pseudo-bytes.html">openssl_random_pseudo_bytes</a></div>
 <div class="up"><a href="ref.openssl.html">OpenSSL 関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.openssl-public-encrypt" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">openssl_public_encrypt</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.0.6, PHP 5)</p><p class="refpurpose"><span class="refname">openssl_public_encrypt</span> &mdash; <span class="dc-title">公開鍵でデータを暗号化する</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.openssl-public-encrypt-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>openssl_public_encrypt</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$data</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter reference">&$crypted</code></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <code class="parameter">$key</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$padding</code><span class="initializer"> = OPENSSL_PKCS1_PADDING</span></span>
  ] )</div>

  <p class="para rdfs-comment">
    <span class="function"><strong>openssl_public_encrypt()</strong></span> は、<em><code class="parameter">data</code></em>
   を公開鍵 <em><code class="parameter">key</code></em> で暗号化し、それを
   <em><code class="parameter">crypted</code></em> に格納します。暗号化されたデータは
    <span class="function"><a href="function.openssl-private-decrypt.html" class="function">openssl_private_decrypt()</a></span> を用いて復号可能です。
  </p>
  <p class="para">
   この関数を使用するのは、例えば秘密鍵の所有者にのみ読めるようにメッセージを暗号化する場合です。
   また、データベースに格納するデータを安全な形式にするためにも使用されます。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.openssl-public-encrypt-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term"><em><code class="parameter">data</code></em></span>
     <dd>

      <p class="para">
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">crypted</code></em></span>
     <dd>

      <p class="para">
       暗号化した結果がここに格納されます。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">key</code></em></span>
     <dd>

      <p class="para">
       公開鍵。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">padding</code></em></span>
     <dd>

      <p class="para">
       <em><code class="parameter">padding</code></em> には
       <strong><code>OPENSSL_PKCS1_PADDING</code></strong>、
       <strong><code>OPENSSL_SSLV23_PADDING</code></strong>、
       <strong><code>OPENSSL_PKCS1_OAEP_PADDING</code></strong>、
       <strong><code>OPENSSL_NO_PADDING</code></strong> が指定可能です。
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.openssl-public-encrypt-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   成功した場合に <strong><code>TRUE</code></strong> を、失敗した場合に <strong><code>FALSE</code></strong> を返します。
  </p>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.openssl-public-encrypt-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"> <span class="function"><a href="function.openssl-private-encrypt.html" class="function" rel="rdfs-seeAlso">openssl_private_encrypt()</a> - 秘密鍵でデータを暗号化する</span></li>
    <li class="member"> <span class="function"><a href="function.openssl-private-decrypt.html" class="function" rel="rdfs-seeAlso">openssl_private_decrypt()</a> - 秘密鍵でデータを復号する</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="104567""></a>
  <div class="note">
   <strong class="user">sumadhuracool at gmail dot com</strong>
   <a href="#104567" class="date">23-Jun-2011 01:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
length of the data &lt; length of the private key ..so i divided the message while taking it,put a ":::".then again encrpt it. look at the pgm to get an idea about this..<br />
<br />
<span class="default">&lt;?php<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">class </span><span class="default">cry<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment"># generate a 1024 bit rsa private key, ask for a passphrase to encrypt it and save to file<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //openssl genrsa -des3 -out /path/to/privatekey 1024<br />
&nbsp;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; # generate the public key for the private key and save to file<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //openssl rsa -in /path/to/privatekey -pubout -out /path/to/publickey<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //programatically using php-openssll<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //This will call while registration<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">gen_cert</span><span class="keyword">(</span><span class="default">$userid</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dn </span><span class="keyword">= array(</span><span class="string">"countryName" </span><span class="keyword">=&gt; </span><span class="string">'XX'</span><span class="keyword">, </span><span class="string">"stateOrProvinceName" </span><span class="keyword">=&gt; </span><span class="string">'State'</span><span class="keyword">, </span><span class="string">"localityName" </span><span class="keyword">=&gt; </span><span class="string">'SomewhereCity'</span><span class="keyword">, </span><span class="string">"organizationName" </span><span class="keyword">=&gt;</span><span class="string">'MySelf'</span><span class="keyword">, </span><span class="string">"organizationalUnitName" </span><span class="keyword">=&gt; </span><span class="string">'Whatever'</span><span class="keyword">, </span><span class="string">"commonName" </span><span class="keyword">=&gt; </span><span class="string">'mySelf'</span><span class="keyword">, </span><span class="string">"emailAddress" </span><span class="keyword">=&gt; </span><span class="string">'user@example.com'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Passphrase can be taken during registration <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //Here its initialized to 1234 for sample&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$privkeypass </span><span class="keyword">= </span><span class="string">'root'</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$numberofdays </span><span class="keyword">= </span><span class="default">365</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//RSA encryption and 1024 bits length<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$privkey </span><span class="keyword">= </span><span class="default">openssl_pkey_new</span><span class="keyword">(array(</span><span class="string">'private_key_bits' </span><span class="keyword">=&gt; </span><span class="default">1024</span><span class="keyword">,</span><span class="string">'private_key_type' </span><span class="keyword">=&gt; </span><span class="default">OPENSSL_KEYTYPE_RSA</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$csr </span><span class="keyword">= </span><span class="default">openssl_csr_new</span><span class="keyword">(</span><span class="default">$dn</span><span class="keyword">, </span><span class="default">$privkey</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$sscert </span><span class="keyword">= </span><span class="default">openssl_csr_sign</span><span class="keyword">(</span><span class="default">$csr</span><span class="keyword">, </span><span class="default">null</span><span class="keyword">, </span><span class="default">$privkey</span><span class="keyword">, </span><span class="default">$numberofdays</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_x509_export</span><span class="keyword">(</span><span class="default">$sscert</span><span class="keyword">, </span><span class="default">$publickey</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_pkey_export</span><span class="keyword">(</span><span class="default">$privkey</span><span class="keyword">, </span><span class="default">$privatekey</span><span class="keyword">, </span><span class="default">$privkeypass</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_csr_export</span><span class="keyword">(</span><span class="default">$csr</span><span class="keyword">, </span><span class="default">$csrStr</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Generated keys are stored into files<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"../PKI/private/</span><span class="default">$userid</span><span class="string">.key"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">$privatekey</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">); <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"../PKI/public/</span><span class="default">$userid</span><span class="string">.crt"</span><span class="keyword">,</span><span class="string">"w"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">$publickey</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);&nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Encryption with public key<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">encrypt</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">,</span><span class="default">$rc</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//path holds the certificate path present in the system&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$path</span><span class="keyword">=</span><span class="string">"../PKI/public/server.crt"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pub_key</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">8192</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_get_publickey</span><span class="keyword">(</span><span class="default">$pub_key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//$source='';<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; //$source="sumanth ahoiadodakjaksdsa;ldadkkllksdalkalsdl;asld;ls sumanthasddddddddddddddddddddddddddddddddfsdfsffdfsdfsumanth";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$j</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$x</span><span class="keyword">=</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">)/</span><span class="default">10</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$y</span><span class="keyword">=</span><span class="default">floor</span><span class="keyword">(</span><span class="default">$x</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">$y</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$crypttext</span><span class="keyword">=</span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_public_encrypt</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">,</span><span class="default">$j</span><span class="keyword">,</span><span class="default">10</span><span class="keyword">),</span><span class="default">$crypttext</span><span class="keyword">,</span><span class="default">$pub_key</span><span class="keyword">);</span><span class="default">$j</span><span class="keyword">=</span><span class="default">$j</span><span class="keyword">+</span><span class="default">10</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$crt</span><span class="keyword">.=</span><span class="default">$crypttext</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$crt</span><span class="keyword">.=</span><span class="string">":::"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if((</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">)%</span><span class="default">10</span><span class="keyword">)&gt;</span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_public_encrypt</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">,</span><span class="default">$j</span><span class="keyword">),</span><span class="default">$crypttext</span><span class="keyword">,</span><span class="default">$pub_key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$crt</span><span class="keyword">.=</span><span class="default">$crypttext</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }&nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return(</span><span class="default">$crt</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">//Decryption with private key<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">decrypt</span><span class="keyword">(</span><span class="default">$crypttext</span><span class="keyword">,</span><span class="default">$userid</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$passphrase</span><span class="keyword">=</span><span class="string">"root"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$path</span><span class="keyword">=</span><span class="string">"../PKI/private/server.key"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fpp1</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$priv_key</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fpp1</span><span class="keyword">,</span><span class="default">8192</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fpp1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$res1</span><span class="keyword">= </span><span class="default">openssl_get_privatekey</span><span class="keyword">(</span><span class="default">$priv_key</span><span class="keyword">,</span><span class="default">$passphrase</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tt</span><span class="keyword">=</span><span class="default">explode</span><span class="keyword">(</span><span class="string">":::"</span><span class="keyword">,</span><span class="default">$crypttext</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$cnt</span><span class="keyword">=</span><span class="default">count</span><span class="keyword">(</span><span class="default">$tt</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">$cnt</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_private_decrypt</span><span class="keyword">(</span><span class="default">$tt</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">],</span><span class="default">$str1</span><span class="keyword">,</span><span class="default">$res1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$str</span><span class="keyword">.=</span><span class="default">$str1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$str</span><span class="keyword">;&nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">sign</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">,</span><span class="default">$rc</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$has</span><span class="keyword">=</span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$source</span><span class="keyword">.=</span><span class="string">"::"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$source</span><span class="keyword">.=</span><span class="default">$has</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$path</span><span class="keyword">=</span><span class="string">"../PKI/public/</span><span class="default">$rc</span><span class="string">.crt"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$pub_key</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">8192</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_get_publickey</span><span class="keyword">(</span><span class="default">$pub_key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_public_encrypt</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">,</span><span class="default">$mese</span><span class="keyword">,</span><span class="default">$pub_key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$mese</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; function </span><span class="default">verify</span><span class="keyword">(</span><span class="default">$crypttext</span><span class="keyword">,</span><span class="default">$userid</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$passphrase</span><span class="keyword">=</span><span class="string">"root"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$path</span><span class="keyword">=</span><span class="string">"../PKI/private/</span><span class="default">$userid</span><span class="string">.key"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fpp1</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="default">$path</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$priv_key</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fpp1</span><span class="keyword">,</span><span class="default">8192</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fpp1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$res1</span><span class="keyword">= </span><span class="default">openssl_get_privatekey</span><span class="keyword">(</span><span class="default">$priv_key</span><span class="keyword">,</span><span class="default">$passphrase</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">openssl_private_decrypt</span><span class="keyword">(</span><span class="default">$crypttext</span><span class="keyword">,</span><span class="default">$has1</span><span class="keyword">,</span><span class="default">$res1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; list(</span><span class="default">$c1</span><span class="keyword">,</span><span class="default">$c2</span><span class="keyword">)=</span><span class="default">split</span><span class="keyword">(</span><span class="string">"::"</span><span class="keyword">,</span><span class="default">$has1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$has</span><span class="keyword">=</span><span class="default">sha1</span><span class="keyword">(</span><span class="default">$c1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$has</span><span class="keyword">==</span><span class="default">$c2</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$message</span><span class="keyword">=</span><span class="default">$c1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$message</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="104420""></a>
  <div class="note">
   <strong class="user">ppostma1</strong>
   <a href="#104420" class="date">14-Jun-2011 09:09</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The confusion most have seems to be on "mixed $key"<br />
<br />
The $key is explained in, and mostly the same as the parameter of <a href="http://www.php.net/manual/en/function.openssl-pkey-get-public.php" rel="nofollow" target="_blank">http://www.php.net/manual/en/function.openssl-pkey-get-public.php</a><br />
<br />
It can take the resource $key returned from openssl_pkey_get_public() OR find the value is text and passes the text to openssl_pkey_get_public() to get a valid resource.<br />
<br />
To better break down rstinnett's example:<br />
(and where the flaw is)<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">EncryptData</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">)<br />
{<br />
&nbsp; </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/etc/httpd/conf/ssl.crt/server.crt"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$pub_key_string</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">8192</span><span class="keyword">);<br />
&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp; </span><span class="default">openssl_get_publickey</span><span class="keyword">(</span><span class="default">$pub_key</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="default">openssl_public_encrypt</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">,</span><span class="default">$crypttext</span><span class="keyword">,</span><span class="default">$pub_key_string</span><span class="keyword">);<br />
&nbsp; </span><span class="comment">/*this simply passes the string contents of pub_key_string back to be decoded*/<br />
&nbsp; </span><span class="keyword">return(</span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$crypttext</span><span class="keyword">));<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
is more efficient:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">EncryptData</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">)<br />
{<br />
&nbsp; </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/etc/httpd/conf/ssl.crt/server.crt"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$pub_key_string</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">8192</span><span class="keyword">);<br />
&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$key_resource </span><span class="keyword">= </span><span class="default">openssl_get_publickey</span><span class="keyword">(</span><span class="default">$pub_key</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="default">openssl_public_encrypt</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">,</span><span class="default">$crypttext</span><span class="keyword">, </span><span class="default">$key_resource </span><span class="keyword">);<br />
&nbsp; </span><span class="comment">/*uses the already existing key resource*/<br />
&nbsp; </span><span class="keyword">return(</span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$crypttext</span><span class="keyword">));<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
shorter:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">EncryptData</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">)<br />
{<br />
&nbsp; </span><span class="default">$fp</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/etc/httpd/conf/ssl.crt/server.crt"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$pub_key</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">8192</span><span class="keyword">);<br />
&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="default">openssl_public_encrypt</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">,</span><span class="default">$crypttext</span><span class="keyword">, </span><span class="default">$pub_key </span><span class="keyword">);<br />
<br />
&nbsp; return(</span><span class="default">base64_encode</span><span class="keyword">(</span><span class="default">$crypttext</span><span class="keyword">));<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="98927""></a>
  <div class="note">
   <strong class="user">Mark Seecof</strong>
   <a href="#98927" class="date">16-Jul-2010 09:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you need a message key, obtain it from the openssl_random_pseudo_bytes() function.<br />
<br />
DO NOT just hash the current time-- an attacker will guess any such key very easily (he'll just hash a bunch of likely time values and try them until he finds the right one.&nbsp; The attacker can generate and test many millions of candidate hashes every minute using an ordinary PC).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="95307""></a>
  <div class="note">
   <strong class="user">public at grik dot net</strong>
   <a href="#95307" class="date">25-Dec-2009 07:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
openssl_private_encrypt() has a low limit for the length of the data it can encrypt due to the nature of the algorithm.<br />
<br />
To encrypt the larger data you can use openssl_encrypt() with a random password (like sha1(microtime(true))), and encrypt the password with openssl_public_encrypt().<br />
This way the data can be encrypted with a public key and decrypted with the private one.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="56449""></a>
  <div class="note">
   <strong class="user">adrian</strong>
   <a href="#56449" class="date">02-Sep-2005 11:53</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
T. Horsten explained the size limits on raw encryption. Here are two functions to encrypt/decrypt larger data when you can't use the envelope functions:<br />
<br />
function ssl_encrypt($source,$type,$key){<br />
//Assumes 1024 bit key and encrypts in chunks.<br />
<br />
$maxlength=117;<br />
$output='';<br />
while($source){<br />
&nbsp; $input= substr($source,0,$maxlength);<br />
&nbsp; $source=substr($source,$maxlength);<br />
&nbsp; if($type=='private'){<br />
&nbsp;&nbsp;&nbsp; $ok= openssl_private_encrypt($input,$encrypted,$key);<br />
&nbsp; }else{<br />
&nbsp;&nbsp;&nbsp; $ok= openssl_public_encrypt($input,$encrypted,$key);<br />
&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp; $output.=$encrypted;<br />
}<br />
return $output;<br />
}<br />
<br />
function ssl_decrypt($source,$type,$key){<br />
// The raw PHP decryption functions appear to work<br />
// on 128 Byte chunks. So this decrypts long text<br />
// encrypted with ssl_encrypt().<br />
<br />
$maxlength=128;<br />
$output='';<br />
while($source){<br />
&nbsp; $input= substr($source,0,$maxlength);<br />
&nbsp; $source=substr($source,$maxlength);<br />
&nbsp; if($type=='private'){<br />
&nbsp;&nbsp;&nbsp; $ok= openssl_private_decrypt($input,$out,$key);<br />
&nbsp; }else{<br />
&nbsp;&nbsp;&nbsp; $ok= openssl_public_decrypt($input,$out,$key);<br />
&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp; $output.=$out;<br />
}<br />
return $output;<br />
<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55901""></a>
  <div class="note">
   <strong class="user">Thomas Horsten</strong>
   <a href="#55901" class="date">17-Aug-2005 01:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
chsnyder writes that the data is limited to 936 bits in his implementation.<br />
<br />
Actually, it has nothing to do with RSA being CPU intensive, RAM or anything of the sort.<br />
<br />
Basically when you encrypt something using an RSA key (whether public or private), the encrypted value must be smaller than the key (due to the maths used to do the actual encryption). So if you have a 1024-bit key, in theory you could encrypt any 1023-bit value (or a 1024-bit value smaller than the key) with that key.<br />
<br />
However, the PKCS#1 standard, which OpenSSL uses, specifies a padding scheme (so you can encrypt smaller quantities without losing security), and that padding scheme takes a minimum of 11 bytes (it will be longer if the value you're encrypting is smaller). So the highest number of bits you can encrypt with a 1024-bit key is 936 bits because of this (unless you disable the padding by adding the OPENSSL_NO_PADDING flag, in which case you can go up to 1023-1024 bits). With a 2048-bit key it's 1960 bits instead.<br />
<br />
But as chsnyder correctly wrote, the normal application of a public key encryption algorithm is to store a key or a hash of the data you want to respectively encrypt or sign. A hash is typically 128-256 bits (the PHP sha1() function returns a 160 bit hash). And an AES key is 128 to 256 bits. So either of those will comfortably fit inside a single RSA encryption.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="54320""></a>
  <div class="note">
   <strong class="user">kenashkov at gmail dot com</strong>
   <a href="#54320" class="date">30-Jun-2005 02:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The encrypted data can be stored in MySQL without use of base64. It must be properly escaped with mysql_real_escape_string(), and then saved to BLOB column. (In fact - this function must be used every time when you insert binary data in MySQL).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="50145""></a>
  <div class="note">
   <strong class="user">chsnyder at gmail dot com</strong>
   <a href="#50145" class="date">19-Feb-2005 06:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In comment below, Jeff says the input to this function is limited to "about 50 characters". On my PHP5 build, the limit is 117 characters (936 bits, strange number).<br />
<br />
That's because public key encryption is CPU intensive, and meant to be used on short values. The idea is to use this function to encrypt a secret key that is in turn used to encrypt data using a more efficient algorithm, such as RC4 or TripleDES. The recipient uses their private key to decrypt the secret, and can then decrypt the data.<br />
<br />
The openssl_seal() and openssl_open() functions do this internally, and are very well documented. You should probably use them instead.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="47333""></a>
  <div class="note">
   <strong class="user">pigo at ms5 dot url dot com dot tw</strong>
   <a href="#47333" class="date">11-Nov-2004 09:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
openssl_public_encrypt and openssl_private_encrypt can't encrypt large data . so I write a class . this class can encrypt large data and decrypt.<br />
<br />
look url : <a href="http://pigo.pigo.idv.tw/opensslcrypt.phps" rel="nofollow" target="_blank">http://pigo.pigo.idv.tw/opensslcrypt.phps</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="46321""></a>
  <div class="note">
   <strong class="user">rstinnett at bfmhconsulting dot com</strong>
   <a href="#46321" class="date">07-Oct-2004 03:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To store the encrypted data in a MySQL database, you first have to encode the data so it can safely be written. You can use a blob type for this, but it can make SELECTs really nasty. The easiest way I have found to do this is with base64_encode and base64_decode. The following example using code from a previous example and split into encrypt and decrypt functions.<br />
<br />
function EncryptData($source)<br />
{<br />
&nbsp; $fp=fopen("/etc/httpd/conf/ssl.crt/server.crt","r");<br />
&nbsp; $pub_key=fread($fp,8192);<br />
&nbsp; fclose($fp);<br />
&nbsp; openssl_get_publickey($pub_key);<br />
&nbsp; /*<br />
&nbsp;&nbsp; * NOTE:&nbsp; Here you use the $pub_key value (converted, I guess)<br />
&nbsp;&nbsp; */<br />
&nbsp; openssl_public_encrypt($source,$crypttext,$pub_key);<br />
&nbsp; return(base64_encode($crypttext));<br />
}<br />
<br />
function DecryptData($source)<br />
{<br />
&nbsp; #print("number : $number");<br />
&nbsp; $fp=fopen("/etc/httpd/conf/ssl.key/server.key","r");<br />
&nbsp; $priv_key=fread($fp,8192);<br />
&nbsp; fclose($fp);<br />
&nbsp; // $passphrase is required if your key is encoded (suggested)<br />
&nbsp; $res = openssl_get_privatekey($priv_key,$passphrase);<br />
&nbsp; /*<br />
&nbsp;&nbsp; * NOTE:&nbsp; Here you use the returned resource value<br />
&nbsp;&nbsp; */<br />
&nbsp; $decoded_source = base64_decode($source);<br />
&nbsp; openssl_private_decrypt($decoded_source,$newsource,$res);<br />
&nbsp; return($newsource);<br />
}<br />
<br />
Just use the return values to store the encrypted data or display the decrypted data.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="42286""></a>
  <div class="note">
   <strong class="user">Jeff</strong>
   <a href="#42286" class="date">11-May-2004 09:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I figured it out.&nbsp; This function is not intended for general encryption and decryption.&nbsp; For that, you want openssl_seal() and openssl_open().</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="42259""></a>
  <div class="note">
   <strong class="user">Jeff</strong>
   <a href="#42259" class="date">10-May-2004 11:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It looks like there is a limit on the size of the string to be encrypted: about 50 characters.<br />
<br />
This is due to the fact that the implementation allocates an output buffer of size EVP_PKEY_size(pkey), which is totally arbitrary and unrelated to the size of the input.&nbsp; Also, it's not using a cipher envelope approach.&nbsp; It's just RSAing the input string.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31311""></a>
  <div class="note">
   <strong class="user">lonewolf at greyskydesigns dot com</strong>
   <a href="#31311" class="date">17-Apr-2003 07:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Easy way:<br />
<br />
<span class="default">&lt;?php<br />
<br />
$publicKey </span><span class="keyword">= </span><span class="string">"file://path/to/public/key-crt.pem"</span><span class="keyword">;<br />
</span><span class="default">$plaintext </span><span class="keyword">= </span><span class="string">"String to encrypt"</span><span class="keyword">;<br />
<br />
</span><span class="default">openssl_public_encrypt</span><span class="keyword">(</span><span class="default">$plaintext</span><span class="keyword">, </span><span class="default">$encrypted</span><span class="keyword">, </span><span class="default">$publicKey</span><span class="keyword">);<br />
<br />
echo </span><span class="default">$encrypted</span><span class="keyword">;&nbsp;&nbsp; </span><span class="comment">//encrypted string<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="30313""></a>
  <div class="note">
   <strong class="user">webmaster at costarica-travelinfo dot com</strong>
   <a href="#30313" class="date">13-Mar-2003 11:51</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This example worked for me:<br />
<br />
RedHat 7.2 / php 4.2.2 / Apache 1.3.7<br />
<br />
// STEP 1: Encryption with Public Key (you will need Private Key to decrypt - see step2).<br />
<br />
$string="Some Important Data";<br />
$fp=fopen ("cert.pem","r");<br />
$pub_key=fread ($fp,8192);<br />
fclose($fp);<br />
$PK="";<br />
$PK=openssl_get_publickey($pub_key);<br />
if (!$PK) {<br />
&nbsp;&nbsp;&nbsp; echo "Cannot get public key";<br />
}<br />
$finaltext="";<br />
openssl_public_encrypt($string,$finaltext,$PK);<br />
if (!empty($finaltext)) {<br />
&nbsp;&nbsp;&nbsp; openssl_free_key($PK);<br />
&nbsp;&nbsp;&nbsp; echo "Encryption OK!";<br />
}else{<br />
&nbsp;&nbsp;&nbsp; echo "Cannot Encrypt";<br />
}<br />
<br />
// STEP 2: Decription (Using Private Key)<br />
<br />
$fp=fopen ("pk.pem","r");<br />
$priv_key2=fread ($fp,8192);<br />
fclose($fp);<br />
$PK2=openssl_get_privatekey($priv_key2);<br />
$Crypted=openssl_private_decrypt($Data,$Decrypted,$PK2);<br />
if (!$Crypted) {<br />
&nbsp;&nbsp;&nbsp; $MSG.="&lt;p class='error'&gt;Cannot Decrypt ($CCID).&lt;/p&gt;";<br />
}else{<br />
&nbsp;&nbsp;&nbsp; echo "Decrypted Data: " . $Decrypted;<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="25810""></a>
  <div class="note">
   <strong class="user">hromi at kyberia dot sk</strong>
   <a href="#25810" class="date">07-Oct-2002 07:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
function description is wrong, you have to switch crypttext and text if you want it to work<br />
this is correct:<br />
bool openssl_public_encrypt ( string crypted, string data, mixed key [, int padding])</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="19725""></a>
  <div class="note">
   <strong class="user">wfredkNOSPAM at L5DevelopmentNOSPAM dot com</strong>
   <a href="#19725" class="date">09-Mar-2002 12:56</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Encrypt using public key, decrypt using private key.<br />
<br />
Use this to store stuff in your database: Unless someone<br />
has your private key, the database contents are useless.<br />
<br />
Also, use this for sending to a specific individual:&nbsp; Get<br />
their public key, encrypt the message, only they can use<br />
their private key to decode it.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">echo </span><span class="string">"Source: </span><span class="default">$source</span><span class="string">"</span><span class="keyword">;<br />
</span><span class="default">$fp</span><span class="keyword">=</span><span class="default">fopen </span><span class="keyword">(</span><span class="string">"/path/to/certificate.crt"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
</span><span class="default">$pub_key</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">8192</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
</span><span class="default">openssl_get_publickey</span><span class="keyword">(</span><span class="default">$pub_key</span><span class="keyword">);<br />
</span><span class="comment">/*<br />
&nbsp;* NOTE:&nbsp; Here you use the $pub_key value (converted, I guess)<br />
&nbsp;*/<br />
</span><span class="default">openssl_public_encrypt</span><span class="keyword">(</span><span class="default">$source</span><span class="keyword">,</span><span class="default">$crypttext</span><span class="keyword">,</span><span class="default">$pub_key</span><span class="keyword">);<br />
echo </span><span class="string">"String crypted: </span><span class="default">$crypttext</span><span class="string">"</span><span class="keyword">;<br />
<br />
</span><span class="default">$fp</span><span class="keyword">=</span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"/path/to/private.key"</span><span class="keyword">,</span><span class="string">"r"</span><span class="keyword">);<br />
</span><span class="default">$priv_key</span><span class="keyword">=</span><span class="default">fread</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">,</span><span class="default">8192</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
</span><span class="comment">// $passphrase is required if your key is encoded (suggested)<br />
</span><span class="default">$res </span><span class="keyword">= </span><span class="default">openssl_get_privatekey</span><span class="keyword">(</span><span class="default">$priv_key</span><span class="keyword">,</span><span class="default">$passphrase</span><span class="keyword">);<br />
</span><span class="comment">/*<br />
&nbsp;* NOTE:&nbsp; Here you use the returned resource value<br />
&nbsp;*/<br />
</span><span class="default">openssl_private_decrypt</span><span class="keyword">(</span><span class="default">$crypttext</span><span class="keyword">,</span><span class="default">$newsource</span><span class="keyword">,</span><span class="default">$res</span><span class="keyword">);<br />
echo </span><span class="string">"String decrypt : </span><span class="default">$newsource</span><span class="string">"</span><span class="keyword">;<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.openssl-public-decrypt.html">openssl_public_decrypt</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.openssl-random-pseudo-bytes.html">openssl_random_pseudo_bytes</a></div>
 <div class="up"><a href="ref.openssl.html">OpenSSL 関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
