<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>共有メモリセグメントを作成またはオープンする</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.sem-remove.html">sem_remove</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.shm-detach.html">shm_detach</a></div>
 <div class="up"><a href="ref.sem.html">セマフォ関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.shm-attach" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">shm_attach</h1>
  <p class="verinfo">(PHP 4, PHP 5)</p><p class="refpurpose"><span class="refname">shm_attach</span> &mdash; <span class="dc-title">共有メモリセグメントを作成またはオープンする</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.shm-attach-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">resource</span> <span class="methodname"><strong>shm_attach</strong></span>
    ( <span class="methodparam"><span class="type">int</span> <code class="parameter">$key</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$memsize</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$perm</code><span class="initializer"> = 0666</span></span>
  ]] )</div>

  <p class="para rdfs-comment">
    <span class="function"><strong>shm_attach()</strong></span> は ID を返します。
   これは、指定されたキー <em><code class="parameter">key</code></em>
   で System V 共有メモリにアクセスする際に使用することが可能です。
   最初のコールの際に、サイズが <em><code class="parameter">memsize</code></em>、
   オプションのパーミッション <em><code class="parameter">perm</code></em>
   を指定した共有メモリセグメントを作成します。
  </p>
  <p class="para">
   同じ <em><code class="parameter">key</code></em> で
    <span class="function"><strong>shm_attach()</strong></span> を 2 回コールした場合は
   別の共有メモリ ID が返されますが、両方の ID は同じ共有メモリをアクセスします。
   <em><code class="parameter">memsize</code></em> および
   <em><code class="parameter">perm</code></em> は無視されます。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.shm-attach-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term"><em><code class="parameter">key</code></em></span>
     <dd>

      <p class="para">
       共有メモリセグメント ID を表す数値。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">memsize</code></em></span>
     <dd>

      <p class="para">
       メモリのサイズ。省略した場合のデフォルトは <var class="filename">php.ini</var> の
       <em>sysvshm.init_mem</em>、あるいは 10000
       バイトとなります。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">perm</code></em></span>
     <dd>

      <p class="para">
       オプションのパーミッション設定。デフォルトは 0666 です。
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.shm-attach-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   共有メモリセグメントの ID を返します。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.shm-attach-changelog">
  <h3 class="title">変更履歴</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>バージョン</th>
       <th>説明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>5.3.0</td>
       <td>
         この関数の返す値の型が、
         <a href="language.types.integer.html" class="link">integer</a> から <a href="language.types.resource.html" class="link">リソース</a>
         に変わりました。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.shm-attach-notes">
  <h3 class="title">注意</h3>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <p class="para">
    PHP 5.3.0 より前のバージョンでは、この関数の返す値は integer 型の値でした。
    前のバージョンと同じ値を得るには、次のように帰り値を
    integer へとキャストします。
   </p>
   <p class="para">
    <div class="example" id="example-3702">
     <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">//&nbsp;テンポラリファイルを作り、そのパスを返します<br /></span><span style="color: #0000BB">$tmp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">tempnam</span><span style="color: #007700">(</span><span style="color: #DD0000">'/tmp'</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'PHP'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;ファイルトークンキーを取得します<br /></span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">ftok</span><span style="color: #007700">(</span><span style="color: #0000BB">$tmp</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'a'</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;SHM&nbsp;リソースをアタッチします。あとでキャストすることに注意<br /></span><span style="color: #0000BB">$id&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">shm_attach</span><span style="color: #007700">(</span><span style="color: #0000BB">$key</span><span style="color: #007700">);<br /><br />if&nbsp;(</span><span style="color: #0000BB">$id&nbsp;</span><span style="color: #007700">===&nbsp;</span><span style="color: #0000BB">false</span><span style="color: #007700">)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;die(</span><span style="color: #DD0000">'共有メモリセグメントを作成できません'</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">//&nbsp;integer&nbsp;にキャストします。PHP&nbsp;5.3.0&nbsp;より前のバージョンでは<br />//&nbsp;リソース&nbsp;ID&nbsp;が返り値となっており、この値はリソースを&nbsp;integer<br />//&nbsp;にキャストすることで得られるからです<br /></span><span style="color: #0000BB">$id&nbsp;</span><span style="color: #007700">=&nbsp;(integer)&nbsp;</span><span style="color: #0000BB">$id</span><span style="color: #007700">;<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
     </div>

    </div>
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.shm-attach-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"> <span class="function"><a href="function.shm-detach.html" class="function" rel="rdfs-seeAlso">shm_detach()</a> - 共有メモリセグメントへの接続を閉じる</span></li>
    <li class="member"> <span class="function"><a href="function.ftok.html" class="function" rel="rdfs-seeAlso">ftok()</a> - パス名とプロジェクト ID を、System V IPC キーに変換する</span></li>
   </ul>
  </p>
 </div>
  

</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="106169""></a>
  <div class="note">
   <strong class="user">info at tristat dot org</strong>
   <a href="#106169" class="date">16-Oct-2011 02:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
You might expect the SHM functions to be significantly faster than building variables from MySQL operations. Unfortunately this is not the case regarding large multidimensional arrays. I've tested write, read, update and delete operations with with a two dimensional associative array directly with SHM and in comparison with a class using MySQL and a class using SHMOP functions (with mostly offset-accurate serialization). Both classes generated the same array as stored with SHM. Unlike SHMOP the performance of SHM decreases considerably with larger arrays. At 2000 instructions with an $array[$row][$key] of 200 rows and 5 keys even MySql is faster than SHM.This might be due to the fact, that SHM deals with any kind of arrays and makes internal use the PHPs powerful serialize() function.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="103285""></a>
  <div class="note">
   <strong class="user">nathanbruer at gmail dot com</strong>
   <a href="#103285" class="date">05-Apr-2011 10:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was playing around with these functions and made a class in the process. This will of course be slower than accessing a variable locally, but gives the ability to store variables in a shared environment and gives many running scripts the understanding that it should access them from the shared area. This should also auto destroy the shared memory area once no more scripts have a link to the data (when all scripts use this class).<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">class </span><span class="default">SharedMemory</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$nameToKey </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$key</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; private </span><span class="default">$id</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$key </span><span class="keyword">= </span><span class="default">null</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$key </span><span class="keyword">=== </span><span class="default">null</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmp </span><span class="keyword">= </span><span class="default">tempnam</span><span class="keyword">(</span><span class="string">'/tmp'</span><span class="keyword">, </span><span class="string">'PHP'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">key </span><span class="keyword">= </span><span class="default">ftok</span><span class="keyword">(</span><span class="default">$tmp</span><span class="keyword">, </span><span class="string">'a'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id </span><span class="keyword">= </span><span class="default">shm_attach</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">nameToKey</span><span class="keyword">[] = </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">nameToKey</span><span class="keyword">[] = </span><span class="string">''</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">updateMemoryVarList</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">key </span><span class="keyword">= </span><span class="default">$key</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id </span><span class="keyword">= </span><span class="default">sem_get</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">refreshMemoryVarList</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">, </span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">) + </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; die(</span><span class="string">'Unable to create shared memory segment'</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">__sleep</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_detach</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">__destruct</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">) == </span><span class="default">1</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// I am the last listener so kill shared memory space<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">remove</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }else{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_detach</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">, </span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">) - </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">__wakeup</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id </span><span class="keyword">= </span><span class="default">sem_get</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">key</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_attach</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">refreshMemoryVarList</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">, </span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">) + </span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">getKey</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">key</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">remove</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_remove</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">refreshMemoryVarList</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">nameToKey </span><span class="keyword">= </span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">updateMemoryVarList</span><span class="keyword">(){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">nameToKey</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">__get</span><span class="keyword">(</span><span class="default">$var</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">in_array</span><span class="keyword">(</span><span class="default">$var</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">nameToKey</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">refreshMemoryVarList</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">array_search</span><span class="keyword">(</span><span class="default">$var</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">nameToKey</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">__set</span><span class="keyword">(</span><span class="default">$var</span><span class="keyword">, </span><span class="default">$val</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(!</span><span class="default">in_array</span><span class="keyword">(</span><span class="default">$var</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">nameToKey</span><span class="keyword">)){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">refreshMemoryVarList</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">nameToKey</span><span class="keyword">[] = </span><span class="default">$var</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">updateMemoryVarList</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">id</span><span class="keyword">, </span><span class="default">array_search</span><span class="keyword">(</span><span class="default">$var</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">nameToKey</span><span class="keyword">), </span><span class="default">$val</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="comment">// Example<br />
</span><span class="default">$sharedMem </span><span class="keyword">= new </span><span class="default">SharedMemory</span><span class="keyword">();<br />
</span><span class="default">$pid </span><span class="keyword">= </span><span class="default">pcntl_fork</span><span class="keyword">();<br />
if(</span><span class="default">$pid</span><span class="keyword">){<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//parent<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Parent Says: " </span><span class="keyword">. </span><span class="default">$sharedMem</span><span class="keyword">-&gt;</span><span class="default">a </span><span class="keyword">. </span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Parent Changed to 0\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sharedMem</span><span class="keyword">-&gt;</span><span class="default">a </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//Parent just changed it to 0<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"Parent Says: " </span><span class="keyword">. </span><span class="default">$sharedMem</span><span class="keyword">-&gt;</span><span class="default">a </span><span class="keyword">. </span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Parent think's it's 0, but child has changed it to 1<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"Parent Says: " </span><span class="keyword">. </span><span class="default">$sharedMem</span><span class="keyword">-&gt;</span><span class="default">a </span><span class="keyword">. </span><span class="string">"\n"</span><span class="keyword">;<br />
}else{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">//child<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sharedMem</span><span class="keyword">-&gt;</span><span class="default">a </span><span class="keyword">= </span><span class="default">2</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Child Changed to 2\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Should be 2 as child just set it to 2<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"Child Says: " </span><span class="keyword">. </span><span class="default">$sharedMem</span><span class="keyword">-&gt;</span><span class="default">a </span><span class="keyword">. </span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">sleep</span><span class="keyword">(</span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Child think's it's 2, but the parent set it to 0.<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">echo </span><span class="string">"Child Says: " </span><span class="keyword">. </span><span class="default">$sharedMem</span><span class="keyword">-&gt;</span><span class="default">a </span><span class="keyword">. </span><span class="string">"\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Child Added 1\n"</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$sharedMem</span><span class="keyword">-&gt;</span><span class="default">a</span><span class="keyword">++;<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">"Child Says: " </span><span class="keyword">. </span><span class="default">$sharedMem</span><span class="keyword">-&gt;</span><span class="default">a </span><span class="keyword">. </span><span class="string">"\n"</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="99235""></a>
  <div class="note">
   <strong class="user">somepay at gmail dot com</strong>
   <a href="#99235" class="date">05-Aug-2010 12:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In my log I have found string<br />
"shm_attach(): failed for key 0x366f: No space left on device" <br />
But have not found any suggestion for this at php.net and at google.<br />
<br />
So question was how to make free memory used by shm_attach .<br />
At first to view (Linux)&nbsp; how many segments allocated, use <br />
:~# ipcs -mu<br />
then<br />
limits<br />
:~# ipcs -ml<br />
<br />
to remove segment use:<br />
:~# ipcrm -m [shmid]<br />
<br />
otherwise you can reboot server, or launch sh script based on commands above.<br />
<br />
To avoid troubles with "No space left on device" ALWAYS use <br />
shm_remove() &amp; shm_detach() after call shm_attach().</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="89228""></a>
  <div class="note">
   <strong class="user">pail dot luo at gmail dot com</strong>
   <a href="#89228" class="date">27-Feb-2009 03:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A simple Sample to introduce SHM.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">if ( </span><span class="default">sizeof</span><span class="keyword">(</span><span class="default">$argv</span><span class="keyword">)&lt;</span><span class="default">2 </span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"Usage: </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]</span><span class="string"> send|recv|rem|dele ID [msg] \n\n" </span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"&nbsp;&nbsp; EX: </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]</span><span class="string"> send 1 \"This is no 1\" \n" </span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]</span><span class="string"> recv 1 \n" </span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]</span><span class="string"> rem 1 \n" </span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]</span><span class="string"> dele \n" </span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; exit;<br />
}<br />
<br />
</span><span class="comment">// $SHMKey = ftok(__FILE__, "Z");<br />
</span><span class="default">$SHMKey </span><span class="keyword">= </span><span class="string">"123456" </span><span class="keyword">;<br />
<br />
</span><span class="comment">## Create/Open a shm<br />
</span><span class="default">$seg </span><span class="keyword">= </span><span class="default">shm_attach</span><span class="keyword">( </span><span class="default">$SHMKey</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">0666 </span><span class="keyword">) ;<br />
<br />
switch ( </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">] ) {<br />
&nbsp;&nbsp;&nbsp; case </span><span class="string">"send"</span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$seg</span><span class="keyword">, </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">], </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="string">"send msg done...\n" </span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; case </span><span class="string">"recv"</span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$data </span><span class="keyword">= </span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$seg</span><span class="keyword">, </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; echo </span><span class="default">$data </span><span class="keyword">. </span><span class="string">"\n" </span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; case </span><span class="string">"rem"</span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_remove_var</span><span class="keyword">(</span><span class="default">$seg</span><span class="keyword">, </span><span class="default">$argv</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
<br />
&nbsp;&nbsp;&nbsp; case </span><span class="string">"dele"</span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">shm_remove</span><span class="keyword">(</span><span class="default">$seg</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; case </span><span class="string">"dele2"</span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; `</span><span class="string">/usr/bin/ipcrm -M 123456</span><span class="keyword">`;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85800""></a>
  <div class="note">
   <strong class="user">nkatz at yahooo dot com</strong>
   <a href="#85800" class="date">18-Sep-2008 02:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Responding to jpeter1978 at yahoo dot com ... Assuming a character is typically two bytes, the size of a serialized variable (incl array or obj) is 2 * its strlen().&nbsp; The 44 is 4 more than the 24 + 16 = 40 suggested by php at cytrax dot de plus 4 bytes for worst case 4-byte alignment.&nbsp; So this is probably a reliable formula if you are too lazy to align it using something similar to zeppelinux at comcast dot net as in:<br />
<br />
($strlen($serialized_array_or_obj) /4 ) * 4 ) + 40;<br />
<br />
The zeppelinux formula would use 20 (for 4-byte integer cpu) or 36 (for 64-bit or 8-byte cpu) for the ending constant so 40 or 44 is probably just achieving header padding but it certainly can't hurt.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="85085""></a>
  <div class="note">
   <strong class="user">zeppelinux at comcast dot net</strong>
   <a href="#85085" class="date">14-Aug-2008 09:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">//how to calculate the&nbsp; minimum $memsize required to store the variable $foo where $foo='foobar'.<br />
<br />
// when shm_attach() is called for the first time, PHP writes a header to the beginning of the shared memory. <br />
</span><span class="default">$shmHeaderSize </span><span class="keyword">= (</span><span class="default">PHP_INT_SIZE </span><span class="keyword">* </span><span class="default">4</span><span class="keyword">) + </span><span class="default">8</span><span class="keyword">;<br />
<br />
</span><span class="comment">// when shm_put_var() is called, the variable is serialized and a small header is placed in front of it before it is written to shared memory.<br />
</span><span class="default">$shmVarSize </span><span class="keyword">= (((</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">serialize</span><span class="keyword">(</span><span class="default">$foo</span><span class="keyword">))+ (</span><span class="default">4 </span><span class="keyword">* </span><span class="default">PHP_INT_SIZE</span><span class="keyword">)) /</span><span class="default">4 </span><span class="keyword">) * </span><span class="default">4 </span><span class="keyword">) + </span><span class="default">4</span><span class="keyword">;<br />
<br />
</span><span class="comment">// now add the two together to get the total memory required. Of course, if you are storing more than one variable then you dont need to add $shmHeaderSize for each variable, only add it once.<br />
</span><span class="default">$memsize </span><span class="keyword">= </span><span class="default">$shmHeaderSize </span><span class="keyword">+ </span><span class="default">$shmVarSize</span><span class="keyword">;<br />
<br />
</span><span class="comment">//this will give you just enough memory to store the one variable using shm_put_var().<br />
</span><span class="default">$shm_id </span><span class="keyword">= </span><span class="default">shm_attach </span><span class="keyword">( </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$memsize</span><span class="keyword">, </span><span class="default">0666 </span><span class="keyword">) ;<br />
</span><span class="default">shm_put_var&nbsp; </span><span class="keyword">( </span><span class="default">$shm_id&nbsp; </span><span class="keyword">, </span><span class="default">$variable_key&nbsp; </span><span class="keyword">, </span><span class="default">$foo&nbsp; </span><span class="keyword">);<br />
<br />
</span><span class="default">any attempt to store another variable will result in a </span><span class="string">'not enough memory' </span><span class="default">error</span><span class="keyword">.<br />
</span><span class="default">Be aware that </span><span class="keyword">if </span><span class="default">you change the contents of $foo to a larger value </span><span class="keyword">and </span><span class="default">then you </span><span class="keyword">try </span><span class="default">to write it to shared memory again using shm_put_var</span><span class="keyword">(), </span><span class="default">then you will get a </span><span class="string">'not enough memory' </span><span class="default">error</span><span class="keyword">. </span><span class="default">In this </span><span class="keyword">case, </span><span class="default">you will have to resize your shared memory segment </span><span class="keyword">and </span><span class="default">then write the </span><span class="keyword">new </span><span class="default">value</span><span class="keyword">.<br />
<br />
If </span><span class="default">you are only storing variables that contain a single integer value</span><span class="keyword">, </span><span class="default">then you can avoid having to resize by always allocating the largest amount of memory that is required to store an int</span><span class="keyword">, </span><span class="default">which should be</span><span class="keyword">:<br />
</span><span class="default">$shmIntVarSize </span><span class="keyword">= (((</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">serialize</span><span class="keyword">(</span><span class="default">PHP_INT_MAX</span><span class="keyword">))+ (</span><span class="default">4 </span><span class="keyword">* </span><span class="default">PHP_INT_SIZE</span><span class="keyword">)) /</span><span class="default">4 </span><span class="keyword">) * </span><span class="default">4 </span><span class="keyword">) + </span><span class="default">4</span><span class="keyword">;<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80354""></a>
  <div class="note">
   <strong class="user">hetii at poczta dot onet dot pl</strong>
   <a href="#80354" class="date">11-Jan-2008 02:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Hi :)<br />
I write small class for build bright message between my application.<br />
<br />
&lt;?<br />
class Bright_Message<br />
{<br />
<br />
var $bright;<br />
var $SHM_KEY;<br />
var $my_pid;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function Bright_Message($SHM_KEY=null)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $this-&gt;my_pid = getmypid();//Get own pid<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (is_null($SHM_KEY)) $this-&gt;SHM_KEY = '123123123';<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $this-&gt;bright = shm_attach($this-&gt;SHM_KEY, 1024, 0666);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $this-&gt;one_instance();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function get_msg($id,$remove=true)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(@$msg=shm_get_var($this-&gt;bright,$id))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if ($remove) @shm_remove_var($this-&gt;bright,$id);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; return $msg;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; } else return false;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function snd_msg($id,$msg)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; @shm_put_var($this-&gt;bright,$id,$msg);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return true;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; function one_instance()<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $SHM_PID = $this-&gt;get_msg(1,false);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if((strpos(exec('ps p'.$SHM_PID),$_SERVER['SCRIPT_FILENAME'])) === false)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $this-&gt;snd_msg(1,$this-&gt;my_pid); else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo "This program exists on pid: $SHM_PID\r\n\r\n";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; exit;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
}<br />
?&gt;<br />
<br />
send.php:<br />
&lt;?<br />
include "bridge_message.class.php";<br />
$shm = new Bright_Message();<br />
$shm-&gt;snd_msg(2,'this is my simple message');<br />
?&gt;<br />
<br />
receive.php:<br />
&lt;?<br />
include "bridge_message.class.php";<br />
$shm = new Bright_Message();<br />
$msg = get_msg(2);<br />
echo print_r($msg,1);<br />
?&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="76888""></a>
  <div class="note">
   <strong class="user">jpeter1978 at yahoo dot com</strong>
   <a href="#76888" class="date">04-Aug-2007 12:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I tried all the suggestions above for getting the object size (in bytes) for $memsize, but they didn't work universally for the two types of objects I tried (string and array of strings).<br />
<br />
After doing some googling and experimenting, I've found the following magic formula:<br />
<br />
$memsize = ( strlen( serialize( $object ) ) + 44 ) * 2;<br />
<br />
I found this in someone else's code, so I can't explain it.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="73744""></a>
  <div class="note">
   <strong class="user">Uther Pendragon</strong>
   <a href="#73744" class="date">08-Mar-2007 06:08</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As a follow-up to my last post regarding shm_attach and its limit capability for knowing how it was created....<br />
<br />
for more control, use the shmop_* series of functions, as they have finer grained control than these.<br />
<br />
and by the way:&nbsp; the SHMOP functions SHOULD BE listed under "see also" for all the SHM* wrapper functions (I assume they are wrappers to the SHMOP* functions).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="72563""></a>
  <div class="note">
   <strong class="user">Uther Pendragon</strong>
   <a href="#72563" class="date">24-Jan-2007 05:26</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Since there aren't seperate functions for CREATING and ATTACHING shared memory (a mistake in my opinion), you might want to do some testing to check whether you've created it or not, as you may not want the slave of a master/slave pair to ever create the shared memory.<br />
<br />
One way you can test this is by having your slave set the size to something small, then testing the size by putting a variable too large to fit, e.g.:<br />
<br />
function get_shmem() {<br />
&nbsp;&nbsp; &nbsp; return shm_attach(ftok('somefile.txt', 'T'), 100, 0644);<br />
}<br />
<br />
$shm = get_shmem();<br />
<br />
while (!@shm_put_var($shm, 1, str_repeat('.....', 20))) {<br />
&nbsp;&nbsp; &nbsp; shm_remove($shm); <br />
&nbsp;&nbsp; &nbsp; sleep(1);<br />
&nbsp;&nbsp; &nbsp; //we created it, so we'll remove it and sleep to wait for the master to create it, then try again.<br />
&nbsp;&nbsp; &nbsp; $shm = get_shmem();<br />
}<br />
shm_remove_var($shm, 1);<br />
//here we know the shared memory was already created, because we could put a variable in bigger than the size requested.<br />
<br />
Another way you can handle it is to have all programs initialize the shared memory with the same parameters... I had a problem with this when my clients starting too fast and created the shmem without passing a memsize value, so it was defaulting to 10k which was too small.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="70935""></a>
  <div class="note">
   <strong class="user">Katzenmeier</strong>
   <a href="#70935" class="date">05-Nov-2006 12:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The limit for one SHM block seems to be 32 MB, but you can split your data in several SHM blocks if you need to. The total SHM limit seems to be about 8 GB.<br />
<br />
I'm not sure whether this is true for all configurations.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62266""></a>
  <div class="note">
   <strong class="user">muytoloco at yahoo dot com dot br</strong>
   <a href="#62266" class="date">23-Feb-2006 06:33</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If one process make a shm_attach to one inexistent memory area, this area will be created under the same priviliegies of the script running user. If another process will try to create or acces the same area, runnig by other user with different privileges of the first user, an error will occur.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="51342""></a>
  <div class="note">
   <strong class="user">rch at todo dot com dot uy</strong>
   <a href="#51342" class="date">28-Mar-2005 01:17</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Cecil, the key of a var is an integer (not the name ). You can put multiples vars in the same share.<br />
<br />
#!/usr/local/bin/php -q<br />
<span class="default">&lt;?PHP<br />
<br />
$SHM_KEY </span><span class="keyword">= </span><span class="default">ftok</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">, </span><span class="default">chr</span><span class="keyword">( </span><span class="default">4 </span><span class="keyword">) ); <br />
<br />
</span><span class="default">$data </span><span class="keyword">=&nbsp; </span><span class="default">shm_attach</span><span class="keyword">(</span><span class="default">$SHM_KEY</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">0666</span><span class="keyword">);<br />
<br />
</span><span class="default">$test1 </span><span class="keyword">= array(</span><span class="string">"hello"</span><span class="keyword">,</span><span class="string">"world"</span><span class="keyword">,</span><span class="string">"1"</span><span class="keyword">,</span><span class="string">"2"</span><span class="keyword">,</span><span class="string">"3"</span><span class="keyword">);<br />
</span><span class="default">$test2 </span><span class="keyword">= array(</span><span class="string">"hello"</span><span class="keyword">,</span><span class="string">"world"</span><span class="keyword">,</span><span class="string">"4"</span><span class="keyword">,</span><span class="string">"5"</span><span class="keyword">,</span><span class="string">"6"</span><span class="keyword">);<br />
</span><span class="default">$test3 </span><span class="keyword">= array(</span><span class="string">"hello"</span><span class="keyword">,</span><span class="string">"world"</span><span class="keyword">,</span><span class="string">"7"</span><span class="keyword">,</span><span class="string">"8"</span><span class="keyword">,</span><span class="string">"9"</span><span class="keyword">);<br />
<br />
</span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">, </span><span class="default">$test1</span><span class="keyword">);<br />
</span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">,</span><span class="default">$test2</span><span class="keyword">);<br />
</span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">,</span><span class="default">$test3</span><span class="keyword">);<br />
<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">));<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">));<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">));<br />
<br />
</span><span class="default">shm_detach</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="41878""></a>
  <div class="note">
   <strong class="user">andreyKEINSPAM at php dot net</strong>
   <a href="#41878" class="date">24-Apr-2004 06:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As far as I see from the sources of ext/sysvshm, it's not needed to&nbsp; do&nbsp; arithmetic (bit) OR (|) of "perm" with&nbsp; IPC_CREAT (and IPC_EXCL). The extension will do it for you. It tries to attach to the memory segment and if the try did not succeed it tries to attach but with flags set to user_flag | IPC_CREAT | IPC_EXCL.<br />
The exact code (shm_flag is the third param to the function) :<br />
if ((shm_id = shmget(shm_key, 0, 0)) &lt; 0) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; if (shm_size &lt; sizeof(sysvshm_chunk_head)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; php_error_docref(NULL TSRMLS_CC, E_WARNING, "failed for key 0x%x: memorysize too small", shm_key);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; efree(shm_list_ptr);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; RETURN_FALSE;<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; if ((shm_id = shmget(shm_key, shm_size, shm_flag | IPC_CREAT | IPC_EXCL)) &lt; 0) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; php_error_docref(NULL TSRMLS_CC, E_WARNING, "failed for key 0x%x: %s", shm_key, strerror(errno));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; efree(shm_list_ptr);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; RETURN_FALSE;<br />
&nbsp;&nbsp; &nbsp; }<br />
}</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="40886""></a>
  <div class="note">
   <strong class="user">Cecil</strong>
   <a href="#40886" class="date">18-Mar-2004 09:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is an example of how to use one shared memory block to store multiple variables or arrays.. unfortunetly in order to store more than ONE variable, you have to use sem_get() multiple times.. same goes for shm_attach(), shm_put_var() and shm_get_var()<br />
<br />
#!/usr/local/bin/php -q<br />
<span class="default">&lt;?PHP<br />
</span><span class="comment">// test.php<br />
<br />
</span><span class="default">$SHM_KEY </span><span class="keyword">= </span><span class="default">ftok</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">,</span><span class="string">'A'</span><span class="keyword">);<br />
<br />
</span><span class="default">$shmid&nbsp; </span><span class="keyword">= </span><span class="default">sem_get</span><span class="keyword">(</span><span class="default">$SHM_KEY</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">0644 </span><span class="keyword">| </span><span class="default">IPC_CREAT</span><span class="keyword">);<br />
</span><span class="default">$shmid2 </span><span class="keyword">= </span><span class="default">sem_get</span><span class="keyword">(</span><span class="default">$SHM_KEY</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">0644 </span><span class="keyword">| </span><span class="default">IPC_CREAT</span><span class="keyword">);<br />
</span><span class="default">$shmid3 </span><span class="keyword">= </span><span class="default">sem_get</span><span class="keyword">(</span><span class="default">$SHM_KEY</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">0644 </span><span class="keyword">| </span><span class="default">IPC_CREAT</span><span class="keyword">);<br />
<br />
</span><span class="default">$data </span><span class="keyword">=&nbsp; </span><span class="default">shm_attach</span><span class="keyword">(</span><span class="default">$shmid</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="default">$data2 </span><span class="keyword">= </span><span class="default">shm_attach</span><span class="keyword">(</span><span class="default">$shmid2</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="default">$data3 </span><span class="keyword">= </span><span class="default">shm_attach</span><span class="keyword">(</span><span class="default">$shmid3</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">);<br />
<br />
</span><span class="default">$test </span><span class="keyword">= array(</span><span class="string">"hello"</span><span class="keyword">,</span><span class="string">"world"</span><span class="keyword">,</span><span class="string">"1"</span><span class="keyword">,</span><span class="string">"2"</span><span class="keyword">,</span><span class="string">"3"</span><span class="keyword">);<br />
</span><span class="default">$test2 </span><span class="keyword">= array(</span><span class="string">"hello"</span><span class="keyword">,</span><span class="string">"world"</span><span class="keyword">,</span><span class="string">"4"</span><span class="keyword">,</span><span class="string">"5"</span><span class="keyword">,</span><span class="string">"6"</span><span class="keyword">);<br />
</span><span class="default">$test3 </span><span class="keyword">= array(</span><span class="string">"hello"</span><span class="keyword">,</span><span class="string">"world"</span><span class="keyword">,</span><span class="string">"7"</span><span class="keyword">,</span><span class="string">"8"</span><span class="keyword">,</span><span class="string">"9"</span><span class="keyword">);<br />
<br />
</span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">,</span><span class="default">$inmem</span><span class="keyword">,</span><span class="default">$test</span><span class="keyword">);<br />
</span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$data2</span><span class="keyword">,</span><span class="default">$inmem2</span><span class="keyword">,</span><span class="default">$test2</span><span class="keyword">);<br />
</span><span class="default">shm_put_var</span><span class="keyword">(</span><span class="default">$data3</span><span class="keyword">,</span><span class="default">$inmem3</span><span class="keyword">,</span><span class="default">$test3</span><span class="keyword">);<br />
<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">,</span><span class="default">$inmem</span><span class="keyword">));<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$data2</span><span class="keyword">,</span><span class="default">$inmem2</span><span class="keyword">));<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$data3</span><span class="keyword">,</span><span class="default">$inmem3</span><span class="keyword">));<br />
<br />
</span><span class="default">shm_detach</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">shm_detach</span><span class="keyword">(</span><span class="default">$data2</span><span class="keyword">);<br />
</span><span class="default">shm_detach</span><span class="keyword">(</span><span class="default">$data2</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
to REALLY test it.. create a second script like so and run it..<br />
<br />
#!/usr/local/bin/php -q<br />
<span class="default">&lt;?PHP<br />
</span><span class="comment">// test2.php<br />
<br />
</span><span class="default">$SHM_KEY </span><span class="keyword">= </span><span class="default">ftok</span><span class="keyword">(</span><span class="default">__FILE__</span><span class="keyword">,</span><span class="string">'A'</span><span class="keyword">);<br />
<br />
</span><span class="default">$shmid&nbsp; </span><span class="keyword">= </span><span class="default">sem_get</span><span class="keyword">(</span><span class="default">$SHM_KEY</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">0644 </span><span class="keyword">| </span><span class="default">IPC_CREAT</span><span class="keyword">);<br />
</span><span class="default">$shmid2 </span><span class="keyword">= </span><span class="default">sem_get</span><span class="keyword">(</span><span class="default">$SHM_KEY</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">0644 </span><span class="keyword">| </span><span class="default">IPC_CREAT</span><span class="keyword">);<br />
</span><span class="default">$shmid3 </span><span class="keyword">= </span><span class="default">sem_get</span><span class="keyword">(</span><span class="default">$SHM_KEY</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">, </span><span class="default">0644 </span><span class="keyword">| </span><span class="default">IPC_CREAT</span><span class="keyword">);<br />
<br />
</span><span class="default">$data </span><span class="keyword">=&nbsp; </span><span class="default">shm_attach</span><span class="keyword">(</span><span class="default">$shmid</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="default">$data2 </span><span class="keyword">= </span><span class="default">shm_attach</span><span class="keyword">(</span><span class="default">$shmid2</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">);<br />
</span><span class="default">$data3 </span><span class="keyword">= </span><span class="default">shm_attach</span><span class="keyword">(</span><span class="default">$shmid3</span><span class="keyword">, </span><span class="default">1024</span><span class="keyword">);<br />
<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">,</span><span class="default">$inmem</span><span class="keyword">));<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$data2</span><span class="keyword">,</span><span class="default">$inmem2</span><span class="keyword">));<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">shm_get_var</span><span class="keyword">(</span><span class="default">$data3</span><span class="keyword">,</span><span class="default">$inmem3</span><span class="keyword">));<br />
<br />
</span><span class="default">shm_detach</span><span class="keyword">(</span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">shm_detach</span><span class="keyword">(</span><span class="default">$data2</span><span class="keyword">);<br />
</span><span class="default">shm_detach</span><span class="keyword">(</span><span class="default">$data2</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
As you can see, test2.php doesn't insert anything into shared memory.. yet it pulls out 3 totally different arrays already stored..<br />
<br />
Hope that helps.. took me a bit to get it right.. everyone seems to have their own idea of how shm should be used. lol.<br />
<br />
BTW, not sure how the ftok works to be honest, cause I didn't change the __FILE__ to match the file path of test.php or anything.. I would think that the file path out have to be the exact same to work correctly.. oh well, it worked as-is! haha..<br />
<br />
- Cecil</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="18327""></a>
  <div class="note">
   <strong class="user">php at cytrax dot de</strong>
   <a href="#18327" class="date">18-Jan-2002 05:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The memsize needed for shared memory (tested on linux system) can be calculated with:<br />
<br />
For each varialbe you want to store: 24 Bytes<br />
+ serialized var-size (see below) alligned by 4 Bytes<br />
+ 16 Bytes<br />
<br />
For a update of a var with the same key, the memory for the old var will be needed extra.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="12087""></a>
  <div class="note">
   <strong class="user">koester at x-itec dot de</strong>
   <a href="#12087" class="date">21-Mar-2001 09:41</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
4194304 means 4 MB and NOT 4 GB for shared memory on FreeBSD. You can increase the shared memory at runtime if you like.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="10892""></a>
  <div class="note">
   <strong class="user">lew at persiankitty dot com</strong>
   <a href="#10892" class="date">25-Jan-2001 01:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Finding out shared memory kernel settings in FreeBSD:<br />
<br />
sys1# sysctl -a | grep -i SHM<br />
<br />
kern.ipc.shmmax: 4194304<br />
kern.ipc.shmmin: 1<br />
kern.ipc.shmmni: 96<br />
kern.ipc.shmseg: 64<br />
kern.ipc.shmall: 1024<br />
kern.ipc.shm_use_phys: 0<br />
<br />
Shows us that we can allocate a total of 4GB (wow) of shared memory, etc...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="1589""></a>
  <div class="note">
   <strong class="user">webmaster at mail dot communityconnect dot com</strong>
   <a href="#1589" class="date">10-Sep-1999 10:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
With Sun Solaris 2.x, the MAXIMUM shared memory value allowed is 1,048,576.&nbsp; The maximum allowed value can be determined using the command /usr/sbin/sysdef.&nbsp; On Linux, there does not seem to be any system enforced maximum size.&nbsp; To change the maximum allowed size on Solaris 2.x, use set shmsys:shminfo_shmmax=[new value].</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="671""></a>
  <div class="note">
   <strong class="user">h dot raaf at i-k-c dot net</strong>
   <a href="#671" class="date">25-Mar-1999 02:40</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Notice that 'int key' for shared-memory is shared with the keys used for semaphores. So you get in trouble when you use the same key value for semaphores and shared memory!</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="564""></a>
  <div class="note">
   <strong class="user">eric at superstats dot com</strong>
   <a href="#564" class="date">13-Feb-1999 04:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Objects are stored serialized in shm_put_var, so to find a value for memsize, you can use strlen(serialize($object_to_store_in_shm)).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.sem-remove.html">sem_remove</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.shm-detach.html">shm_detach</a></div>
 <div class="up"><a href="ref.sem.html">セマフォ関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
