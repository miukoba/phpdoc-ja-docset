<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>S/MIME メッセージを暗号化する</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.openssl-pkcs7-decrypt.html">openssl_pkcs7_decrypt</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.openssl-pkcs7-sign.html">openssl_pkcs7_sign</a></div>
 <div class="up"><a href="ref.openssl.html">OpenSSL 関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.openssl-pkcs7-encrypt" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">openssl_pkcs7_encrypt</h1>
  <p class="verinfo">(PHP 4 &gt;= 4.0.6, PHP 5)</p><p class="refpurpose"><span class="refname">openssl_pkcs7_encrypt</span> &mdash; <span class="dc-title">S/MIME メッセージを暗号化する</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.openssl-pkcs7-encrypt-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>openssl_pkcs7_encrypt</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$infile</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$outfile</code></span>
   , <span class="methodparam"><span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <code class="parameter">$recipcerts</code></span>
   , <span class="methodparam"><span class="type">array</span> <code class="parameter">$headers</code></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$flags</code><span class="initializer"> = 0</span></span>
   [, <span class="methodparam"><span class="type">int</span> <code class="parameter">$cipherid</code><span class="initializer"> = OPENSSL_CIPHER_RC2_40</span></span>
  ]] )</div>

  <p class="para rdfs-comment">
    <span class="function"><strong>openssl_pkcs7_encrypt()</strong></span> は、
   <em><code class="parameter">infile</code></em> という名前のファイルの内容を
   RC2 40 ビット暗号により暗号化します。この内容は、
   <em><code class="parameter">recipcerts</code></em>
   で指定した意図する受信者によってのみ読むことが可能です。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.openssl-pkcs7-encrypt-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term"><em><code class="parameter">infile</code></em></span>
     <dd>

      <p class="para">
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">outfile</code></em></span>
     <dd>

      <p class="para">
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">recipcerts</code></em></span>
     <dd>

      <p class="para">
       X.509 証明書または X.509 証明書の配列。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">headers</code></em></span>
     <dd>

      <p class="para">
       <em><code class="parameter">headers</code></em> は、
       暗号化された後にデータの前に付加されるヘッダの配列です。
      </p>
      <p class="para">
       <em><code class="parameter">headers</code></em>
       はヘッダ名をキーとする連想配列または添字配列であり、
       各要素には、各ヘッダ行が一行ずつ含まれています。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">flags</code></em></span>
     <dd>

      <p class="para">
       <em><code class="parameter">flags</code></em> は
       オプションとして使用可能であり、エンコード処理を変更するために指定します。
       <a href="openssl.pkcs7.flags.html" class="link">PKCS7 定数</a> を参照ください。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">cipherid</code></em></span>
     <dd>

      <p class="para">
       <a href="openssl.ciphers.html" class="link">暗号定数</a>のうちの一つ。
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.openssl-pkcs7-encrypt-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   成功した場合に <strong><code>TRUE</code></strong> を、失敗した場合に <strong><code>FALSE</code></strong> を返します。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.openssl-pkcs7-encrypt-changelog">
  <h3 class="title">変更履歴</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>バージョン</th>
       <th>説明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>5.0.0</td>
       <td>
        <em><code class="parameter">cipherid</code></em> パラメータが追加されました。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-function.openssl-pkcs7-encrypt-examples">
  <h3 class="title">例</h3>
  <p class="para">
   <div class="example" id="example-863">
    <p><strong>例1  <span class="function"><strong>openssl_pkcs7_encrypt()</strong></span> の例</strong></p>
    <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br /></span><span style="color: #FF8000">//&nbsp;暗号化するメッセージを&nbsp;nighthawk&nbsp;という名前の外部の秘密の<br />//&nbsp;エージェントに送信します。送信先の証明書をファイル&nbsp;nighthawk.pem&nbsp;に<br />//&nbsp;有しています。<br /></span><span style="color: #0000BB">$data&nbsp;</span><span style="color: #007700">=&nbsp;&lt;&lt;&lt;EOD<br /></span><span style="color: #DD0000">Nighthawk,<br /><br />Top&nbsp;secret,&nbsp;for&nbsp;your&nbsp;eyes&nbsp;only!<br /><br />The&nbsp;enemy&nbsp;is&nbsp;closing&nbsp;in!&nbsp;Meet&nbsp;me&nbsp;at&nbsp;the&nbsp;cafe&nbsp;at&nbsp;8.30am<br />to&nbsp;collect&nbsp;your&nbsp;forged&nbsp;passport!<br /><br />HQ<br /></span><span style="color: #007700">EOD;<br /><br /></span><span style="color: #FF8000">//&nbsp;キーを読み込む<br /></span><span style="color: #0000BB">$key&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">file_get_contents</span><span style="color: #007700">(</span><span style="color: #DD0000">"nighthawk.pem"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;ファイルにメッセージを保存<br /></span><span style="color: #0000BB">$fp&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">fopen</span><span style="color: #007700">(</span><span style="color: #DD0000">"msg.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"w"</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fwrite</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$data</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">fclose</span><span style="color: #007700">(</span><span style="color: #0000BB">$fp</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">//&nbsp;メッセージを暗号化<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">openssl_pkcs7_encrypt</span><span style="color: #007700">(</span><span style="color: #DD0000">"msg.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"enc.txt"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$key</span><span style="color: #007700">,<br />&nbsp;&nbsp;&nbsp;&nbsp;array(</span><span style="color: #DD0000">"To"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"nighthawk@example.com"</span><span style="color: #007700">,&nbsp;</span><span style="color: #FF8000">//&nbsp;連想配列の構文<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"From:&nbsp;HQ&nbsp;&lt;hq@example.com&gt;"</span><span style="color: #007700">,&nbsp;</span><span style="color: #FF8000">//&nbsp;添字配列の構文<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #DD0000">"Subject"&nbsp;</span><span style="color: #007700">=&gt;&nbsp;</span><span style="color: #DD0000">"Eyes&nbsp;only"</span><span style="color: #007700">)))&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">//&nbsp;メッセージを暗号化し、送信します!<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">exec</span><span style="color: #007700">(</span><span style="color: #0000BB">ini_get</span><span style="color: #007700">(</span><span style="color: #DD0000">"sendmail_path"</span><span style="color: #007700">)&nbsp;.&nbsp;</span><span style="color: #DD0000">"&nbsp;&lt;&nbsp;enc.txt"</span><span style="color: #007700">);<br />}<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
    </div>

   </div>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="107892""></a>
  <div class="note">
   <strong class="user">Anonymous</strong>
   <a href="#107892" class="date">13-Mar-2012 11:37</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
To build on what people have already done, below is a function that takes a from address, an array of e-mails/public keys, a subject, and a message and sends out an encrypted message using the appropriate public key.<br />
<br />
Since we're sending an encrypted message, the assumption is that what we're sending is actually critical. As a result the files used for sending the message are immediately shredded.<br />
<br />
$recipients = Array("user@example.com"=&gt;file_get_contents("cert.pem"));<br />
$body = 'secret text';<br />
&nbsp;&nbsp; sendSignedMail("me@examplel.com", $recipients, "Test Message", $body);<br />
<br />
&nbsp; //Recepients is an array of e-mail address=&gt;Key<br />
&nbsp; function sendSignedMail($from, $recepients, $subject, $body){<br />
&nbsp;&nbsp;&nbsp; foreach($recepients AS $email=&gt;$key){<br />
&nbsp;&nbsp; &nbsp;&nbsp; $tfn_in = tempnam("/tmp", "b");<br />
&nbsp;&nbsp; &nbsp;&nbsp; $tfn_out = tempnam("/tmp", "e");<br />
&nbsp;<br />
&nbsp;&nbsp; &nbsp;&nbsp; $handle = fopen($tfn_in, "w");<br />
&nbsp;&nbsp; &nbsp;&nbsp; fwrite($handle, $body);<br />
&nbsp;&nbsp; &nbsp;&nbsp; fclose($handle);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; openssl_pkcs7_encrypt($tfn_in, $tfn_out, $key,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; array("To" =&gt; $email,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; "From" =&gt; $from,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; "Subject" =&gt; $subject), 0);<br />
&nbsp;&nbsp; &nbsp;&nbsp; $data = file_get_contents($tfn_out);<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; //Shred the files since this is sensitive data.<br />
&nbsp;&nbsp; &nbsp;&nbsp; $handle = popen("/usr/bin/shred -n 3 -u $tfn_in", 'r');<br />
&nbsp;&nbsp; &nbsp;&nbsp; pclose($handle);<br />
&nbsp;&nbsp; &nbsp;&nbsp; $handle = popen("/usr/bin/shred -n 3 -u $tfn_out", 'r');<br />
&nbsp;&nbsp; &nbsp;&nbsp; pclose($handle);<br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp;&nbsp; $parts = explode("\n\n", $data, 2);//Fixes headers in mail function<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; mail($email, $subject, $parts[1], $parts[0]);<br />
&nbsp; <br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; <br />
&nbsp; }</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="107342""></a>
  <div class="note">
   <strong class="user">Ryan Schaffner</strong>
   <a href="#107342" class="date">02-Feb-2012 05:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
After tinkering around for about an hour, I found this that might help someone.&nbsp; When you export your certificate, make sure it is a base-64 certificate, as the DER-encoded cannot be read by these functions.&nbsp; Windows want's to default to DER.&nbsp; IT MUST BE Base-64 cert for these to work.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="96542""></a>
  <div class="note">
   <strong class="user">1matqo1 at azet dot sk</strong>
   <a href="#96542" class="date">04-Mar-2010 11:30</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For everyone who spent lots of time trying to encrypt multipart/alternative emailwith no success:<br />
<br />
1.) put complete email (header together with body) into file to encrypt as in example from koen:<br />
<span class="default">&lt;?php<br />
$body </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"body.txt"</span><span class="keyword">);<br />
</span><span class="default">$msg </span><span class="keyword">= </span><span class="default">$enc_header</span><span class="keyword">.</span><span class="default">$body</span><span class="keyword">;<br />
</span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="default">$msg</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
2.) headers array sent to openssl_pkcs7_encrypt can`t contain some of headers, it conflicts/doubles and some clients have problems with it - i.e. Thunderbird don`t show you email body. For me worked headers: "Subject", "To", "From", "Reply-To", "Date","Return-Receipt","Message-ID","CC", "X-Priority", "X-Mailer"<br />
<br />
one more thing - if your public key for encryption is not working, check if you are sending certificate with key, not only pure key(must be certificate)<br />
<br />
Good luck to everyone, its a little bit hard because of small amount of documentation which is sometimes confusing...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="84484""></a>
  <div class="note">
   <strong class="user">koen dot thomeer at pubmed dot be</strong>
   <a href="#84484" class="date">16-Jul-2008 03:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In the previous example, the decrypted message couldn't be read by the 'popular' mail clients. Those mail clients needed also headers in the encrypted part.<br />
<br />
I also noticed that there were some double headers in the previous example ('To:' and 'Subject:' were not overriden by the Headers parameter in mail()). This is also corrected by unsetting 'To:' and 'Subject:' in $headers_msg.<br />
<br />
body.txt is the file with the mail body.<br />
publickey.cer is the file with the public certificate.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// Setup mail headers.<br />
</span><span class="default">$headers </span><span class="keyword">= array(</span><span class="string">"From" </span><span class="keyword">=&gt; </span><span class="string">"from@mail.com"</span><span class="keyword">, </span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="string">"to@mail.com"</span><span class="keyword">, </span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">"Encrypted mail readable with most clients"</span><span class="keyword">, </span><span class="string">"X-Mailer" </span><span class="keyword">=&gt; </span><span class="string">"PHP/"</span><span class="keyword">.</span><span class="default">phpversion</span><span class="keyword">());<br />
<br />
</span><span class="comment">// Get the public key certificate.<br />
</span><span class="default">$pubkey </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"publickey.cer"</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Header for encrypted part<br />
</span><span class="default">$eol </span><span class="keyword">= </span><span class="string">"\r\n"</span><span class="keyword">;<br />
</span><span class="default">$enc_header </span><span class="keyword">.= </span><span class="string">"From: "</span><span class="keyword">.</span><span class="default">$headers</span><span class="keyword">[</span><span class="string">'From'</span><span class="keyword">].</span><span class="default">$eol</span><span class="keyword">;<br />
</span><span class="default">$enc_header </span><span class="keyword">.= </span><span class="string">"To: "</span><span class="keyword">.</span><span class="default">$headers</span><span class="keyword">[</span><span class="string">'To'</span><span class="keyword">].</span><span class="default">$eol</span><span class="keyword">;<br />
</span><span class="default">$enc_header </span><span class="keyword">.= </span><span class="string">"Subject: "</span><span class="keyword">.</span><span class="default">$headers</span><span class="keyword">[</span><span class="string">'Subject'</span><span class="keyword">].</span><span class="default">$eol</span><span class="keyword">;<br />
</span><span class="default">$enc_header </span><span class="keyword">.= </span><span class="string">"Content-Type: text/plain; format=flowed; charset=\"iso-8859-1\"; reply-type=original"</span><span class="keyword">.</span><span class="default">$eol</span><span class="keyword">;<br />
</span><span class="default">$enc_header </span><span class="keyword">.= </span><span class="string">"Content-Transfer-Encoding: 7bit"</span><span class="keyword">.</span><span class="default">$eol</span><span class="keyword">;<br />
</span><span class="default">$enc_header </span><span class="keyword">.= </span><span class="string">"\n"</span><span class="keyword">;<br />
<br />
</span><span class="comment">// Prepend header for encrypted message<br />
</span><span class="default">$body </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"body.txt"</span><span class="keyword">);<br />
</span><span class="default">$msg </span><span class="keyword">= </span><span class="default">$enc_header</span><span class="keyword">.</span><span class="default">$body</span><span class="keyword">;<br />
</span><span class="default">file_put_contents</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="default">$msg</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Remove some double headers for mail()<br />
</span><span class="default">$headers_msg </span><span class="keyword">= </span><span class="default">$headers</span><span class="keyword">;<br />
unset(</span><span class="default">$headers_msg</span><span class="keyword">[</span><span class="string">'To'</span><span class="keyword">], </span><span class="default">$headers_msg</span><span class="keyword">[</span><span class="string">'Subject'</span><span class="keyword">]);<br />
<br />
</span><span class="comment">// Encrypt message<br />
</span><span class="default">openssl_pkcs7_encrypt</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="string">"enc.txt"</span><span class="keyword">,</span><span class="default">$pubkey</span><span class="keyword">,</span><span class="default">$headers_msg</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Seperate headers and body for mail()<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"enc.txt"</span><span class="keyword">);<br />
</span><span class="default">$parts </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">"\n\n"</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);<br />
<br />
</span><span class="comment">// send mail <br />
</span><span class="default">mail</span><span class="keyword">(</span><span class="default">$headers</span><span class="keyword">[</span><span class="string">'To'</span><span class="keyword">], </span><span class="default">$headers</span><span class="keyword">[</span><span class="string">'Subject'</span><span class="keyword">], </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="55497""></a>
  <div class="note">
   <strong class="user">bob at bobscheffler dot com</strong>
   <a href="#55497" class="date">05-Aug-2005 02:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It's not worth it.&nbsp; Honestly, it would sound like a great idea, but it is such a pain in the arse.&nbsp; I have done so using asp, but have not yet found a way (or really tried for that matter) to do this using PGP.&nbsp; Using asp took me a full day to do (had to judo-kung foo chop a little for it to work correctly).&nbsp; Peace--</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="51006""></a>
  <div class="note">
   <strong class="user">ungdi at hotmail dot com</strong>
   <a href="#51006" class="date">16-Mar-2005 12:19</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Amongst the many discussions about signing or encrypting email by itself, none really discuss the pain of having an email BOTH signed AND encrypted.<br />
<br />
*** What do you do first? Sign then Encrypt? Or Encrypt then Sign?<br />
<br />
According to RFC 2311, you can encrypt then sign or sign then encrypt. However, it depends on the client in which you are programming for. In my experience, in Outlook 2000, it prefers it Encrypt then Sign. While in Outlook 2003, it is Sign then Encrypt. Generally, you want Sign then Encrypt, as it seems most logical from a snail-mail piece point of view. You first sign a letter than put it in an envelope. Certain clients complain if you do it in an order it does not like, so you may want to experiement with it.<br />
<br />
*** Example of doing both signing AND encrypting.<br />
<br />
When you perform the first function, do NOT put in any headers in the headers array parameters, you want to put it in the SECOND function you want to perform. If you put the headers in the first function, the second function will hide it from the mail servers. You do not want that. Here I will sign then encrypt.<br />
<br />
&lt;?<br />
// Setup mail headers.<br />
$headers = array("To" =&gt; "someone@nowhere.net",<br />
&nbsp;&nbsp; &nbsp; "From" =&gt; "noone@somewhere.net",<br />
&nbsp;&nbsp; &nbsp; "Subject" =&gt; "A signed and encrypted message.");<br />
<br />
// Sign the message first<br />
openssl_pkcs7_sign("msg.txt","signed.txt",<br />
&nbsp;&nbsp; &nbsp; "signing_cert.pem",array("private_key.pem",<br />
&nbsp;&nbsp; &nbsp; "password"),array());<br />
<br />
// Get the public key certificate.<br />
$pubkey = file_get_contents("cert.pem");<br />
<br />
//encrypt the message, now put in the headers.<br />
openssl_pkcs7_encrypt("signed.txt", "enc.txt",<br />
&nbsp;&nbsp; &nbsp; $pubkey,$headers,0,1);<br />
<br />
$data = file_get_contents("enc.txt");<br />
<br />
// separate header and body, to use with mail function<br />
//&nbsp; unfortunate but required, else we have two sets of headers<br />
//&nbsp; and the email client doesn't decode the attachment<br />
$parts = explode("\n\n", $data, 2);<br />
<br />
// send mail (headers in the Headers parameter will override those<br />
//&nbsp; generated for the To &amp; Subject parameters)<br />
mail($mail, $subject, $parts[1], $parts[0]);<br />
?&gt;<br />
<br />
Note that if you use a function that picks up the data from the disk to be used in another function in your program, remember that you may have used the explode("\n\n",$data,2) function which may have removed the spacing between the header and the message content. <br />
<br />
When you take the signed message and feed it in to the encryption part, you have to remember that the line spacing must also be fed AS PART OF THE MESSAGE BODY! If you plan to sign then encrypt, do not feed the header output from the signing into the encrypting as part of the headers array parameter! The output of the signing should stay as part of the message body being encrypted. (And the same is true if you are doing the reverse of encrypting then signing.) An example of both the signing and encryption function made in to a routine for reusability, and then called to sign and encrypt a message.<br />
<br />
*** Example of signing and encrypting executed from a routine function for code reusability through a program.<br />
<br />
THIS IS WRONG!:<br />
&lt;?<br />
// [0] of Array contains headers of message. [1] of Array contains signed body of message.<br />
$signedOutputArray = signMessage($inputMessage,$headers);<br />
<br />
// [0] of Array contains headers of message and the signing.<br />
// [1] of Array contains encrypted body of message without the signing header.<br />
$signedAndEncryptedArray = encryptMessage($signedOutputArray[1],<br />
&nbsp;&nbsp; &nbsp; $signedOutputArray[0]);<br />
<br />
mail($emailAddr,$subject,$signedAndEncryptedArray[1],<br />
&nbsp;&nbsp; &nbsp;&nbsp; $signedAndEncryptedArray[0]);<br />
?&gt;<br />
<br />
THIS IS CORRECT!<br />
&lt;?<br />
// [0] of Array contains headers of signing.<br />
// [1] of Array contains signed body of message.<br />
$signedOutputArray = signMessage($inputMessage,array());<br />
<br />
// [0] of Array contains headers of message.<br />
// [1] of Array contains encrypted contents of both the signed message and its headers of the signing.<br />
$signedAndEncryptedArray = <br />
&nbsp;&nbsp; &nbsp; encryptMessage($signedOutputArray[0] . "\n\n" . $signedOutputArray[1],$headers);<br />
<br />
mail($emailAddr,$subject,$signedAndEncryptedArray[1],<br />
&nbsp;&nbsp; &nbsp; $signedAndEncryptedArray[0]);<br />
?&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="44669""></a>
  <div class="note">
   <strong class="user">ungdi AT hotmail DOT com</strong>
   <a href="#44669" class="date">12-Aug-2004 08:07</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As of PHP 5.0.0, you have the ability to choose between 64 bit RC2 encryption OR 128 bit RC2 encryption.<br />
<br />
The new function description should now be:<br />
bool openssl_pkcs7_encrypt ( string infile, string outfile, mixed recipcerts, array headers [, int flags] [,int cipher])<br />
<br />
Where the int value of cipher is 0 or 1. 0 = 64 bit and 1 = 128 bit.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="36598""></a>
  <div class="note">
   <strong class="user">richardaburton at hotmail dot com</strong>
   <a href="#36598" class="date">16-Oct-2003 02:38</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Using sendmail isn't very portable, and seems daft since PHP has the mail function which will do the job. Problem is how do you use the mail function to send this email, since it's already complete with headers?<br />
<br />
If you pull in the contents of the file produced by openssl_pkcs7_encrypt and pass this as the message data to the mail command, you end up with an email with two sets of headers (one set from the encrypt function, another added by the mail command). The result is that the second set of headers (which tell the mail client the email is encrypted) get ignored and the (base64 encoded) encrypted mail is shown as-is, rather than being decrypted.<br />
<br />
The solution is quite simple, but it took me a little while to think of it, so I'm sharing it here. Once you load the contents of the file, split the headers off the body. Then pass the headers as the additional_headers parameter to the mail function, and just the body of the email as the message parameter of the mail function.<br />
<br />
You will need to specify the to &amp; subject parameters, but these will be overriden in the final email (as delievered to the recipiant) by the ones from the real encrypted email.<br />
<br />
<span class="default">&lt;?php<br />
<br />
$pubkey </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"cert.pem"</span><span class="keyword">);<br />
<br />
</span><span class="default">openssl_pkcs7_encrypt</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="string">"enc.txt"</span><span class="keyword">, </span><span class="default">$pubkey</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="string">"nighthawk@example.com"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"From" </span><span class="keyword">=&gt; </span><span class="string">"HQ &lt;hq@example.com&gt;"</span><span class="keyword">,<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">"Eyes only"</span><span class="keyword">), </span><span class="default">0</span><span class="keyword">)<br />
<br />
</span><span class="default">$data </span><span class="keyword">= </span><span class="default">file_get_contents</span><span class="keyword">(</span><span class="string">"enc.txt"</span><span class="keyword">);<br />
<br />
</span><span class="comment">// separate header and body, to use with mail function<br />
//&nbsp; unfortunate but required, else we have two sets of headers<br />
//&nbsp; and the email client doesn't decode the attachment<br />
</span><span class="default">$parts </span><span class="keyword">= </span><span class="default">explode</span><span class="keyword">(</span><span class="string">"\n\n"</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);<br />
<br />
</span><span class="comment">// send mail (headers in the Headers parameter will override those<br />
//&nbsp; generated for the To &amp; Subject parameters)<br />
</span><span class="default">mail</span><span class="keyword">(</span><span class="default">$mail</span><span class="keyword">, </span><span class="default">$subject</span><span class="keyword">, </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">$parts</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">]);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Richard.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="36596""></a>
  <div class="note">
   <strong class="user">richardaburton at hotmail dot com</strong>
   <a href="#36596" class="date">16-Oct-2003 02:31</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you don't like the idea of only using RC2/40bit you can always recompile the php_openssl extension. Simply search through the extensions openssl.c source file for the EVP_rc2_40_cbc() call, which selects this cipher. Replace the call to select another better cipher such as EVP_rc2_cbc() (RC2/128bit) or EVP_des_ede3_cbc() (triple-DES).<br />
<br />
I patched the source to allow the selection of cipher as an extra parameter, but got the latest source from CVS to submit a patch and it appears the work has already been done, so looks like we will see this feature in pretty soon.<br />
<br />
Richard.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="32206""></a>
  <div class="note">
   
   <a href="#32206" class="date">20-May-2003 05:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
It is a bit scary to use only RC2/40bit considering that has been already so exposed as vulnerable to brute-force cracking (see for example www.distributed.net)<br />
<br />
Here is an alternate method which allows stronger encryption (128bit.) This works on Solaris 8 but could be adapted for e.g. Linux by removing the "-rand" parameter and its randomfile name.<br />
<br />
-------------snippet-------------------<br />
<br />
$execstring=&nbsp; "echo \"" . $yourbodytext . "\" | /usr/local/ssl/bin/openssl smime -encrypt -rc2-128 -rand /usr/local/apache/yoursecuredir/randomfile -text&nbsp; -to " .&nbsp; $recipient . " -from someuser@example.com -subject \"" . $subject . "\"&nbsp; /usr/local/apache/yoursecuredir/usercerts/someuser.pem | /usr/lib/sendmail -t";<br />
<br />
exec($execstring,$returndata,$resultcode);<br />
<br />
-------------snippet-------------------<br />
<br />
It requires the .pem format for the user certificate.&nbsp; Assuming you already got a certificate from a commercial CA such as www.thawte.com then it is fairly simple to export it from your browser WITHOUT --REPEAT-- WITHOUT its private key and copy it to the PHP/web server. The export process is browser-specific but assuming MS Internet Explorer you require the menu selection tools -&gt; internet options -&gt; content -&gt; certificates -&gt; (highlight your cert in the list) -&gt; export wizard.<br />
<br />
The exported file will probably be in DER-encoded binary<br />
with a name like "whatever.CER" and you need to convert it to Privacy Enhanced message (PEM) format. Typically you would now transfer the file to the *nix machine and the command for doing this conversion is, for example:<br />
<br />
/usr/local/ssl/bin/openssl x509 -inform DER -outform PEM -in someuser.cer -out someuser.pem<br />
<br />
When adapting this code it is of course as always vital to ensure that the values ($recipient etc.) being passed into the system call are acquired in a clean way that avoids trusting user-supplied data.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="31786""></a>
  <div class="note">
   <strong class="user">glyn at tomkins dot net</strong>
   <a href="#31786" class="date">03-May-2003 10:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I have been struggling to get openssl_pkcs7_encrypt() to work just as I need it to do but through my perseverence I have prevailed.&nbsp; The issues I came across were due to my very incomplete understanding of S/MIME, MIME and email headers.<br />
<br />
First, both the example in the manual and the correction offered by msisolak above are also slightly incorrect.&nbsp; Let me explain in lay terms how the problem arises ... <br />
<br />
email messages are constructed as follows<br />
<br />
headers<br />
blank line<br />
content<br />
<br />
For S/MIME, the message is encrypted (including headers) and further headers are wrapped around the encrypted message, like so: <br />
<br />
S/MIME headers<br />
blank line<br />
encrypted MIME headers<br />
encrypted blank line<br />
encrypted content<br />
<br />
If you have no headers in what you are encrypting then anything before the 1st blank line is regarded as headers and doesn't appear in the content of your message.<br />
<br />
openssl_pkcs7_encrypt() creates the entire encrypted portion so if you do not include any headers in your infile then you will find that some of your message may be treated as headers unless you make the first line of your file a blank line.<br />
<br />
There is also an error in the way the "From" S/MIME header is coded on the call to openssl_pkcs7_encrypt(). <br />
<br />
So the example, to work 100% correctly needs to read as follows: <br />
<br />
// the message you want to encrypt and send to your secret agent<br />
// in the field, known as nighthawk.&nbsp; You have his certificate<br />
// in the file nighthawk.pem<br />
//<br />
//Note the first line must be blank as i am providing no headers inside the secure portion of the mail.<br />
$data = &lt;&lt;&lt;EOD<br />
<br />
Nighthawk,<br />
<br />
Top secret, for your eyes only!<br />
<br />
The enemy is closing in! Meet me at the cafe at 8.30am<br />
to collect your forged passport!<br />
<br />
HQ<br />
EOD;<br />
<br />
// load key<br />
$key = implode("", file("my.pem"));<br />
<br />
// save message to file<br />
$fp = fopen("msg.txt", "w");<br />
fwrite($fp, $data);<br />
fclose($fp);<br />
<br />
// encrypt it<br />
if (openssl_pkcs7_encrypt("msg.txt", "enc.txt", $key,<br />
&nbsp; array("To" =&gt; "you@yourdomain.com", // keyed syntax<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; "From" =&gt; "HQ &lt;hq@cia.com&gt;", // indexed syntax<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; "Subject" =&gt; "Eyes only")))<br />
{<br />
&nbsp;&nbsp; // message encrypted - send it!<br />
&nbsp; exec(ini_get("sendmail_path") . " &lt; enc.txt");<br />
}<br />
<br />
Now,&nbsp; I wanted to make a couple of other enhancements. My email contained html content and must be formatted when displayed in the email client and I also wanted to use temporary file names to allow multiple users to use the script at the same time. Finally, I wanted to remove these temporary files afterwards.&nbsp;&nbsp; <br />
<br />
Here is how the example ends up with these additional enhancements:<br />
<br />
&lt;?<br />
<br />
// the message you want to encrypt and send to your secret agent<br />
// in the field, known as nighthawk.&nbsp; You have his certificate<br />
// in the file my.pem<br />
//<br />
//Note the blank line&nbsp; following the Content-type header<br />
//<br />
$data = &lt;&lt;&lt;EOD<br />
MIME-Version: 1.0<br />
Content-type: text/html; charset=iso-8859-1<br />
<br />
&lt;html&gt;<br />
&lt;b&gt;Nighthawk&lt;/b&gt;,<br />
&lt;h1&gt;Top secret, for your eyes only!&lt;/h1&gt;<br />
&lt;p&gt;The enemy is closing in! Meet me at the cafe at 8.30am<br />
to collect your forged passport!&lt;/p&gt;<br />
&lt;p&gt;HQ&lt;/p&gt;<br />
&lt;/html&gt;<br />
EOD;<br />
<br />
// load key<br />
$key = implode("", file("my.pem"));<br />
<br />
// generate a unique temporary file name.&nbsp; Use .txt for the clear text version and .enc for the encrypted version.<br />
$clearfile = tempnam("temp","email") . ".txt";<br />
$encfile = $clearfile . ".enc";<br />
$clearfile .= ".txt";<br />
<br />
$fp = fopen($clearfile, "w");<br />
fwrite($fp, $data);<br />
fclose($fp);<br />
<br />
// encrypt it<br />
if (openssl_pkcs7_encrypt($clearfile,$encfile, $key,<br />
&nbsp; array("To" =&gt; "you@yourdomain.com", // keyed syntax<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; "From" =&gt; "HQ &lt;hq@cia.com&gt;", // indexed syntax<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; "Subject" =&gt; "Eyes only")))<br />
{<br />
&nbsp;&nbsp; // message encrypted - send it!<br />
&nbsp; exec(ini_get("sendmail_path") . " &lt; $encfile");<br />
<br />
};<br />
// now erase the temp files<br />
unlink($clearfile);<br />
unlink($encfile);<br />
<br />
?&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="21823""></a>
  <div class="note">
   <strong class="user">msisolak at yahoo dot com</strong>
   <a href="#21823" class="date">28-May-2002 09:14</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For those trying to use this function from Windows with a key in Outlook or Outlook Express it can be tricky to figure out how to get the key exported in the format that OpenSSL is looking for.&nbsp; Since all (at least all Microsoft) products share a common key store, it's easier to export the key from IE than Outlook.<br />
<br />
In IE select Tools -&gt; Internet Options, then the "Content" tab, and click the Certificates button.&nbsp; Select your certificate from the list and click the Export button.&nbsp; To encrypt email you only want your public key exported in the "Base-64 encoded X.509 (.CER)" format.&nbsp; The file this procedure creates can be directly used as a key file to S/MIME encrypt with openssl-pkcs7-encrypt.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="21030""></a>
  <div class="note">
   <strong class="user">msisolak at yahoo dot com</strong>
   <a href="#21030" class="date">26-Apr-2002 12:24</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The example code is wrong (at least as of 4.2.0).&nbsp; The recipcerts parameter is either the actual text of the base64 encoded key file, or it must be a filename in "file://..." format.&nbsp; A normal path will not work (OpenSSL tries to use the path as the actual certificate).&nbsp; The above code works as:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">// the message you want to encrypt and send to your secret agent<br />
// in the field, known as nighthawk.&nbsp; You have his certificate<br />
// in the file nighthawk.pem<br />
</span><span class="default">$data </span><span class="keyword">= &lt;&lt;&lt;EOD<br />
</span><span class="string">Nighthawk,<br />
<br />
Top secret, for your eyes only!<br />
<br />
The enemy is closing in! Meet me at the cafe at 8.30am<br />
to collect your forged passport!<br />
<br />
HQ<br />
</span><span class="keyword">EOD;<br />
<br />
</span><span class="comment">// load key<br />
</span><span class="default">$key </span><span class="keyword">= </span><span class="default">implode</span><span class="keyword">(</span><span class="string">""</span><span class="keyword">, </span><span class="default">file</span><span class="keyword">(</span><span class="string">"my.pem"</span><span class="keyword">));<br />
<br />
</span><span class="comment">// save message to file<br />
</span><span class="default">$fp </span><span class="keyword">= </span><span class="default">fopen</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="string">"w"</span><span class="keyword">);<br />
</span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="default">$data</span><span class="keyword">);<br />
</span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
<br />
</span><span class="comment">// encrypt it<br />
</span><span class="keyword">if (</span><span class="default">openssl_pkcs7_encrypt</span><span class="keyword">(</span><span class="string">"msg.txt"</span><span class="keyword">, </span><span class="string">"enc.txt"</span><span class="keyword">, </span><span class="default">$key</span><span class="keyword">,<br />
&nbsp;&nbsp;&nbsp; array(</span><span class="string">"To" </span><span class="keyword">=&gt; </span><span class="string">"example@example.com"</span><span class="keyword">, </span><span class="comment">// keyed syntax<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"From: HQ &lt;hq@cia.com&gt;"</span><span class="keyword">, </span><span class="comment">// indexed syntax<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="string">"Subject" </span><span class="keyword">=&gt; </span><span class="string">"Eyes only"</span><span class="keyword">)))<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// message encrypted - send it!<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">exec</span><span class="keyword">(</span><span class="default">ini_get</span><span class="keyword">(</span><span class="string">"sendmail_path"</span><span class="keyword">) . </span><span class="string">" &lt; enc.txt"</span><span class="keyword">);<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
[You can also pass an array of recipcerts values, but I haven't used that so I don't know what it's expecting.]</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.openssl-pkcs7-decrypt.html">openssl_pkcs7_decrypt</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.openssl-pkcs7-sign.html">openssl_pkcs7_sign</a></div>
 <div class="up"><a href="ref.openssl.html">OpenSSL 関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
