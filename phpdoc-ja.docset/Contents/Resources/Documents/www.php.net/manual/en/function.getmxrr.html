<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>指定したインターネットホスト名に対応する MX レコードを取得する</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.gethostname.html">gethostname</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.getprotobyname.html">getprotobyname</a></div>
 <div class="up"><a href="ref.network.html">ネットワーク 関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="function.getmxrr" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">getmxrr</h1>
  <p class="verinfo">(PHP 4, PHP 5)</p><p class="refpurpose"><span class="refname">getmxrr</span> &mdash; <span class="dc-title">指定したインターネットホスト名に対応する MX レコードを取得する</span></p>

 </div>
 
 <div class="refsect1 description" id="refsect1-function.getmxrr-description">
  <h3 class="title">説明</h3>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>getmxrr</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$hostname</code></span>
   , <span class="methodparam"><span class="type">array</span> <code class="parameter reference">&$mxhosts</code></span>
   [, <span class="methodparam"><span class="type">array</span> <code class="parameter reference">&$weight</code></span>
  ] )</div>

  <p class="para rdfs-comment">
   <em><code class="parameter">hostname</code></em>
   に対応する MX レコードを DNS から探します。
  </p>
 </div>


 <div class="refsect1 parameters" id="refsect1-function.getmxrr-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    <dt>

     <span class="term"><em><code class="parameter">hostname</code></em></span>
     <dd>

      <p class="para">
       インターネットホスト名。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">mxhosts</code></em></span>
     <dd>

      <p class="para">
       見つかった MX レコードのリストが、配列
       <em><code class="parameter">mxhosts</code></em> に格納されます。
      </p>
     </dd>

    </dt>

    <dt>

     <span class="term"><em><code class="parameter">weight</code></em></span>
     <dd>

      <p class="para">
       配列 <em><code class="parameter">weight</code></em> を指定すると、
       そこに重み情報が格納されます。
      </p>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-function.getmxrr-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   何かレコードが見つかった場合に <strong><code>TRUE</code></strong>、
   何も見つからないかエラーが発生した場合に <strong><code>FALSE</code></strong> を返します。
  </p>
 </div>


 <div class="refsect1 changelog" id="refsect1-function.getmxrr-changelog">
  <h3 class="title">変更履歴</h3>
  <p class="para">
   <table class="doctable informaltable">
    
     <thead>
      <tr>
       <th>バージョン</th>
       <th>説明</th>
      </tr>

     </thead>

     <tbody class="tbody">
      <tr>
       <td>5.3.0</td>
       <td>
         この関数は、Windows プラットフォームでも動作するようになりました。
       </td>
      </tr>

     </tbody>
    
   </table>

  </p>
 </div>


 <div class="refsect1 notes" id="refsect1-function.getmxrr-notes">
  <h3 class="title">注意</h3>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <p class="para">
    この関数をメールアドレスの確認の目的で使用すべきではありません。
    DNS が検出したメールエクスチェンジャーを返すだけです。
    しかし、<a href="http://www.faqs.org/rfcs/rfc2821" class="link external" title="Link : http://www.faqs.org/rfcs/rfc2821">&raquo;&nbsp;RFC 2821</a> によれば、
    メールエクスチェンジャーがひとつも見つからなければ、
    <em><code class="parameter">hostname</code></em> 自体が唯一のメールエクスチェンジャー
    であるとみなされ、その優先度は <em>0</em>（最高）となります。
   </p>
  </p></blockquote>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <p class="para">
    この関数が実装される前の Windows での互換性を保つには、
    <a href="http://pear.php.net/" class="link external" title="Link : http://pear.php.net/">&raquo;&nbsp;PEAR</a> の
    <a href="http://pear.php.net/package/Net_DNS" class="link external" title="Link : http://pear.php.net/package/Net_DNS">&raquo;&nbsp;Net_DNS</a> クラスを試してみてください。
   </p>
  </p></blockquote>
 </div>


 <div class="refsect1 seealso" id="refsect1-function.getmxrr-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"> <span class="function"><a href="function.checkdnsrr.html" class="function" rel="rdfs-seeAlso">checkdnsrr()</a> - 指定したインターネットホスト名もしくは IP アドレスに対応する DNS レコードを検索する</span></li>
    <li class="member"> <span class="function"><a href="function.dns-get-record.html" class="function" rel="rdfs-seeAlso">dns_get_record()</a> - ホスト名に関連する DNS リソースレコードを取得する</span></li>
    <li class="member"> <span class="function"><a href="function.gethostbyname.html" class="function" rel="rdfs-seeAlso">gethostbyname()</a> - インターネットホスト名に対応するIPv4アドレスを取得する</span></li>
    <li class="member"> <span class="function"><a href="function.gethostbynamel.html" class="function" rel="rdfs-seeAlso">gethostbynamel()</a> - 指定したインターネットホスト名に対応するIPv4アドレスのリストを取得する</span></li>
    <li class="member"> <span class="function"><a href="function.gethostbyaddr.html" class="function" rel="rdfs-seeAlso">gethostbyaddr()</a> - 指定した IP アドレスに対応するインターネットホスト名を取得する</span></li>
    <li class="member"><em>named(8)</em> のマニュアルページ</li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="103123""></a>
  <div class="note">
   <strong class="user">Robert Imhoff</strong>
   <a href="#103123" class="date">27-Mar-2011 03:21</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I tried using getmxrr() to validate the domain portion of email addresses in enquiry submission forms, and there is a curious effect with some top-level domains when checking non-existant domains.<br />
<br />
With sdlkfjsdl.com, since the domain does not exist, getmxrr() returns false, as expected, and the returned mxhosts array is empty.<br />
<br />
But with sdlkfjsdl.gov, getmxrr() returns true,&nbsp; and the returned mxhosts array contains one element: NULL<br />
<br />
With sdlkfjsdl.org, getmxrr() returns true,&nbsp; and the returned mxhosts array contains one element: '0.0.0.0'<br />
<br />
With sdlkfjsdl.co.uk, getmxrr()&nbsp; returns true and supplies one MX record: uk-net-wildcard-null-mx.centralnic.net<br />
<br />
So to validate the email domain, it would seem one has to check the returned mxhosts array to exclude the possibility of mxhosts being returned as NULL, 0.0.0.0 and wildcard ...</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="88033""></a>
  <div class="note">
   <strong class="user">php [spat] hm2k.org</strong>
   <a href="#88033" class="date">06-Jan-2009 11:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I decided to have a bash at this after doing a bit of research...<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">// getmxrr() support for Windows by HM2K &lt;php [spat] hm2k.org&gt;<br />
</span><span class="keyword">function </span><span class="default">win_getmxrr</span><span class="keyword">(</span><span class="default">$hostname</span><span class="keyword">, &amp;</span><span class="default">$mxhosts</span><span class="keyword">, &amp;</span><span class="default">$mxweight</span><span class="keyword">=</span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">strtoupper</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">PHP_OS</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">)) != </span><span class="string">'WIN'</span><span class="keyword">) return;<br />
&nbsp;&nbsp;&nbsp; if (!</span><span class="default">is_array </span><span class="keyword">(</span><span class="default">$mxhosts</span><span class="keyword">) ) </span><span class="default">$mxhosts </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; if (empty(</span><span class="default">$hostname</span><span class="keyword">)) return;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$exec</span><span class="keyword">=</span><span class="string">'nslookup -type=MX '</span><span class="keyword">.</span><span class="default">escapeshellarg</span><span class="keyword">(</span><span class="default">$hostname</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; @</span><span class="default">exec</span><span class="keyword">(</span><span class="default">$exec</span><span class="keyword">, </span><span class="default">$output</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (empty(</span><span class="default">$output</span><span class="keyword">)) return;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">=-</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; foreach (</span><span class="default">$output </span><span class="keyword">as </span><span class="default">$line</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">"/^</span><span class="default">$hostname</span><span class="string">\tMX preference = ([0-9]+), mail exchanger = (.+)$/i"</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">, </span><span class="default">$parts</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$mxweight</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$mxhosts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">'/responsible mail addr = (.+)$/i'</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">, </span><span class="default">$parts</span><span class="keyword">)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$mxweight</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">$i</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$mxhosts</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">trim</span><span class="keyword">(</span><span class="default">$parts</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return (</span><span class="default">$i</span><span class="keyword">!=-</span><span class="default">1</span><span class="keyword">);<br />
}<br />
<br />
</span><span class="comment">// Define<br />
</span><span class="keyword">if (!</span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">'getmxrr'</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; function </span><span class="default">getmxrr</span><span class="keyword">(</span><span class="default">$hostname</span><span class="keyword">, &amp;</span><span class="default">$mxhosts</span><span class="keyword">, &amp;</span><span class="default">$mxweight</span><span class="keyword">=</span><span class="default">false</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">win_getmxrr</span><span class="keyword">(</span><span class="default">$hostname</span><span class="keyword">, </span><span class="default">$mxhosts</span><span class="keyword">, </span><span class="default">$mxweight</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
<br />
</span><span class="comment">/* example */<br />
<br />
</span><span class="default">$domain</span><span class="keyword">=</span><span class="string">'php.net'</span><span class="keyword">;<br />
echo </span><span class="string">"&lt;pre&gt;"</span><span class="keyword">;<br />
</span><span class="default">getmxrr</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">,</span><span class="default">$mxhosts</span><span class="keyword">,</span><span class="default">$mxweight</span><span class="keyword">);<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$mxhosts</span><span class="keyword">);<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$mxweight</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="79782""></a>
  <div class="note">
   <strong class="user">TZ at inpetho dot net</strong>
   <a href="#79782" class="date">12-Dec-2007 07:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If greylisting is installed on the mx host then he send a "451 4.7.1 Please try again later"<br />
<br />
My code fragment:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="comment">//...<br />
</span><span class="keyword">foreach (</span><span class="default">$mx_records </span><span class="keyword">as </span><span class="default">$mx_host</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$code </span><span class="keyword">= </span><span class="default">CheckMX</span><span class="keyword">(</span><span class="default">$mx_host</span><span class="keyword">, </span><span class="default">$eMail</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$code </span><span class="keyword">== </span><span class="default">0</span><span class="keyword">)&nbsp; &nbsp; continue; </span><span class="comment">// host not found<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$code </span><span class="keyword">== </span><span class="default">451</span><span class="keyword">)&nbsp; &nbsp; </span><span class="default">$code </span><span class="keyword">= </span><span class="default">CheckMX</span><span class="keyword">(</span><span class="default">$mx_host</span><span class="keyword">, </span><span class="default">$eMail</span><span class="keyword">); </span><span class="comment">// Greylisting<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">$code </span><span class="keyword">== </span><span class="default">250</span><span class="keyword">)&nbsp; &nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$ok </span><span class="keyword">= </span><span class="default">true</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; break;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="comment">//...<br />
<br />
</span><span class="keyword">function </span><span class="default">CheckMX</span><span class="keyword">(</span><span class="default">$mx_host</span><span class="keyword">, </span><span class="default">$eMail</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$code </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$fp </span><span class="keyword">= @</span><span class="default">fsockopen</span><span class="keyword">(</span><span class="default">$mx_host</span><span class="keyword">, </span><span class="default">25</span><span class="keyword">, </span><span class="default">$errno</span><span class="keyword">, </span><span class="default">$errstr</span><span class="keyword">, </span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">$fp</span><span class="keyword">)&nbsp; &nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">send_command</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'HELO microsoft.com'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">send_command</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'MAIL FROM:&lt;support@microsoft.com&gt;'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$erg </span><span class="keyword">= </span><span class="default">send_command</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">, </span><span class="string">'RCPT TO:&lt;'</span><span class="keyword">.</span><span class="default">$eMail</span><span class="keyword">.</span><span class="string">'&gt;'</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$fp</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$code </span><span class="keyword">= </span><span class="default">intval</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$erg</span><span class="keyword">, </span><span class="default">0</span><span class="keyword">, </span><span class="default">3</span><span class="keyword">));<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return </span><span class="default">$code</span><span class="keyword">;<br />
}<br />
</span><span class="comment">//...<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="77751""></a>
  <div class="note">
   <strong class="user">Jay</strong>
   <a href="#77751" class="date">12-Sep-2007 01:10</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
As stated, some of the code listed below will have trouble with multiple equal weights, such as if you query gmail.com. The following code will prevent that by switching the key/values.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">// Get the records<br />
</span><span class="default">getmxrr</span><span class="keyword">(</span><span class="string">"gmail.com"</span><span class="keyword">, </span><span class="default">$mx_records</span><span class="keyword">, </span><span class="default">$mx_weight</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Put the records together in a array we can sort<br />
</span><span class="keyword">for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">count</span><span class="keyword">(</span><span class="default">$mx_records</span><span class="keyword">);</span><span class="default">$i</span><span class="keyword">++){<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mxs</span><span class="keyword">[</span><span class="default">$mx_records</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">]] = </span><span class="default">$mx_weight</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];<br />
}<br />
<br />
</span><span class="comment">// Sort them<br />
</span><span class="default">asort </span><span class="keyword">(</span><span class="default">$mxs</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Since the keys actually hold the data we want, just put those in an array, called records&nbsp; &nbsp;&nbsp; <br />
</span><span class="default">$records </span><span class="keyword">= </span><span class="default">array_keys</span><span class="keyword">(</span><span class="default">$mxs</span><span class="keyword">);<br />
<br />
</span><span class="comment">// Simply echoes all the stuff in the records array&nbsp; &nbsp;&nbsp; <br />
</span><span class="keyword">for(</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$i </span><span class="keyword">&lt; </span><span class="default">count</span><span class="keyword">(</span><span class="default">$records</span><span class="keyword">); </span><span class="default">$i</span><span class="keyword">++){<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">$records</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="string">'&lt;br&gt;'</span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
If you wanted to get the weight, you would use "array_values($mxs);" instead of "array_keys($mxs);".<br />
<br />
Hope this helps some people.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="70575""></a>
  <div class="note">
   <strong class="user">tomhutter at web dot de</strong>
   <a href="#70575" class="date">20-Oct-2006 09:50</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Leonardt's code fails with multiple mx records with the same wight. You can easily change this by switching keys and values in the mxs array:<br />
<br />
&nbsp;&nbsp; &nbsp; for($i=0;$i&lt;count($mx_records);$i++){<br />
&nbsp;&nbsp; &nbsp; &nbsp; $mxs[$mx_records[$i]] = $mx_weight[$i];<br />
&nbsp;&nbsp; &nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; arsort ($mxs );<br />
&nbsp;&nbsp; &nbsp; reset ($mxs);<br />
<br />
&nbsp;&nbsp;&nbsp; while (list ($mx_host, $mx_weight) = each ($mxs) ) {<br />
<br />
cheers <br />
<br />
Tom</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="70401""></a>
  <div class="note">
   <strong class="user">php dot net at oitc dot com</strong>
   <a href="#70401" class="date">15-Oct-2006 02:28</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This function has some strange side effects when dealing with aliases...<br />
<br />
My function:<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (getmxrr($fqdn, $mx_records, $mx_weight)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // copy mx records and weight into array $mxs<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // ignore multiple mx's at the same weight<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; for ($i = 0; $i &lt; count($mx_records); $i++) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $mxs[$mx_weight[$i]] = $mx_records[$i];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // sort array mxs to get servers with highest priority<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; ksort ($mxs, SORT_NUMERIC);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; reset ($mxs);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; // No MX so use A<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $mxs[0]= $fqdn;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
fails because a $fqdn containing an alias returns a true yet on return both $mx_records and $mx_weight contain nothing!<br />
<br />
The solution until this gets fixed is to replace if (getmxrr($fqdn, $mx_records, $mx_weight)) with<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // Handle aliases etc.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ($result = getmxrr($fqdn, $mx_records, $mx_weight)) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(!isset($mx_records) || (count($mx_records) == 0)) $result = false;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; // Process MXs<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if ($result) {<br />
<br />
Hope this helps others....&nbsp; Tom</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="69869""></a>
  <div class="note">
   <strong class="user">MagicalTux at ooKoo dot org</strong>
   <a href="#69869" class="date">24-Sep-2006 04:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you want to use getmxrr on windows, be careful as choward AT fast DOT net DOT NO SPAM PLZ's function has a security flaw.<br />
<br />
It passes its argument to an external command without escaping it. If you don't validate the input, someone may manage to run nasty things on your system.<br />
<br />
Here's a fixed version (just added escapeshellarg())<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">getmxrr</span><span class="keyword">(</span><span class="default">$hostname</span><span class="keyword">, &amp;</span><span class="default">$mxhosts</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mxhosts </span><span class="keyword">= array();<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">exec</span><span class="keyword">(</span><span class="string">'%SYSTEMDIRECTORY%\\nslookup.exe -q=mx '</span><span class="keyword">.</span><span class="default">escapeshellarg</span><span class="keyword">(</span><span class="default">$hostname</span><span class="keyword">), </span><span class="default">$result_arr</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; foreach(</span><span class="default">$result_arr </span><span class="keyword">as </span><span class="default">$line</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; if (</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">"/.*mail exchanger = (.*)/"</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">, </span><span class="default">$matches</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$mxhosts</span><span class="keyword">[] = </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return( </span><span class="default">count</span><span class="keyword">(</span><span class="default">$mxhosts</span><span class="keyword">) &gt; </span><span class="default">0 </span><span class="keyword">);<br />
}</span><span class="comment">//--End of workaround<br />
<br />
//test..<br />
</span><span class="default">getmxrr</span><span class="keyword">(</span><span class="string">'yahoo.com'</span><span class="keyword">, </span><span class="default">$mxhosts</span><span class="keyword">);<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$mxhosts</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
This way you'll avoid a lot of nasty things ;)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="64117""></a>
  <div class="note">
   <strong class="user">Lennart Poot(www.twing.nl)</strong>
   <a href="#64117" class="date">07-Apr-2006 09:23</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This script validates an e-mail adress using getmxrr and fsockopen<br />
<br />
1. it validates the syntax of the address.<br />
2. get MX records by hostname<br />
3. connect mail server and verify mailbox(using smtp command RCTP TO:&lt;email&gt;)<br />
<br />
When the function "validate_email([email])" fails connecting the mail server with the highest priority in the MX record it will continue with the second mail server and so on..<br />
<br />
The function "validate_email([email])" returns 0 when it failes one the 3 steps above, it will return 1 otherwise<br />
<br />
Grtz Lennart Poot<br />
<br />
&lt;?<br />
function validate_email($email){<br />
&nbsp;&nbsp; $mailparts=explode("@",$email);<br />
&nbsp;&nbsp; $hostname = $mailparts[1];<br />
<br />
&nbsp;&nbsp; // validate email address syntax<br />
&nbsp;&nbsp; $exp = "^[a-z\'0-9]+([._-][a-z\'0-9]+)*@([a-z0-9]+([._-][a-z0-9]+))+$";<br />
&nbsp;&nbsp; $b_valid_syntax=eregi($exp, $email);<br />
<br />
&nbsp;&nbsp; // get mx addresses by getmxrr<br />
&nbsp;&nbsp; $b_mx_avail=getmxrr( $hostname, $mx_records, $mx_weight );<br />
&nbsp;&nbsp; $b_server_found=0;<br />
<br />
&nbsp;&nbsp; if($b_valid_syntax &amp;&amp; $b_mx_avail){<br />
&nbsp;&nbsp; &nbsp; // copy mx records and weight into array $mxs<br />
&nbsp;&nbsp; &nbsp; $mxs=array();<br />
<br />
&nbsp;&nbsp; &nbsp; for($i=0;$i&lt;count($mx_records);$i++){<br />
&nbsp;&nbsp; &nbsp; &nbsp; $mxs[$mx_weight[$i]]=$mx_records[$i];<br />
&nbsp;&nbsp; &nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; // sort array mxs to get servers with highest prio<br />
&nbsp;&nbsp; &nbsp; ksort ($mxs, SORT_NUMERIC );<br />
&nbsp;&nbsp; &nbsp; reset ($mxs);<br />
<br />
&nbsp;&nbsp; &nbsp; while (list ($mx_weight, $mx_host) = each ($mxs) ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; if($b_server_found == 0){<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; //try connection on port 25<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; $fp = @fsockopen($mx_host,25, $errno, $errstr, 2);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; if($fp){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $ms_resp="";<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // say HELO to mailserver<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $ms_resp.=send_command($fp, "HELO microsoft.com");<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // initialize sending mail <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $ms_resp.=send_command($fp, "MAIL FROM:&lt;support@microsoft.com&gt;");<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // try receipent address, will return 250 when ok..<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $rcpt_text=send_command($fp, "RCPT TO:&lt;".$email."&gt;");<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $ms_resp.=$rcpt_text;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(substr( $rcpt_text, 0, 3) == "250")<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $b_server_found=1;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // quit mail server connection<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; $ms_resp.=send_command($fp, "QUIT");<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; fclose($fp);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp; }<br />
&nbsp; return $b_server_found;<br />
}<br />
<br />
function send_command($fp, $out){<br />
<br />
&nbsp; fwrite($fp, $out . "\r\n");<br />
&nbsp; return get_data($fp);<br />
}<br />
<br />
function get_data($fp){<br />
&nbsp; $s="";<br />
&nbsp; stream_set_timeout($fp, 2);<br />
<br />
&nbsp; for($i=0;$i&lt;2;$i++)<br />
&nbsp;&nbsp;&nbsp; $s.=fgets($fp, 1024);<br />
<br />
&nbsp; return $s;<br />
}<br />
<br />
// support windows platforms<br />
if (!function_exists ('getmxrr') ) {<br />
&nbsp; function getmxrr($hostname, &amp;$mxhosts, &amp;$mxweight) {<br />
&nbsp;&nbsp;&nbsp; if (!is_array ($mxhosts) ) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; $mxhosts = array ();<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; if (!empty ($hostname) ) {<br />
&nbsp;&nbsp; &nbsp;&nbsp; $output = "";<br />
&nbsp;&nbsp; &nbsp;&nbsp; @exec ("nslookup.exe -type=MX $hostname.", $output);<br />
&nbsp;&nbsp; &nbsp;&nbsp; $imx=-1;<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; foreach ($output as $line) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $imx++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $parts = "";<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (preg_match ("/^$hostname\tMX preference = ([0-9]+), mail exchanger = (.*)$/", $line, $parts) ) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $mxweight[$imx] = $parts[1];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; $mxhosts[$imx] = $parts[2];<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; return ($imx!=-1);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; return false;<br />
&nbsp; }<br />
}<br />
<br />
?&gt;</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="62745""></a>
  <div class="note">
   <strong class="user">jeff at pzenix dot com</strong>
   <a href="#62745" class="date">08-Mar-2006 06:58</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I should point out that the below example won't work with some domains (.co.uk, .org.uk, .net.uk for example) because it assumes (possibly incorrectly) that the format is [ DOMAIN ].[ EXT ].</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="61773""></a>
  <div class="note">
   <strong class="user">off at NOSPAM dot abwesend dot de</strong>
   <a href="#61773" class="date">11-Feb-2006 04:18</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Concerning the message by 'rolf at rowi dot net' (do a check on a address containing a subdomain) we could use:<br />
<br />
$email = 'abc@etpc01.trier.fh-rpl.de';<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
$strDot&nbsp; &nbsp; &nbsp; = '.';<br />
$strAfterAt&nbsp; = substr(strstr($email, '@'), 1);<br />
$chunks&nbsp; &nbsp; &nbsp; = explode($strDot, $strAfterAt);<br />
$cntChunks&nbsp;&nbsp; = count($chunks) - 1;<br />
<br />
$strDomain = $chunks[($cntChunks-1)] . $strDot . $chunks[$cntChunks];<br />
<br />
if (!getmxrr( $strDomain, $mxhosts )) {<br />
&nbsp;&nbsp;&nbsp; echo 'Mailserver not found';<br />
}<br />
<br />
// $strDomain is set to 'fh-rpl.de';</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="56359""></a>
  <div class="note">
   
   <a href="#56359" class="date">31-Aug-2005 05:16</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
nice function for validating email-adresses! Take care on "register globals" paramter.<br />
<br />
<a href="http://www.zend.com/zend/spotlight/ev12apr.php" rel="nofollow" target="_blank">http://www.zend.com/zend/spotlight/ev12apr.php</a></span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="53182""></a>
  <div class="note">
   <strong class="user">richard dot quadling at bandvulc dot co dot uk</strong>
   <a href="#53182" class="date">25-May-2005 11:04</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Windows alternative for getmxrr without the need for PEAR.<br />
<br />
<span class="default">&lt;?php<br />
define</span><span class="keyword">(</span><span class="string">'DEFAULT_GATEWAY'</span><span class="keyword">, </span><span class="string">'nnn.nnn.nnn.nnn'</span><span class="keyword">);<br />
if (!</span><span class="default">function_exists</span><span class="keyword">(</span><span class="string">'getmxrr'</span><span class="keyword">))<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">/*<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; This function is a replacement for the missing Windows function getmxrr.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; The parameters are the same as those for the normal getmxrr function.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; The steps this function takes are :<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 1 - Use NSLOOKUP.EXE to get the MX records for the supplied Host.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 2 - Use regular expressions to extract the mail servers and the preference.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 3 - Sort the results by preference.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 4 - Set the return arrays.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 5 - Return true or false.<br />
&nbsp;&nbsp;&nbsp; */<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">function </span><span class="default">getmxrr</span><span class="keyword">(</span><span class="default">$s_HostName</span><span class="keyword">, array &amp;</span><span class="default">$a_MXHosts </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">, array &amp;</span><span class="default">$a_Weights </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Simulate all the required network activity by executing windows' NSLOOKUP.<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$s_NSLookup </span><span class="keyword">= </span><span class="default">shell_exec</span><span class="keyword">(</span><span class="string">"nslookup -q=mx </span><span class="keyword">{</span><span class="default">$s_HostName</span><span class="keyword">}</span><span class="string"> 2&gt;nul"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">preg_match_all</span><span class="keyword">(</span><span class="string">"'^.*MX preference = (\d{1,10}), mail exchanger = (.*)$'simU"</span><span class="keyword">, </span><span class="default">$s_NSLookup</span><span class="keyword">, </span><span class="default">$a_MXMatches</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// If there is something to return ...<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">if (</span><span class="default">count</span><span class="keyword">(</span><span class="default">$a_MXMatches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]) &gt; </span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="comment">// Produce output arrays if they have been requested.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i_ArgCount </span><span class="keyword">= </span><span class="default">func_num_args</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$i_ArgCount </span><span class="keyword">&gt; </span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">array_multisort</span><span class="keyword">(</span><span class="default">$a_MXMatches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">], </span><span class="default">$a_MXMatches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; switch (</span><span class="default">$i_ArgCount</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case </span><span class="default">3 </span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$a_Weights </span><span class="keyword">= </span><span class="default">$a_MXMatches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; case </span><span class="default">2 </span><span class="keyword">:<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$a_MXHosts </span><span class="keyword">= </span><span class="default">$a_MXMatches</span><span class="keyword">[</span><span class="default">2</span><span class="keyword">];<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">True</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; else<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">False</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; }<br />
</span><span class="default">?&gt;<br />
</span><br />
You will need to know your default gateway (either it's IP address or its name).<br />
<br />
To do this, run the program IPCONFIG /ALL at a cmd prompt and look for the Default Gateway.<br />
<br />
Then replace the 'nnn.nnn.nnn.nnn' with the address.<br />
<br />
Richard.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="49290""></a>
  <div class="note">
   <strong class="user">rune dot heggtveit at devzone dot progative dot com</strong>
   <a href="#49290" class="date">23-Jan-2005 10:02</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
An other way to do mx-lookup on a windows platform.<br />
Rewrote this from an other class i wrote for DNS lookup - so it might be a bit messy - but hope you get the idea.<br />
<br />
Big thanks to the rfc community.<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">mxlookup<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp;&nbsp; var </span><span class="default">$dns_socket </span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; var </span><span class="default">$QNAME </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; var </span><span class="default">$dns_packet</span><span class="keyword">= </span><span class="default">NULL</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; var </span><span class="default">$ANCOUNT </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; var </span><span class="default">$cIx </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; var </span><span class="default">$dns_repl_domain</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; var </span><span class="default">$arrMX </span><span class="keyword">= array();<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; function </span><span class="default">mxlookup</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">, </span><span class="default">$dns</span><span class="keyword">=</span><span class="string">"192.168.2.1"</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">QNAME</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">pack_dns_packet</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$dns_socket </span><span class="keyword">= </span><span class="default">fsockopen</span><span class="keyword">(</span><span class="string">"udp://</span><span class="default">$dns</span><span class="string">"</span><span class="keyword">, </span><span class="default">53</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fwrite</span><span class="keyword">(</span><span class="default">$dns_socket</span><span class="keyword">,</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dns_packet</span><span class="keyword">,</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dns_packet</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dns_reply&nbsp; </span><span class="keyword">= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$dns_socket</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$bytes </span><span class="keyword">= </span><span class="default">stream_get_meta_data</span><span class="keyword">(</span><span class="default">$dns_socket</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dns_reply </span><span class="keyword">.= </span><span class="default">fread</span><span class="keyword">(</span><span class="default">$dns_socket</span><span class="keyword">,</span><span class="default">$bytes</span><span class="keyword">[</span><span class="string">'unread_bytes'</span><span class="keyword">]);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">fclose</span><span class="keyword">(</span><span class="default">$dns_socket</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">=</span><span class="default">6</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">ANCOUNT&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">gord</span><span class="keyword">(</span><span class="default">2</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">+=</span><span class="default">4</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">parse_data</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dns_repl_domain</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">+=</span><span class="default">7</span><span class="keyword">;<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; for(</span><span class="default">$ic</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">;</span><span class="default">$ic</span><span class="keyword">&lt;=</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">ANCOUNT</span><span class="keyword">;</span><span class="default">$ic</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$QTYPE </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">gdi</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; if(</span><span class="default">$QTYPE</span><span class="keyword">!==</span><span class="default">15</span><span class="keyword">){print(</span><span class="string">"[MX Record not returned]"</span><span class="keyword">); die();}<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">+=</span><span class="default">9</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$mxPref </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">gdi</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">parse_data</span><span class="keyword">(</span><span class="default">$curmx</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">arrMX</span><span class="keyword">[] = array(</span><span class="string">"MX_Pref" </span><span class="keyword">=&gt; </span><span class="default">$mxPref</span><span class="keyword">, </span><span class="string">"MX" </span><span class="keyword">=&gt; </span><span class="default">$curmx</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">+=</span><span class="default">3</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; }<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; function </span><span class="default">parse_data</span><span class="keyword">(&amp;</span><span class="default">$retval</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$arName </span><span class="keyword">= array();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$byte </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">gdi</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">$byte</span><span class="keyword">!==</span><span class="default">0</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$byte</span><span class="keyword">==</span><span class="default">192</span><span class="keyword">) </span><span class="comment">//compressed<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">{<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmpIx </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">gdi</span><span class="keyword">(</span><span class="default">$cIx</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$tmpName </span><span class="keyword">= </span><span class="default">$retval</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">parse_data</span><span class="keyword">(</span><span class="default">$tmpName</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$retval</span><span class="keyword">=</span><span class="default">$retval</span><span class="keyword">.</span><span class="string">"."</span><span class="keyword">.</span><span class="default">$tmpName</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx </span><span class="keyword">= </span><span class="default">$tmpIx</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$retval</span><span class="keyword">=</span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bCount </span><span class="keyword">= </span><span class="default">$byte</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$b</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$b</span><span class="keyword">&lt;</span><span class="default">$bCount</span><span class="keyword">;</span><span class="default">$b</span><span class="keyword">++)<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$retval </span><span class="keyword">.= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">gdi</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$arName</span><span class="keyword">[]=</span><span class="default">$retval</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$byte </span><span class="keyword">= </span><span class="default">ord</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">gdi</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$retval</span><span class="keyword">=</span><span class="default">join</span><span class="keyword">(</span><span class="string">"."</span><span class="keyword">,</span><span class="default">$arName</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; function </span><span class="default">gdi</span><span class="keyword">(&amp;</span><span class="default">$cIx</span><span class="keyword">,</span><span class="default">$bytes</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; return(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dns_reply</span><span class="keyword">, </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">-</span><span class="default">1</span><span class="keyword">, </span><span class="default">$bytes</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; function </span><span class="default">QNAME</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$dot_pos </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">; </span><span class="default">$temp </span><span class="keyword">= </span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while(</span><span class="default">$dot_pos</span><span class="keyword">=</span><span class="default">strpos</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">,</span><span class="string">"."</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$temp&nbsp;&nbsp; </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">,</span><span class="default">0</span><span class="keyword">,</span><span class="default">$dot_pos</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$domain </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">,</span><span class="default">$dot_pos</span><span class="keyword">+</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">QNAME </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$temp</span><span class="keyword">)).</span><span class="default">$temp</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">QNAME </span><span class="keyword">.= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">strlen</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">)).</span><span class="default">$domain</span><span class="keyword">.</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; function </span><span class="default">gord</span><span class="keyword">(</span><span class="default">$ln</span><span class="keyword">=</span><span class="default">1</span><span class="keyword">)<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$reply</span><span class="keyword">=</span><span class="string">""</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; for(</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">$ln</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$reply</span><span class="keyword">.=</span><span class="default">ord</span><span class="keyword">(</span><span class="default">substr</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dns_reply</span><span class="keyword">,</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">,</span><span class="default">1</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">cIx</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$reply</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp;&nbsp; function </span><span class="default">pack_dns_packet</span><span class="keyword">()<br />
&nbsp;&nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">dns_packet </span><span class="keyword">= </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).</span><span class="default">chr</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">).<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">chr</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">).</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).</span><span class="default">chr</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">).<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).</span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">QNAME</span><span class="keyword">.<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).</span><span class="default">chr</span><span class="keyword">(</span><span class="default">15</span><span class="keyword">).<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">chr</span><span class="keyword">(</span><span class="default">0</span><span class="keyword">).</span><span class="default">chr</span><span class="keyword">(</span><span class="default">1</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp;&nbsp; }<br />
<br />
}<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
<span class="default">&lt;?php<br />
<br />
</span><span class="comment">/* Exampe of use: */<br />
</span><span class="default">$mx </span><span class="keyword">= new </span><span class="default">mxlookup</span><span class="keyword">(</span><span class="string">"php.net"</span><span class="keyword">);<br />
<br />
print </span><span class="default">$mx</span><span class="keyword">-&gt;</span><span class="default">ANCOUNT</span><span class="keyword">.</span><span class="string">" MX Records\n"</span><span class="keyword">;<br />
print </span><span class="string">"Records returned for "</span><span class="keyword">.</span><span class="default">$mx</span><span class="keyword">-&gt;</span><span class="default">dns_repl_domain</span><span class="keyword">.</span><span class="string">":\n&lt;pre&gt;"</span><span class="keyword">;<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$mx</span><span class="keyword">-&gt;</span><span class="default">arrMX</span><span class="keyword">);<br />
<br />
</span><span class="default">?&gt;<br />
</span><br />
Return:<br />
<br />
02 MX Records Records returned for php.net:<br />
<br />
Array<br />
(<br />
&nbsp;&nbsp;&nbsp; [0] =&gt; Array<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; (<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; [MX_Pref] =&gt; 15<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; [MX] =&gt; smtp.osuosl.org<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; )<br />
<br />
&nbsp;&nbsp;&nbsp; [1] =&gt; Array<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; (<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; [MX_Pref] =&gt; 5<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; [MX] =&gt; osu1.php.net<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; )<br />
<br />
)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="49251""></a>
  <div class="note">
   <strong class="user">rolf at rowi dot net</strong>
   <a href="#49251" class="date">21-Jan-2005 03:36</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Be aware that not just user@example.com ist a valid address, also user@subnet.example.com is valid (but maybe less common). Just got into trouble with this check...<br />
<br />
Rolf</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="48673""></a>
  <div class="note">
   <strong class="user">siclawrence at gmail dot com</strong>
   <a href="#48673" class="date">04-Jan-2005 03:43</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
This code replicates online tools that let you check if an email address is valid. First it checks if the email format is correct, then looks up and prints the mx records. All nicely formatted with fancy words that in the end prints whether the email address valid or invalid.<br />
<br />
<span class="default">&lt;?php<br />
$email </span><span class="keyword">= </span><span class="string">"email@domain.com"</span><span class="keyword">;<br />
<br />
print(</span><span class="string">"Checking: </span><span class="default">$email</span><span class="string">&lt;br&gt;"</span><span class="keyword">);<br />
<br />
if (</span><span class="default">eregi</span><span class="keyword">(</span><span class="string">"^[_a-z0-9-]+(\.[_a-z0-9-]+)*@[a-z0-9-]+(\.[a-z0-9-]+)+$"</span><span class="keyword">, </span><span class="default">$email</span><span class="keyword">)) {<br />
<br />
&nbsp;&nbsp;&nbsp; print(</span><span class="string">"Format Test: PASSED&lt;br&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; print(</span><span class="string">"Online host verification Test...&lt;br&gt;&lt;br&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; print(</span><span class="string">"MX Records for: </span><span class="default">$email</span><span class="string">&lt;br&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; list(</span><span class="default">$alias</span><span class="keyword">, </span><span class="default">$domain</span><span class="keyword">) = </span><span class="default">split</span><span class="keyword">(</span><span class="string">"@"</span><span class="keyword">, </span><span class="default">$email</span><span class="keyword">); <br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; if (</span><span class="default">checkdnsrr</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">, </span><span class="string">"MX"</span><span class="keyword">)) {<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">getmxrr</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">, </span><span class="default">$mxhosts</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach(</span><span class="default">$mxhosts </span><span class="keyword">as </span><span class="default">$mxKey </span><span class="keyword">=&gt; </span><span class="default">$mxValue</span><span class="keyword">){<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print(</span><span class="string">"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;</span><span class="default">$mxValue</span><span class="string">&lt;br&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print(</span><span class="string">"Online host verification Test: PASSED&lt;br&gt;&lt;br&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print(</span><span class="string">"Email Status: VALID"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; } else {<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print(</span><span class="string">"&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;No records found.&lt;br&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print(</span><span class="string">"Online host verification Test: FAILED&lt;br&gt;&lt;br&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print(</span><span class="string">"Email Status: INVALID"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
} else {<br />
<br />
&nbsp;&nbsp;&nbsp; print(</span><span class="string">"Format Test: FAILED&lt;br&gt;&lt;br&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; print(</span><span class="string">"Invalid email address provided.&lt;br&gt;&lt;br&gt;"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; print(</span><span class="string">"Email Status: INVALID"</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="42396""></a>
  <div class="note">
   <strong class="user">zorlac_man at hotmail dot com</strong>
   <a href="#42396" class="date">14-May-2004 09:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
For some reason this and the other DNS lookup functions seem to be really slow on my Linux box. I've checked several things and have no explanation.<br />
<br />
As a work-around, I gave in and just used a system call to dig:<br />
<br />
<span class="default">&lt;?php<br />
CheckMX</span><span class="keyword">(</span><span class="string">"fakedomain.org"</span><span class="keyword">);<br />
</span><span class="default">CheckMX</span><span class="keyword">(</span><span class="string">"hotmail.com"</span><span class="keyword">);<br />
<br />
function </span><span class="default">CheckMX</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">exec</span><span class="keyword">(</span><span class="string">"dig +short MX " </span><span class="keyword">. </span><span class="default">escapeshellarg</span><span class="keyword">(</span><span class="default">$domain</span><span class="keyword">),</span><span class="default">$ips</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">$ips</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">] == </span><span class="string">""</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; print </span><span class="string">"MX record found for </span><span class="default">$domain</span><span class="string"> not found!\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">FALSE</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; print </span><span class="string">"MX Record for </span><span class="default">$domain</span><span class="string"> found\n"</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">TRUE</span><span class="keyword">;<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
Output:<br />
<br />
MX record found for fakedomain.org not found!<br />
MX Record for hotmail.com found<br />
<br />
As someone else pointed out, it is prudent to check to see if the TLD has an IP address if the MX record is not found.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="40236""></a>
  <div class="note">
   <strong class="user">ng4rrjanbiah at rediffmail dot com</strong>
   <a href="#40236" class="date">26-Feb-2004 12:11</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Here is a better workaround for Windows platform. Tested on Windows XP. Highly impressed by "geoffbrisbine A T y a h o o DOT c o m"'s idea of nslookup usage.<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">function </span><span class="default">getmxrr</span><span class="keyword">(</span><span class="default">$hostname</span><span class="keyword">, &amp;</span><span class="default">$mxhosts</span><span class="keyword">)<br />
{<br />
&nbsp;&nbsp; </span><span class="default">$mxhosts </span><span class="keyword">= array();<br />
&nbsp;&nbsp; </span><span class="default">exec</span><span class="keyword">(</span><span class="string">'nslookup -type=mx '</span><span class="keyword">.</span><span class="default">$hostname</span><span class="keyword">, </span><span class="default">$result_arr</span><span class="keyword">);<br />
&nbsp;&nbsp; foreach(</span><span class="default">$result_arr </span><span class="keyword">as </span><span class="default">$line</span><span class="keyword">) <br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp;&nbsp; if (</span><span class="default">preg_match</span><span class="keyword">(</span><span class="string">"/.*mail exchanger = (.*)/"</span><span class="keyword">, </span><span class="default">$line</span><span class="keyword">, </span><span class="default">$matches</span><span class="keyword">)) <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$mxhosts</span><span class="keyword">[] = </span><span class="default">$matches</span><span class="keyword">[</span><span class="default">1</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp; return( </span><span class="default">count</span><span class="keyword">(</span><span class="default">$mxhosts</span><span class="keyword">) &gt; </span><span class="default">0 </span><span class="keyword">);<br />
}</span><span class="comment">//--End of workaround<br />
<br />
//test..<br />
</span><span class="keyword">echo </span><span class="default">getmxrr</span><span class="keyword">(</span><span class="string">'yahoo.com'</span><span class="keyword">, </span><span class="default">$mxhosts</span><span class="keyword">);<br />
</span><span class="default">print_r</span><span class="keyword">(</span><span class="default">$mxhosts</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
HTH,<br />
R. Rajesh Jeba Anbiah</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="25472""></a>
  <div class="note">
   <strong class="user">geoffbrisbine A T  y a h o o  DOT  c o m</strong>
   <a href="#25472" class="date">25-Sep-2002 06:39</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
I was pretty disappointed that the Win32 build of PHP doesn't incorporate getmxrr so, since I'm a naive newbie, I decided to hack together my own (and I stress hack).&nbsp; This has been tested on Win 2000 and Win XP.&nbsp; There's no reason this shouldn't work on Win NT but it will not work on Win 9x (you need the nslookup command).&nbsp; It will finish with the array $mx that will be a multidimensional array with the MX preference, host name and ip address. You can do a print_r ( $mx ) to see what it looks like.<br />
<br />
-----------------------------------------------<br />
<br />
<span class="default">&lt;?php<br />
$command </span><span class="keyword">= </span><span class="string">"nslookup -type=mx yahoo.com"</span><span class="keyword">;<br />
</span><span class="default">exec </span><span class="keyword">( </span><span class="default">$command</span><span class="keyword">, </span><span class="default">$result </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; <br />
</span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
while ( list ( </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$value </span><span class="keyword">) = </span><span class="default">each </span><span class="keyword">( </span><span class="default">$result </span><span class="keyword">) ) {<br />
&nbsp;&nbsp;&nbsp; if ( </span><span class="default">strstr </span><span class="keyword">( </span><span class="default">$value</span><span class="keyword">, </span><span class="string">"mail exchanger" </span><span class="keyword">) ) { </span><span class="default">$nslookup</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">] = </span><span class="default">$value</span><span class="keyword">; </span><span class="default">$i</span><span class="keyword">++; }<br />
}<br />
&nbsp;&nbsp;&nbsp; <br />
while ( list ( </span><span class="default">$key</span><span class="keyword">, </span><span class="default">$value </span><span class="keyword">) = </span><span class="default">each </span><span class="keyword">( </span><span class="default">$nslookup </span><span class="keyword">) ) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$temp </span><span class="keyword">= </span><span class="default">explode </span><span class="keyword">( </span><span class="string">" "</span><span class="keyword">, </span><span class="default">$value </span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mx</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">][</span><span class="default">0</span><span class="keyword">] = </span><span class="default">$temp</span><span class="keyword">[</span><span class="default">3</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mx</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">][</span><span class="default">1</span><span class="keyword">] = </span><span class="default">$temp</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">];<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$mx</span><span class="keyword">[</span><span class="default">$key</span><span class="keyword">][</span><span class="default">2</span><span class="keyword">] = </span><span class="default">gethostbyname </span><span class="keyword">( </span><span class="default">$temp</span><span class="keyword">[</span><span class="default">7</span><span class="keyword">] );<br />
}<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="default">array_multisort </span><span class="keyword">( </span><span class="default">$mx </span><span class="keyword">);<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="10675""></a>
  <div class="note">
   <strong class="user">paul at start dot co dot uk</strong>
   <a href="#10675" class="date">16-Jan-2001 09:48</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Prevent your dns server from 'creating' a valid host name by appending the local domain to incomplete emails by appending to the domain a&nbsp; trailing . both in the pattern match and mx checks:<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">if (</span><span class="default">eregi</span><span class="keyword">(</span><span class="string">"^[0-9a-z_]([-_.]?[0-9a-z])*@[0-9a-z][-.0-9a-z]*\\.[a-z]{2,3}[.]?$"</span><span class="keyword">, </span><span class="default">$string</span><span class="keyword">, </span><span class="default">$check</span><span class="keyword">)) { <br />
&nbsp;&nbsp;&nbsp; </span><span class="default">$host </span><span class="keyword">= </span><span class="default">substr</span><span class="keyword">(</span><span class="default">strstr</span><span class="keyword">(</span><span class="default">$check</span><span class="keyword">[</span><span class="default">0</span><span class="keyword">], </span><span class="string">'@'</span><span class="keyword">), </span><span class="default">1</span><span class="keyword">).</span><span class="string">"."</span><span class="keyword">; <br />
&nbsp;&nbsp;&nbsp; if ( </span><span class="default">getmxrr</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$validate_email_temp</span><span class="keyword">) ) <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">TRUE</span><span class="keyword">; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// THIS WILL CATCH DNSs THAT ARE NOT MX. <br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">if(</span><span class="default">checkdnsrr</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">,</span><span class="string">"ANY"</span><span class="keyword">))<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">TRUE</span><span class="keyword">; <br />
}<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="function.gethostname.html">gethostname</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="function.getprotobyname.html">getprotobyname</a></div>
 <div class="up"><a href="ref.network.html">ネットワーク 関数</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
