<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
 <head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <title>SQL ステートメントを実行するために準備する</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <link media="all" rel="stylesheet" type="text/css" href="style.css"/>
 </head>
 <body class="docs"><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqli-stmt.param-count.html">mysqli_stmt::$param_count</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqli-stmt.reset.html">mysqli_stmt::reset</a></div>
 <div class="up"><a href="class.mysqli-stmt.html">mysqli_stmt</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div><hr /><div id="mysqli-stmt.prepare" class="refentry">
 <div class="refnamediv">
  <h1 class="refname">mysqli_stmt::prepare</h1>
  <h1 class="refname">mysqli_stmt_prepare</h1>
  <p class="verinfo">(PHP 5)</p><p class="refpurpose"><span class="refname">mysqli_stmt::prepare</span> -- <span class="refname">mysqli_stmt_prepare</span> &mdash; <span class="dc-title">SQL ステートメントを実行するために準備する</span></p>

 </div>

 <div class="refsect1 description" id="refsect1-mysqli-stmt.prepare-description">
  <h3 class="title">説明</h3>
  <p class="para">オブジェクト指向型</p>
  <div class="methodsynopsis dc-description">
   <span class="type"><a href="language.pseudo-types.html#language.types.mixed" class="type mixed">mixed</a></span> <span class="methodname"><strong>mysqli_stmt::prepare</strong></span>
    ( <span class="methodparam"><span class="type">string</span> <code class="parameter">$query</code></span>
   )</div>

  <p class="para rdfs-comment">手続き型</p>
  <div class="methodsynopsis dc-description">
   <span class="type">bool</span> <span class="methodname"><strong>mysqli_stmt_prepare</strong></span>
    ( <span class="methodparam"><span class="type"><a href="class.mysqli-stmt.html" class="type mysqli_stmt">mysqli_stmt</a></span> <code class="parameter">$stmt</code></span>
   , <span class="methodparam"><span class="type">string</span> <code class="parameter">$query</code></span>
   )</div>

  <p class="para rdfs-comment">
   null で終わる文字列で指定した SQL クエリを準備します。
  </p>
  <p class="para">
   パラメータマーカは、ステートメントの実行や行の取得の前に
    <span class="function"><a href="mysqli-stmt.bind-param.html" class="function">mysqli_stmt_bind_param()</a></span>
   や  <span class="function"><a href="mysqli-stmt.bind-result.html" class="function">mysqli_stmt_bind_result()</a></span> を使用して
   アプリケーション変数にバインドする必要があります。
  </p>
  <blockquote class="note"><p><strong class="note">注意</strong>: 
   <p class="para">
    サーバーの <em>max_allowed_packet</em> よりも長いステートメントを
     <span class="function"><strong>mysqli_stmt_prepare()</strong></span> に渡した場合、
    返ってくるエラーコードは MySQL Native Driver (<em>mysqlnd</em>)
    を使っているか MySQL Client Library
    (<em>libmysqlclient</em>) を使っているかで異なります。
    それぞれ、次のように振る舞います。
   </p>
   <ul class="itemizedlist">
    <li class="listitem">
     <p class="para">
      Linux 上の <em>mysqlnd</em> では、エラーコード 1153 を返します。
      エラーメッセージは "<span class="quote">got a packet bigger than
      <em>max_allowed_packet</em> bytes</span>" です。
     </p>
    </li>
    <li class="listitem">
     <p class="para">
      Windows 上の <em>mysqlnd</em> では、エラーコード 2006 を返します。
      エラーメッセージは "<span class="quote">server has gone away</span>" です。
     </p>
    </li>
    <li class="listitem">
     <p class="para">
      すべてのプラットフォームの <em>libmysqlclient</em> では、エラーコード
      2006 を返します。エラーメッセージは "<span class="quote">server has gone
      away</span>" です。
     </p>
    </li>
   </ul>
  </p></blockquote>
 </div>


 <div class="refsect1 parameters" id="refsect1-mysqli-stmt.prepare-parameters">
  <h3 class="title">パラメータ</h3>
  <p class="para">
   <dl>

    <dt>
<span class="term"><em><code class="parameter">
stmt</code></em></span><dd>
<p class="para">手続き型のみ:
 <span class="function"><a href="mysqli.stmt-init.html" class="function">mysqli_stmt_init()</a></span> が返すステートメント ID。</p></dd>
</dt>

    <dt>

     <span class="term"><em><code class="parameter">query</code></em></span>
     <dd>

      <p class="para">
       クエリを表す文字列。単一の SQL 文で構成されている必要があります。
      </p>
      <p class="para">
       ひとつまたは複数のパラメータを SQL 文に含めることができます。
       そのためには、適切な位置にクエスチョンマーク
       (<em>?</em>) を埋め込みます。
      </p>
      <blockquote class="note"><p><strong class="note">注意</strong>: 
       <p class="para">
        ステートメントの最後にセミコロンや <em>\g</em>
        を追加してはいけません。
       </p>
      </p></blockquote>
      <blockquote class="note"><p><strong class="note">注意</strong>: 
       <p class="para">
        パラメータのマーカは、それが SQL 文の適切な位置にある場合のみ
        有効です。例えば INSERT 文の VALUES() リストの中
        (行に登録するカラム値を指定する) や 
        WHERE 句で列のデータと比較する値などが適切な位置の例です。
       </p>
       <p class="para">
        しかし、識別子 (テーブルやカラムの名前) や SELECT 文で選択する
        項目の名前に指定したり、(等号 <em>=</em> のような)
        二項演算子の両側にパラメータを指定したりすることはできません。
        後者の制限は、パラメータの型が判断できなくなることによるものです。
        また、パラメータのマーカを <em>NULL</em> と比較して
        <em>? IS NULL</em> のようにすることもできません。
        一般に、パラメータが使用可能なのはデータ操作言語 (DML)
        ステートメントであり、データ定義言語 (DDL) ステートメントでは
        使用できません。
       </p>
      </p></blockquote>
     </dd>

    </dt>

   </dl>

  </p>
 </div>


 <div class="refsect1 returnvalues" id="refsect1-mysqli-stmt.prepare-returnvalues">
  <h3 class="title">返り値</h3>
  <p class="para">
   成功した場合に <strong><code>TRUE</code></strong> を、失敗した場合に <strong><code>FALSE</code></strong> を返します。
  </p>
 </div>


 <div class="refsect1 examples" id="refsect1-mysqli-stmt.prepare-examples">
  <h3 class="title">例</h3>
  <div class="example" id="example-1711">
   <p><strong>例1 オブジェクト指向型</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$mysqli&nbsp;</span><span style="color: #007700">=&nbsp;new&nbsp;</span><span style="color: #0000BB">mysqli</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"world"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;接続状況をチェックします&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Connect&nbsp;failed:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">());<br />&nbsp;&nbsp;&nbsp;&nbsp;exit();<br />}<br /><br /></span><span style="color: #0000BB">$city&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"Amersfoort"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/*&nbsp;プリペアドステートメントを作成します&nbsp;*/<br /></span><span style="color: #0000BB">$stmt&nbsp;</span><span style="color: #007700">=&nbsp;&nbsp;</span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">stmt_init</span><span style="color: #007700">();<br />if&nbsp;(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">prepare</span><span style="color: #007700">(</span><span style="color: #DD0000">"SELECT&nbsp;District&nbsp;FROM&nbsp;City&nbsp;WHERE&nbsp;Name=?"</span><span style="color: #007700">))&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;マーカにパラメータをバインドします&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bind_param</span><span style="color: #007700">(</span><span style="color: #DD0000">"s"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$city</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;クエリを実行します&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">execute</span><span style="color: #007700">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;結果変数をバインドします&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">bind_result</span><span style="color: #007700">(</span><span style="color: #0000BB">$district</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;値を取得します&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">fetch</span><span style="color: #007700">();<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%s&nbsp;is&nbsp;in&nbsp;district&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$city</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$district</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;ステートメントを閉じます&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;接続を閉じます&nbsp;*/<br /></span><span style="color: #0000BB">$mysqli</span><span style="color: #007700">-&gt;</span><span style="color: #0000BB">close</span><span style="color: #007700">();<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

  </div>
  <div class="example" id="example-1712">
   <p><strong>例2 手続き型</strong></p>
   <div class="example-contents">
<div class="phpcode"><code><span style="color: #000000">
<span style="color: #0000BB">&lt;?php<br />$link&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqli_connect</span><span style="color: #007700">(</span><span style="color: #DD0000">"localhost"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_user"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"my_password"</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"world"</span><span style="color: #007700">);<br /><br /></span><span style="color: #FF8000">/*&nbsp;接続状況をチェックします&nbsp;*/<br /></span><span style="color: #007700">if&nbsp;(</span><span style="color: #0000BB">mysqli_connect_errno</span><span style="color: #007700">())&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"Connect&nbsp;failed:&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">mysqli_connect_error</span><span style="color: #007700">());<br />&nbsp;&nbsp;&nbsp;&nbsp;exit();<br />}<br /><br /></span><span style="color: #0000BB">$city&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #DD0000">"Amersfoort"</span><span style="color: #007700">;<br /><br /></span><span style="color: #FF8000">/*&nbsp;プリペアドステートメントを作成します&nbsp;*/<br /></span><span style="color: #0000BB">$stmt&nbsp;</span><span style="color: #007700">=&nbsp;</span><span style="color: #0000BB">mysqli_stmt_init</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">);<br />if&nbsp;(</span><span style="color: #0000BB">mysqli_stmt_prepare</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">'SELECT&nbsp;District&nbsp;FROM&nbsp;City&nbsp;WHERE&nbsp;Name=?'</span><span style="color: #007700">))&nbsp;{<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;マーカにパラメータをバインドします&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mysqli_stmt_bind_param</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">,&nbsp;</span><span style="color: #DD0000">"s"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$city</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;クエリを実行します&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mysqli_stmt_execute</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;結果変数をバインドします&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mysqli_stmt_bind_result</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$district</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;値を取得します&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mysqli_stmt_fetch</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">printf</span><span style="color: #007700">(</span><span style="color: #DD0000">"%s&nbsp;is&nbsp;in&nbsp;district&nbsp;%s\n"</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$city</span><span style="color: #007700">,&nbsp;</span><span style="color: #0000BB">$district</span><span style="color: #007700">);<br /><br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #FF8000">/*&nbsp;ステートメントを閉じます&nbsp;*/<br />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000BB">mysqli_stmt_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$stmt</span><span style="color: #007700">);<br />}<br /><br /></span><span style="color: #FF8000">/*&nbsp;接続を閉じます&nbsp;*/<br /></span><span style="color: #0000BB">mysqli_close</span><span style="color: #007700">(</span><span style="color: #0000BB">$link</span><span style="color: #007700">);<br /></span><span style="color: #0000BB">?&gt;</span>
</span>
</code></div>
   </div>

   <div class="example-contents"><p>上の例の出力は以下となります。</p></div>
   <div class="example-contents screen">
<div class="cdata"><pre>
Amersfoort is in district Utrecht
</pre></div>
   </div>
  </div>
 </div>


 <div class="refsect1 seealso" id="refsect1-mysqli-stmt.prepare-seealso">
  <h3 class="title">参考</h3>
  <p class="para">
   <ul class="simplelist">
    <li class="member"> <span class="function"><a href="mysqli.stmt-init.html" class="function" rel="rdfs-seeAlso">mysqli_stmt_init()</a> - ステートメントを初期化し、mysqli_stmt_prepare で使用するオブジェクトを返す</span></li>
    <li class="member"> <span class="function"><a href="mysqli-stmt.execute.html" class="function" rel="rdfs-seeAlso">mysqli_stmt_execute()</a> - プリペアドクエリを実行する</span></li>
    <li class="member"> <span class="function"><a href="mysqli-stmt.fetch.html" class="function" rel="rdfs-seeAlso">mysqli_stmt_fetch()</a> - プリペアドステートメントから結果を取得し、バインド変数に格納する</span></li>
    <li class="member"> <span class="function"><a href="mysqli-stmt.bind-param.html" class="function" rel="rdfs-seeAlso">mysqli_stmt_bind_param()</a> - プリペアドステートメントのパラメータに変数をバインドする</span></li>
    <li class="member"> <span class="function"><a href="mysqli-stmt.bind-result.html" class="function" rel="rdfs-seeAlso">mysqli_stmt_bind_result()</a> - 結果を保存するため、プリペアドステートメントに変数をバインドする</span></li>
    <li class="member"> <span class="function"><a href="mysqli-stmt.close.html" class="function" rel="rdfs-seeAlso">mysqli_stmt_close()</a> - プリペアドステートメントを閉じる</span></li>
   </ul>
  </p>
 </div>


</div><div id="usernotes">
 <div class="head">
  <h3 class="title">User Contributed Notes</h3>
 </div>
<div id="allnotes">  <a name="108038""></a>
  <div class="note">
   <strong class="user">logos-php at kith dot orgpp</strong>
   <a href="#108038" class="date">24-Mar-2012 02:34</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Turns out you can't directly use a prepared statement for a query that has a placeholder in an IN() clause.<br />
<br />
There are ways around that (such as constructing a string that consists of n question marks separated by commas, then using that set of placeholders in the IN() clause), but you can't just say IN (?).<br />
<br />
This is a MySQL restriction rather than a PHP restriction, but it's not really documented in the MySQL docs either, so I figured it was worth mentioning here.<br />
<br />
(Btw, turns out someone else had previously posted the info that I put in my previous comment, about not using quotation marks. Sorry for the repeat; not sure how I missed the earlier comment.)</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="108023""></a>
  <div class="note">
   <strong class="user">logos-php at kith dot org</strong>
   <a href="#108023" class="date">23-Mar-2012 04:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Note that if you're using a question mark as a placeholder for a string value, you don't surround it with quotation marks in the MySQL query.<br />
<br />
For example, do this:<br />
<br />
mysqli_stmt_prepare($stmt, "SELECT * FROM foo WHERE foo.Date &gt; ?");<br />
<br />
Do not do this:<br />
<br />
mysqli_stmt_prepare($stmt, "SELECT * FROM foo WHERE foo.Date &gt; '?'");<br />
<br />
If you put quotation marks around a question mark in the query, then PHP doesn't recognize the question mark as a placeholder, and then when you try to use mysqli_stmt_bind_param(), it gives an error to the effect that you have the wrong number of parameters.<br />
<br />
The lack of quotation marks around a string placeholder is implicit in the official example on this page, but it's not explicitly stated in the docs, and I had trouble figuring it out, so figured it was worth posting.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="90436""></a>
  <div class="note">
   <strong class="user">ndungi at gmail dot com</strong>
   <a href="#90436" class="date">22-Apr-2009 11:25</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
The `prepare` , `bind_param`, `bind_result`, `fetch` result, `close` stmt cycle can be tedious at times. Here is an object that does all the mysqli mumbo jumbo for you when all you want is a select leaving you to the bare essential `preparedSelect` on a prepared stmt. The method returns the result set as a 2D associative array with the `select`ed columns as keys. I havent done sufficient error-checking and it also may have some bugs. Help debug and improve on it. <br />
<br />
I used the bible.sql db from <a href="http://www.biblesql.net/sites/biblesql.net/files/bible.mysql.gz." rel="nofollow" target="_blank">http://www.biblesql.net/sites/biblesql.net/files/bible.mysql.gz.</a><br />
<br />
Baraka tele!<br />
<br />
============================<br />
<br />
<span class="default">&lt;?php<br />
<br />
</span><span class="keyword">class </span><span class="default">DB<br />
</span><span class="keyword">{<br />
&nbsp;&nbsp;&nbsp; public </span><span class="default">$connection</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">#establish db connection<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">__construct</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">=</span><span class="string">"localhost"</span><span class="keyword">, </span><span class="default">$user</span><span class="keyword">=</span><span class="string">"user"</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">=</span><span class="string">""</span><span class="keyword">, </span><span class="default">$db</span><span class="keyword">=</span><span class="string">"bible"</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection </span><span class="keyword">= new </span><span class="default">mysqli</span><span class="keyword">(</span><span class="default">$host</span><span class="keyword">, </span><span class="default">$user</span><span class="keyword">, </span><span class="default">$pass</span><span class="keyword">, </span><span class="default">$db</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if(</span><span class="default">mysqli_connect_errno</span><span class="keyword">())<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo(</span><span class="string">"Database connect Error : " <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">. </span><span class="default">mysqli_connect_error</span><span class="keyword">(</span><span class="default">$mysqli</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">#store mysqli object<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">connect</span><span class="keyword">()<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">#run a prepared query<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">runPreparedQuery</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">, </span><span class="default">$params_r</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$stmt </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">bindParameters</span><span class="keyword">(</span><span class="default">$stmt</span><span class="keyword">, </span><span class="default">$params_r</span><span class="keyword">);<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; if (</span><span class="default">$stmt</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$stmt</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } else {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; echo(</span><span class="string">"Error in </span><span class="default">$statement</span><span class="string">: " <br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="keyword">. </span><span class="default">mysqli_error</span><span class="keyword">(</span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">connection</span><span class="keyword">));<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; }<br />
<br />
&nbsp;</span><span class="comment"># To run a select statement with bound parameters and bound results. <br />
&nbsp;# Returns an associative array two dimensional array which u can easily&nbsp; <br />
&nbsp;# manipulate with array functions.<br />
&nbsp;<br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">public function </span><span class="default">preparedSelect</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">, </span><span class="default">$bind_params_r</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$select </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">runPreparedQuery</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">, </span><span class="default">$bind_params_r</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fields_r </span><span class="keyword">= </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">fetchFields</span><span class="keyword">(</span><span class="default">$select</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; foreach (</span><span class="default">$fields_r </span><span class="keyword">as </span><span class="default">$field</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$bind_result_r</span><span class="keyword">[] = &amp;${</span><span class="default">$field</span><span class="keyword">};<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; } <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$this</span><span class="keyword">-&gt;</span><span class="default">bindResult</span><span class="keyword">(</span><span class="default">$select</span><span class="keyword">, </span><span class="default">$bind_result_r</span><span class="keyword">);<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result_r </span><span class="keyword">= array();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i </span><span class="keyword">= </span><span class="default">0</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (</span><span class="default">$select</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; foreach (</span><span class="default">$fields_r </span><span class="keyword">as </span><span class="default">$field</span><span class="keyword">) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$result_r</span><span class="keyword">[</span><span class="default">$i</span><span class="keyword">][</span><span class="default">$field</span><span class="keyword">] = $</span><span class="default">$field</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$i</span><span class="keyword">++;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$select</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$result_r</span><span class="keyword">;&nbsp; &nbsp; <br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">#takes in array of bind parameters and binds them to result of <br />
&nbsp;&nbsp;&nbsp; #executed prepared stmt<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private function </span><span class="default">bindParameters</span><span class="keyword">(&amp;</span><span class="default">$obj</span><span class="keyword">, &amp;</span><span class="default">$bind_params_r</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">call_user_func_array</span><span class="keyword">(array(</span><span class="default">$obj</span><span class="keyword">, </span><span class="string">"bind_param"</span><span class="keyword">), </span><span class="default">$bind_params_r</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; private function </span><span class="default">bindResult</span><span class="keyword">(&amp;</span><span class="default">$obj</span><span class="keyword">, &amp;</span><span class="default">$bind_result_r</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">call_user_func_array</span><span class="keyword">(array(</span><span class="default">$obj</span><span class="keyword">, </span><span class="string">"bind_result"</span><span class="keyword">), </span><span class="default">$bind_result_r</span><span class="keyword">);<br />
&nbsp;&nbsp;&nbsp; }<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">#returns a list of the selected field names<br />
&nbsp;&nbsp;&nbsp; <br />
&nbsp;&nbsp;&nbsp; </span><span class="keyword">private function </span><span class="default">fetchFields</span><span class="keyword">(</span><span class="default">$selectStmt</span><span class="keyword">)<br />
&nbsp;&nbsp;&nbsp; {<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$metadata </span><span class="keyword">= </span><span class="default">$selectStmt</span><span class="keyword">-&gt;</span><span class="default">result_metadata</span><span class="keyword">();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fields_r </span><span class="keyword">= array();<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; while (</span><span class="default">$field </span><span class="keyword">= </span><span class="default">$metadata</span><span class="keyword">-&gt;</span><span class="default">fetch_field</span><span class="keyword">()) {<br />
&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; </span><span class="default">$fields_r</span><span class="keyword">[] = </span><span class="default">$field</span><span class="keyword">-&gt;</span><span class="default">name</span><span class="keyword">;<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; }<br />
<br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; return </span><span class="default">$fields_r</span><span class="keyword">;<br />
&nbsp;&nbsp;&nbsp; }<br />
}<br />
</span><span class="comment">#end of class<br />
&nbsp;<br />
#An example of the DB class in use<br />
<br />
</span><span class="default">$DB </span><span class="keyword">= new </span><span class="default">DB</span><span class="keyword">(</span><span class="string">"localhost"</span><span class="keyword">, </span><span class="string">"root"</span><span class="keyword">, </span><span class="string">""</span><span class="keyword">, </span><span class="string">"bible"</span><span class="keyword">);<br />
</span><span class="default">$var </span><span class="keyword">= </span><span class="default">5</span><span class="keyword">; <br />
</span><span class="default">$query </span><span class="keyword">= </span><span class="string">"SELECT abbr, name from books where id &gt; ?" </span><span class="keyword">;<br />
</span><span class="default">$bound_params_r </span><span class="keyword">= array(</span><span class="string">"i"</span><span class="keyword">, </span><span class="default">$var</span><span class="keyword">);<br />
<br />
</span><span class="default">$result_r </span><span class="keyword">= </span><span class="default">$DB</span><span class="keyword">-&gt;</span><span class="default">preparedSelect</span><span class="keyword">(</span><span class="default">$query</span><span class="keyword">, </span><span class="default">$bound_params_r</span><span class="keyword">);<br />
<br />
</span><span class="comment">#loop thru result array and display result<br />
<br />
</span><span class="keyword">foreach (</span><span class="default">$result_r </span><span class="keyword">as </span><span class="default">$result</span><span class="keyword">) {<br />
&nbsp;&nbsp;&nbsp; echo </span><span class="default">$result</span><span class="keyword">[</span><span class="string">'abbr'</span><span class="keyword">] . </span><span class="string">" : " </span><span class="keyword">. </span><span class="default">$result</span><span class="keyword">[</span><span class="string">'name'</span><span class="keyword">] . </span><span class="string">"&lt;br/&gt;" </span><span class="keyword">;<br />
}<br />
<br />
</span><span class="default">?&gt;</span>
</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83873""></a>
  <div class="note">
   <strong class="user">kontakt at arthur minus schiwon dot de</strong>
   <a href="#83873" class="date">16-Jun-2008 04:22</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you wrap the placeholders with quotation marks you will experience warnings like "Number of variables doesn't match number of parameters in prepared statement" (at least with INSERT Statements).</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="83224""></a>
  <div class="note">
   <strong class="user">mhradek AT gmail.com</strong>
   <a href="#83224" class="date">16-May-2008 01:06</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
A particularly helpful adaptation of this function and the call_user_func_array function:<br />
<br />
// $params is sent as array($val=&gt;'i', $val=&gt;'d', etc...)<br />
<br />
function db_stmt_bind_params($stmt, $params)<br />
{ <br />
&nbsp;&nbsp;&nbsp; $funcArg[] = $stmt; <br />
&nbsp;&nbsp;&nbsp; foreach($params as $val=&gt;$type)<br />
&nbsp;&nbsp;&nbsp; { <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $funcArg['type'] .= $type; <br />
&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; $funcArg[] = $val; <br />
&nbsp;&nbsp;&nbsp; } <br />
&nbsp;&nbsp;&nbsp; return call_user_func_array('mysqli_stmt_bind_param', $funcArgs); <br />
} <br />
<br />
Thanks to 'sned' for the code.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="80426""></a>
  <div class="note">
   <strong class="user">lukaszNOSPAMPLEASE at epas dot pl</strong>
   <a href="#80426" class="date">15-Jan-2008 04:15</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
i've got some bad news for you guys if you haven't found out already.<br />
the trick with mysqli_next_result() only prevents having the connection dropped after a stored procedure call.<br />
apparently you can bind parameters for a prepared stored procedure call, but you'll get messed up records from mysqli_stmt_fetch() after mysqli_stmt_bind_result(), at least when the stored procedure itself contains a prepared statement.<br />
a way to avoid data corruption could be specifying the CLIENT_MULTI_STATEMENTS flag in mysqli_real_connect(), if it wasn't disabled entirely (for security reasons, as they say). another option is to use mysqli_multi_query(), but then you can't bind at all.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="75534""></a>
  <div class="note">
   <strong class="user">st dot john dot johnson at gmail dot com</strong>
   <a href="#75534" class="date">04-Jun-2007 05:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
In reference to what lachlan76 said before, stored procedures CAN be executed through prepared statements as long as you tell the DB to move to the next result before executing again.<br />
<br />
Example (Five calls to a stored procedure):<br />
<br />
<span class="default">&lt;?php<br />
</span><span class="keyword">for (</span><span class="default">$i</span><span class="keyword">=</span><span class="default">0</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">&lt;</span><span class="default">5</span><span class="keyword">;</span><span class="default">$i</span><span class="keyword">++) {<br />
&nbsp; </span><span class="default">$statement </span><span class="keyword">= </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">stmt_init</span><span class="keyword">();<br />
&nbsp; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"CALL some_procedure( ? )"</span><span class="keyword">);<br />
<br />
&nbsp; </span><span class="comment">// Bind, execute, and bind.<br />
&nbsp; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bind_param</span><span class="keyword">(</span><span class="string">"i"</span><span class="keyword">, </span><span class="default">1</span><span class="keyword">);<br />
&nbsp; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">execute</span><span class="keyword">();<br />
&nbsp; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">bind_result</span><span class="keyword">(</span><span class="default">$results</span><span class="keyword">);<br />
<br />
&nbsp; while(</span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">fetch</span><span class="keyword">()) {<br />
&nbsp;&nbsp;&nbsp; </span><span class="comment">// Do what you want with your results.<br />
&nbsp; </span><span class="keyword">}<br />
<br />
&nbsp; </span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">close</span><span class="keyword">();<br />
<br />
&nbsp; </span><span class="comment">// Now move the mysqli connection to a new result.<br />
&nbsp; </span><span class="keyword">while(</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">()) { }<br />
}<br />
</span><span class="default">?&gt;<br />
</span><br />
If you include the last statement, this code should execute without the nasty "Commands out of sync" error.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="71439""></a>
  <div class="note">
   <strong class="user">lachlan76 at gmail dot com</strong>
   <a href="#71439" class="date">29-Nov-2006 05:59</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
Do not try to use a stored procedure through a prepared statement.<br />
<br />
Example:<br />
<br />
<span class="default">&lt;?php<br />
$statement </span><span class="keyword">= </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">stmt_init</span><span class="keyword">();<br />
</span><span class="default">$statement</span><span class="keyword">-&gt;</span><span class="default">prepare</span><span class="keyword">(</span><span class="string">"CALL some_procedure()"</span><span class="keyword">);<br />
</span><span class="default">?&gt;<br />
</span><br />
If you attempt to do this, it will fail by dropping the connection during the next query.&nbsp; Use mysqli_multi_query instead.<br />
<br />
Example:<br />
<br />
<span class="default">&lt;?php<br />
$mysqli</span><span class="keyword">-&gt;</span><span class="default">multi_query</span><span class="keyword">(</span><span class="string">"CALL some_procedure()"</span><span class="keyword">);<br />
do<br />
{<br />
&nbsp; </span><span class="default">$result </span><span class="keyword">= </span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">store_result</span><span class="keyword">();<br />
<br />
&nbsp;&nbsp; </span><span class="comment">// Do your processing work here&nbsp; <br />
&nbsp; <br />
&nbsp; </span><span class="default">$result</span><span class="keyword">-&gt;</span><span class="default">free</span><span class="keyword">();<br />
} while(</span><span class="default">$mysqli</span><span class="keyword">-&gt;</span><span class="default">next_result</span><span class="keyword">());<br />
</span><span class="default">?&gt;<br />
</span><br />
This means that you cannot bind parameters or results, however.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
  <a name="57563""></a>
  <div class="note">
   <strong class="user">andrey at php dot net</strong>
   <a href="#57563" class="date">07-Oct-2005 02:35</a>
   <div class="text">
    <div class="phpcode">
<code><span class="html">
If you select LOBs use the following order of execution or you risk mysqli allocating more memory that actually used<br />
<br />
1)prepare()<br />
2)execute()<br />
3)store_result()<br />
4)bind_result()<br />
<br />
If you skip 3) or exchange 3) and 4) then mysqli will allocate memory for the maximal length of the column which is 255 for tinyblob, 64k for blob(still ok), 16MByte for MEDIUMBLOB - quite a lot and 4G for LONGBLOB (good if you have so much memory). Queries which use this order a bit slower when there is a LOB but this is the price of not having memory exhaustion in seconds.</span>
</code>
    </div>
   </div>
  </div>
 <div class="foot"></div>
</div>
</div>
<hr /><div class="manualnavbar" style="text-align: center;">
 <div class="prev" style="text-align: left; float: left;"><a href="mysqli-stmt.param-count.html">mysqli_stmt::$param_count</a></div>
 <div class="next" style="text-align: right; float: right;"><a href="mysqli-stmt.reset.html">mysqli_stmt::reset</a></div>
 <div class="up"><a href="class.mysqli-stmt.html">mysqli_stmt</a></div>
 <div class="home"><a href="index.html">PHP Manual</a></div>
</div></body></html>
